<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Rust 中的 Pin, Unpin 和 !Unpin - MinCodes</title><meta name=Description content="MinCodes, Minimal but useful Codes"><meta property="og:title" content="Rust 中的 Pin, Unpin 和 !Unpin">
<meta property="og:description" content="为什么需要 Pin? 引入 Pin 的目的主要是为了支持 自引用类型 (self-referential types) 。下面我们以 Future 为例，解释一下自引用类型以及引入 Pin 的必要性。 由于异步函数中可能包含对局部变"><meta property="og:type" content="article"><meta property="og:url" content="https://mincodes.com/posts/pin-unpin-in-rust/"><meta property="og:image" content="https://mincodes.com/favicon.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-19T11:54:00+08:00"><meta property="article:modified_time" content="2024-03-19T12:13:22+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mincodes.com/favicon.svg"><meta name=twitter:title content="Rust 中的 Pin, Unpin 和 !Unpin"><meta name=twitter:description content="为什么需要 Pin? 引入 Pin 的目的主要是为了支持 自引用类型 (self-referential types) 。下面我们以 Future 为例，解释一下自引用类型以及引入 Pin 的必要性。 由于异步函数中可能包含对局部变"><meta name=application-name content="MinCodes"><meta name=apple-mobile-web-app-title content="MinCodes"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://mincodes.com/posts/pin-unpin-in-rust/><link rel=prev href=https://mincodes.com/posts/understanding-lifetimes-in-rust/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Rust 中的 Pin, Unpin 和 !Unpin","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mincodes.com\/posts\/pin-unpin-in-rust\/"},"genre":"posts","keywords":"rust","wordcount":1833,"url":"https:\/\/mincodes.com\/posts\/pin-unpin-in-rust\/","datePublished":"2024-03-19T11:54:00+08:00","dateModified":"2024-03-19T12:13:22+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Min Deng"},"description":""}</script><script src=https://mincodes.com/js/mathjax-config.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=MinCodes><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.svg data-srcset="/favicon.svg, /favicon.svg 1.5x, /favicon.svg 2x" data-sizes=auto alt=/favicon.svg title=/favicon.svg><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>posts </a><a class=menu-item href=/tags/tools>tools </a><a class=menu-item href=/tags/>tags </a><a class=menu-item href=/about/>about </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=MinCodes><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.svg data-srcset="/favicon.svg, /favicon.svg 1.5x, /favicon.svg 2x" data-sizes=auto alt=/favicon.svg title=/favicon.svg><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>posts</a><a class=menu-item href=/tags/tools title>tools</a><a class=menu-item href=/tags/ title>tags</a><a class=menu-item href=/about/ title>about</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Rust 中的 Pin, Unpin 和 !Unpin</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Min Deng</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-03-19>2024-03-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 1833 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#为什么需要-pin>为什么需要 <code>Pin</code>?</a></li><li><a href=#pin-是什么><code>Pin</code> 是什么？</a></li><li><a href=#pin-的不可移动性是通过编译器来保证的><code>Pin</code> 的不可移动性是通过编译器来保证的</a></li><li><a href=#pin-的使用场景示例><code>Pin</code> 的使用场景示例</a><ul><li><a href=#需要通过-future-的-and-mut-引用调用-dot-await-方法时>需要通过 <code>Future</code> 的 <code>&amp;mut _</code> 引用调用 <code>.await</code> 方法时</a></li><li><a href=#对-stream-try-stream-宏生成的-stream-进行迭代时>对 <code>stream!</code> / <code>try_stream!</code> 宏生成的 <code>Stream</code> 进行迭代时</a></li></ul></li><li><a href=#unpin-和-pin-box-t-示例><code>!Unpin</code> 和 <code>Pin&lt;Box&lt;T>></code> 示例</a></li><li><a href=#unpin-和-pin-box-t-示例><code>Unpin</code> 和 <code>Pin&lt;Box&lt;T>></code> 示例</a></li></ul></nav></div></div><div class=content id=content><h2 id=为什么需要-pin>为什么需要 <code>Pin</code>?</h2><p>引入 <code>Pin</code> 的目的主要是为了支持 <strong>自引用类型 (self-referential types)</strong> 。下面我们以
<code>Future</code> 为例，解释一下自引用类型以及引入 <code>Pin</code> 的必要性。</p><p>由于异步函数中可能包含对局部变量的引用，例如下面的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>128</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>read_into_buf_fut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read_into_buf</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>read_into_buf_fut</span><span class=p>.</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这类代码在生成 Future 结构时，就会出现 <strong>自引用类型 (self-referential types)</strong>, 例如，上面的代码可能生成类似下面的 Future 结构：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>ReadIntoBuf</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span>: <span class=kp>&amp;</span><span class=na>&#39;a</span> <span class=nc>mut</span><span class=w> </span><span class=p>[</span><span class=kt>u8</span><span class=p>],</span><span class=w> </span><span class=c1>// points to `x` below
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>AsyncFuture</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>128</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>read_into_buf_fut</span>: <span class=nc>ReadIntoBuf</span><span class=o>&lt;</span><span class=na>&#39;what_lifetime</span><span class=o>?&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这类结构如果不能保证 self 地址的稳定性，则会出现严重的安全隐患。例如，如果
AsyncFuture 发生了移动，则 x 的地址也会发生变化，从而导致 ReadIntoBuf 中存储的
buf 指针失效。</p><p>要防止该问题，我们需要引入 <code>Pin</code> 来确保 self 地址的稳定性，以便在 <code>async</code> 块中安全地创建引用。</p><p>更多细节可参考 <a href=https://rust-lang.github.io/async-book/04_pinning/01_chapter.html target=_blank rel="noopener noreffer">Pinning - Asynchronous Programming in Rust</a>。</p><h2 id=pin-是什么><code>Pin</code> 是什么？</h2><ul><li><p><code>Pin&lt;P></code> 是一个 <code>struct</code>, 可用于包装任意的指针类型 <code>P</code>, 而 <code>Unpin</code> 和 <code>!Unpin</code> 都是
<code>trait</code> 。</p></li><li><p><code>Pin&lt;P></code> 是一个智能指针，可保证其包装的指针 <code>P</code> 后面的值不会发生移动（即物理地址保持稳定且有效），前提是其目标类型没有实现 <code>Unpin</code> 。</p><p>例如， <code>Pin&lt;&amp;mut T></code>, <code>Pin&lt;&amp;T></code>, <code>Pin&lt;Box&lt;T>></code> 都能保证 <code>T</code> 不会发生移动，如果 <code>T: !Unpin</code> 。</p></li><li><p>大多数类型在移动时都没啥问题，这些类型实现了一个叫 <code>Unpin</code> 的 trait。</p><ul><li><p>对于这些类型来讲，Pin 前和 Pin 后在使用上基本一样，不受影响。例如 <code>Pin&lt;&amp;mut u8></code> 的行为和 <code>&amp;mut u8</code> 没啥区别。</p></li><li><p>由于标准库为 <code>Unpin</code> 提供了 <code>DerefMut</code> 的一揽子实现，因此，如果 <code>T</code> 实现了 <code>Unpin</code>
trait, 则可以通过 Deref Coercion 自动获得 <code>Pin</code> 对象的可变引用 <code>&amp;mut T</code>, 也可以通过 <code>Pin::get_mut</code> 方法手动获取 <code>&amp;mut T</code>, 这意味着可以安全地对 <code>T</code> 进行修改。</p><p>详情可参考 <a href=#pin-%e7%9a%84%e4%b8%8d%e5%8f%af%e7%a7%bb%e5%8a%a8%e6%80%a7%e6%98%af%e9%80%9a%e8%bf%87%e7%bc%96%e8%af%91%e5%99%a8%e6%9d%a5%e4%bf%9d%e8%af%81%e7%9a%84 rel>Pin 的不可移动性是通过编译器来保证的</a> 。</p></li></ul></li><li><p>如果 T 带有 <code>!Unpin</code> marker，一旦被 pin 则 <code>T</code> 不可移动。</p><ul><li><code>Future</code> 就是一个 <code>!Unpin</code> 的例子。</li><li>大多数类型默认实现了 <code>Unpin</code>, 如果要强制实现 <code>!Unpin</code>, 可以在结构体中添加一个
<code>PhantomPinned</code> 字段。参考 <a href=#unpin-%e5%92%8c-pin-box-t-%e7%a4%ba%e4%be%8b rel><code>!Unpin</code> 和 <code>Pin&lt;Box&lt;T>></code> 示例</a> 。</li></ul></li><li><p>在 <code>T: !Unpin</code> 的前提下，保证 <code>T</code> 不会发生移动意味着 <code>T</code> 的物理地址是稳定且有效的，我们可以始终依赖该地址。</p><p>这点主要通过限制对 <code>T</code> 的修改来解决。因为对于 <code>T: !Unpin</code> 来说，我们拿不到 <code>Pin</code> 所指向的 <code>T</code> 的可变引用。详情可参考 <a href=#pin-%e7%9a%84%e4%b8%8d%e5%8f%af%e7%a7%bb%e5%8a%a8%e6%80%a7%e6%98%af%e9%80%9a%e8%bf%87%e7%bc%96%e8%af%91%e5%99%a8%e6%9d%a5%e4%bf%9d%e8%af%81%e7%9a%84 rel>Pin 的不可移动性是通过编译器来保证的</a> 。</p><blockquote><p>🌟 对 <a href=https://doc.rust-lang.org/std/pin/struct.Pin.html#method.set target=_blank rel="noopener noreffer"><code>Pin::set</code> </a>方法的理解。</p><p><code>Pin::set</code> 方法可以设置一个新的 <code>T</code> 值以替换旧值。请注意，这种替换永远是一个完整的、合法的 <code>T</code> 值替换另一个 <code>T</code> 值，这点和直接获取 <code>mut</code> 引用有所不同，因为直接获取 <code>mut</code> 引用可能会导致不安全的修改（例如对自引用类型的 <code>swap</code> 操作）。同时，
<code>set</code> 方法会引起旧的值的析构，因此是安全的，没有违反 <code>Pin</code> 协议。</p></blockquote></li><li><p>Pin 可以发生在栈上，也可以发生在堆上。</p><ul><li><p>栈上的 Pin 依赖于 <code>unsafe</code> 代码，且需要由 我们自己提供被 Pin 值的生命周期的保证，否则可能违反 Pin 契约。（更新：Rust 1.68 引入了 <a href=https://doc.rust-lang.org/std/pin/macro.pin.html target=_blank rel="noopener noreffer">安全版本的栈上 pin 宏</a>
<code>std::pin::pin!()</code> ）。参考 <a href=#unpin-%e5%92%8c-pin-box-t-%e7%a4%ba%e4%be%8b rel><code>!Unpin</code> 和 <code>Pin&lt;Box&lt;T>></code> 示例</a> 。</p></li><li><p>堆上的 Pin 直接用 <code>Box::pin()</code> 即可。参考 <a href=#unpin-%e5%92%8c-pin-box-t-%e7%a4%ba%e4%be%8b rel><code>Unpin</code> 和 <code>Pin&lt;Box&lt;T>></code> 示例</a> 。</p></li></ul></li></ul><h2 id=pin-的不可移动性是通过编译器来保证的><code>Pin</code> 的不可移动性是通过编译器来保证的</h2><p><code>Pin&lt;P></code> 仅为 Target 为 <code>Unpin</code> 的可变引用实现了 <code>DerefMut</code>, 其他情况都只能获得 Target
的不可变引用。</p><p>参考标准库中的 <code>Pin</code> 实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=o>&lt;</span><span class=n>P</span>: <span class=nc>Deref</span><span class=o>&gt;</span><span class=w> </span><span class=n>Deref</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Pin</span><span class=o>&lt;</span><span class=n>P</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>P</span>::<span class=n>Target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>deref</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>P</span>::<span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Pin</span>::<span class=n>get_ref</span><span class=p>(</span><span class=n>Pin</span>::<span class=n>as_ref</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 为 Target 为 Unpin 的可变引用提供的 DerefMut 实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>P</span>: <span class=nc>DerefMut</span><span class=o>&lt;</span><span class=n>Target</span>: <span class=nb>Unpin</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>DerefMut</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Pin</span><span class=o>&lt;</span><span class=n>P</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>deref_mut</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>P</span>::<span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Pin</span>::<span class=n>get_mut</span><span class=p>(</span><span class=n>Pin</span>::<span class=n>as_mut</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=pin-的使用场景示例><code>Pin</code> 的使用场景示例</h2><h3 id=需要通过-future-的-and-mut-引用调用-dot-await-方法时>需要通过 <code>Future</code> 的 <code>&amp;mut _</code> 引用调用 <code>.await</code> 方法时</h3><ul><li><code>async fn</code> 返回的 Future 是 <code>!Unpin</code> 的</li><li>Future 在被 poll 之前，必须被 pin 住</li><li>直接在 Future 上调用 <code>.await</code> 会自动处理 pin 的逻辑，但是会将该 Future 消耗掉</li><li>要想不消耗掉 Future (例如在 loop 里面对 Future 进行 <code>select!</code>), 需要通过 mut 引用来调用 <code>.await</code> 方法。</li><li>通过 mut 引用 <code>.await</code> 前，需要我们自己手动先将 Future pin 住。</li><li>Pin 有两种方式：<ul><li><strong>在堆上 pin:</strong> 使用 <code>Box::pin</code> 将数据分配到堆上并 pin 住。</li><li><strong>在栈上 pin:</strong> 使用 <code>tokio::pin!</code> (或者 <code>std::pin::pin!</code>) 宏，将数据 pin 在栈上。</li></ul></li></ul><p>参考 <a href=https://docs.rs/tokio/latest/tokio/macro.pin.html target=_blank rel="noopener noreffer">tokio::pin</a>。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>use tokio::pin;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>async fn my_async_fn() {
</span></span><span class=line><span class=cl>    // async logic here
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#[tokio::main]
</span></span><span class=line><span class=cl>async fn main() {
</span></span><span class=line><span class=cl>    let future = my_async_fn();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 去掉下面这句，将导致编译失败‼️
</span></span><span class=line><span class=cl>    pin!(future);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    (&amp;mut future).await;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 或者用标准库的 local pin 方法：
</span></span><span class=line><span class=cl>    // std::pin::pin!(future).await;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=对-stream-try-stream-宏生成的-stream-进行迭代时>对 <code>stream!</code> / <code>try_stream!</code> 宏生成的 <code>Stream</code> 进行迭代时</h3><p>和 <code>Future</code> 类似，由于 <code>stream!</code> / <code>try_stream!</code> 生成的 Stream 同样是 <code>!Unpin</code> 的，因此，在对其进行迭代操作前，同样需要先 pin 住。</p><p>详细信息可参考 <a href=https://tokio.rs/tokio/tutorial/streams target=_blank rel="noopener noreffer">Streams in Tokio</a>。</p><h2 id=unpin-和-pin-box-t-示例><code>!Unpin</code> 和 <code>Pin&lt;Box&lt;T>></code> 示例</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>marker</span>::<span class=n>PhantomPinned</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>a</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>b</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 表明该类型未实现 Unpin, 去掉该字段则默认实现了 Unpin
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>_marker</span>: <span class=nc>PhantomPinned</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>txt</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Pin</span><span class=o>&lt;</span><span class=nb>Box</span><span class=o>&lt;</span><span class=bp>Self</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>a</span>: <span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>txt</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>b</span>: <span class=nc>std</span>::<span class=n>ptr</span>::<span class=n>null</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_marker</span>: <span class=nc>PhantomPinned</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>boxed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Box</span>::<span class=n>pin</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>self_ptr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=nb>String</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>boxed</span><span class=p>.</span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>boxed</span><span class=p>.</span><span class=n>as_mut</span><span class=p>().</span><span class=n>get_unchecked_mut</span><span class=p>().</span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self_ptr</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>boxed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>a</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=kt>str</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>get_ref</span><span class=p>().</span><span class=n>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>b</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nb>String</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>&amp;*</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>test1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Test</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;test1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>test2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Test</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;test2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;a: </span><span class=si>{}</span><span class=s>, b: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>test1</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>a</span><span class=p>(),</span><span class=w> </span><span class=n>test1</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>b</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;a: </span><span class=si>{}</span><span class=s>, b: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>a</span><span class=p>(),</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>b</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 下面这行编译报错❗
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>//   cannot borrow data in dereference of `Pin&lt;Box&lt;Test&gt;&gt;` as mutable rustc (E0596)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// trait `DerefMut` is required to modify through a dereference,
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// but it is not implemented for `Pin&lt;Box&lt;Test&gt;&gt;`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// test1.a.push_str(&#34;hello&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=unpin-和-pin-box-t-示例><code>Unpin</code> 和 <code>Pin&lt;Box&lt;T>></code> 示例</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Example</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>value</span>: <span class=kt>i32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Example</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>increment</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>value</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Example 类型自动实现了 Unpin。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>example</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Example</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>value</span>: <span class=mi>10</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>pinned_example</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>example</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 由于 Example 实现了 Unpin，我们可以获取可变引用来修改它
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>pinned_example</span><span class=p>.</span><span class=n>as_mut</span><span class=p>().</span><span class=n>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Updated value: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pinned_example</span><span class=p>.</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-03-19</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust 中的 Pin, Unpin 和 !Unpin" data-hashtags=rust><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-hashtag=rust><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust 中的 Pin, Unpin 和 !Unpin"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust 中的 Pin, Unpin 和 !Unpin"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust 中的 Pin, Unpin 和 !Unpin"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/rust/>Rust</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/understanding-lifetimes-in-rust/ class=prev rel=prev title="理解 Rust 的 生命周期 (Lifetime)"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>理解 Rust 的 生命周期 (Lifetime)</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?7b760b677a021bf17f98d03f83124b62",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Min Deng</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},data:{"id-1":"MinCodes","id-2":"MinCodes"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>