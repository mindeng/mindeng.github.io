<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin - MinCodes</title><meta name=Description content="MinCodes, Minimal but useful Codes"><meta property="og:title" content="Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin">
<meta property="og:description" content="ä¸ºä»€ä¹ˆéœ€è¦ Pin? å¼•å…¥ Pin çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒ è‡ªå¼•ç”¨ç±»å‹ (self-referential types) ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ Future ä¸ºä¾‹ï¼Œè§£é‡Šä¸€ä¸‹è‡ªå¼•ç”¨ç±»å‹ä»¥åŠå¼•å…¥ Pin çš„å¿…è¦æ€§ã€‚ ç”±äºå¼‚æ­¥å‡½æ•°ä¸­å¯èƒ½åŒ…å«å¯¹å±€éƒ¨å˜"><meta property="og:type" content="article"><meta property="og:url" content="https://mincodes.com/posts/pin-unpin-in-rust/"><meta property="og:image" content="https://mincodes.com/favicon.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-19T11:54:00+08:00"><meta property="article:modified_time" content="2024-03-19T12:13:22+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mincodes.com/favicon.svg"><meta name=twitter:title content="Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin"><meta name=twitter:description content="ä¸ºä»€ä¹ˆéœ€è¦ Pin? å¼•å…¥ Pin çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒ è‡ªå¼•ç”¨ç±»å‹ (self-referential types) ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ Future ä¸ºä¾‹ï¼Œè§£é‡Šä¸€ä¸‹è‡ªå¼•ç”¨ç±»å‹ä»¥åŠå¼•å…¥ Pin çš„å¿…è¦æ€§ã€‚ ç”±äºå¼‚æ­¥å‡½æ•°ä¸­å¯èƒ½åŒ…å«å¯¹å±€éƒ¨å˜"><meta name=application-name content="MinCodes"><meta name=apple-mobile-web-app-title content="MinCodes"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://mincodes.com/posts/pin-unpin-in-rust/><link rel=prev href=https://mincodes.com/posts/understanding-lifetimes-in-rust/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mincodes.com\/posts\/pin-unpin-in-rust\/"},"genre":"posts","keywords":"rust","wordcount":1833,"url":"https:\/\/mincodes.com\/posts\/pin-unpin-in-rust\/","datePublished":"2024-03-19T11:54:00+08:00","dateModified":"2024-03-19T12:13:22+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Min Deng"},"description":""}</script><script src=https://mincodes.com/js/mathjax-config.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=MinCodes><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.svg data-srcset="/favicon.svg, /favicon.svg 1.5x, /favicon.svg 2x" data-sizes=auto alt=/favicon.svg title=/favicon.svg><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>posts </a><a class=menu-item href=/tags/tools>tools </a><a class=menu-item href=/tags/>tags </a><a class=menu-item href=/about/>about </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=MinCodes><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.svg data-srcset="/favicon.svg, /favicon.svg 1.5x, /favicon.svg 2x" data-sizes=auto alt=/favicon.svg title=/favicon.svg><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>posts</a><a class=menu-item href=/tags/tools title>tools</a><a class=menu-item href=/tags/ title>tags</a><a class=menu-item href=/about/ title>about</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Min Deng</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-03-19>2024-03-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 1833 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 4 åˆ†é’Ÿ&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#ä¸ºä»€ä¹ˆéœ€è¦-pin>ä¸ºä»€ä¹ˆéœ€è¦ <code>Pin</code>?</a></li><li><a href=#pin-æ˜¯ä»€ä¹ˆ><code>Pin</code> æ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href=#pin-çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„><code>Pin</code> çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„</a></li><li><a href=#pin-çš„ä½¿ç”¨åœºæ™¯ç¤ºä¾‹><code>Pin</code> çš„ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</a><ul><li><a href=#éœ€è¦é€šè¿‡-future-çš„-and-mut-å¼•ç”¨è°ƒç”¨-dot-await-æ–¹æ³•æ—¶>éœ€è¦é€šè¿‡ <code>Future</code> çš„ <code>&amp;mut _</code> å¼•ç”¨è°ƒç”¨ <code>.await</code> æ–¹æ³•æ—¶</a></li><li><a href=#å¯¹-stream-try-stream-å®ç”Ÿæˆçš„-stream-è¿›è¡Œè¿­ä»£æ—¶>å¯¹ <code>stream!</code> / <code>try_stream!</code> å®ç”Ÿæˆçš„ <code>Stream</code> è¿›è¡Œè¿­ä»£æ—¶</a></li></ul></li><li><a href=#unpin-å’Œ-pin-box-t-ç¤ºä¾‹><code>!Unpin</code> å’Œ <code>Pin&lt;Box&lt;T>></code> ç¤ºä¾‹</a></li><li><a href=#unpin-å’Œ-pin-box-t-ç¤ºä¾‹><code>Unpin</code> å’Œ <code>Pin&lt;Box&lt;T>></code> ç¤ºä¾‹</a></li></ul></nav></div></div><div class=content id=content><h2 id=ä¸ºä»€ä¹ˆéœ€è¦-pin>ä¸ºä»€ä¹ˆéœ€è¦ <code>Pin</code>?</h2><p>å¼•å…¥ <code>Pin</code> çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒ <strong>è‡ªå¼•ç”¨ç±»å‹ (self-referential types)</strong> ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥
<code>Future</code> ä¸ºä¾‹ï¼Œè§£é‡Šä¸€ä¸‹è‡ªå¼•ç”¨ç±»å‹ä»¥åŠå¼•å…¥ <code>Pin</code> çš„å¿…è¦æ€§ã€‚</p><p>ç”±äºå¼‚æ­¥å‡½æ•°ä¸­å¯èƒ½åŒ…å«å¯¹å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>128</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>read_into_buf_fut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read_into_buf</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>read_into_buf_fut</span><span class=p>.</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ç±»ä»£ç åœ¨ç”Ÿæˆ Future ç»“æ„æ—¶ï¼Œå°±ä¼šå‡ºç° <strong>è‡ªå¼•ç”¨ç±»å‹ (self-referential types)</strong>, ä¾‹å¦‚ï¼Œä¸Šé¢çš„ä»£ç å¯èƒ½ç”Ÿæˆç±»ä¼¼ä¸‹é¢çš„ Future ç»“æ„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>ReadIntoBuf</span><span class=o>&lt;</span><span class=na>&#39;a</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span>: <span class=kp>&amp;</span><span class=na>&#39;a</span> <span class=nc>mut</span><span class=w> </span><span class=p>[</span><span class=kt>u8</span><span class=p>],</span><span class=w> </span><span class=c1>// points to `x` below
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>AsyncFuture</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>128</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>read_into_buf_fut</span>: <span class=nc>ReadIntoBuf</span><span class=o>&lt;</span><span class=na>&#39;what_lifetime</span><span class=o>?&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ç±»ç»“æ„å¦‚æœä¸èƒ½ä¿è¯ self åœ°å€çš„ç¨³å®šæ€§ï¼Œåˆ™ä¼šå‡ºç°ä¸¥é‡çš„å®‰å…¨éšæ‚£ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ
AsyncFuture å‘ç”Ÿäº†ç§»åŠ¨ï¼Œåˆ™ x çš„åœ°å€ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå¯¼è‡´ ReadIntoBuf ä¸­å­˜å‚¨çš„
buf æŒ‡é’ˆå¤±æ•ˆã€‚</p><p>è¦é˜²æ­¢è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ <code>Pin</code> æ¥ç¡®ä¿ self åœ°å€çš„ç¨³å®šæ€§ï¼Œä»¥ä¾¿åœ¨ <code>async</code> å—ä¸­å®‰å…¨åœ°åˆ›å»ºå¼•ç”¨ã€‚</p><p>æ›´å¤šç»†èŠ‚å¯å‚è€ƒ <a href=https://rust-lang.github.io/async-book/04_pinning/01_chapter.html target=_blank rel="noopener noreffer">Pinning - Asynchronous Programming in Rust</a>ã€‚</p><h2 id=pin-æ˜¯ä»€ä¹ˆ><code>Pin</code> æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul><li><p><code>Pin&lt;P></code> æ˜¯ä¸€ä¸ª <code>struct</code>, å¯ç”¨äºåŒ…è£…ä»»æ„çš„æŒ‡é’ˆç±»å‹ <code>P</code>, è€Œ <code>Unpin</code> å’Œ <code>!Unpin</code> éƒ½æ˜¯
<code>trait</code> ã€‚</p></li><li><p><code>Pin&lt;P></code> æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå¯ä¿è¯å…¶åŒ…è£…çš„æŒ‡é’ˆ <code>P</code> åé¢çš„å€¼ä¸ä¼šå‘ç”Ÿç§»åŠ¨ï¼ˆå³ç‰©ç†åœ°å€ä¿æŒç¨³å®šä¸”æœ‰æ•ˆï¼‰ï¼Œå‰ææ˜¯å…¶ç›®æ ‡ç±»å‹æ²¡æœ‰å®ç° <code>Unpin</code> ã€‚</p><p>ä¾‹å¦‚ï¼Œ <code>Pin&lt;&amp;mut T></code>, <code>Pin&lt;&amp;T></code>, <code>Pin&lt;Box&lt;T>></code> éƒ½èƒ½ä¿è¯ <code>T</code> ä¸ä¼šå‘ç”Ÿç§»åŠ¨ï¼Œå¦‚æœ <code>T: !Unpin</code> ã€‚</p></li><li><p>å¤§å¤šæ•°ç±»å‹åœ¨ç§»åŠ¨æ—¶éƒ½æ²¡å•¥é—®é¢˜ï¼Œè¿™äº›ç±»å‹å®ç°äº†ä¸€ä¸ªå« <code>Unpin</code> çš„ traitã€‚</p><ul><li><p>å¯¹äºè¿™äº›ç±»å‹æ¥è®²ï¼ŒPin å‰å’Œ Pin ååœ¨ä½¿ç”¨ä¸ŠåŸºæœ¬ä¸€æ ·ï¼Œä¸å—å½±å“ã€‚ä¾‹å¦‚ <code>Pin&lt;&amp;mut u8></code> çš„è¡Œä¸ºå’Œ <code>&amp;mut u8</code> æ²¡å•¥åŒºåˆ«ã€‚</p></li><li><p>ç”±äºæ ‡å‡†åº“ä¸º <code>Unpin</code> æä¾›äº† <code>DerefMut</code> çš„ä¸€æ½å­å®ç°ï¼Œå› æ­¤ï¼Œå¦‚æœ <code>T</code> å®ç°äº† <code>Unpin</code>
trait, åˆ™å¯ä»¥é€šè¿‡ Deref Coercion è‡ªåŠ¨è·å¾— <code>Pin</code> å¯¹è±¡çš„å¯å˜å¼•ç”¨ <code>&amp;mut T</code>, ä¹Ÿå¯ä»¥é€šè¿‡ <code>Pin::get_mut</code> æ–¹æ³•æ‰‹åŠ¨è·å– <code>&amp;mut T</code>, è¿™æ„å‘³ç€å¯ä»¥å®‰å…¨åœ°å¯¹ <code>T</code> è¿›è¡Œä¿®æ”¹ã€‚</p><p>è¯¦æƒ…å¯å‚è€ƒ <a href=#pin-%e7%9a%84%e4%b8%8d%e5%8f%af%e7%a7%bb%e5%8a%a8%e6%80%a7%e6%98%af%e9%80%9a%e8%bf%87%e7%bc%96%e8%af%91%e5%99%a8%e6%9d%a5%e4%bf%9d%e8%af%81%e7%9a%84 rel>Pin çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„</a> ã€‚</p></li></ul></li><li><p>å¦‚æœ T å¸¦æœ‰ <code>!Unpin</code> markerï¼Œä¸€æ—¦è¢« pin åˆ™ <code>T</code> ä¸å¯ç§»åŠ¨ã€‚</p><ul><li><code>Future</code> å°±æ˜¯ä¸€ä¸ª <code>!Unpin</code> çš„ä¾‹å­ã€‚</li><li>å¤§å¤šæ•°ç±»å‹é»˜è®¤å®ç°äº† <code>Unpin</code>, å¦‚æœè¦å¼ºåˆ¶å®ç° <code>!Unpin</code>, å¯ä»¥åœ¨ç»“æ„ä½“ä¸­æ·»åŠ ä¸€ä¸ª
<code>PhantomPinned</code> å­—æ®µã€‚å‚è€ƒ <a href=#unpin-%e5%92%8c-pin-box-t-%e7%a4%ba%e4%be%8b rel><code>!Unpin</code> å’Œ <code>Pin&lt;Box&lt;T>></code> ç¤ºä¾‹</a> ã€‚</li></ul></li><li><p>åœ¨ <code>T: !Unpin</code> çš„å‰æä¸‹ï¼Œä¿è¯ <code>T</code> ä¸ä¼šå‘ç”Ÿç§»åŠ¨æ„å‘³ç€ <code>T</code> çš„ç‰©ç†åœ°å€æ˜¯ç¨³å®šä¸”æœ‰æ•ˆçš„ï¼Œæˆ‘ä»¬å¯ä»¥å§‹ç»ˆä¾èµ–è¯¥åœ°å€ã€‚</p><p>è¿™ç‚¹ä¸»è¦é€šè¿‡é™åˆ¶å¯¹ <code>T</code> çš„ä¿®æ”¹æ¥è§£å†³ã€‚å› ä¸ºå¯¹äº <code>T: !Unpin</code> æ¥è¯´ï¼Œæˆ‘ä»¬æ‹¿ä¸åˆ° <code>Pin</code> æ‰€æŒ‡å‘çš„ <code>T</code> çš„å¯å˜å¼•ç”¨ã€‚è¯¦æƒ…å¯å‚è€ƒ <a href=#pin-%e7%9a%84%e4%b8%8d%e5%8f%af%e7%a7%bb%e5%8a%a8%e6%80%a7%e6%98%af%e9%80%9a%e8%bf%87%e7%bc%96%e8%af%91%e5%99%a8%e6%9d%a5%e4%bf%9d%e8%af%81%e7%9a%84 rel>Pin çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„</a> ã€‚</p><blockquote><p>ğŸŒŸ å¯¹ <a href=https://doc.rust-lang.org/std/pin/struct.Pin.html#method.set target=_blank rel="noopener noreffer"><code>Pin::set</code> </a>æ–¹æ³•çš„ç†è§£ã€‚</p><p><code>Pin::set</code> æ–¹æ³•å¯ä»¥è®¾ç½®ä¸€ä¸ªæ–°çš„ <code>T</code> å€¼ä»¥æ›¿æ¢æ—§å€¼ã€‚è¯·æ³¨æ„ï¼Œè¿™ç§æ›¿æ¢æ°¸è¿œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€åˆæ³•çš„ <code>T</code> å€¼æ›¿æ¢å¦ä¸€ä¸ª <code>T</code> å€¼ï¼Œè¿™ç‚¹å’Œç›´æ¥è·å– <code>mut</code> å¼•ç”¨æœ‰æ‰€ä¸åŒï¼Œå› ä¸ºç›´æ¥è·å– <code>mut</code> å¼•ç”¨å¯èƒ½ä¼šå¯¼è‡´ä¸å®‰å…¨çš„ä¿®æ”¹ï¼ˆä¾‹å¦‚å¯¹è‡ªå¼•ç”¨ç±»å‹çš„ <code>swap</code> æ“ä½œï¼‰ã€‚åŒæ—¶ï¼Œ
<code>set</code> æ–¹æ³•ä¼šå¼•èµ·æ—§çš„å€¼çš„ææ„ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„ï¼Œæ²¡æœ‰è¿å <code>Pin</code> åè®®ã€‚</p></blockquote></li><li><p>Pin å¯ä»¥å‘ç”Ÿåœ¨æ ˆä¸Šï¼Œä¹Ÿå¯ä»¥å‘ç”Ÿåœ¨å †ä¸Šã€‚</p><ul><li><p>æ ˆä¸Šçš„ Pin ä¾èµ–äº <code>unsafe</code> ä»£ç ï¼Œä¸”éœ€è¦ç”± æˆ‘ä»¬è‡ªå·±æä¾›è¢« Pin å€¼çš„ç”Ÿå‘½å‘¨æœŸçš„ä¿è¯ï¼Œå¦åˆ™å¯èƒ½è¿å Pin å¥‘çº¦ã€‚ï¼ˆæ›´æ–°ï¼šRust 1.68 å¼•å…¥äº† <a href=https://doc.rust-lang.org/std/pin/macro.pin.html target=_blank rel="noopener noreffer">å®‰å…¨ç‰ˆæœ¬çš„æ ˆä¸Š pin å®</a>
<code>std::pin::pin!()</code> ï¼‰ã€‚å‚è€ƒ <a href=#unpin-%e5%92%8c-pin-box-t-%e7%a4%ba%e4%be%8b rel><code>!Unpin</code> å’Œ <code>Pin&lt;Box&lt;T>></code> ç¤ºä¾‹</a> ã€‚</p></li><li><p>å †ä¸Šçš„ Pin ç›´æ¥ç”¨ <code>Box::pin()</code> å³å¯ã€‚å‚è€ƒ <a href=#unpin-%e5%92%8c-pin-box-t-%e7%a4%ba%e4%be%8b rel><code>Unpin</code> å’Œ <code>Pin&lt;Box&lt;T>></code> ç¤ºä¾‹</a> ã€‚</p></li></ul></li></ul><h2 id=pin-çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„><code>Pin</code> çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„</h2><p><code>Pin&lt;P></code> ä»…ä¸º Target ä¸º <code>Unpin</code> çš„å¯å˜å¼•ç”¨å®ç°äº† <code>DerefMut</code>, å…¶ä»–æƒ…å†µéƒ½åªèƒ½è·å¾— Target
çš„ä¸å¯å˜å¼•ç”¨ã€‚</p><p>å‚è€ƒæ ‡å‡†åº“ä¸­çš„ <code>Pin</code> å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=o>&lt;</span><span class=n>P</span>: <span class=nc>Deref</span><span class=o>&gt;</span><span class=w> </span><span class=n>Deref</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Pin</span><span class=o>&lt;</span><span class=n>P</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>P</span>::<span class=n>Target</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>deref</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>P</span>::<span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Pin</span>::<span class=n>get_ref</span><span class=p>(</span><span class=n>Pin</span>::<span class=n>as_ref</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ä¸º Target ä¸º Unpin çš„å¯å˜å¼•ç”¨æä¾›çš„ DerefMut å®ç°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>P</span>: <span class=nc>DerefMut</span><span class=o>&lt;</span><span class=n>Target</span>: <span class=nb>Unpin</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>DerefMut</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Pin</span><span class=o>&lt;</span><span class=n>P</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>deref_mut</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>P</span>::<span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Pin</span>::<span class=n>get_mut</span><span class=p>(</span><span class=n>Pin</span>::<span class=n>as_mut</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=pin-çš„ä½¿ç”¨åœºæ™¯ç¤ºä¾‹><code>Pin</code> çš„ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</h2><h3 id=éœ€è¦é€šè¿‡-future-çš„-and-mut-å¼•ç”¨è°ƒç”¨-dot-await-æ–¹æ³•æ—¶>éœ€è¦é€šè¿‡ <code>Future</code> çš„ <code>&amp;mut _</code> å¼•ç”¨è°ƒç”¨ <code>.await</code> æ–¹æ³•æ—¶</h3><ul><li><code>async fn</code> è¿”å›çš„ Future æ˜¯ <code>!Unpin</code> çš„</li><li>Future åœ¨è¢« poll ä¹‹å‰ï¼Œå¿…é¡»è¢« pin ä½</li><li>ç›´æ¥åœ¨ Future ä¸Šè°ƒç”¨ <code>.await</code> ä¼šè‡ªåŠ¨å¤„ç† pin çš„é€»è¾‘ï¼Œä½†æ˜¯ä¼šå°†è¯¥ Future æ¶ˆè€—æ‰</li><li>è¦æƒ³ä¸æ¶ˆè€—æ‰ Future (ä¾‹å¦‚åœ¨ loop é‡Œé¢å¯¹ Future è¿›è¡Œ <code>select!</code>), éœ€è¦é€šè¿‡ mut å¼•ç”¨æ¥è°ƒç”¨ <code>.await</code> æ–¹æ³•ã€‚</li><li>é€šè¿‡ mut å¼•ç”¨ <code>.await</code> å‰ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨å…ˆå°† Future pin ä½ã€‚</li><li>Pin æœ‰ä¸¤ç§æ–¹å¼ï¼š<ul><li><strong>åœ¨å †ä¸Š pin:</strong> ä½¿ç”¨ <code>Box::pin</code> å°†æ•°æ®åˆ†é…åˆ°å †ä¸Šå¹¶ pin ä½ã€‚</li><li><strong>åœ¨æ ˆä¸Š pin:</strong> ä½¿ç”¨ <code>tokio::pin!</code> (æˆ–è€… <code>std::pin::pin!</code>) å®ï¼Œå°†æ•°æ® pin åœ¨æ ˆä¸Šã€‚</li></ul></li></ul><p>å‚è€ƒ <a href=https://docs.rs/tokio/latest/tokio/macro.pin.html target=_blank rel="noopener noreffer">tokio::pin</a>ã€‚</p><p>ç¤ºä¾‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>use tokio::pin;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>async fn my_async_fn() {
</span></span><span class=line><span class=cl>    // async logic here
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#[tokio::main]
</span></span><span class=line><span class=cl>async fn main() {
</span></span><span class=line><span class=cl>    let future = my_async_fn();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // å»æ‰ä¸‹é¢è¿™å¥ï¼Œå°†å¯¼è‡´ç¼–è¯‘å¤±è´¥â€¼ï¸
</span></span><span class=line><span class=cl>    pin!(future);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    (&amp;mut future).await;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // æˆ–è€…ç”¨æ ‡å‡†åº“çš„ local pin æ–¹æ³•ï¼š
</span></span><span class=line><span class=cl>    // std::pin::pin!(future).await;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=å¯¹-stream-try-stream-å®ç”Ÿæˆçš„-stream-è¿›è¡Œè¿­ä»£æ—¶>å¯¹ <code>stream!</code> / <code>try_stream!</code> å®ç”Ÿæˆçš„ <code>Stream</code> è¿›è¡Œè¿­ä»£æ—¶</h3><p>å’Œ <code>Future</code> ç±»ä¼¼ï¼Œç”±äº <code>stream!</code> / <code>try_stream!</code> ç”Ÿæˆçš„ Stream åŒæ ·æ˜¯ <code>!Unpin</code> çš„ï¼Œå› æ­¤ï¼Œåœ¨å¯¹å…¶è¿›è¡Œè¿­ä»£æ“ä½œå‰ï¼ŒåŒæ ·éœ€è¦å…ˆ pin ä½ã€‚</p><p>è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ <a href=https://tokio.rs/tokio/tutorial/streams target=_blank rel="noopener noreffer">Streams in Tokio</a>ã€‚</p><h2 id=unpin-å’Œ-pin-box-t-ç¤ºä¾‹><code>!Unpin</code> å’Œ <code>Pin&lt;Box&lt;T>></code> ç¤ºä¾‹</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>marker</span>::<span class=n>PhantomPinned</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>a</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>b</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¡¨æ˜è¯¥ç±»å‹æœªå®ç° Unpin, å»æ‰è¯¥å­—æ®µåˆ™é»˜è®¤å®ç°äº† Unpin
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>_marker</span>: <span class=nc>PhantomPinned</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=n>txt</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Pin</span><span class=o>&lt;</span><span class=nb>Box</span><span class=o>&lt;</span><span class=bp>Self</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Test</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>a</span>: <span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>txt</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>b</span>: <span class=nc>std</span>::<span class=n>ptr</span>::<span class=n>null</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_marker</span>: <span class=nc>PhantomPinned</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>boxed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Box</span>::<span class=n>pin</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>self_ptr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=nb>String</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>boxed</span><span class=p>.</span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>boxed</span><span class=p>.</span><span class=n>as_mut</span><span class=p>().</span><span class=n>get_unchecked_mut</span><span class=p>().</span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self_ptr</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>boxed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>a</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=kt>str</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>get_ref</span><span class=p>().</span><span class=n>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>b</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nb>String</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>&amp;*</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>test1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Test</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;test1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>test2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Test</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;test2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;a: </span><span class=si>{}</span><span class=s>, b: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>test1</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>a</span><span class=p>(),</span><span class=w> </span><span class=n>test1</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>b</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;a: </span><span class=si>{}</span><span class=s>, b: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>a</span><span class=p>(),</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=n>as_ref</span><span class=p>().</span><span class=n>b</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¸‹é¢è¿™è¡Œç¼–è¯‘æŠ¥é”™â—
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ï—  cannot borrow data in dereference of `Pin&lt;Box&lt;Test&gt;&gt;` as mutable rustc (E0596)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// trait `DerefMut` is required to modify through a dereference,
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// but it is not implemented for `Pin&lt;Box&lt;Test&gt;&gt;`
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// test1.a.push_str(&#34;hello&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=unpin-å’Œ-pin-box-t-ç¤ºä¾‹><code>Unpin</code> å’Œ <code>Pin&lt;Box&lt;T>></code> ç¤ºä¾‹</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Example</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>value</span>: <span class=kt>i32</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Example</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>increment</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>value</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Example ç±»å‹è‡ªåŠ¨å®ç°äº† Unpinã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>example</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Example</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>value</span>: <span class=mi>10</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>pinned_example</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>example</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ç”±äº Example å®ç°äº† Unpinï¼Œæˆ‘ä»¬å¯ä»¥è·å–å¯å˜å¼•ç”¨æ¥ä¿®æ”¹å®ƒ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>pinned_example</span><span class=p>.</span><span class=n>as_mut</span><span class=p>().</span><span class=n>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Updated value: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pinned_example</span><span class=p>.</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2024-03-19</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin" data-hashtags=rust><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Facebook" data-sharer=facebook data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-hashtag=rust><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Hacker News" data-sharer=hackernews data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Line" data-sharer=line data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=https://mincodes.com/posts/pin-unpin-in-rust/ data-title="Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/rust/>Rust</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/posts/understanding-lifetimes-in-rust/ class=prev rel=prev title="ç†è§£ Rust çš„ ç”Ÿå‘½å‘¨æœŸ (Lifetime)"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>ç†è§£ Rust çš„ ç”Ÿå‘½å‘¨æœŸ (Lifetime)</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?7b760b677a021bf17f98d03f83124b62",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Min Deng</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:50},comment:{},data:{"id-1":"MinCodes","id-2":"MinCodes"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>