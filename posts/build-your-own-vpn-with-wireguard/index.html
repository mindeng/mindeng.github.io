<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=UTF-8><meta name=generator content="Hugo 0.150.1"><meta name=theme-color content="#fff"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><title>利用 WireGuard 快速构建属于你自己的虚拟专用网络 | MinCodes</title><link rel=stylesheet href=/css/meme.min.72d3072bb698c427b5f0f83d1928dbfb228b83b6475ca3cdfffb5f335fb4fd1e.css><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js defer></script><script src=/js/meme.min.2872df1d06c92334a338cf8ff2d1250458bb744c8955b71c2c61f579ef1ed6e8.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&amp;family=Fira+Code:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&amp;family=Fira+Code:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap"></noscript><meta name=author content><meta name=description content="引言 本文详细分析了 WireGuard 的数据收发、数据中继的基本原理，并介绍了一种如何利用 WireGuard 快速构建一个属于自己的虚拟专用网络，可用于跨广域网安全通信，以及内网穿透。常见应用场景有：
"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/svg+xml href=/icons/favicon.svg><link rel=icon type=image/png href=/icons/favicon-96x96.png sizes=96x96><link rel=apple-touch-icon href=/icons/apple-touch-icon.png sizes=180x180><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="MinCodes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="MinCodes"><link rel=manifest href=/manifest.json><link rel=canonical href=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2025-09-26T23:40:01+08:00","dateModified":"2025-09-26T23:40:01+08:00","url":"https://mincodes.com/posts/build-your-own-vpn-with-wireguard/","headline":"\n利用 WireGuard 快速构建属于你自己的虚拟专用网络","description":"引言 本文详细分析了 WireGuard 的数据收发、数据中继的基本原理，并介绍了一种如何利用 WireGuard 快速构建一个属于自己的虚拟专用网络，可用于跨广域网安全通信，以及内网穿透。常见应用场景有：\n","inLanguage":"zh-cn","articleSection":"posts","wordCount":10479,"image":"https://mincodes.com/icons/apple-touch-icon.png","author":{"@type":"Person","url":"https://mincodes.com/"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)","publisher":{"@type":"Organization","name":"MinCodes","logo":{"@type":"ImageObject","url":"https://mincodes.com/icons/apple-touch-icon.png"},"url":"https://mincodes.com/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://mincodes.com/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="
利用 WireGuard 快速构建属于你自己的虚拟专用网络"><meta property="og:description" content="引言 本文详细分析了 WireGuard 的数据收发、数据中继的基本原理，并介绍了一种如何利用 WireGuard 快速构建一个属于自己的虚拟专用网络，可用于跨广域网安全通信，以及内网穿透。常见应用场景有：
"><meta property="og:url" content="https://mincodes.com/posts/build-your-own-vpn-with-wireguard/"><meta property="og:site_name" content="MinCodes"><meta property="og:locale" content="en"><meta property="og:image" content="https://mincodes.com/icons/apple-touch-icon.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2025-09-26T23:40:01+08:00"><meta property="article:modified_time" content="2025-09-26T23:40:01+08:00"><meta property="article:section" content="posts"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>MinCodes</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/posts/><svg viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7.0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6.0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6.0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3.0 64v48c0 8.8 7.2 16 16 16h480c8.8.0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class=menu-item-name>Posts</span></a></li><li class=menu-item><a href=/tags/><svg viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg><span class=menu-item-name>Tags</span></a></li><li class=menu-item><a href=/about/><svg viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6.0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7.0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4.0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9s28-2.7 40.9-6.9c2.3-.7 4.7-1.1 7.1-1.1 42.9.0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class=menu-item-name>About</span></a></li><li class=menu-item><button id=theme-switcher type=button aria-label="Switch theme"><svg viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg><svg viewBox="0 0 576 512" class="icon theme-icon-system"><path d="M528 0H48C21.5.0.0 21.5.0 48v320c0 26.5 21.5 48 48 48h192l-16 48h-72c-13.3.0-24 10.7-24 24s10.7 24 24 24h272c13.3.0 24-10.7 24-24s-10.7-24-24-24h-72l-16-48h192c26.5.0 48-21.5 48-48V48c0-26.5-21.5-48-48-48zm-16 352H64V64h448v288z"/></svg></button></li><li class="menu-item search-item"><form id=search class=search role=search><label for=search-input><svg viewBox="0 0 512 512" class="icon search-icon"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></label>
<input type=search id=search-input class=search-input></form><template id=search-result hidden><article class="content post"><h2 class=post-title><a class=summary-title-link></a></h2><summary class=summary></summary><div class=read-more-container><a class=read-more-link>Read More »</a></div></article></template></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-small-caps=true data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">利用 WireGuard 快速构建属于你自己的虚拟专用网络</h1><div class=post-meta><time datetime=2025-09-26T23:40:01+08:00 class="post-meta-item published dt-published"><svg viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2025.9.26</time>
<time datetime=2025-09-26T23:40:01+08:00 class="post-meta-item modified dt-updated"><svg viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M4e2 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V160h352v298a6 6 0 01-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2025.9.26</time>
<span class="post-meta-item wordcount"><svg viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;10479</span>
<span class="post-meta-item reading-time"><svg viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;21&nbsp;mins</span></div><nav class=contents><h2 id=contents class=contents-title>Contents</h2><ol class=toc><li><a id=contents:引言 href=#引言>引言</a></li><li><a id=contents:为什么选择-wireguard href=#为什么选择-wireguard>为什么选择 WireGuard</a></li><li><a id=contents:方案介绍 href=#方案介绍>方案介绍</a><ol><li><a id=contents:设备说明 href=#设备说明>设备说明</a></li><li><a id=contents:网段划分 href=#网段划分>网段划分</a></li><li><a id=contents:连通性说明 href=#连通性说明>连通性说明</a></li><li><a id=contents:方案优缺点 href=#方案优缺点>方案优缺点</a></li></ol></li><li><a id=contents:wireguard-原理介绍 href=#wireguard-原理介绍>WireGuard 原理介绍</a><ol><li><a id=contents:最简-wireguard-tunnel-配置 href=#最简-wireguard-tunnel-配置>最简 WireGuard Tunnel 配置</a></li><li><a id=contents:wireguard-数据发送-and-接收流程-示意图 href=#wireguard-数据发送-and-接收流程-示意图>WireGuard 数据发送 & 接收流程（示意图）</a><ol><li><a id=contents:wireguard-数据发送流程 href=#wireguard-数据发送流程>WireGuard 数据发送流程</a></li><li><a id=contents:wireguard-数据接收流程 href=#wireguard-数据接收流程>WireGuard 数据接收流程</a></li></ol></li><li><a id=contents:wireguard-数据中继原理 href=#wireguard-数据中继原理>WireGuard 数据中继原理</a><ol><li><a id=contents:wireguard-数据中继-配置清单 href=#wireguard-数据中继-配置清单>WireGuard 数据中继（配置清单）</a></li><li><a id=contents:wireguard-数据中继-示意图 href=#wireguard-数据中继-示意图>WireGuard 数据中继（示意图）</a></li><li><a id=contents:wireguard-内网网关-配置清单 href=#wireguard-内网网关-配置清单>WireGuard 内网网关（配置清单）</a></li><li><a id=contents:wireguard-内网网关-示意图 href=#wireguard-内网网关-示意图>WireGuard 内网网关（示意图）</a></li></ol></li></ol></li><li><a id=contents:方案实施 href=#方案实施>方案实施</a><ol><li><a id=contents:router-配置 href=#router-配置>router 配置</a><ol><li><a id=contents:打开-ip-转发 href=#打开-ip-转发>打开 IP 转发</a></li><li><a id=contents:wireguard-配置 href=#wireguard-配置>WireGuard 配置</a></li></ol></li><li><a id=contents:home-gw-配置 href=#home-gw-配置>home-gw 配置</a><ol><li><a id=contents:打开-ip-转发 href=#打开-ip-转发>打开 IP 转发</a></li><li><a id=contents:wireguard-配置 href=#wireguard-配置>WireGuard 配置</a></li></ol></li><li><a id=contents:office-gw-配置 href=#office-gw-配置>office-gw 配置</a><ol><li><a id=contents:打开-ip-转发 href=#打开-ip-转发>打开 IP 转发</a></li><li><a id=contents:wireguard-配置 href=#wireguard-配置>WireGuard 配置</a></li></ol></li><li><a id=contents:macbook-配置 href=#macbook-配置>MacBook 配置</a></li><li><a id=contents:cellphone-配置 href=#cellphone-配置>Cellphone 配置</a></li></ol></li></ol></nav><div class="post-body e-content"><h2 id=引言><a href=#引言 class=anchor-link aria-label=引言><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:引言 class=headings>引言</a></h2><blockquote><p style=text-indent:0><span class=drop-cap>本</span>文详细分析了 WireGuard 的数据收发、数据中继的基本原理，并介绍了一种如何利用
WireGuard 快速构建一个属于自己的虚拟专用网络，可用于跨广域网安全通信，以及内网穿透。常见应用场景有：</p><ul><li>从公网安全访问家庭内网。例如：访问家庭摄像头，访问智能门锁，访问 NAS 服务器等。</li><li>从公网安全访问公司内网，满足远程办公需求。</li></ul><p>“快速”二字主要体现在本文介绍的方法可以较大程度简化配置和管理，并允许线性扩展网络规模，且不倚赖第三方服务（例如 tailscale）。</p></blockquote><h2 id=为什么选择-wireguard><a href=#为什么选择-wireguard class=anchor-link aria-label=为什么选择-wireguard><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:为什么选择-wireguard class=headings>为什么选择 WireGuard</a></h2><dl><dt>安全</dt><dd>WireGuard 的安全性经过<a href=https://zh-wireguard.com/formal-verification/ target=_blank rel=noopener>形式化验证</a>。</dd><dt>开源</dt><dd>WireGuard 完全开源，有 Go 和 C 语言两种实现。</dd><dt>跨平台</dt><dd>多平台支持，包括 Linux, Windows, macOS, Android, iOS 等。且内核模块已进入 Linux 内核树。</dd><dt>性能</dt><dd>快速，现代化，精简且实用。</dd></dl><h2 id=方案介绍><a href=#方案介绍 class=anchor-link aria-label=方案介绍><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:方案介绍 class=headings>方案介绍</a></h2><p>本文介绍的方法是利用 WireGuard 搭建一个逻辑上的「星型」网络结构，如下图所示：</p><pre tabindex=0><code class=language-uniline data-lang=uniline>          ╭─────────╮                          ╭───────────╮
          │ MacBook &lt;╌╌╌╌╌╌╌╌╌╌╌╮   ╭╌╌╌╌╌╌╌╌╌╌&gt; Cellphone │
          ╰─10.9.9.1╯           ┆   ┆          ╰──╴10.9.9.2╯
                            ╭┬──v───v─┬╮☁️
                            ││ router ││      ╔═════════════════ office ══════╗
                            ╰┴10.9.0.1┴╯      ║                   ╭─────────╮ ║
                                ^   ^         ║ ╭┬──────────┬╮  ╭─┤ jenkins │ ║
                     ╭╌╌╌╌╌╌╌╌╌╌╯   ╰╌╌╌╌╌╌╌╌╌&gt;─┤│ offic-gw │├──╯ ╰─────────╯ ║
                     ┆                        ║ ╰┴╴10.9.0.3╶┴╯       ...      ║
                     ┆                        ║                               ║
                     ┆                        ╚═════════════╸172.19.50.0/24 ══╝
╔════════════════════v═══════ homelab ═══╗
║              ╭┬────┴────┬╮             ║
║              ││ home-gw ││             ║                  &lt;╌╌╌╌&gt;
║              ╰┴╴10.9.0.2┴╯             ║           ╭─╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌─╮
║      ╭─────────────┼──────────────╮    ║           ┆ WireGuard Tunnel ┆
║ ╭────┴───╮  ╭──────┴─────╮     ╭──┴──╮ ║           ╰─╌╌10.9.0.0/16╶╌╌─╯
║ │ camera │  │ smart-lock │ ... │ NAS │ ║
║ ╰────────╯  ╰────────────╯     ╰─────╯ ║
╚══════════════════════ 192.168.1.0/24 ══╝
</code></pre><h3 id=设备说明><a href=#设备说明 class=anchor-link aria-label=设备说明><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:设备说明 class=headings>设备说明</a></h3><dl><dt>router</dt><dd>云端的一台服务器，有公网 IP，充当 tunnel 网络的路由器，提供路由中转服务。</dd><dt>home-gw</dt><dd>放在家里的一台服务器，充当家庭网络 (homelab) 的网关，通过该网关可以安全地穿透到家庭网络，访问家里的各种设备，例如：摄像头，智能门锁，NAS 服务器等。</dd><dt>office-gw</dt><dd>放在公司办公室的一台服务器，充当办公室网络 (office) 的网关,通过该网关可以安全地访问到公司内网的各项服务，满足远程办公需求。</dd><dt>MacBook</dt><dd>作为移动办公设备，位置不固定，可能在办公室、在家里，也可能处在咖啡厅、图书馆等外部网络。</dd><dt>Cellphone</dt><dd>手机，位置不固定，和 MacBook 类似。</dd></dl><h3 id=网段划分><a href=#网段划分 class=anchor-link aria-label=网段划分><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:网段划分 class=headings>网段划分</a></h3><dl><dt><code>10.9.0.0/16</code></dt><dd>WireGuard tunnel 网段，是我们为 WireGuard 节点分配的网段（也可以改成你喜欢的任何局域网网段，只要不与现有的 LAN 网段冲突即可）。<p>其内部划分出如下网段：</p><ul><li><strong><code>10.9.0.0/24</code>:</strong> 分配给 router 和 gateway。</li><li><strong><code>10.9.9.0/24</code>:</strong> 分配给移动设备，包括 MacBook, Cellphone 等。</li></ul><p>这样划分主要是为了便于区分不同类型的设备，同时也起到一个隔离保护的作用。</p></dd><dt><code>192.168.1.0/24</code></dt><dd>家庭局域网私有网段，这里称为 homelab。</dd><dt><code>172.19.50.0/24</code></dt><dd>公司局域网私有网段，这里称为 office。</dd></dl><h3 id=连通性说明><a href=#连通性说明 class=anchor-link aria-label=连通性说明><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:连通性说明 class=headings>连通性说明</a></h3><ul><li>MacBook 和 Cellphone 可以访问所有网络，包括：<ul><li>office：满足移动办公需求。</li><li>homelab: 方便随时访问家庭网络中的各项设备。</li></ul></li><li>office 和 homelab 之间默认无法互通，起到隐私安全方面的保护作用。</li></ul><h3 id=方案优缺点><a href=#方案优缺点 class=anchor-link aria-label=方案优缺点><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:方案优缺点 class=headings>方案优缺点</a></h3><p>方案优点：</p><ul><li><p>简化 WireGuard 的配置和管理</p><p>只有二级节点（指直接与 router 相连的节点）需要与 router 互换公钥，二级节点之间无需互相了解，二级节点后面的所有设备也无需任何配置。这样可以最大程度简化
WireGuard 的配置和管理工作，同时允许以线性复杂度扩展接入 tunnel 的设备数量。</p></li><li><p>扩展性强</p><p>上面提到二级节点后面的设备无需任何配置，就能通过 WireGuard 网络访问。这点其实很重要，因为像摄像头、智能门锁等设备是无法进行这类配置的。该方案基本上允许我们无限扩展 WG 网络的可访问范围。</p></li><li><p>安全、透明地访问内网资源</p><p>MacBook/Cellphone 可以安全、透明地访问 homelab/office 的内网资源，被访问资源无需其他额外设置。</p></li></ul><p>方案缺点：</p><ul><li>设备之间的通信都需要经由中心的 router 服务器转发，可能存在单点故障和性能瓶颈。</li></ul><p>作为个人用途而言，这个缺点一般是可以接受的。原因如下：</p><ul><li>私人网络一般数据量都比较小，不太可能出现性能瓶颈。</li><li>除非接入 WireGuard 的每台设备都有外网 IP，否则转发不可避免。</li><li>现在的云服务器还是相当稳定的，出故障的概率极低。要真碰上了，最差也就只是访问不了内网（跟没配置这个 tunnel 时一样），也不会有啥其他影响。</li></ul><h2 id=wireguard-原理介绍><a href=#wireguard-原理介绍 class=anchor-link aria-label=wireguard-原理介绍><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-原理介绍 class=headings>WireGuard 原理介绍</a></h2><p>在方案实施之前，有必要先了解一下 WireGuard 的路由寻址、加解密通信原理，这对理解我们的方案有很大帮助。</p><h3 id=最简-wireguard-tunnel-配置><a href=#最简-wireguard-tunnel-配置 class=anchor-link aria-label=最简-wireguard-tunnel-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:最简-wireguard-tunnel-配置 class=headings>最简 WireGuard Tunnel 配置</a></h3><p>为了方便讲解，我们先从一个最简单的 WireGuard Tunnel 配置开始。</p><p>该 tunnel 仅包含 A, B 两个节点：</p><pre tabindex=0><code class=language-uniline data-lang=uniline>Public IP:  1.1.1.A                 1.1.1.B
            ╭──────╮                ╭──────╮
            │node A├───╴Internet ───┤node B│
            ╰──────╯                ╰──────╯
WG IP:      10.0.0.A                10.0.0.B
</code></pre><p>其配置分别见下方。</p><p>Node A 的配置清单：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.0.A              # A 是 1~254 之间的任意数字</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Node B</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>&lt;B`s public key&gt;</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.0.B/32</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>1.1.1.B:51820        # 假设 B 的公网 IP 为 1.1.1.B</span>
</span></span></code></pre></td></tr></table></div></div></div><p>Node B 的配置清单：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.0.B              # B 是和 A 不相同的 1~254 之间的任意数字</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Node A</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>&lt;A`s public key&gt;</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.0.A/32</span>
</span></span><span class=line><span class=cl><span class=c1># A 的 Endpoint 会在协议握手之后自动获取</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=wireguard-数据发送-and-接收流程-示意图><a href=#wireguard-数据发送-and-接收流程-示意图 class=anchor-link aria-label=wireguard-数据发送-and-接收流程-示意图><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-数据发送-and-接收流程-示意图 class=headings>WireGuard 数据发送 & 接收流程（示意图）</a></h3><p>按照上述最简配置，以 <code>ping</code> 命令为例，我画了一张 WireGuard 数据发送 & 接收流程示意图：</p><pre tabindex=0><code class=language-uniline data-lang=uniline>       Node A                                                  Node B

╭───────╴user space╶────╮
│   ping 10.0.0.B       │
╰─────────┼─────────────╯
          1
╭─────────v───kernel────╮                      ╭───────────────kernel─────────────╮
│ ╭───────────────────╮ │                      │ ╭──────────────────────────────╮ │
│ │   TCP/IP stack    │ │                      │ │         TCP/IP stack      ╭────&gt;──╮
│ ╰──┬────^───────┬───╯ │                      │ ╰──^──────────┬───^────┬────^──╯ │  │
│    │    │       │     │                      │    │          │   │    │    │    │  │
│  ICMP  UDP     UDP    │                      │   UDP        UDP ICMP Reply UDP  │  │
│    2    3       4     │                      │    5          6   7    8    9    │  10
╰─┬─╴v────┴─┬─┬───v────┬╯                      ╰─┬──┴──────┬─┬─v───┴────v────┴───┬╯  │
  │   wg0   │ │  eth0  │──────╮               ╭──&gt;  eth0   │ │        wg0        │   │
  ╰10.0.0.A─╯ ╰1.1.1.A─╯      │               │  ╰─1.1.1.B─╯ ╰──────10.0.0.B─────╯   │
                  ^         ICMP Req          │                                   via eth0
                  │      (Encrypte in UDP)    │                                      │
                  │           │               ╵                                      │
                  │           │     ╭─────UDP datagram─────╮             ╭─────UDP datagram─────╮
                  │           ╰────&gt;│  src: 1.1.1.A:xxxxx  │             │  src: 1.1.1.B:51820  │
                  │                 │  dst: 1.1.1.B:51820  │             │  dst: 1.1.1.A:xxxxx  │
                  │                 ╰─┬─────WG Header────┬─╯             ╰─┬─────WG Header────┬─╯
                  │                  ╭╯  Received Index  ╰╮               ╭╯  Received Index  ╰╮
                  │                  │   Counter          │               │   Counter          │
                  │                  ├──────Encrypted─────┤               ├──────Encrypted─────┤
                  │                  │  ╭─────ICMP────╮   │               │  ╭─╴ICMP Reply─╮   │
                  │                  │  │src: 10.0.0.A│   │               │  │src: 10.0.0.B│   │
                  │                  │  │dst: 10.0.0.B│   │               │  │dst: 10.0.0.A│   │
                  │                  ╰──┴─────────────┴───╯               ╰──┴─────────────┴───╯
                  │                                                                 │
                  ╰───────────────────────ICMP Reply to A───────────────────────────╯
                                         (Encrypted in UDP)
</code></pre><blockquote><p>💡由于 <code>ping</code> 的响应由 kernel 的 TCP/IP stack 自动完成，因此上图中的 Node B 在
user space 并没有对应的用户空间处理程序。</p><p>如果是普通的 TCP/UDP 应用，则会将数据丢给用户空间对应的处理程序，形成一个 Node
A app ↔ Node B app 的完整闭环。</p></blockquote><p>下面，我们就按照上图标注的 1~7 个步骤，依次分析 WireGuard 的数据发送 & 接收过程。</p><h4 id=wireguard-数据发送流程><a href=#wireguard-数据发送流程 class=anchor-link aria-label=wireguard-数据发送流程><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-数据发送流程 class=headings>WireGuard 数据发送流程</a></h4><blockquote><p>💡WireGuard 虽然是通过 UDP 来传输数据的，但其建立的网络隧道确是工作在 Layer 3
上的（通过创建虚拟网络接口来实现）。</p></blockquote><p>在 Node A 上执行命令 <code>ping 10.0.0.B</code> 时，会发生下面几件事情（大致对应 <a href=#wireguard-%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81-and-%E6%8E%A5%E6%94%B6%E6%B5%81%E7%A8%8B-%E7%A4%BA%E6%84%8F%E5%9B%BE>WireGuard
数据发送 & 接收流程示意图</a> 中的步骤 1~4）：</p><ol><li><p>应用层产生报文</p><ol><li>在 node A 上执行 <code>ping 10.0.0.B</code> 命令</li><li>应用层交给内核协议栈生成一个 ICMP 报文<div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=na>[Inner IP Header]               # 源</span><span class=o>=</span><span class=s>10.0.0.A，目的=10.0.0.B</span>
</span></span><span class=line><span class=cl><span class=k>[ICMP Echo Request]</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ol></li><li><p>路由查找</p><ol><li><p>内核查路由表，发现 packet 的目标地址 10.0.0.B 应该由 WireGuard 接口 wg0
处理。</p><blockquote><p>💡在配置文件中的 AllowedIPs 中声明的地址，都会自动加入到对应 WireGuard 接口的路由表项中。可以通过 <code>ip route</code> 命令可以很轻松的验证这一点。</p></blockquote></li><li><p>内核将该 packet 交给 wg0 处理。</p></li></ol></li><li><p>WireGuard 接口处理（出站方向）</p><ol><li><p>确定目标 Peer: WireGuard 内核模块查找 AllowedIPs，找到 10.0.0.B 属于Peer
B。</p></li><li><p>加密：</p><ul><li><p>取出会话密钥 (session key) —— 该密钥由 WG 协议握手协商得来</p></li><li><p>使用 ChaCha20-Poly1305 将整个原始 IP packet 加密</p></li></ul></li><li><p>加上 WG Data Header, 包含如下信息：</p><ul><li>Receiver Index (32bit, 标识接受方的会话）</li><li>Counter (64bit, 防重放计数）</li></ul><p>将 WG Data Header 和加密后的数据放到一个 UDP 包中：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=na>[Outer IP Header]   # 源</span> <span class=o>=</span> <span class=s>A 公网地址，目的 = B 公网地址（Endpoint 指定）</span>
</span></span><span class=line><span class=cl><span class=na>[UDP Header]        # 源端口</span><span class=o>=</span><span class=s>随机/固定，目的端口=51820 (Endpoint 指定)</span>
</span></span><span class=line><span class=cl><span class=na>[WG Data Header]    # Receiver Index, Counter</span>
</span></span><span class=line><span class=cl><span class=na>[Encrypted Payload] # 原始 IP 报文 (10.0.0.A → 10.0.0.B)</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ol></li><li><p>UDP 发送</p><p>内核把这个 UDP packet 交给物理网卡，发送到 Internet → node B 。</p></li></ol><p>从上述过程中可以看到， <strong>在发送数据的过程中，AllowedIPs 起到类似路由表 (routing
table) 的作用</strong> 。</p><h4 id=wireguard-数据接收流程><a href=#wireguard-数据接收流程 class=anchor-link aria-label=wireguard-数据接收流程><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-数据接收流程 class=headings>WireGuard 数据接收流程</a></h4><p>下面是 node B 接收数据的过程（大致对应 <a href=#wireguard-%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81-and-%E6%8E%A5%E6%94%B6%E6%B5%81%E7%A8%8B-%E7%A4%BA%E6%84%8F%E5%9B%BE>WireGuard 数据发送 & 接收流程示意图</a> 中的步骤 5~7）：</p><ol start=5><li>到达网卡<ol><li>外层 UDP packet 到达 node B 的 WireGuard 监听端口（这里是 51820）。</li><li>内核网络栈把该 packet 交给 wg0 接口对应的 WireGuard 内核模块。</li></ol></li><li>WireGuard 接口处理（入站方向）<ol><li><p>定位会话</p><ol><li>WireGuard 内核模块读取 Receiver Index</li><li>根据这个 index 查找本地存储的会话信息 (session key, peer)。</li><li>如果找不到 → 丢弃。</li></ol></li><li><p>防重放校验</p><ol><li>使用 Counter 和本地的滑动窗口机制检查：<ul><li>这个包是不是比上一次的序号小？</li><li>是否落在防重放窗口内？</li></ul></li><li>未通过检查 → 丢弃</li></ol></li><li><p>解密</p><ol><li><p>使用找到的 session key 解密并校验完整性</p></li><li><p>解密失败 → 丢弃</p></li></ol></li><li><p>校验原始 packet 的源 IP 地址</p></li><li><p>解密后得到的就是原始的 IP packet, 例如：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=na>[Inner IP Header]   # 源</span><span class=o>=</span><span class=s>10.0.0.A，目的=10.0.0.B</span>
</span></span><span class=line><span class=cl><span class=k>[ICMP Echo Request]</span>
</span></span></code></pre></td></tr></table></div></div></div></li><li><p>检查原始 IP packet 的源地址是否在该 Peer 的 AllowedIPs 配置范围内：</p><ul><li><p>✅ 如果匹配 → 把原始报文交给 wg0 虚拟网卡 → 内核继续处理。</p></li><li><p>❌ 如果不匹配 → 直接丢弃。</p></li></ul></li></ol></li><li>报文处理<ol><li><p>内核查找路由表，发现目的 IP <code>10.0.0.B</code> 是 B 自己 (wg0 配置的隧道内 IP)</p><blockquote><p>💡如果发现目的 IP 不是 B 自己呢？读者可以思考一下。本节先留点悬念，后文章节 <a href=#wireguard-%E6%95%B0%E6%8D%AE%E4%B8%AD%E7%BB%A7%E5%8E%9F%E7%90%86>WireGuard 数据中继原理</a> 中会详细讲解。</p></blockquote></li><li><p>内核将该 packet 交给本地协议栈（ICMP handler, TCP socket 等）。</p></li></ol></li></ol><p>从上述过程中可以看到， <strong>在接收数据的过程中，AllowedIPs 起到类似 ACL (Access
Control List) 的作用</strong> 。</p><p>Node B 的内核协议栈在收到 ping 后，向 Node A 发送响应 (ICMP Echo Rely) 的过程，其实就是上述步骤的逆向过程（对应图中的 8~10）：</p><ol start=8><li><p>协议栈发现是发给本机的 ICMP Echo Request:</p><ol><li>生成一个 ICMP Echo Reply。</li><li>内核查路由表，发现 Reply packet 应该交给 wg0 处理。</li></ol></li><li><p>WireGuard 查找 AllowedIPs, 找到 peer A 可以接收这个 ICMP Echo Reply，于是用
peer A 的 session key 加密 packet, 并封装到 UDP 包中（该 UDP 包的目的地址为
peer A 的公网 IP 地址 <code>10.0.0.A</code> ），交给内核协议栈。</p></li><li><p>内核查路由表，然后通过物理网卡 <code>eth0</code> 将该 UDP 包发送给 node A。</p><p>node A 收到 UDP 包后，按照同样的流程，将其交给监听该端口的程序 (WireGuard)
→ 找到 session key → 解密 → 交给内核协议栈 → 最终交给上层的 <code>ping</code> 应用 → 打印 ICMP Echo Reply 消息。</p></li></ol><h3 id=wireguard-数据中继原理><a href=#wireguard-数据中继原理 class=anchor-link aria-label=wireguard-数据中继原理><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-数据中继原理 class=headings>WireGuard 数据中继原理</a></h3><p>前文提到，当 WireGuard 解出内层的原始 IP 报文，并交给内核处理，此时如果内核发现目的 IP 不是本机，会如何处理？</p><p>很简单，Linux 内核只有两种处理方式：</p><dl><dt>系统已打开 <code>ip_forward</code></dt><dd>查找路由表，尝试转发。</dd><dt>系统未打开 <code>ip_forward</code></dt><dd>直接丢弃。</dd></dl><p>WireGuard 的数据中继功能就是以此为基础的。</p><p>因此，本章有个前提，就是用作中继节点的 WireGuard 服务器已经打开了 <code>ip_forward</code> 。具体打开方式，可参考后文 <a href=#%E6%89%93%E5%BC%80-ip-%E8%BD%AC%E5%8F%91>打开 IP 转发</a> 中的介绍。</p><h4 id=wireguard-数据中继-配置清单><a href=#wireguard-数据中继-配置清单 class=anchor-link aria-label=wireguard-数据中继-配置清单><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-数据中继-配置清单 class=headings>WireGuard 数据中继（配置清单）</a></h4><p>现在咱们在 <a href=#%E6%9C%80%E7%AE%80-wireguard-tunnel-%E9%85%8D%E7%BD%AE>最简 WireGuard Tunnel 配置</a> 基础上，增加了一个 node C：</p><pre tabindex=0><code class=language-uniline data-lang=uniline>Public IP:  1.1.1.A     1.1.1.B     1.1.1.C
            ╭──────╮    ╭──────╮    ╭──────╮
            │node A├────┤node B├────┤node C│
            ╰──────╯    ╰──────╯    ╰──────╯
WG IP:      10.0.0.A    10.0.0.B    10.0.0.C
</code></pre><p>这次需要在 node A 上，运行 <code>ping 10.0.0.C</code> 。</p><p>要满足这个需求，需要修改一下 WireGuard 配置文件。</p><ul><li><p>Node A 的配置清单</p><p>A 需要向 C 发消息，所以在 Peer B 处的 <code>AllowedIPs</code> 应该填 C 的 IP，而不是 B 的 IP。
B 只起到一个路由转发的作用。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=c1># A&#39;s wg0.conf</span>
</span></span><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.0.A/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># B</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>&lt;B`s public key&gt;</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.0.C/32        # A \leftrightarrow C</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>1.1.1.B:51820        # 假设 B 的公网 IP 为 1.1.1.B</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><ul><li><p>Node B 的配置清单</p><p>B 作为中继节点，需要同时配置 peer A 和 peer C。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=c1># B&#39;s wg0.conf</span>
</span></span><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.0.B/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># node A</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>A`s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.0.A/32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># node C</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>C`s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.0.C/32</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><ul><li><p>Node C 的配置清单</p><p>同样的，C 需要允许 A 向我发消息，所以在 Peer B 处的 <code>AllowedIPs</code> 应该填 A 的 IP，而不是 B 的 IP。B 只起到一个路由转发的作用。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=c1># C&#39;s wg0.conf</span>
</span></span><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.0.C/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># B</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>&lt;B`s public key&gt;</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.0.A/32        # A \leftrightarrow C</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>1.1.1.B:51820        # 假设 B 的公网 IP 为 1.1.1.B</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><h4 id=wireguard-数据中继-示意图><a href=#wireguard-数据中继-示意图 class=anchor-link aria-label=wireguard-数据中继-示意图><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-数据中继-示意图 class=headings>WireGuard 数据中继（示意图）</a></h4><p>还是以 <code>ping</code> 命令为例，下面是我画的 WireGuard 数据中继的流程示意图：</p><pre tabindex=0><code class=language-uniline data-lang=uniline>       Node A                                         Node B                                              Node C
                                                  (ip_forward=1)
╭───────╴user space╶────╮                           Relay Node                                         Target Node
│   ping 10.0.0.B       │
╰─────────┼─────────────╯
          1
╭─────────v───kernel────╮             ╭───────────────kernel─────────────╮                ╭───────────────kernel─────────────╮
│ ╭───────────────────╮ │             │ ╭──────────────────────────────╮ │                │ ╭──────────────────────────────╮ │
│ │   TCP/IP stack    │ │             │ │         TCP/IP stack      ╭────&gt;──╮             │ │         TCP/IP stack      ╭────&gt;──╮
│ ╰──┬────^───────┬───╯ │             │ ╰──^──────────┬───^────┬────^──╯ │  │             │ ╰──^──────────┬───^────┬────^──╯ │  │
│    │    │       │     │             │    │          │   │    │    │    │  │             │    │          │   │    │    │    │  │
│  ICMP  UDP     UDP    │             │   UDP        UDP ICMP ICMP UDP   │  │             │   UDP        UDP ICMP Reply UDP  │  │
│    2    3       4     │             │    5          6   7    8    9    │  10            │    11         12  13   14   15   │  16
╰─┬─╴v────┴─┬─┬───v────┬╯             ╰─┬──┴──────┬─┬─v───┴────v────┴───┬╯  │             ╰─┬──┴──────┬─┬─v───┴────v────┴───┬╯  │
  │   wg0   │ │  eth0  │────────╮       │  eth0   │ │        wg0        │   │      ╭────────&gt;  eth0   │ │        wg0        │   │
  ╰10.0.0.A─╯ ╰1.1.1.A─╯        │       ╰─1.1.1.B─╯ ╰──────10.0.0.B─────╯   │      │        ╰─1.1.1.C─╯ ╰──────10.0.0.C─────╯   │
                  ^       ICMP Echo Req      ^                           via eth0  │                                         via eth0
                  │     (Encrypted in UDP)   │                              │      │                                            │
                  │             │            │                              │      │                                            │
                  ╵             │    ╭─────UDP datagram─────╮      ╭─────UDP datagram─────╮     ╭─────UDP datagram─────╮        │
     Got ICMP Echo Reply!       ╰───&gt;│  src: 1.1.1.A:xxxxx  │      │  src: 1.1.1.B:51820  │     │  src: 1.1.1.C:51820  │&lt;───────╯
     (Encrypted in UDP)              │  dst: 1.1.1.B:51820  │      │  dst: 1.1.1.C:xxxxx  │     │  dst: 1.1.1.B:xxxxx  │
                  ╷                  ╰─┬─────WG Header────┬─╯      ╰─┬─────WG Header────┬─╯     ╰─┬─────WG Header────┬─╯
                  │                   ╭╯  Received Index  ╰╮        ╭╯  Received Index  ╰╮       ╭╯  Received Index  ╰╮
                  │                   │   Counter          │        │   Counter          │       │   Counter          │
       ╭─────UDP datagram─────╮       ├──────Encrypted─────┤        ├──────Encrypted─────┤       ├──────Encrypted─────┤
       │  src: 1.1.1.B:51820  │       │  ╭─────ICMP────╮   │        │  ╭─────ICMP────╮   │       │  ╭─ICMP Reply──╮   │
       │  dst: 1.1.1.A:xxxxx  │       │  │src: 10.0.0.A│   │        │  │src: 10.0.0.A│   │       │  │src: 10.0.0.C│   │
       ╰─┬─────WG Header────┬─╯       │  │dst: 10.0.0.C│   │        │  │dst: 10.0.0.C│   │       │  │dst: 10.0.0.A│   │
        ╭╯  Received Index  ╰╮        ╰──┴─────────────┴───╯        ╰──┴─────────────┴───╯       ╰──┴─────────────┴───╯
        │   Counter          │                                   ╭──────────╮                              │
        ├──────Encrypted─────┤                    ╭───────wg0────┴─╮ Node B │                              │
        │  ╭──ICMP Reply─╮   │&lt;──────via eth0────╴│Encrypt into UDP│        &lt;──────────────────────────────╯
        │  │src: 10.0.0.C│   │                 ╭──┴──ICMP Reply─╮  ├────────╯
        │  │dst: 10.0.0.A│   │                 │src: 10.0.0.C   │──╯
        ╰──┴─────────────┴───╯                 │dst: 10.0.0.A   │
                                               ╰────────────────╯
</code></pre><p>和前面的 <a href=#wireguard-%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81-and-%E6%8E%A5%E6%94%B6%E6%B5%81%E7%A8%8B-%E7%A4%BA%E6%84%8F%E5%9B%BE>WireGuard 数据发送 & 接收示意图</a> 相比较，可以看到，前面的 7 个步骤是完全一致的。区别从第 8 步开始：</p><ol start=8><li><p>进入数据转发流程</p><p>内核收到 WireGuard 解密后的 ICMP 包之后，发现这个包不是发给本机的，于是进入转发流程（前提是打开了 ip_forward）。</p><p>首先仍然是内核查找路由表：</p><ul><li>发现目的 IP <code>10.0.0.C</code> 应该由 wg0 处理</li><li>继续交给 wg0 负责发送该 ICMP 包</li></ul></li><li><p>WireGuard 接口处理（出站方向）</p><p>到这一步之后，就和 <a href=#wireguard-%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B>WireGuard 数据发送流程</a> 中的出站数据处理一致了：</p><ol><li><p>确定目标 peer C</p></li><li><p>重新用 peer C 的 session key 加密</p></li><li><p>封装 WG Data Header → 封装 UDP 包，UDP 的目标地址为 <code>1.1.1.C</code> 。</p></li></ol></li><li><p>UDP 包发送至 node C。</p></li></ol><blockquote><p>💡请注意，WireGuard 在转发内层 IP 报文时，内层报文会 <strong>原封不动</strong> 地传递，包括：</p><ul><li>不会修改源地址</li><li>不会修改目标地址</li><li>不做 NAT</li></ul><p>WireGuard 唯一会做的就是：</p><dl><dt>接收方向</dt><dd>确认解密后的源 IP 属于该 peer 的 AllowedIPs, 否则丢弃 （类似 ACL
的作用）。</dd><dt>发送方向</dt><dd>根据目的 IP 查找匹配的 AllowedIPs, 把数据交给对应的 peer, 加密后发出去（类似 routing table 的作用）。</dd></dl><p>除此之外，它不会对内层 IP 报文做任何修改。</p><p>因此，node C 收到的内层报文，仍然是原始的 10.0.0.A → 10.0.0.C 的 ping 报文。</p></blockquote><p>而 node C 之后的步骤，就是一个逆向返回的过程，这里就不再赘述。</p><h4 id=wireguard-内网网关-配置清单><a href=#wireguard-内网网关-配置清单 class=anchor-link aria-label=wireguard-内网网关-配置清单><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-内网网关-配置清单 class=headings>WireGuard 内网网关（配置清单）</a></h4><p>有了对 WireGuard 数据中继原理的理解，就可以轻松理解 WireGuard 内网网关
(home-gw, office-gw) 是如何工作的了。</p><pre tabindex=0><code class=language-uniline data-lang=uniline>            ╭────LAN: 192.168.1.0/24──────╮
            │   Gateway                   │
            │ 192.168.1.B     192.168.1.C │
╭1.1.1.A─╮  │  ╭1.1.1.B╶╮      ╭────────╮ │
│ node A ├──┼──┤ node B ├──────┤ node C │ │
╰────────╯  │  ╰────────╯      ╰────────╯ │
 10.0.0.A   │   10.0.0.B                  │
            ╰─────────────────────────────╯
</code></pre><p>请注意，这次的网络拓扑结构和之前的有所不同：</p><ul><li>Node B 和 node C 处在同一个 LAN 中。</li><li>Node C 不是 WireGuard 节点，并没有加入 WG tunnel。</li></ul><p>我们还是先给出配置清单。</p><ul><li><p>Node A 的配置清单</p><p>A 需要向 C 发消息，所以在 Peer B 处的 <code>AllowedIPs</code> 应该填 C 的 IP，而不是 B 的 IP。
B 只起到一个路由转发的作用。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=c1># A&#39;s wg0.conf</span>
</span></span><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.0.A/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># B</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>&lt;B`s public key&gt;</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>192.168.1.C        # A \leftrightarrow C</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>1.1.1.B:51820        # 假设 B 的公网 IP 为 1.1.1.B</span>
</span></span></code></pre></td></tr></table></div></div></div></li></ul><ul><li><p>Node B 的配置清单</p><p>B 作为 gateway，仅需配置 peer A （peer B 不加入 WG tunnel)。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=c1># B&#39;s wg0.conf</span>
</span></span><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.0.B/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># eth0 为物理网卡地址，如有不同请自行修改。</span>
</span></span><span class=line><span class=cl><span class=na>PostUp</span> <span class=o>=</span> <span class=s>iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span class=line><span class=cl><span class=na>PostDown</span> <span class=o>=</span> <span class=s>iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># node A</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>A`s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.0.A/32</span>
</span></span></code></pre></td></tr></table></div></div></div><p>注意，相比之前的配置，Node B 增加了 <code>PostUp</code> 和 <code>PostDown</code> 配置。这两项配置分别会在
wg0 接口启用、停用之后执行。也就是说：</p><ul><li>wg0 接口启动后： <code>iptables</code> 增加一条转发规则，允许将来自 wg0 的包转发给 eth0，并执行 NAT 操作。</li><li>wg0 接口停止后： <code>iptables</code> 删除上述规则。</li></ul><p>如果没有这两条配置，Node B 就不能将数据转发给 LAN 网络。</p></li></ul><h4 id=wireguard-内网网关-示意图><a href=#wireguard-内网网关-示意图 class=anchor-link aria-label=wireguard-内网网关-示意图><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-内网网关-示意图 class=headings>WireGuard 内网网关（示意图）</a></h4><p>还是以 <code>ping</code> 命令为例，但这次换成：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ping 192.168.1.C
</span></span></code></pre></td></tr></table></div></div></div><p>这要求将 <code>ICMP</code> 包穿透到内网中的非 WireGuard 设备上。</p><p>下面是我画的内网穿透示意图。</p><pre tabindex=0><code class=language-uniline data-lang=uniline>                                 ╭╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌LAN: 192.168.1.0/24╶╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╮
       Node A                    ┆              Node B                                                        Node C            ┆
                                 ┆          (ip_forward=1)                                                                      ┆
╭───────╴user space╶────╮        ┆        LAN IP: 192.168.1.B                                           LAN IP: 192.168.1.C     ┆
│   ping 192.168.1.C    │        ┆           Gateway Node                                                  Target Node          ┆
╰─────────┼─────────────╯        ┆                                                                                              ┆
          1                      ┆                                                                                              ┆
╭─────────v───kernel────╮        ┆    ╭──────────kernel─────────╮                                    ╭────────kernel╶───────╮   ┆
│ ╭───────────────────╮ │        ╰╌╌╌╴│ ╭─────────────────────╮ │                                    │ ╭──────────────────╮ │╶╌╌╯
│ │   TCP/IP stack    │ │             │ │  TCP/IP stack   ╭─────&gt;─────╮                              │ │  TCP/IP stack    ╶─&gt;──╮
│ ╰──┬────^───────┬───╯ │             │ ╰──^──────────┬───^───╯ │     │                              │ ╰──^───────────────╯ │  │
│    │    │       │     │             │    │          │   │     │     │                              │    │                 │  │
│  ICMP  UDP     UDP    │             │   UDP        UDP ICMP   │     │                              │  ICMP                │  │
│    2    3       4     │             │    5          6   7     │     8                              │    9                 │  10
╰─┬─╴v────┴─┬─┬───v────┬╯             ╰─┬──┴──────┬─┬─v───┴────┬╯     │                              ╰─┬──┴────── ───┬──────╯  │
  │   wg0   │ │  eth0  │────────╮       │  eth0   │ │   wg0    │  ╭────SNAT──────╮   ╭─via eth0────────&gt;    eth0     │         │
  ╰10.0.0.A─╯ ╰1.1.1.A─╯        │       ╰─1.1.1.B─╯ ╰─10.0.0.B─╯  │╭─╴10.0.0.A   │   │                 ╰─192.168.1.C─╯         │
                  ^       ICMP Echo Req      ^                    │╰─&gt;192.168.1.B│   │                                     via eth0
                  │     (Encrypted in UDP)   │                    ╰───┬──────────╯   │                                         │
                  │             │            │                        │              │                                         │
                  ╵             │    ╭─────UDP datagram─────╮       ╭──╴ICMP packet╶──╮                                        │
        Got ICMP Echo Reply     ╰───╴│  src: 1.1.1.A:xxxxx  │       │src: 192.168.1.B │                                        │
        (Encrypted in UDP)           │  dst: 1.1.1.B:51820  │       │dst: 192.168.1.C │                                        │
                  ╷                  ╰─┬─────WG Header────┬─╯       ╰─────────────────╯                                        │
                  │                   ╭╯  Received Index  ╰╮                                 ╭──╴ICMP Reply────╮               │
                  │                   │   Counter          │                                 │src: 192.168.1.C │&lt;──────────────╯
     ╭──────UDP datagram─────╮        ├──────Encrypted─────┤                                 │dst: 192.168.1.B │
     │   src: 1.1.1.B:51820  │        │ ╭─────ICMP───────╮ │                                 ╰─────────────────╯
     │   dst: 1.1.1.A:xxxxx  │        │ │src: 10.0.0.A   │ │                                           │
     ╰──┬─────WG Header────┬─╯        │ │dst: 192.168.1.C│ │                                           │
      ╭─╯  Received Index  ╰╮         ╰─┴────────────────┴─╯                    ╭─────────╮            │
      │    Counter          │                                   ╭──────DNAT─────┴╮ Node B │            │
      ├───────Encrypted─────┤                   ╭───────wg0─────┴╮ ╭─╴192.168.1.B│        &lt;─────11─────╯
      │  ╭─────ICMP───────╮ │&lt;────via eth0─────╴│Encrypt into UDP│ ╰─&gt;10.0.0.A   ├────────╯
      │  │src: 192.168.1.C│ │                ╭──┴──ICMP Reply─╮  ├───────────────╯
      │  │dst: 10.0.0.A   │ │                │src: 192.168.1.C│──╯
      ╰──┴────────────────┴─╯                │dst: 10.0.0.A   │
                                             ╰────────────────╯
</code></pre><p>和 <a href=#wireguard-%E6%95%B0%E6%8D%AE%E4%B8%AD%E7%BB%A7-%E7%A4%BA%E6%84%8F%E5%9B%BE>WireGuard 数据中继（示意图）</a> 做对比，可以看到前面 7 个步骤都是一致的，从步骤
8 开始有区别：</p><ol start=8><li><p>进入数据转发流程</p><p>内核收到 WireGuard 解密后的 ICMP 包之后，发现这个包不是发给本机的，于是进入转发流程（前提是打开了 ip_forward）。</p><p>首先仍然是内核查找路由表：</p><ul><li>发现目的 IP <code>192.168.1.C</code> 应该由 eth0 发送</li><li>发送前需要做 <code>SNAT</code>, 将源地址从 <code>10.0.0.A</code> 转换为本机的 LAN 地址 <code>192.168.1.B</code></li><li>再通过 eth0 接口发送给 node C</li></ul></li><li><p>Node C 收到 ICMP 包后，内核协议栈按照正常流程生成 ICMP Echo Reply。</p></li><li><p>ICMP Echo Reply 经由 eth0 发往 node B。</p></li><li><p>Node B 收到 Reply, 需要先做 DNAT 将目的地址转换回 <code>10.0.0.A</code>, 后续步骤就和
WireGuard 数据中继的流程一致了。</p></li></ol><h2 id=方案实施><a href=#方案实施 class=anchor-link aria-label=方案实施><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:方案实施 class=headings>方案实施</a></h2><p>有了上述理论基础，要实现文章开头的 WireGuard 星型拓扑结构就很简单了。</p><p>WireGuard 在不同平台上的安装都比较简单，网上也很多相关介绍，这里略去不提，直接给出各个节点的配置说明。</p><p>WireGuard 的配置文件如果没有特殊说明，路径统一为 <code>/etc/wireguard/wg0.conf</code> 。
macOS 和 iOS/Android 比较特殊，有 UI 界面可以直接配置（Windows 没用过，想必应该也有界面可以配置）。</p><h3 id=router-配置><a href=#router-配置 class=anchor-link aria-label=router-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:router-配置 class=headings>router 配置</a></h3><h4 id=打开-ip-转发><a href=#打开-ip-转发 class=anchor-link aria-label=打开-ip-转发><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:打开-ip-转发 class=headings>打开 IP 转发</a></h4><ol><li>修改 <code>/etc/syslog.conf</code> 文件，增加如下内容：<div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=na>net.ipv4.ip_forward</span> <span class=o>=</span> <span class=s>1</span>
</span></span></code></pre></td></tr></table></div></div></div></li><li>运行命令：<div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sysctl -p
</span></span></code></pre></td></tr></table></div></div></div></li></ol><blockquote><p>💡为何要为 router 打开 IP 转发？</p><p>如果不打开 IP 转发，服务器在发现目标地址不属于自己的 packet 时，会直接丢弃。</p><p>而我们的 router 服务器作为“星型”网络的中心节点，需要为所有的下级节点将数据转发给其他各个节点，起到中继的作用，所以必须打开这个功能。</p></blockquote><h4 id=wireguard-配置><a href=#wireguard-配置 class=anchor-link aria-label=wireguard-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-配置 class=headings>WireGuard 配置</a></h4><p>router wg0.conf 配置：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.9.0.1/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># home-gw</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx                 # home-gw&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=c1># 在发送报文时，请将目标地址符合 AllowedIPs 配置的报文，发给此 Peer</span>
</span></span><span class=line><span class=cl><span class=c1># 在收到报文时，允许接收源地址符合 AllowedIPs 配置的报文</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.0.2/32, 192.168.1.0/24 # 允许将报文转发给 homelab 网络</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># office-gw</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx                          # office-gw&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.0.3/32, 172.19.50.0/24 # 允许将报文转发给 office 网络</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># MacBook</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx                 # MacBook&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.9.1/32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cellphone</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx                 # Cellphone&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.9.2/32</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=home-gw-配置><a href=#home-gw-配置 class=anchor-link aria-label=home-gw-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:home-gw-配置 class=headings>home-gw 配置</a></h3><h4 id=打开-ip-转发><a href=#打开-ip-转发 class=anchor-link aria-label=打开-ip-转发><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:打开-ip-转发 class=headings>打开 IP 转发</a></h4><p>参考<a href=#%E6%89%93%E5%BC%80-ip-%E8%BD%AC%E5%8F%91>前面的方法</a>打开 IP 转发功能。</p><blockquote><p>💡为何要为 home-gw 打开 IP 转发？</p><p>我们的 home-gw 服务器作为 homelab 网络的网关设备，需要为 homelab 网络中的其他所有设备提供网络穿透和数据转发服务，所以必须打开这个功能。</p></blockquote><h4 id=wireguard-配置><a href=#wireguard-配置 class=anchor-link aria-label=wireguard-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-配置 class=headings>WireGuard 配置</a></h4><p>home-gw wg0.conf 配置：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.9.0.2/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># 将目标地址不是本机的数据包通过物理网卡 eth0 转发出去，同时做一个地址伪装 (SNAT)</span>
</span></span><span class=line><span class=cl><span class=c1># 如果你的物理网卡不是 eth0，请修改成实际物理网卡接口</span>
</span></span><span class=line><span class=cl><span class=na>PostUp</span> <span class=o>=</span> <span class=s>iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span class=line><span class=cl><span class=na>PostDown</span> <span class=o>=</span> <span class=s>iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># router</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx                 # router&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.9.0/24        # 和移动端设备（MacBook/Cellphone）互通</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=office-gw-配置><a href=#office-gw-配置 class=anchor-link aria-label=office-gw-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:office-gw-配置 class=headings>office-gw 配置</a></h3><h4 id=打开-ip-转发><a href=#打开-ip-转发 class=anchor-link aria-label=打开-ip-转发><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:打开-ip-转发 class=headings>打开 IP 转发</a></h4><p>参考<a href=#%E6%89%93%E5%BC%80-ip-%E8%BD%AC%E5%8F%91>前面的方法</a>打开 IP 转发功能。原因和前面说的<a href=#%E6%89%93%E5%BC%80-ip-%E8%BD%AC%E5%8F%91>为 home-gw 打开 IP 转发</a>的原因一致。</p><h4 id=wireguard-配置><a href=#wireguard-配置 class=anchor-link aria-label=wireguard-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:wireguard-配置 class=headings>WireGuard 配置</a></h4><p>office-gw wg0.conf 配置：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.9.0.3/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># 将目标地址不是本机的数据包通过物理网卡 eth0 转发出去，同时做一个地址伪装 (SNAT)</span>
</span></span><span class=line><span class=cl><span class=c1># 如果你的物理网卡不是 eth0，请修改成实际物理网卡接口</span>
</span></span><span class=line><span class=cl><span class=na>PostUp</span> <span class=o>=</span> <span class=s>iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span class=line><span class=cl><span class=na>PostDown</span> <span class=o>=</span> <span class=s>iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># router</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx             # router&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.9.0/24    # 和移动端设备（MacBook/Cellphone）互通</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=macbook-配置><a href=#macbook-配置 class=anchor-link aria-label=macbook-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:macbook-配置 class=headings>MacBook 配置</a></h3><p>MacBook WireGuard 配置：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.9.9.1/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># router</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx                                          # router&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.0.0/16, 192.168.1.0/24, 172.19.50.0/24 # 和所有设备互通</span>
</span></span></code></pre></td></tr></table></div></div></div><h3 id=cellphone-配置><a href=#cellphone-配置 class=anchor-link aria-label=cellphone-配置><svg viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:cellphone-配置 class=headings>Cellphone 配置</a></h3><p>Cellphone WireGuard 配置和 MacBook 配置类似：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.9.9.2/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>&lt;private key&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># router</span>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>xxx                                          # router&#39;s public key</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.9.0.0/16, 192.168.1.0/24, 172.19.50.0/24 # 和所有设备互通</span>
</span></span></code></pre></td></tr></table></div></div></div></div></article><div class=updated-badge-container><span title="Updated @ 2025-09-26 23:40:01 +0800" style=cursor:help><svg width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2025-09-26</text><text x="915" y="140" textLength="650" transform="scale(.1)">2025-09-26</text></g></svg></span></div><div class=post-share><div class=share-items><div class="share-item facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;hashtag=%23Wireguard" title="Share on Facebook" target=_blank rel=noopener><svg viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a></div><div class="share-item mastodon"><a href="/fedishare.html#title=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;description=%e5%bc%95%e8%a8%80%20%e6%9c%ac%e6%96%87%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e4%ba%86%20WireGuard%20%e7%9a%84%e6%95%b0%e6%8d%ae%e6%94%b6%e5%8f%91%e3%80%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e7%bb%a7%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%ef%bc%8c%e5%b9%b6%e4%bb%8b%e7%bb%8d%e4%ba%86%e4%b8%80%e7%a7%8d%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b1%9e%e4%ba%8e%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c%ef%bc%8c%e5%8f%af%e7%94%a8%e4%ba%8e%e8%b7%a8%e5%b9%bf%e5%9f%9f%e7%bd%91%e5%ae%89%e5%85%a8%e9%80%9a%e4%bf%a1%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%86%85%e7%bd%91%e7%a9%bf%e9%80%8f%e3%80%82%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%ef%bc%9a%0a&amp;url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/" title="Share on Mastodon" target=_blank rel=noopener><svg viewBox="0 0 448 512" class="icon mastodon-icon"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></a></div><div class="share-item fediverse"><a href="/fedishare.html#title=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;description=%e5%bc%95%e8%a8%80%20%e6%9c%ac%e6%96%87%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e4%ba%86%20WireGuard%20%e7%9a%84%e6%95%b0%e6%8d%ae%e6%94%b6%e5%8f%91%e3%80%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e7%bb%a7%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%ef%bc%8c%e5%b9%b6%e4%bb%8b%e7%bb%8d%e4%ba%86%e4%b8%80%e7%a7%8d%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b1%9e%e4%ba%8e%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c%ef%bc%8c%e5%8f%af%e7%94%a8%e4%ba%8e%e8%b7%a8%e5%b9%bf%e5%9f%9f%e7%bd%91%e5%ae%89%e5%85%a8%e9%80%9a%e4%bf%a1%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%86%85%e7%bd%91%e7%a9%bf%e9%80%8f%e3%80%82%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%ef%bc%9a%0a&amp;url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/" title="Share on Fediverse" target=_blank rel=noopener><svg viewBox="64 163 873 873" class="icon fediverse-icon"><defs><linearGradient id="fediverse-gradient"><stop offset="0" stop-color="#ff0101"/><stop offset="10%" stop-color="#9501ff"/><stop offset="50%" stop-color="#ffca01"/><stop offset="75%" stop-color="#01a3ff"/><stop offset="100%" stop-color="#65ff01"/></linearGradient></defs><path d="M539 176q-32 0-55 22t-25 55 20.5 58 56 27 58.5-20.5 27-56-20.5-59T544 176h-5zm-87 95-232 118q20 20 25 48l231-118q-19-20-24-48zm167 27q-13 25-38 38l183 184q13-25 39-38zM477 320 342 585l40 40 143-280q-28-5-48-25zm104 16q-22 11-46 10l-8-1 21 132 56 9zM155 370q-32 0-55 22.5t-25 55 20.5 58 56.5 27 59-21 26.5-56-21-58.5-55.5-27h-6zm90 68q1 9 1 18-1 19-10 35l132 21 26-50zm225 36-26 51 311 49q-1-8-1-17 1-19 10-36zm372 6q-32 1-55 23t-24.5 55 21 58 56 27 58.5-20.5 27-56.5-20.5-59-56.5-27h-6zM236 493q-13 25-39 38l210 210 51-25zm-40 38q-21 11-44 10l-9-1 40 256q21-10 45-9l8 1zm364 22 48 311q21-10 44-9l10 1-46-294zm195 23-118 60 8 56 135-68q-20-20-25-48zm26 49-119 231q28 5 48 25l119-231q-28-5-48-25zM306 654l-68 134q28 5 48 25l60-119zm262 17-281 143q19 20 24 48l265-135zM513 771l-51 25 106 107q13-25 39-38zM222 795q-32 0-55.5 22.5t-25 55 21 57.5 56 27 58.5-20.5 27-56-20.5-58.5-56.5-27h-5zm89 68q2 9 1 18-1 19-9 35l256 41q-1-9-1-18 1-18 10-35zm335 0q-32 0-55 22.5t-24.5 55 20.5 58 56 27 59-21 27-56-20.5-58.5-56.5-27h-6z"/></svg></a></div><div class="share-item x"><a href="https://x.com/share?url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;text=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;hashtags=Wireguard,Network,Tunnel,Vpn,Homelab," title="Share on 𝕏" target=_blank rel=noopener><svg viewBox="0 0 512 512" class="icon x-icon"><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></a></div><div class="share-item linkedin"><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;title=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;summary=%e5%bc%95%e8%a8%80%20%e6%9c%ac%e6%96%87%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e4%ba%86%20WireGuard%20%e7%9a%84%e6%95%b0%e6%8d%ae%e6%94%b6%e5%8f%91%e3%80%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e7%bb%a7%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%ef%bc%8c%e5%b9%b6%e4%bb%8b%e7%bb%8d%e4%ba%86%e4%b8%80%e7%a7%8d%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b1%9e%e4%ba%8e%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c%ef%bc%8c%e5%8f%af%e7%94%a8%e4%ba%8e%e8%b7%a8%e5%b9%bf%e5%9f%9f%e7%bd%91%e5%ae%89%e5%85%a8%e9%80%9a%e4%bf%a1%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%86%85%e7%bd%91%e7%a9%bf%e9%80%8f%e3%80%82%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%ef%bc%9a%0a&amp;source=MinCodes" title="Share on LinkedIn" target=_blank rel=noopener><svg viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div><div class="share-item telegram"><a href="https://t.me/share/url?url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;text=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c" title="Share on Telegram" target=_blank rel=noopener><svg viewBox="0 0 496 512" class="icon telegram-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a></div><div class="share-item weibo"><a href="https://service.weibo.com/share/share.php?&amp;url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;title=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;pic=https://mincodes.com/icons/apple-touch-icon.png&amp;searchPic=false" title="Share on Weibo" target=_blank rel=noopener><svg viewBox="0 0 512 512" class="icon weibo-icon"><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7.0 395.3.0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></a></div><div class="share-item douban"><a href="https://www.douban.com/share/service?href=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;name=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;text=%e5%bc%95%e8%a8%80%20%e6%9c%ac%e6%96%87%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e4%ba%86%20WireGuard%20%e7%9a%84%e6%95%b0%e6%8d%ae%e6%94%b6%e5%8f%91%e3%80%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e7%bb%a7%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%ef%bc%8c%e5%b9%b6%e4%bb%8b%e7%bb%8d%e4%ba%86%e4%b8%80%e7%a7%8d%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b1%9e%e4%ba%8e%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c%ef%bc%8c%e5%8f%af%e7%94%a8%e4%ba%8e%e8%b7%a8%e5%b9%bf%e5%9f%9f%e7%bd%91%e5%ae%89%e5%85%a8%e9%80%9a%e4%bf%a1%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%86%85%e7%bd%91%e7%a9%bf%e9%80%8f%e3%80%82%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%ef%bc%9a%0a" title="Share on Douban" target=_blank rel=noopener><svg viewBox="0 0 24 24" class="icon douban-icon"><path d="M.643.92v2.412h22.714V.92H.643zm1.974 4.926v9.42h18.764v-9.42H2.617zm2.72 2.408H18.69v4.605H5.338V8.254zm1.657 7.412-2.512.938c1.037 1.461 1.87 2.825 2.512 4.091H0v2.385h24v-2.385h-6.678c.818-1.176 1.589-2.543 2.303-4.091l-2.73-.938a29.952 29.952.0 01-2.479 5.03h-4.75c-.786-1.962-1.677-3.641-2.672-5.03z"/></svg></a></div><div class="share-item qq"><a href="https://connect.qq.com/widget/shareqq/index.html?url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;title=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;summary=%e5%bc%95%e8%a8%80%20%e6%9c%ac%e6%96%87%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e4%ba%86%20WireGuard%20%e7%9a%84%e6%95%b0%e6%8d%ae%e6%94%b6%e5%8f%91%e3%80%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e7%bb%a7%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%ef%bc%8c%e5%b9%b6%e4%bb%8b%e7%bb%8d%e4%ba%86%e4%b8%80%e7%a7%8d%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b1%9e%e4%ba%8e%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c%ef%bc%8c%e5%8f%af%e7%94%a8%e4%ba%8e%e8%b7%a8%e5%b9%bf%e5%9f%9f%e7%bd%91%e5%ae%89%e5%85%a8%e9%80%9a%e4%bf%a1%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%86%85%e7%bd%91%e7%a9%bf%e9%80%8f%e3%80%82%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%ef%bc%9a%0a&amp;pics=https://mincodes.com/icons/apple-touch-icon.png&amp;site=MinCodes" title="Share on QQ" target=_blank rel=noopener><svg viewBox="0 0 448 512" class="icon qq-icon"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741.0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792.0.0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"/></svg></a></div><div class="share-item qzone"><a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;title=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;summary=%e5%bc%95%e8%a8%80%20%e6%9c%ac%e6%96%87%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e4%ba%86%20WireGuard%20%e7%9a%84%e6%95%b0%e6%8d%ae%e6%94%b6%e5%8f%91%e3%80%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e7%bb%a7%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%ef%bc%8c%e5%b9%b6%e4%bb%8b%e7%bb%8d%e4%ba%86%e4%b8%80%e7%a7%8d%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b1%9e%e4%ba%8e%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c%ef%bc%8c%e5%8f%af%e7%94%a8%e4%ba%8e%e8%b7%a8%e5%b9%bf%e5%9f%9f%e7%bd%91%e5%ae%89%e5%85%a8%e9%80%9a%e4%bf%a1%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%86%85%e7%bd%91%e7%a9%bf%e9%80%8f%e3%80%82%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%ef%bc%9a%0a&amp;pics=https://mincodes.com/icons/apple-touch-icon.png&amp;site=MinCodes" title="Share on Qzone" target=_blank rel=noopener><svg viewBox="0 0 24 24" class="icon qzone-icon"><path d="M23.985 9.202c-.032-.099-.127-.223-.334-.258-.207-.036-7.351-1.406-7.351-1.406s-.105-.022-.198-.07c-.092-.047-.127-.167-.127-.167S12.447.956 12.349.77C12.25.583 12.104.532 12 .532s-.251.051-.349.238c-.098.186-3.626 6.531-3.626 6.531s-.035.12-.128.167c-.092.047-.197.07-.197.07S.556 8.908.348 8.943c-.208.036-.302.16-.333.258a.477.477.0 00.125.449l5.362 5.49s.072.08.119.172c.016.104.005.21.005.21s-1.189 7.242-1.22 7.45.075.369.159.43c.083.062.233.106.421.013.189-.093 6.812-3.261 6.812-3.261s.098-.044.201-.061.201.061.201.061 6.623 3.168 6.812 3.261c.188.094.338.049.421-.013a.463.463.0 00.159-.43c-.021-.14-.93-5.677-.93-5.677.876-.54 1.425-1.039 1.849-1.747-2.594.969-6.006 1.717-9.415 1.866-.915.041-2.41.097-3.473-.015-.678-.071-1.17-.144-1.243-.438-.053-.215.054-.46.545-.831a2640.5 2640.5.0 012.861-2.155c1.285-.968 3.559-2.47 3.559-2.731.0-.285-2.144-.781-4.037-.781-1.945.0-2.275.132-2.811.168-.488.034-.769.005-.804-.138-.06-.248.183-.389.588-.568.709-.314 1.86-.594 1.984-.626.194-.052 3.082-.805 5.618-.535 1.318.14 3.244.668 3.244 1.276.0.342-1.721 1.494-3.225 2.597-1.149.843-2.217 1.561-2.217 1.688.0.342 3.533 1.241 6.689 1.01l.003-.022c.048-.092.119-.172.119-.172l5.362-5.49a.477.477.0 00.127-.449z"/></svg></a></div><div class="share-item pocket"><a href="https://getpocket.com/edit.php?url=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/" title="Share on Pocket" target=_blank rel=noopener><svg viewBox="0 0 448 512" class="icon pocket-icon"><path d="M407.6 64h-367C18.5 64 0 82.5.0 104.6v135.2C0 364.5 99.7 464 224.2 464c124 0 223.8-99.5 223.8-224.2V104.6c0-22.4-17.7-40.6-40.4-40.6zm-162 268.5c-12.4 11.8-31.4 11.1-42.4.0C89.5 223.6 88.3 227.4 88.3 209.3c0-16.9 13.8-30.7 30.7-30.7 17 0 16.1 3.8 105.2 89.3 90.6-86.9 88.6-89.3 105.5-89.3 16.9.0 30.7 13.8 30.7 30.7.0 17.8-2.9 15.7-114.8 123.2z"/></svg></a></div><div class="share-item hackernews"><a href="https://news.ycombinator.com/submitlink?u=https://mincodes.com/posts/build-your-own-vpn-with-wireguard/&amp;t=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c" title="Share on Hacker News" target=_blank rel=noopener><svg viewBox="0 0 448 512" class="icon hackernews-icon"><path d="M0 32v448h448V32H0zm21.2 197.2H21c.1-.1.2-.3.3-.4.0.1.0.3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg></a></div><div class="share-item qrcode"><div class=qrcode-container title="Share via QR Code"><svg viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id=qrcode-img></div></div><script src=https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js></script><script>const typeNumber=0,errorCorrectionLevel="L",qr=qrcode(typeNumber,errorCorrectionLevel);qr.addData("https://mincodes.com/posts/build-your-own-vpn-with-wireguard/"),qr.make(),document.getElementById("qrcode-img").innerHTML=qr.createImgTag()</script></div><div class="share-item email"><a href="mailto:?subject=%0a%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e5%b1%9e%e4%ba%8e%e4%bd%a0%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c&amp;body=%e5%bc%95%e8%a8%80%20%e6%9c%ac%e6%96%87%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e4%ba%86%20WireGuard%20%e7%9a%84%e6%95%b0%e6%8d%ae%e6%94%b6%e5%8f%91%e3%80%81%e6%95%b0%e6%8d%ae%e4%b8%ad%e7%bb%a7%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86%ef%bc%8c%e5%b9%b6%e4%bb%8b%e7%bb%8d%e4%ba%86%e4%b8%80%e7%a7%8d%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8%20WireGuard%20%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b1%9e%e4%ba%8e%e8%87%aa%e5%b7%b1%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%93%e7%94%a8%e7%bd%91%e7%bb%9c%ef%bc%8c%e5%8f%af%e7%94%a8%e4%ba%8e%e8%b7%a8%e5%b9%bf%e5%9f%9f%e7%bd%91%e5%ae%89%e5%85%a8%e9%80%9a%e4%bf%a1%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%86%85%e7%bd%91%e7%a9%bf%e9%80%8f%e3%80%82%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%ef%bc%9a%0a%0Ahttps://mincodes.com/posts/build-your-own-vpn-with-wireguard/" title="Share via email" target=_blank rel=noopener><svg viewBox="0 0 512 512" class="icon email-icon"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></a></div></div></div><div class=related-posts><h2 class=related-title>See Also:<svg viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6.0-12-5.4-12-12v-92h-92c-6.6.0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6.0 12 5.4 12 12v92h92c6.6.0 12 5.4 12 12v56z"/></svg></h2><ul class=related-list><li class=related-item><a href=/posts/network-tools/ class=related-link>Network Tools 网络工具箱</a></li><li class=related-item><a href=/posts/network-security/ class=related-link>网络安全 Network Security</a></li></ul></div><div class=post-tags><a href=/tags/wireguard/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Wireguard</a>
<a href=/tags/network/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Network</a>
<a href=/tags/tunnel/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Tunnel</a>
<a href=/tags/vpn/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Vpn</a>
<a href=/tags/homelab/ rel=tag class=post-tags-link><svg viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>Homelab</a></div><ul class=post-nav><li class=post-nav-next><a href=/posts/understand-k8s-external-traffic-policy/ rel=next>一个小实验理解 Kubernetes 的外部流量策略 (externalTrafficPolicy) ></a></li></ul></div></main><div id=back-to-top class=back-to-top><a href=#top aria-label="Back to top"><svg viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>©&nbsp;2020–2025&nbsp;<svg viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;</div><div class=site-copyright><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en target=_blank rel=noopener>CC BY-NC-SA 4.0</a></div><div class=custom-footer><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?7b760b677a021bf17f98d03f83124b62",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></div></div></footer></div><script>typeof MathJax=="undefined"?(window.MathJax={loader:{load:["[tex]/mhchem"]},tex:{inlineMath:{"[+]":[["$","$"]]},tags:"ams",packages:{"[+]":["mhchem"]}}},function(){const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js",e.defer=!0,document.head.appendChild(e)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>let imgNodes=document.querySelectorAll("div.post-body img");imgNodes=Array.from(imgNodes).filter(e=>e.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>